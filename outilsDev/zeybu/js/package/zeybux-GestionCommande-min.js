function GestionCommandeTemplate(){this.dialogAjoutProduitAjoutMarche='<div id="dialog-ajout-pro" title="Produit"><div id="information-detail-producteur"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Le Produit</div><div id="pro-idFerme" class="com-float-left"><select name="ferme"><option value="0" >== Choisir une ferme ==</option><!-- BEGIN listeFerme --><option value="{listeFerme.ferId}" >{listeFerme.ferNom}</option><!-- END listeFerme --></select></div><div id="pro-idCategorie" class="com-float-left"><select name="categorie" disabled="disabled"><option value="0" >== Choisir une catégorie ==</option></select></div><div id="pro-idProduit" class="com-float-left"><select name="produit" disabled="disabled"><option value="0" >== Choisir un produit ==</option></select></div></div><div id="prix-stock-produit"></div></div>';this.ajoutProduitSelectCategorie='<div id="pro-idCategorie" class="com-float-left"><select name="categorie"><option value="0" >== Choisir une catégorie ==</option><!-- BEGIN listeCategorie --><option value="{listeCategorie.cproId}" >{listeCategorie.cproNom}</option><!-- END listeCategorie --></select></div>';this.ajoutProduitSelectProduit='<div id="pro-idProduit" class="com-float-left"><select name="produit"><option value="0" >== Choisir un produit ==</option><!-- BEGIN listeProduit --><option value="{listeProduit.nproId}" >{listeProduit.nproNom}</option><!-- END listeProduit --></select></div>';this.prixEtStockAjoutProduit='<div id="prix-stock-produit"><div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Prix de vente</div><table class="com-table-form" id="table-pro-prix"><tr><td class="catalogue-entete-lot">Quantité</td><td class="catalogue-entete-lot">Unité</td><td>Prix</td><td></td><td></td></tr><tr class="btn-lot"><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-quantite" maxlength="13" id="pro-lot-quantite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all" type="text" name="lot-unite" maxlength="20" id="pro-lot-unite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-prix" maxlength="13" id="pro-lot-prix"/> {sigleMonetaire}</td><td colspan="2"><button type="button" id="btn-ajout-lot" class="ui-state-default ui-corner-all com-button com-center">Ajouter</button></td></tr></table><table class="com-table" id="lot-liste"><!-- BEGIN modelesLot --><tr class="ligne-lot" id="ligne-lot-{modelesLot.id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{modelesLot.id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" value="{modelesLot.id}" name="pro-lot" id="pro-lot-{modelesLot.id}-id" class="modele-lot"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{modelesLot.id} lot-quantite" id="lot-{modelesLot.id}-quantite">{modelesLot.quantite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-quantite" maxlength="13" id="pro-lot-{modelesLot.id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{modelesLot.id} lot-unite" id="lot-{modelesLot.id}-unite">{modelesLot.unite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{modelesLot.id}-unite" maxlength="20" id="pro-lot-{modelesLot.id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{modelesLot.id} lot-prix" id="lot-{modelesLot.id}-prix">{modelesLot.prix}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-prix" maxlength="13" id="pro-lot-{modelesLot.id}-prix"/> {modelesLot.sigleMonetaire}</td><td class="com-table-td-med td-edt"><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-lot" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-valider-lot" id="btn-valider-lot-{modelesLot.id}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-annuler-lot" id="btn-annuler-lot-{modelesLot.id}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-lot" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span></td></tr><!-- END modelesLot --></table></div><div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Stock</div><table class="com-table-form"><tr><th class="com-table-form-th">Limite de stock : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-stock-choix" value="0" checked="checked"/>Pas de limite</td></tr><tr><th class="com-table-form-th"></th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-stock-choix" value="1"/><input disabled="disabled" class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="pro-stock" maxlength="13" id="pro-qteRestante"/> <span class="unite-stock">{unite}</span></td></tr><tr><th class="com-table-form-th">Quantité max par adhérent : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="0" checked="checked"/>Pas de limite</td></tr><tr><th class="com-table-form-th"></th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="1" /><input disabled="disabled" class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="pro-qte-max" maxlength="13" id="pro-qteMaxCommande"/> <span class="unite-stock">{unite}</span></td></tr></table></div></div>';this.modeleLot='<tr class="ligne-lot" id="ligne-lot-{id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" value="{id}" name="pro-lot" id="pro-lot-{id}-id"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{id} lot-quantite" id="lot-{id}-quantite">{quantite}</span><input class="champ-lot-{id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{id}-quantite" maxlength="13" id="pro-lot-{id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{id} lot-unite" id="lot-{id}-unite">{unite}</span><input class="champ-lot-{id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{id}-unite" maxlength="20" id="pro-lot-{id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{id} lot-prix" id="lot-{id}-prix">{prix}</span><input class="champ-lot-{id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{id}-prix" maxlength="13" id="pro-lot-{id}-prix"/> {sigleMonetaire}</td><td class="com-table-td-med td-edt"><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-lot" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-valider-lot" id="btn-valider-lot-{id}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-annuler-lot" id="btn-annuler-lot-{id}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-lot" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span></td></tr>';this.btnValiderAjoutMarche='<div id="btn-gestion-marche" class="com-widget-window ui-widget ui-widget-header ui-corner-all com-center"><button type="button" id="btn-modifier-creation-commande" class="com-btn-edt-multiples ui-helper-hidden ui-state-default ui-corner-all com-button com-center">Modifier</button><button type="button" id="btn-creer-marche" class="ui-state-default ui-corner-all com-button com-center">Valider</button></div>';this.ajoutMarcheListeProduit='<div id="liste-ferme"><!-- BEGIN fermes --><div class="com-widget-window ui-widget ui-widget-content ui-corner-all" id="ferme-{fermes.ferId}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">{fermes.ferNom}</div><!-- BEGIN fermes.categories --><table class="com-table"><tr class="ui-widget-header" ><td class="com-table-td-debut">{fermes.categories.cproNom}</td><td class="com-table-td-med"></td><td class="com-table-td-fin"></td></tr><!-- BEGIN fermes.categories.produits --><tr><td class="com-table-td-debut">{fermes.categories.produits.nproNom}</td><td class="com-table-td-med td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-produit" title="Modifier" id-produit="{fermes.categories.produits.nproId}"><span class="ui-icon ui-icon-pencil"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-produit" title="Supprimer" id-produit="{fermes.categories.produits.nproId}"><span class="ui-icon ui-icon-trash"></span></span></td></tr><!-- END fermes.categories.produits --></table><!-- END fermes.categories --></div><!-- END fermes --></div>';this.dialogModifProduitAjoutMarche='<div id="dialog-modif-pro" title="Produit"><div id="information-detail-producteur"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Le Produit</div><div id="pro-idFerme" class="com-float-left" id-ferme="{ferId}">{ferNom}</div><div id="pro-idCategorie" class="com-float-left" id-categorie="{cproId}">{cproNom}</div><div id="pro-idProduit" class="com-float-left" id-produit="{nproId}">{nproNom}</div></div><div id="prix-stock-produit"><div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Prix de vente</div><table class="com-table-form" id="table-pro-prix"><tr><td class="catalogue-entete-lot">Quantité</td><td class="catalogue-entete-lot">Unité</td><td>Prix</td><td></td><td></td></tr><tr class="btn-lot"><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-quantite" maxlength="13" id="pro-lot-quantite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all" type="text" name="lot-unite" maxlength="20" id="pro-lot-unite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-prix" maxlength="13" id="pro-lot-prix"/> {sigleMonetaire}</td><td colspan="2"><button type="button" id="btn-ajout-lot" class="ui-state-default ui-corner-all com-button com-center">Ajouter</button></td></tr></table><table class="com-table" id="lot-liste"><!-- BEGIN modelesLot --><tr class="ligne-lot" id="ligne-lot-{modelesLot.id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{modelesLot.id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" value="{modelesLot.id}" name="pro-lot" id="pro-lot-{modelesLot.id}-id" {modelesLot.checked} class="{modelesLot.modele}"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{modelesLot.id} lot-quantite" id="lot-{modelesLot.id}-quantite">{modelesLot.quantite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-quantite" maxlength="13" id="pro-lot-{modelesLot.id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{modelesLot.id} lot-unite" id="lot-{modelesLot.id}-unite">{modelesLot.unite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{modelesLot.id}-unite" maxlength="20" id="pro-lot-{modelesLot.id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{modelesLot.id} lot-prix" id="lot-{modelesLot.id}-prix">{modelesLot.prix}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-prix" maxlength="13" id="pro-lot-{modelesLot.id}-prix"/> {modelesLot.sigleMonetaire}</td><td class="com-table-td-med td-edt"><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-lot" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-valider-lot" id="btn-valider-lot-{modelesLot.id}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-annuler-lot" id="btn-annuler-lot-{modelesLot.id}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-lot" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span></td></tr><!-- END modelesLot --></table></div><div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Stock</div><table class="com-table-form"><tr><th class="com-table-form-th">Limite de stock : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-stock-choix" value="0" {nproStockCheckedNoLimit} />Pas de limite</td></tr><tr><th class="com-table-form-th"></th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-stock-choix" value="1" {nproStockCheckedLimit} /><input {nproStockDisabled} class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" value="{nproStock}" name="pro-stock" maxlength="13" id="pro-qteRestante"/> <span class="unite-stock">{unite}</span></td></tr><tr><th class="com-table-form-th">Quantité max par adhérent : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="0" {nproQteMaxCheckedNoLimit} />Pas de limite</td></tr><tr><th class="com-table-form-th"></th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="1" {nproQteMaxCheckedLimit} /><input {nproQteMaxDisabled} class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" value="{nproQteMax}" name="pro-qte-max" maxlength="13" id="pro-qteMaxCommande"/> <span class="unite-stock">{unite}</span></td></tr></table></div></div></div>';this.formulaireAjoutMarche='<div id="contenu"><div id="formulaire_ajout_commande_ext"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Nouveau Marché</div><div class="com-widget-content"><form id="formulaire-information-creation-commande"><table class="com-table-form"><tr><th class="com-table-form-th">Nom du Marché : </th><td class="com-table-form-td"><span id="nom-marche-span" class="ui-helper-hidden informations-marche"></span><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="nom" id="marche-nom" maxlength="100" /></td></tr><tr><th class="com-table-form-th">Début des Réservations * : </th><td class="com-table-form-td"><span id="date-debut-reservation-marche-span" class="ui-helper-hidden informations-marche"></span><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="date-debut-reservation" id="marche-dateDebutReservation" /></td><td class="com-table-form-td">à <span id="time-debut-reservation-marche-span" class="ui-helper-hidden informations-marche"></span><select name="heure-debut-reservation" id="marche-timeDebutReservation" class="informations-marche" ><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><span class="informations-marche">H</span> <select name="minute-debut-reservation" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td></tr><tr><th class="com-table-form-th">Fin des Réservations * : </th><td class="com-table-form-td"><span id="date-fin-reservation-marche-span" class="ui-helper-hidden informations-marche"></span><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="date-fin-reservation" id="marche-dateFinReservation" /></td><td class="com-table-form-td">à <span id="time-fin-reservation-marche-span" class="ui-helper-hidden informations-marche"></span><select name="heure-fin-reservation" id="marche-timeFinReservation" class="informations-marche" ><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><span class="informations-marche">H</span> <select name="minute-fin-reservation" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td></tr><tr><th class="com-table-form-th">Jour du marché * : </th><td class="com-table-form-td"><span id="date-debut-marche-span" class="ui-helper-hidden informations-marche"></span><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="date-debut" id="marche-dateMarcheDebut"/></td><td class="com-table-form-td">de <span id="time-debut-marche-span" class="ui-helper-hidden informations-marche"></span><select name="heure-debut" id="marche-timeMarcheDebut" class="informations-marche"><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><span class="informations-marche">H</span> <select name="minute-debut" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td><td class="com-table-form-td">à <span id="time-fin-marche-span" class="ui-helper-hidden informations-marche"></span><select name="heure-fin" id="marche-timeMarcheFin" class="informations-marche"><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><span class="informations-marche">H</span> <select name="minute-fin" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td></tr><tr><th class="com-table-form-th">Description : </th><td class="com-table-form-td"><span id="description-marche-span" class="ui-helper-hidden informations-marche"></span><textarea class="com-input-text ui-widget-content ui-corner-all informations-marche" name="description" id="marche-description" ></textarea></td></tr></table></form></div></div><div id="btn-ajout-produit-div" class="com-widget-window ui-widget ui-widget-header ui-corner-all com-center"><button type="button" id="btn-ajout-produit" class="ui-state-default ui-corner-all com-button com-center">Ajouter un produit</button></div><div id="liste-ferme"></div></div></div>';this.listeCommandePage='<div id="contenu"><div id="liste_commande_int"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-marche-archive"><span class="com-float-left">Les Marchés cloturés</span><span class="com-float-left ui-icon ui-icon-arrowthick-1-e"></span></button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés en cours<span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-nv-marche" title="Ajouter un marché"><span class="ui-icon ui-icon-plusthick"></span></span></div><table class="com-table"><tr class="ui-widget ui-widget-header"><th class="com-table-th lst-resa-th-num">N°</th><th class="com-table-th">Marché</th>	<th class="com-table-th">Date de cloture des Réservations</th><th class="com-table-th"></th><th class="com-table-th"></th></tr><!-- BEGIN commande --><tr><td class="com-table-td com-text-align-right">{commande.numero}</td><td class="com-table-td">Le {commande.dateMarcheDebut} de {commande.heureMarcheDebut}H{commande.minuteMarcheDebut} à {commande.heureMarcheFin}H{commande.minuteMarcheFin}</td><td class="com-table-td">Le {commande.dateFinReservation} à {commande.heureFinReservation}H{commande.minuteFinReservation}</td><td class="com-table-td lst-resa-btn-commander"><button class="btn-editer ui-state-default ui-corner-all com-button com-center" id="{commande.id}" >Editer</button></td><td class="com-table-td lst-resa-btn-commander"><button class="btn-marche ui-state-default ui-corner-all com-button com-center" id="{commande.id}" >Vente</button></td></tr><!-- END commande --></table></div></div></div></div>';this.listeCommandeArchivePage='<div id="contenu"><div id="liste_commande_int"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-marche-encours"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Les Marchés en cours</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés cloturés</div><div id="content-nav-liste-operation" class="ui-helper-clearfix ui-state-default ui-corner-all"><form>	<span id="icone-nav-liste-operation-w" class="prev ui-helper-hidden ui-state-default ui-corner-all com-button" ><span class="ui-icon ui-icon-circle-arrow-w"></span></span>	<span id="page-compteur">Page : <span type="text" class="pagedisplay"></span></span>	<span id="icone-nav-liste-operation-e" class="next ui-state-default ui-corner-all com-button" ><span class="ui-icon ui-icon-circle-arrow-e"></span></span>	<input type="hidden" class="pagesize" value="30"></form></div><table class="com-table" id="table-marche-archive"><thead><tr class="ui-widget ui-widget-header"><th class="com-table-th lst-resa-th-num com-cursor-pointer"><span class="ui-icon span-icon"></span>N°</th><th class="com-table-th com-cursor-pointer" ><span class="ui-icon span-icon"></span>Date de cloture des Réservations</th><th class="com-table-th com-cursor-pointer" ><span class="ui-icon span-icon"></span>Marché</th>	</tr></thead><tbody><!-- BEGIN commande --><tr class="com-cursor-pointer detail-commande-ligne" ><td class="com-table-td com-underline-hover com-text-align-right"><span class="ui-helper-hidden id-commande">{commande.id}</span>{commande.numero}</td><td class="com-table-td com-underline-hover">Le {commande.dateFinReservation} à {commande.heureFinReservation}H{commande.minuteFinReservation}</td><td class="com-table-td com-underline-hover">Le {commande.dateMarcheDebut} de {commande.heureMarcheDebut}H{commande.minuteMarcheDebut} à {commande.heureMarcheFin}H{commande.minuteMarcheFin}</td></tr><!-- END commande --></tbody></table></div></div></div></div>';this.listeAdherentCommandePage='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Vente du Marché n°{numeroMarche}</div><div class="recherche com-widget-header ui-widget ui-widget-header ui-corner-all"><form id="filter-form"> <span class="conteneur-icon com-float-left ui-widget-content ui-corner-left" title="Chercher"><span class="ui-icon ui-icon-search"></span></span><input class="com-input-text ui-widget-content ui-corner-right" name="filter" id="filter" value="" maxlength="30" size="15" type="text" /></form></div><table class="com-table"><thead><tr class="ui-widget ui-widget-header com-cursor-pointer achat-commande-ligne"><th class="com-table-th com-underline-hover com-center"><span class="ui-helper-hidden id-adherent">0</span>Compte invité</th></tr></thead></table><table class="com-table" id="liste-adherent"><thead><tr class="ui-widget ui-widget-header com-cursor-pointer"><th class="com-table-th com-underline-hover marche-com-th-num-adh"><span class="ui-icon span-icon"></span>Numéro Adhérent</th><th class="com-table-th com-underline-hover marche-com-th-num-adh"><span class="ui-icon span-icon"></span>Numéro Compte</th><th class="com-table-th com-underline-hover marche-com-th-nom"><span class="ui-icon span-icon"></span>Nom</th>	<th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Prénom</th></tr></thead><tbody><!-- BEGIN listeAdherentCommande --><tr class="com-cursor-pointer achat-commande-ligne" ><td class="com-table-td com-underline-hover"><span class="ui-helper-hidden id-adherent">{listeAdherentCommande.adhId}</span>{listeAdherentCommande.adhNumero}</td><td class="com-table-td com-underline-hover">{listeAdherentCommande.cptLabel}</td><td class="com-table-td com-underline-hover">{listeAdherentCommande.adhNom}</td><td class="com-table-td com-underline-hover">{listeAdherentCommande.adhPrenom}</td></tr><!-- END listeAdherentCommande --></tbody></table></div></div></div>';this.achatCommandePage='<div id="contenu"><div id="vente-info-adherent" class="com-float-left com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Vente du Marché n°{comNumero}</div><div id="vente-achat-info-marche">{adhNumero} :  {adhPrenom} {adhNom}<br/>N° de Compte : {adhCompte}</div><div><span>Solde Actuel : </span><span>{adhSolde} {sigleMonetaire}</span><br/><span>Nouveau Solde : </span><span id="nouveau-solde">{adhNouveauSolde}</span> <span id="nouveau-solde-sigle">{sigleMonetaire}</span></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all com-float-left" id="achat-rechgt-widget"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Rechargement du compte</div><div class="com-widget-content"><table><thead><tr><th>Montant</th><th>Type de Paiement</th><th id="label-champ-complementaire"></th></tr></thead><tbody><tr><td><input type="text" name="montant-rechargement" value="" class="com-numeric com-input-text ui-widget-content ui-corner-all" id="rechargementmontant" maxlength="12" size="3"/> <span>{sigleMonetaire}</span></td><td class="com-center"><select name="typepaiement" id="rechargementtypePaiement"><option value="0">== Choisir ==</option><!-- BEGIN typePaiement --><option value="{typePaiement.tppId}">{typePaiement.tppType}</option><!-- END typePaiement --></select></td><td id="td-champ-complementaire"><input type="text" name="champ-complementaire" value="" class="com-input-text ui-widget-content ui-corner-all" id="rechargementchampComplementaire" maxlength="50" size="15"/></td></tr></tbody></table></div></div><div class="com-clear-float-left com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><span>Total Marché : <span id="total-global">0,00</span> {sigleMonetaire}</span></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all" id="achat-pdt-widget"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat</div><div class="com-widget-content"><table class="achat-commande-table-pdt"><thead><tr><th colspan="3"></th><th colspan="2" class="table-vente-quantite">Quantité</th><th colspan="2" class="table-vente-prix">Prix</th></tr></thead><tbody><!-- BEGIN categories --><tr><td class="ui-widget-header ui-corner-all com-center">{categories.nom}</td><td colspan="6"></td></tr><!-- BEGIN categories.produits --><tr class="ligne-produit"><td class="table-vente-produit"><span class="produit-id ui-helper-hidden">{categories.produits.proId}</span>{categories.produits.nproNom}</td><td class="table-vente-lot"><select id="lot-{categories.produits.proId}" class="lot-vente-produit lot-vente-produit-select"><!-- BEGIN categories.produits.lot --><option value="{categories.produits.lot.dcomId}">par {categories.produits.lot.dcomTaille} {categories.produits.proUniteMesure}</option><!-- END categories.produits.lot --></select><span class="lot-vente-produit ui-helper-hidden"></span></td><td class="table-vente-prix-unitaire" >à <span id="prix-unitaire-{categories.produits.proId}">{categories.produits.prixUnitaire}</span> {sigleMonetaire}/{categories.produits.proUniteMesure}</td><td class="com-text-align-right"><input type="text" value="{categories.produits.stoQuantite}" class="com-numeric produit-quantite com-input-text ui-widget-content ui-corner-all" id="produits{categories.produits.proId}quantite" maxlength="12" size="3"/> </td><td class="">{categories.produits.proUniteMesure}</td><td class="com-text-align-right " ><input type="text" value="{categories.produits.proPrix}" class="com-numeric produit-prix com-input-text ui-widget-content ui-corner-all" id="produits{categories.produits.proId}prix" maxlength="12" size="3"/></td><td><span>{sigleMonetaire}</span></td></tr><!-- END categories.produits --><!-- END categories --></tbody><tfoot><tr><td colspan="4"></td><td class="com-text-align-right" >Total :</td><td class="com-text-align-right" ><span id="total-achat">{total}</span></td><td><span>{sigleMonetaire}</span></td></tr></tfoot></table></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all" id="achat-pdt-solidaire-widget" ><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat Solidaire</div><div class="com-widget-content"><table class="achat-commande-table-pdt"><thead><tr><th colspan="3"></th><th colspan="2" class="table-vente-quantite">Quantité</th><th colspan="2" class="table-vente-prix">Prix</th></tr></thead><tbody><!-- BEGIN categoriesSolidaire --><tr><td class="ui-widget-header ui-corner-all com-center">{categoriesSolidaire.nom}</td><td colspan="6"></td></tr><!-- BEGIN categoriesSolidaire.produits --><tr class="ligne-produit-solidaire"><td class="table-vente-produit"><span class="produit-id ui-helper-hidden">{categoriesSolidaire.produits.proId}</span>{categoriesSolidaire.produits.nproNom}</td><td class="table-vente-lot"><select id="lot-solidaire-{categoriesSolidaire.produits.proId}"><!-- BEGIN categoriesSolidaire.produits.lot --><option value="{categoriesSolidaire.produits.lot.dcomId}">par {categoriesSolidaire.produits.lot.dcomTaille} {categoriesSolidaire.produits.proUniteMesure}</option><!-- END categoriesSolidaire.produits.lot --></select></td><td class="table-vente-prix-unitaire" >à <span id="prix-unitaire-solidaire-{categoriesSolidaire.produits.proId}">{categoriesSolidaire.produits.prixUnitaire}</span> {sigleMonetaire}/{categoriesSolidaire.produits.proUniteMesure}</td><td class="com-text-align-right"><input type="text" value="0" class="com-numeric produit-solidaire-quantite com-input-text ui-widget-content ui-corner-all" id="produitsSolidaire{categoriesSolidaire.produits.proId}quantite" maxlength="12" size="3"/> </td><td>{categoriesSolidaire.produits.proUniteMesure}</td><td class="com-text-align-right" ><input type="text" value="0" class="com-numeric produit-solidaire-prix com-input-text ui-widget-content ui-corner-all" id="produitsSolidaire{categoriesSolidaire.produits.proId}prix" maxlength="12" size="3"/></td><td><span>{sigleMonetaire}</span></td></tr><!-- END categoriesSolidaire.produits --><!-- END categoriesSolidaire --></tbody><tfoot><tr><td colspan="4"></td><td class="com-text-align-right" >Total :</td><td class="com-text-align-right" ><span id="total-achat-solidaire">0,00</span></td><td><span>{sigleMonetaire}</span></td></tr></tfoot></table></div></div><div class="com-clear-float-left com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button type="button" id="btn-annuler" class="com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center">Annuler</button><button type="button" class="ui-helper-hidden com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center" id="btn-modifier">Modifier</button><button type="button" id="btn-valider" class="ui-state-default ui-corner-all com-button com-center">Valider</button></div></div>';this.lotUnique='<input type="hidden" id="lot-{IdPdt}" value="{valeur}" /><span>{text}</span>';this.lotUniqueSolidaire='<input type="hidden" id="lot-solidaire-{IdPdt}" value="{valeur}" /><span>{text}</span>';this.achatCommandeSucces='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat</div><div class="com-widget-content"><p class="com-msg-confirm-icon"><span class="com-float-left ui-icon ui-icon-check"></span>Achat effectué avec succès.<br/><br/><button id="btn-annuler" class="ui-state-default ui-corner-all com-button com-center">Retourner à la liste des adhérents</button></p></div></div></div>';this.dialogClotureCommande='<div id="dialog-cloturer-com" title="Cloture du Marché n°{comNumero}"><p>Vous allez cloturer le Marché n°{comNumero}</p></div>';this.dialogExportListeAchatEtReservation='<div id="dialog-cloturer-com" title="Export des Achats et Réservations du marché n°{comNumero}"><p>Vous allez exporter les Achats et Réservations du Marché n°{comNumero}.<br/>Cette action peut être longue.</p></div>';this.dialogExportListeReservation='<div id="dialog-export-liste-reservation" title="Export des réservations en cours."><form><table><tr><td>Format de sortie : </td><td><input type="radio" name="format" value="0" checked="checked" />Pdf</td><td><input type="radio" name="format" value="1" />CSV</td></tr></table><div>Sélectionner les produits : </div><table class="com-table-100"><!-- BEGIN fermes --><tr class="ui-widget-header" ><td colspan="2" class="com-table-td">{fermes.ferNom}</td></tr><!-- BEGIN fermes.categories --><tr><td colspan="2" class="com-table-td">{fermes.categories.cproNom}</td></tr><!-- BEGIN fermes.categories.produits --><tr><td class="com-table-td-debut td-edt"><input type="checkbox" value="{fermes.categories.produits.id}" name="id_produits"/></td><td class="com-table-td-fin">{fermes.categories.produits.nproNom}</td></tr><!-- END fermes.categories.produits --><!-- END fermes.categories --><!-- END fermes --></table></form></div>';this.editerCommandePage='<div id="contenu"><div id="edt-com-nav-resa-achat"><span class="com-cursor-pointer ui-widget-header ui-corner-tl com-btn-hover ui-state-active" id="btn-information-marche">Information</span><span class="com-cursor-pointer ui-widget-header com-btn-hover" id="btn-liste-resa">Reservation</span><span class="com-cursor-pointer ui-widget-header ui-corner-tr com-btn-hover" id="btn-liste-achat-resa">Achat</span></div><div id="edt-com-liste"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}<span class="ui-helper-hidden marche-archive-1 com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-cloture-com" title="Cloturer"><span class="ui-icon ui-icon-locked"></span></span><span class="ui-helper-hidden marche-archive-1 com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-play-com" title="Ouvrir les ventes et réservations"><span class="ui-icon ui-icon-play"></span></span><span class="ui-helper-hidden marche-archive-0  com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-pause-com" title="Arrêter les ventes et réservations"><span class="ui-icon ui-icon-pause"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-modif-com" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-dupliquer-com" title="Dupliquer le marché"><span class="ui-icon ui-icon-copy"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-livraison-com" title="Bon de livraison"><span class="ui-icon ui-icon-cart"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-bon-com" title="Bon de commande"><span class="ui-icon ui-icon-document"></span></span></div><div>Réservations : Du <span id="edt-marche-dateDebutReservation">{dateDebutReservation}</span> à <span id="edt-marche-heureDebutReservation">{heureDebutReservation}</span>H<span id="edt-marche-minuteDebutReservation">{minuteDebutReservation}</span> au <span id="edt-marche-dateFinReservation">{dateFinReservation}</span> à <span id="edt-marche-heureFinReservation">{heureFinReservation}</span>H<span id="edt-marche-minuteFinReservation">{minuteFinReservation}</span> <br/>Marché : Le <span id="edt-marche-dateMarcheDebut">{dateMarcheDebut}</span> de <span id="edt-marche-heureMarcheDebut">{heureMarcheDebut}</span>H<span id="edt-marche-minuteMarcheDebut">{minuteMarcheDebut}</span> à <span id="edt-marche-heureMarcheFin">{heureMarcheFin}</span>H<span id="edt-marche-minuteMarcheFin">{minuteMarcheFin}</span></div></div><div id="btn-ajout-produit-div" class="com-widget-window ui-widget ui-widget-header ui-corner-all com-center"><button type="button" id="btn-ajout-produit" class="ui-state-default ui-corner-all com-button com-center">Ajouter un produit</button></div><div id="liste-ferme"></div></div></div>';this.listeReservation='<div id="edt-com-liste" ><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Liste des Réservations en cours<span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all" id="btn-export-resa" title="Exporter les réservations"><span class="ui-icon ui-icon-print"></span></span></div><div id="edt-com-recherche" class="recherche com-widget-header ui-widget ui-widget-header ui-corner-all"><form id="filter-form"><span class="conteneur-icon com-float-left ui-widget-content ui-corner-left" title="Chercher"><span class="ui-icon ui-icon-search"></span></span><input class="com-input-text ui-widget-content ui-corner-right" name="filter" id="filter" value="" maxlength="30" size="15" type="text" /></form></div><table class="com-table" id="edt-com-liste-resa"><thead><tr class="ui-widget ui-widget-header com-cursor-pointer"><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>N°</th><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Compte</th><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Nom</th>	<th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Prénom</th></tr></thead><tbody><!-- BEGIN listeAdherentCommande --><tr class="com-cursor-pointer edt-com-reservation-ligne" ><td class="com-table-td com-underline-hover"><span class="ui-helper-hidden id-adherent">{listeAdherentCommande.adhId}</span>{listeAdherentCommande.adhNumero}</td><td class="com-table-td com-underline-hover">{listeAdherentCommande.adhLabelCompte}</td><td class="com-table-td com-underline-hover">{listeAdherentCommande.adhNom}</td><td class="com-table-td com-underline-hover">{listeAdherentCommande.adhPrenom}</td></tr><!-- END listeAdherentCommande --></tbody></table></div></div>';this.listeAchatEtReservation='<div id="edt-com-liste" ><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Liste des Achats et Réservations<span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all" id="btn-export-achat" title="Exporter les Achats et les réservations"><span class="ui-icon ui-icon-print"></span></span></div><div id="edt-com-recherche" class="recherche com-widget-header ui-widget ui-widget-header ui-corner-all"><form id="filter-form"><span class="conteneur-icon com-float-left ui-widget-content ui-corner-left" title="Chercher"><span class="ui-icon ui-icon-search"></span></span><input class="com-input-text ui-widget-content ui-corner-right" name="filter" id="filter" value="" maxlength="30" size="15" type="text" /></form></div><table class="com-table" id="edt-com-liste-resa"><thead><tr class="ui-widget ui-widget-header com-cursor-pointer"><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>N°</th><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Compte</th><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Nom</th>	<th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Prénom</th><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Réservation</th><th class="com-table-th com-underline-hover"><span class="ui-icon span-icon"></span>Achat</th></tr></thead><tbody><!-- BEGIN listeAchatEtReservation --><tr class="com-cursor-pointer edt-com-achat-ligne" ><td class="com-table-td com-underline-hover"><span class="ui-helper-hidden id-adherent">{listeAchatEtReservation.adhId}</span>{listeAchatEtReservation.adhNumero}</td><td class="com-table-td com-underline-hover">{listeAchatEtReservation.cptLabel}</td><td class="com-table-td com-underline-hover">{listeAchatEtReservation.adhNom}</td><td class="com-table-td com-underline-hover">{listeAchatEtReservation.adhPrenom}</td><td class="com-table-td com-underline-hover">{listeAchatEtReservation.reservation}</td><td class="com-table-td com-underline-hover">{listeAchatEtReservation.achat}</td></tr><!-- END listeAchatEtReservation --></tbody></table></div></div>';this.listeAchatEtReservationVide='<div class="com-float-left" id="edt-com-liste" ><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Liste des Achats et Réservations</div><p id="texte-liste-vide">Aucun adhérent sur ce marché.</p></div></div>';this.detailAchatEtReservation='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="btn-annuler"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour au Marché</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div><div>Fin des réservations : Le {dateFinReservation} à {heureFinReservation}H{minuteFinReservation} <br/>Marché : Le {dateMarcheDebut} de {heureMarcheDebut}H{minuteMarcheDebut} à {heureMarcheFin}H{minuteMarcheFin}</div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Adhérent</div><div class="com-widget-content"><div id="resa-info-commande">{adhNumero} :  {adhPrenom} {adhNom}<br/>N° de Compte : {adhCompte}</div><div><span>Solde : </span><span>{adhSolde} {sigleMonetaire}</span></div><div class="com-clear-float-left"></div></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">La réservation : <span class="resa-etat" id="reservation-etat-label">{etatReservation}</span><span class="resa-etat ui-helper-hidden"><select id="reservation-etat"><!-- BEGIN typeEtatReservation --><option value="{typeEtatReservation.value}" {typeEtatReservation.selected}>{typeEtatReservation.label}</option><!-- END typeEtatReservation --></select></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all modif-resa ui-helper-hidden" id="btn-modif-resa" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all ui-helper-hidden modif-resa" id="btn-check-resa" title="Valider"><span class="ui-icon ui-icon-check"></span></span></div><table><!-- BEGIN reservation --><tr class="ligne-produit-reservation"><td class="detail-resa-npro"><span class="ui-helper-hidden produit-id">{reservation.id}</span>{reservation.nproNom}</td><td class="com-text-align-right detail-resa-qte" id="reservation-{reservation.id}-quantite">{reservation.stoQuantite}</td><td class="com-text-align-right detail-resa-qte ui-helper-hidden"><input type="text" value="{reservation.stoQuantite}" class="com-numeric produit-quantite com-input-text ui-widget-content ui-corner-all" id="reservation-produits{reservation.id}quantite" maxlength="12" size="3"/></td><td class="detail-resa-unite">{reservation.proUniteMesure}</td><td class="com-text-align-right detail-resa-prix" id="reservation-{reservation.id}-prix">{reservation.prix}</td><td class="com-text-align-right detail-resa-prix ui-helper-hidden"><input type="text" value="{reservation.prix}" class="com-numeric produit-prix com-input-text ui-widget-content ui-corner-all" id="reservation-produits{reservation.id}prix" maxlength="12" size="3"/></td><td>{sigleMonetaire}</td></tr><!-- END reservation --><tr><td class="com-text-align-right" colspan="3">Total : </td><td class="com-text-align-right resa-total" id="reservation-total-label">{totalReservation}</td><td class="com-text-align-right resa-total ui-helper-hidden"><input type="text" value="{totalReservation}" class="com-numeric com-input-text ui-widget-content ui-corner-all" id="reservation-total" maxlength="12" size="3"/></td><td>{sigleMonetaire}</td></tr></table></div><!-- BEGIN achats --><div class="achat com-widget-window ui-widget ui-widget-content ui-corner-all" id="achat-{achats.idAchat}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat <span class="achat-id ui-helper-hidden">{achats.idAchat}</span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all modif-achat-{achats.idAchat}" id="btn-supp-achat-{achats.idAchat}" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all modif-achat-{achats.idAchat}" id="btn-modif-achat-{achats.idAchat}" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all ui-helper-hidden modif-achat-{achats.idAchat}" id="btn-annuler-achat-{achats.idAchat}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all ui-helper-hidden modif-achat-{achats.idAchat}" id="btn-check-achat-{achats.idAchat}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></div><table><!-- BEGIN achats.achat --><tr class="ligne-produit-achat-{achats.idAchat}"><td class="detail-resa-npro"><span class="ui-helper-hidden produit-id">{achats.achat.id}</span>{achats.achat.nproNom}</td><td class="com-text-align-right detail-achat-{achats.idAchat}-qte" id="achat-{achats.idAchat}-{achats.achat.id}-quantite">{achats.achat.stoQuantite}</td><td class="com-text-align-right detail-achat-{achats.idAchat}-qte ui-helper-hidden"><input type="text" value="{achats.achat.stoQuantite}" class="com-numeric produit-quantite com-input-text ui-widget-content ui-corner-all" id="achat-{achats.idAchat}-produits{achats.achat.id}quantite" maxlength="12" size="3"/></td><td class="detail-resa-unite">{achats.achat.proUniteMesure}</td><td class="com-text-align-right detail-achat-{achats.idAchat}-prix" id="achat-{achats.idAchat}-{achats.achat.id}-prix">{achats.achat.prix}</td><td class="com-text-align-right detail-achat-{achats.idAchat}-prix ui-helper-hidden"><input type="text" value="{achats.achat.prix}" class="com-numeric produit-prix com-input-text ui-widget-content ui-corner-all" id="achat-{achats.idAchat}-produits{achats.achat.id}prix" maxlength="12" size="3"/></td><td>{sigleMonetaire}</td></tr><!-- END achats.achat --><tr><td class="com-text-align-right" colspan="3">Total : </td><td class="com-text-align-right achat-{achats.idAchat}-total" id="achat-{achats.idAchat}-total-label">{achats.total}</td><td class="com-text-align-right achat-{achats.idAchat}-total ui-helper-hidden"><input type="text" value="{achats.total}" class="com-numeric com-input-text ui-widget-content ui-corner-all" id="achat-{achats.idAchat}-total" maxlength="12" size="3"/></td><td>{sigleMonetaire}</td></tr></table></div><!-- END achats --><!-- BEGIN achatsSolidaire --><div class="achatSolidaire com-widget-window ui-widget ui-widget-content ui-corner-all" id="achat-{achatsSolidaire.idAchat}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat Solidaire <span class="achat-id ui-helper-hidden">{achatsSolidaire.idAchat}</span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all modif-achat-{achatsSolidaire.idAchat}" id="btn-supp-achat-{achatsSolidaire.idAchat}" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all modif-achat-{achatsSolidaire.idAchat}" id="btn-modif-achat-{achatsSolidaire.idAchat}" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all ui-helper-hidden modif-achat-{achatsSolidaire.idAchat}" id="btn-annuler-achat-{achatsSolidaire.idAchat}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all ui-helper-hidden modif-achat-{achatsSolidaire.idAchat}" id="btn-check-achat-{achatsSolidaire.idAchat}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></div><table><!-- BEGIN achatsSolidaire.achat --><tr class="ligne-produit-achat-{achatsSolidaire.idAchat}"><td class="detail-resa-npro"><span class="ui-helper-hidden produit-id">{achatsSolidaire.achat.id}</span>{achatsSolidaire.achat.nproNom}</td><td class="com-text-align-right detail-achat-{achatsSolidaire.idAchat}-qte" id="achat-{achatsSolidaire.idAchat}-{achatsSolidaire.achat.id}-quantite">{achatsSolidaire.achat.stoQuantite}</td><td class="com-text-align-right detail-achat-{achatsSolidaire.idAchat}-qte ui-helper-hidden"><input type="text" value="{achatsSolidaire.achat.stoQuantite}" class="com-numeric produit-quantite com-input-text ui-widget-content ui-corner-all" id="achat-{achatsSolidaire.idAchat}-produits{achatsSolidaire.achat.id}quantite" maxlength="12" size="3"/></td><td class="detail-resa-unite">{achatsSolidaire.achat.proUniteMesure}</td><td class="com-text-align-right detail-achat-{achatsSolidaire.idAchat}-prix" id="achat-{achatsSolidaire.idAchat}-{achatsSolidaire.achat.id}-prix">{achatsSolidaire.achat.prix}</td><td class="com-text-align-right detail-achat-{achatsSolidaire.idAchat}-prix ui-helper-hidden"><input type="text" value="{achatsSolidaire.achat.prix}" class="com-numeric produit-prix com-input-text ui-widget-content ui-corner-all" id="achat-{achatsSolidaire.idAchat}-produits{achatsSolidaire.achat.id}prix" maxlength="12" size="3"/></td><td>{sigleMonetaire}</td></tr><!-- END achatsSolidaire.achat --><tr><td class="com-text-align-right" colspan="3">Total : </td><td class="com-text-align-right achat-{achatsSolidaire.idAchat}-total" id="achat-{achatsSolidaire.idAchat}-total-label">{achatsSolidaire.totalSolidaire}</td><td class="com-text-align-right achat-{achatsSolidaire.idAchat}-total ui-helper-hidden"><input type="text" value="{achatsSolidaire.totalSolidaire}" class="com-numeric com-input-text ui-widget-content ui-corner-all" id="achat-{achatsSolidaire.idAchat}-total" maxlength="12" size="3"/></td><td>{sigleMonetaire}</td></tr></table></div><!-- END achatsSolidaire --></div>';this.supprimerReservationDialog='<div id="dialog-supprimer-reservation" title="Supprimer la réservation"><p>Voulez-vous supprimer la réservation ?</p></div>';this.dialogSupprimerAchat='<div title="Supprimer la réservation"><p>Voulez-vous supprimer cet achat ?</p></div>';this.detailReservation='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="btn-annuler"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour au Marché</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div><div>Fin des réservations : Le {dateFinReservation} à {heureFinReservation}H{minuteFinReservation} <br/>Marché : Le {dateMarcheDebut} de {heureMarcheDebut}H{minuteMarcheDebut} à {heureMarcheFin}H{minuteMarcheFin}</div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Adhérent</div><div class="com-widget-content"><div id="resa-info-commande">{adhNumero} :  {adhPrenom} {adhNom}<br/>N° de Compte : {adhCompte}</div><div><span>Solde Actuel : </span><span>{adhSolde} {sigleMonetaire}</span></div><div class="com-clear-float-left"></div></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">La réservation</div><table><!-- BEGIN categories --><td class="ui-widget-header ui-corner-all com-center">{categories.nom}</td><td colspan="4"></td><!-- BEGIN categories.produits --><tr ><td class="detail-resa-npro">{categories.produits.nproNom}</td><td class="com-text-align-right detail-resa-qte">{categories.produits.stoQuantite}</td><td class="detail-resa-unite">{categories.produits.proUniteMesure}</td><td class="com-text-align-right detail-resa-prix">{categories.produits.prix}</td><td>{sigleMonetaire}</td></tr><!-- END categories.produits --><!-- END categories --><tr><td class="com-text-align-right" colspan="3">Total : </td><td class="com-text-align-right">{total}</td><td>{sigleMonetaire}</td></tr></table></div><div class="boutons-edition com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button class="com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center" id="btn-modifier">Modifier</button><button class="ui-state-default ui-corner-all com-button com-center" id="btn-supprimer">Supprimer</button></div></div>';this.modifierReservation='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div><div>Fin des réservations : Le {dateFinReservation} à {heureFinReservation}H{minuteFinReservation} <br/>Marché : Le {dateMarcheDebut} de {heureMarcheDebut}H{minuteMarcheDebut} à {heureMarcheFin}H{minuteMarcheFin}</div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Adhérent</div><div class="com-widget-content"><div id="resa-info-commande">{adhNumero} :  {adhPrenom} {adhNom}<br/>N° de Compte : {adhCompte}</div><div><span>Solde Actuel : </span><span>{adhSolde} {sigleMonetaire}</span><br/><span>Nouveau Solde : </span><span id="nouveau-solde">{adhNouveauSolde}</span> <span id="nouveau-solde-sigle">{sigleMonetaire}</span></div></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">La réservation</div><div><table><!-- BEGIN categories --><tr><td colspan="3" class="ui-widget-header ui-corner-all com-center">{categories.nom}</td><td colspan="6"></td></tr><!-- BEGIN categories.produits --><tr class="pdt"><td><input type="checkbox" {categories.produits.checked}/></td><td><span class="ui-helper-hidden"><span class="pdt-id">{categories.produits.proId}</span></span></td><td>{categories.produits.nproNom}</td><td><select id="lot-{categories.produits.proId}"><!-- BEGIN categories.produits.lot --><option value="{categories.produits.lot.dcomId}">par {categories.produits.lot.dcomTaille} {categories.produits.proUniteMesure}</option><!-- END categories.produits.lot --></select></td><td>à <span id="prix-unitaire-{categories.produits.proId}">{categories.produits.prixUnitaire}</span> {sigleMonetaire}/{categories.produits.proUniteMesure}</td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><button class="btn-moins">-</button></td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><span id="qte-pdt-{categories.produits.proId}"></span> {categories.produits.proUniteMesure}</td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><button class="btn-plus">+</button></td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId} com-text-align-right"><span id="prix-pdt-{categories.produits.proId}"></span> {sigleMonetaire}</td></tr><!-- END categories.produits --><!-- END categories --><tr><td colspan="8" class="com-text-align-right">Total : </td><td class="com-text-align-right detail-resa-prix"><span id="total">{total}</span></td><td>{sigleMonetaire}</td></tr></table></div></div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button class="com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center" id="btn-annuler">Annuler</button><button class="ui-state-default ui-corner-all com-button com-center" id="btn-valider">Valider</button></div></div>';this.listeCommandeVide='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-marche-archive"><span class="com-float-left">Les Marchés cloturés</span><span class="com-float-left ui-icon ui-icon-arrowthick-1-e"></span></button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés en cours</div><p id="texte-liste-vide">Aucun Marché en cours.</p></div></div>';this.listeCommandeArchiveVide='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-marche-encours"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Les Marchés en cours</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés en cloturés</div><p id="texte-liste-vide">Aucun Marché cloturé.</p></div></div>';this.listeMarcheVide='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Vente</div><p id="texte-liste-vide">Aucune adhérent.</p></div></div>';this.listeReservationVide='<p id="texte-liste-vide">Aucune réservation.</p>';this.dialogEnregistrement='<div title="Enregistrer les modifications"><p>Vous n\'avez pas enregistré vos modifications.</p></div>';this.dialogExportBonDeCommande='<div id="dialog-export-bon-commande" title="Export du Bon de Commande du Marché n°{comNumero}"><form><table><tr><td>Format de sortie : </td><td><input type="radio" name="format" value="0" checked="checked" />Pdf</td><td><input type="radio" name="format" value="1" />CSV</td></tr></table></form></div>';this.bonDeCommande='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="btn-editer-com"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour au Marché</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Bon de commande du Marché n°{comNumero}<span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all" id="btn-export-bcom" title="Exporter le bon de commande"><span class="ui-icon ui-icon-print"></span></span></div><div><form><span>Producteur : <select id="select-prdt"><option value="0" >== Choisir un producteur ==</option><!-- BEGIN producteurs --><option value="{producteurs.proIdCompteFerme}">{producteurs.ferNom}</option><!-- END producteurs --></select></span></form></div><div id="liste-pdt"></div></div></div>';this.listeProduitVide='<div id="liste-pdt"></div>';this.listeProduitBonDeCommande='<div id="liste-pdt"><table class="com-table"><thead><tr><th>Produit</th><th>Réservation</th><th>Commande</th><th>Prix</th><th>État</th></tr></thead><tbody><!-- BEGIN produits --><tr><td>{produits.nproNom}</td><td>{produits.stoQuantite} {produits.proUniteMesure}</td><td><span class="pro-id ui-helper-hidden">{produits.proId}</span><input class="qte-commande com-numeric com-input-text ui-widget-content ui-corner-all" type="text" name="qte-commande-{produits.proId}" maxlength="11" value="{produits.stoQuantiteCommande}" id="produits{produits.proId}quantite"/> {produits.proUniteMesure}</td><td><input class="prix-commande com-numeric com-input-text ui-widget-content ui-corner-all" type="text" name="prix-commande-{produits.proId}" maxlength="11" value="{produits.dopeMontant}" id="produits{produits.proId}prix" /> {sigleMonetaire}</td><td><div id="etat-commande-{produits.proId}" class="{produits.classEtat} ui-corner-all"></div></td></tr><!-- END produits --></tbody></table><div class="com-center"><button class="ui-state-default ui-corner-all com-button" id="btn-enregistrer">Enregistrer</button></div></div>';this.dialogExportBonDeLivraison='<div id="dialog-export-livraison" title="Export du bon de livraison du Marché n°{comNumero}"><form><table><tr><td>Format de sortie : </td><td><input type="radio" name="format" value="0" checked="checked" />Pdf</td><td><input type="radio" name="format" value="1" />CSV</td></tr></table></form></div>';this.bonDeLivraison='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="btn-editer-com"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour au Marché</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Bon de Livraison du Marché n°{comNumero}<span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all" id="btn-export-bcom" title="Exporter le bon de livraison"><span class="ui-icon ui-icon-print"></span></span></div><div><form><span>Producteur : <select id="select-prdt"><option value="0" >== Choisir un producteur ==</option><!-- BEGIN producteurs --><option value="{producteurs.proIdCompteFerme}">{producteurs.ferNom}</option><!-- END producteurs --></select></span></form></div><div id="liste-pdt"></div></div></div>';this.listeProduitLivraison='<div id="liste-pdt"><table class="com-table"><thead><tr><th>Produit</th><th>Réservation</th><th>Commande</th><th>Prix</th><th>Livraison</th><th>Prix</th><th>Solidaire</th><th>État</th></tr></thead><tbody><!-- BEGIN produits --><tr><td>{produits.nproNom}</td><td>{produits.stoQuantite} {produits.proUniteMesure}</td><td>{produits.stoQuantiteCommande} {produits.proUniteMesure}</td><td>{produits.opeMontantCommande} {sigleMonetaire}</td><td><span class="pro-id pro-id-etat ui-helper-hidden">{produits.proId}</span><input class="input-bon-livraison qte-commande com-numeric com-input-text ui-widget-content ui-corner-all" type="text" name="qte-commande-{produits.proId}" maxlength="11" value="{produits.stoQuantiteLivraison}" id="produits{produits.proId}quantite"/> {produits.proUniteMesure}</td><td><input class="input-bon-livraison prix-commande com-numeric com-input-text ui-widget-content ui-corner-all" type="text" name="prix-commande-{produits.proId}" maxlength="11" value="{produits.opeMontantLivraison}" id="produits{produits.proId}prix" /> {sigleMonetaire}</td><td><span class="pro-id-etat ui-helper-hidden">{produits.proId}</span><input class="qte-solidaire-commande input-bon-livraison com-numeric com-input-text ui-widget-content ui-corner-all" type="text" name="qte-solidaire-commande-{produits.proId}" maxlength="11" value="{produits.stoQuantiteSolidaire}" id="produits{produits.proId}quantiteSolidaire" /> {produits.proUniteMesure}</td><td><div id="etat-commande-{produits.proId}" class="{produits.classEtat} ui-corner-all"></div></td></tr><!-- END produits --></tbody><tfoot><tr><td colspan="2"></td><td>Total :</td><td>{totalCommande} {sigleMonetaire}</td><td></td><td><input class="input-bon-livraison com-numeric com-input-text ui-widget-content ui-corner-all" type="text" name="total" maxlength="11" value="{total}" id="total" /> {sigleMonetaire}</td><td><select name="typepaiement" id="typePaiement"><option value="0">== Choisir le paiement ==</option><!-- BEGIN typePaiement --><option value="{typePaiement.tppId}">{typePaiement.tppType}</option><!-- END typePaiement --></select></td></tr><tr id="tr-champ-complementaire"><td colspan="5"></td><td><span id="label-champ-complementaire" ></span></td><td><input type="text" name="champ-complementaire" value="{champComplementaire}" class="com-input-text ui-widget-content ui-corner-all" id="typePaiementChampComplementaire" maxlength="50" size="15"/></td></tr></tfoot></table><div class="com-center"><button class="ui-state-default ui-corner-all com-button" id="btn-enregistrer">Enregistrer</button></div></div>';this.infoCommandeArchive='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Détail du Marché n°{numero}<span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-dupliquer-com" title="Dupliquer le marché"><span class="ui-icon ui-icon-copy"></span></span></div><div><div class="com-center" id="resultat-marche-archive"><span class="ui-widget ui-widget-header com-table-th">Résultat Zeybu Marché : {total} {sigleMonetaire}</span>    <span class="ui-widget ui-widget-header com-table-th">Résultat Zeybu Solidaire : {totalSolidaire} {sigleMonetaire}</span></div><table class="com-table" id="info-marche-archive"><thead><tr><th></th><th class="com-table-th ui-widget ui-widget-header" colspan="5">Achat</th><th class="com-table-th ui-widget ui-widget-header" colspan="4">Vente</th></tr><tr class="ui-widget ui-widget-header"><th class="com-table-th">Produit</th><th class="com-table-th">Qté Commande</th><th class="com-table-th">Prix Commande</th><th class="com-table-th">Qté Livraison</th><th class="com-table-th">Prix Livraison</th><th class="com-table-th">Qté Solidaire</th><th class="com-table-th">Qté Vente</th><th class="com-table-th">Prix Vente</th><th class="com-table-th">Qté Solidaire</th><th class="com-table-th">Prix Solidaire</th></tr></thead><tbody><!-- BEGIN infoCommande --><tr><td class="com-table-td">{infoCommande.nproNom}</td><td class="com-table-td">{infoCommande.stoQuantite} {infoCommande.proUniteMesure}</td><td class="com-table-td">{infoCommande.opeMontant} {sigleMonetaire}</td><td class="com-table-td">{infoCommande.stoQuantiteLivraison} {infoCommande.proUniteMesure}</td><td class="com-table-td">{infoCommande.opeMontantLivraison} {sigleMonetaire}</td><td class="com-table-td">{infoCommande.stoQuantiteSolidaire} {infoCommande.proUniteMesure}</td><td class="com-table-td">{infoCommande.stoQuantiteVente} {infoCommande.proUniteMesure}</td><td class="com-table-td">{infoCommande.opeMontantVente} {sigleMonetaire}</td><td class="com-table-td">{infoCommande.stoQuantiteVenteSolidaire} {infoCommande.proUniteMesure}</td><td class="com-table-td">{infoCommande.opeMontantVenteSolidaire} {sigleMonetaire}</td></tr><!-- END infoCommande --></tbody></table></div></div></div>';this.produitIndisponible="<tr>Le produit {nom} n'est plus disponible.</tr>";this.lotUnique='<input type="hidden" id="lot-{IdPdt}" value="{valeur}" /><span>{text}</span>';this.editerMarcheListeProduit='<div id="liste-ferme"><!-- BEGIN fermes --><div class="com-widget-window ui-widget ui-widget-content ui-corner-all" id="ferme-{fermes.ferId}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">{fermes.ferNom}</div><!-- BEGIN fermes.categories --><table class="com-table"><tr class="ui-widget-header" ><td class="com-table-td-debut">{fermes.categories.cproNom}</td><td class="com-table-td-med"></td><td class="com-table-td-med"></td><td class="com-table-td-fin"></td></tr><!-- BEGIN fermes.categories.produits --><tr><td class="com-table-td-debut">{fermes.categories.produits.nproNom}</td><td class="com-table-td-med edt-marche-pro-unite">{fermes.categories.produits.qteReservation} {fermes.categories.produits.nproUnite}</td><td class="com-table-td-med td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-produit" title="Modifier" id-produit="{fermes.categories.produits.id}"><span class="ui-icon ui-icon-pencil"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-produit" title="Supprimer" id-produit="{fermes.categories.produits.id}" qte-reservation="{fermes.categories.produits.qteReservation}"><span class="ui-icon ui-icon-trash"></span></span></td></tr><!-- END fermes.categories.produits --></table><!-- END fermes.categories --></div><!-- END fermes --></div>';this.dialogModifierInfoMarche='<div id="dialog-modif-pro" title="Produit"><div class="com-widget-content"><form id="formulaire-information-creation-commande"><table class="com-table-form"><tr><th class="com-table-form-th">Nom du Marché : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="nom" id="marche-nom" maxlength="100" value="{nom}"/></td></tr><tr><th class="com-table-form-th">Début des Réservations * : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="date-debut-reservation" id="marche-dateDebutReservation" value="{dateDebutReservation}"/></td><td class="com-table-form-td">à <select name="heure-debut-reservation" id="marche-timeDebutReservation" class="informations-marche" ><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><select name="minute-debut-reservation" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td></tr><tr><th class="com-table-form-th">Fin des Réservations * : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="date-fin-reservation" id="marche-dateFinReservation" value="{dateFinReservation}"/></td><td class="com-table-form-td">à <select name="heure-fin-reservation" id="marche-timeFinReservation" class="informations-marche" ><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><select name="minute-fin-reservation" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td></tr><tr><th class="com-table-form-th">Jour du marché * : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all informations-marche" type="text" name="date-debut" id="marche-dateMarcheDebut" value="{dateMarcheDebut}"/></td><td class="com-table-form-td">de <select name="heure-debut" id="marche-timeMarcheDebut" class="informations-marche"><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><select name="minute-debut" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td><td class="com-table-form-td">à <select name="heure-fin" id="marche-timeMarcheFin" class="informations-marche"><option value="00">00</option><option value="01">01</option><option value="02">02</option><option value="03">03</option><option value="04">04</option><option value="05">05</option><option value="06">06</option><option value="07">07</option><option value="08">08</option><option value="09">09</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option></select><select name="minute-fin" class="informations-marche"><option value="00">00</option><option value="05">05</option><option value="10">10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="35">35</option><option value="40">40</option><option value="45">45</option><option value="50">50</option><option value="55">55</option></select></td></tr><tr><th class="com-table-form-th">Description : </th><td class="com-table-form-td"><textarea class="com-input-text ui-widget-content ui-corner-all informations-marche" name="description" id="marche-description" >{comDescription}</textarea></td></tr></table></form></div></div>';this.dialogSupprimerProduit='<div id="dialog-supprimer-produit" title="Supprimer le produit du marché"><p>Des réservations sont présentes sur ce produit.<br/>Voulez-vous toujours le supprimer ?</p></div>'}function GestionListeCommandeVue(a){this.construct=function(b){$.history({vue:function(){GestionListeCommandeVue(b)}});var c=this;$.post("./index.php?m=GestionCommande&v=ListeCommande",function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(d){var c=this;var b=new GestionCommandeTemplate();if(d.listeCommande.length>0&&d.listeCommande[0].comId!=null){var e=new Object;e.commande=new Array();$(d.listeCommande).each(function(){var g=new Object();g.id=this.comId;g.numero=this.comNumero;g.dateFinReservation=this.comDateFinReservation.extractDbDate().dateDbToFr();g.heureFinReservation=this.comDateFinReservation.extractDbHeure();g.minuteFinReservation=this.comDateFinReservation.extractDbMinute();g.dateMarcheDebut=this.comDateMarcheDebut.extractDbDate().dateDbToFr();g.heureMarcheDebut=this.comDateMarcheDebut.extractDbHeure();g.minuteMarcheDebut=this.comDateMarcheDebut.extractDbMinute();g.heureMarcheFin=this.comDateMarcheFin.extractDbHeure();g.minuteMarcheFin=this.comDateMarcheFin.extractDbMinute();e.commande.push(g)});var f=b.listeCommandePage;$("#contenu").replaceWith(c.affect($(f.template(e))))}else{$("#contenu").replaceWith(c.affect($(b.listeCommandeVide)))}};this.affect=function(b){b=this.affectLienEditer(b);b=this.affectLienMarche(b);b=gCommunVue.comHoverBtn(b);b=this.affectLienListeCommandeArchive(b);b=this.affectNouveauMarche(b);return b};this.affectNouveauMarche=function(b){b.find("#btn-nv-marche").click(function(){AjoutCommandeVue()});return b};this.affectLienEditer=function(b){b.find(".btn-editer").click(function(){var c={id_commande:$(this).attr("id")};EditerCommandeVue(c)});return b};this.affectLienMarche=function(b){b.find(".btn-marche").click(function(){var c={id_commande:$(this).attr("id")};MarcheCommandeVue(c)});return b};this.affectLienListeCommandeArchive=function(b){b.find("#lien-marche-archive").click(function(){ListeCommandeArchiveVue()});return b};this.construct(a)}function AjoutCommandeVue(a){this.mListeFerme={};this.mProduits=[];this.mMarche=new MarcheVO();this.mAffichageMarche=[];this.mNbProduit=0;this.mEditionLot=false;this.mIdLot=0;this.mEtapeCreationMarche=0;this.construct=function(b){$.history({vue:function(){AjoutCommandeVue(b)}});var d=$.extend(d,b);d.fonction="afficher";var c=this;$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(e)}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(c){var d=this;this.mListeFerme=c.listeFerme;var b=new GestionCommandeTemplate();var e=b.formulaireAjoutMarche;$("#contenu").replaceWith(d.affect($(e.template(c))))};this.affect=function(b){b=this.affectDialogAjoutProduit(b);b=this.affectControleDatepicker(b);b=gCommunVue.comNumeric(b);b=gCommunVue.comHoverBtn(b);return b};this.affectDialogAjoutProduit=function(b){var c=this;b.find("#btn-ajout-produit").click(function(){var d=new GestionCommandeTemplate();var e=d.dialogAjoutProduitAjoutMarche;$(c.affectAjoutProduitSelectFerme($(e.template({listeFerme:c.mListeFerme})))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Ajouter:function(){c.ajouterProduit($(this))},Annuler:function(){c.mEditionLot=false;$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}})});return b};this.affectAjoutProduitSelectFerme=function(b){var c=this;b.find("#pro-idFerme select").change(function(){var e=$(this).val();$("#pro-idCategorie select, #pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#prix-stock-produit").replaceWith('<div id="prix-stock-produit"></div>');if(e>0){var d={fonction:"listeProduit",id:e};$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(d),function(j){if(j){if(j.valid){Infobulle.init();if(j.listeProduit.length>0&&j.listeProduit[0].nproId!=null){c.mProduits=[];var h=0;var l=[];$.each(j.listeProduit,function(){if(c.mProduits[this.cproId]){c.mProduits[this.cproId].listeProduit.push(this)}else{c.mProduits[this.cproId]={nom:this.cproNom,listeProduit:[this]}}if(h!=this.cproId){l.push({cproId:this.cproId,cproNom:this.cproNom});h=this.cproId}});var f=new GestionCommandeTemplate();var k=f.ajoutProduitSelectCategorie;$("#pro-idCategorie").replaceWith(c.affectAjoutProduitSelectCategorie($(k.template({listeCategorie:l}))))}else{var m=new TemplateVR();m.valid=false;m.log.valid=false;var g=new VRerreur();g.code=ERR_332_CODE;g.message=ERR_332_MSG;m.log.erreurs.push(g);Infobulle.generer(m,"")}}else{Infobulle.generer(j,"")}}},"json")}});return b};this.affectAjoutProduitSelectCategorie=function(b){var c=this;b.find("select").change(function(){var f=$(this).val();$("#pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#prix-stock-produit").replaceWith('<div id="prix-stock-produit"></div>');if(f>0){var d=new GestionCommandeTemplate();var e=d.ajoutProduitSelectProduit;$("#pro-idProduit").replaceWith(c.affectAjoutProduitSelectProduit($(e.template(c.mProduits[f]))))}});return b};this.affectAjoutProduitSelectProduit=function(b){var c=this;b.find("select").change(function(){var g=$(this).val();if(g>0){if(!c.mMarche.produits[g]){var e={fonction:"listeModeleLot",idNomProduit:g};$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(e),function(k){if(k){if(k.valid){Infobulle.init();var j={sigleMonetaire:gSigleMonetaire};if(k.modelesLot.length>0&&k.modelesLot[0].mLotId!=null){j.modelesLot=[];$(k.modelesLot).each(function(){if(this.mLotId!=null){this.id=this.mLotId;this.quantite=this.mLotQuantite.nombreFormate(2,","," ");this.unite=this.mLotUnite;this.prix=this.mLotPrix.nombreFormate(2,","," ");this.sigleMonetaire=gSigleMonetaire;j.modelesLot.push(this);j.unite=this.mLotUnite}})}var h=new GestionCommandeTemplate();var l=h.prixEtStockAjoutProduit;$("#prix-stock-produit").replaceWith(c.affectPrixEtStock($(l.template(j))))}else{Infobulle.generer(k,"")}}},"json")}else{var f=new Object();var d=new VRerreur();d.code=ERR_211_CODE;d.message=ERR_211_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(d);Infobulle.generer(f,"")}}else{$("#prix-stock-produit").replaceWith($('<div id="prix-stock-produit">'))}});return b};this.affectPrixEtStock=function(b){b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);b=this.affectAjoutLotGestion(b);b=this.affectAjoutLot(b);b=this.affectLimiteStock(b);return b};this.affectLimiteStock=function(b){b.find(":input[name=pro-stock-choix]").change(function(){if($(":input[name=pro-stock-choix]:checked").val()==1){$(":input[name=pro-stock]").attr("disabled","").val("")}else{$(":input[name=pro-stock]").attr("disabled","disabled").val("")}});b.find(":input[name=pro-qte-max-choix]").change(function(){if($(":input[name=pro-qte-max-choix]:checked").val()==1){$(":input[name=pro-qte-max]").attr("disabled","").val("")}else{$(":input[name=pro-qte-max]").attr("disabled","disabled").val("")}});return b};this.affectAjoutLot=function(b){var c=this;b.find("#btn-ajout-lot").click(function(){c.ajoutLot()});b.find("#table-pro-prix input").keyup(function(d){if(d.keyCode=="13"){c.ajoutLot()}});return b};this.ajoutLot=function(){var c=new ModeleLotVO();c.quantite=$(":input[name=lot-quantite]").val().numberFrToDb();c.unite=$(":input[name=lot-unite]").val();c.prix=$(":input[name=lot-prix]").val().numberFrToDb();var d=new ModeleLotValid();var f=d.validAjout(c);if(f.valid){Infobulle.init();var b=new GestionCommandeTemplate();var e=b.modeleLot;this.mIdLot--;c.id=this.mIdLot;c.sigleMonetaire=gSigleMonetaire;c.quantite=c.quantite.nombreFormate(2,","," ");c.prix=c.prix.nombreFormate(2,","," ");$("#lot-liste").append(this.affectLot($(e.template(c))));$(":input[name=lot-quantite], :input[name=lot-unite], :input[name=lot-prix]").val("")}else{Infobulle.generer(f,"pro-lot-")}};this.affectLot=function(b){b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);b=this.affectAjoutLotGestion(b);return b};this.affectAjoutLotGestion=function(b){var c=this;b.find(".btn-modifier-lot").click(function(){c.ajoutLotModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-valider-lot").click(function(){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())});b.find(".catalogue-input-lot").keyup(function(d){if(d.keyCode=="13"){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())}});b.find(".btn-annuler-lot").click(function(){c.ajoutLotAnnulerModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-supprimer-lot").click(function(){c.ajoutLotSupprimer($(this).closest("tr").find("#id-lot").text())});b.find(":checkbox").change(function(){if(!c.majUnite()){if($(this).attr("checked")){$(this).removeAttr("checked")}else{$(this).attr("checked","checked")}}});return b};this.majUnite=function(){var d=true;var c=0;var e="";$(".ligne-lot :checkbox:checked").each(function(){var g=$(this).closest(".ligne-lot").find(".lot-unite").text();if(e!=""&&e!=g){d=false}else{e=g}c++});if(d){if(c>0){$(".unite-stock").text(e)}}else{var f=new Object();var b=new VRerreur();b.code=ERR_333_CODE;b.message=ERR_333_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(b);Infobulle.generer(f,"")}return d};this.ajoutLotModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();$("#pro-lot-"+b+"-quantite").val($("#lot-"+b+"-quantite").text());$("#pro-lot-"+b+"-unite").val($("#lot-"+b+"-unite").text());$("#pro-lot-"+b+"-prix").val($("#lot-"+b+"-prix").text());this.mEditionLot=true};this.ajoutLotValiderModification=function(c){var b=new ModeleLotVO();b.quantite=$("#pro-lot-"+c+"-quantite").val().numberFrToDb();b.unite=$("#pro-lot-"+c+"-unite").val();b.prix=$("#pro-lot-"+c+"-prix").val().numberFrToDb();var d=new ModeleLotValid();var e=d.validAjout(b);if(e.valid){Infobulle.init();$("#lot-"+c+"-quantite").text(b.quantite.nombreFormate(2,","," "));$("#lot-"+c+"-unite").text(b.unite);$("#lot-"+c+"-prix").text(b.prix.nombreFormate(2,","," "));$(".btn-lot, #btn-annuler-lot-"+c+", #btn-valider-lot-"+c+", .champ-lot-"+c).toggle();this.mEditionLot=false;this.majUnite()}else{Infobulle.generer(e,"pro-lot-"+c+"-")}};this.ajoutLotAnnulerModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();this.mEditionLot=false};this.ajoutLotSupprimer=function(b){$("#ligne-lot-"+b).remove()};this.ajouterProduit=function(h){var f=this;if(!this.mEditionLot){var o=h.find(":input[name=ferme]").val();var m=h.find(":input[name=categorie]").val();var e=h.find(":input[name=produit]").val();if(e!=0){var l=h.find(":input[name=pro-stock]").val().numberFrToDb();if(h.find(":input[name=pro-stock-choix]:checked").val()==1&&l==""){var p=new Object();var j=new VRerreur();j.code=ERR_201_CODE;j.message=ERR_201_MSG;p.valid=false;p.qteRestante=new VRelement();p.qteRestante.valid=false;p.qteRestante.erreurs.push(j);Infobulle.generer(p,"pro-")}else{var k=h.find(":input[name=pro-qte-max]").val().numberFrToDb();if(h.find(":input[name=pro-qte-max-choix]:checked").val()==1&&k==""){var p=new Object();var j=new VRerreur();j.code=ERR_201_CODE;j.message=ERR_201_MSG;p.valid=false;p.qteMaxCommande=new VRelement();p.qteMaxCommande.valid=false;p.qteMaxCommande.erreurs.push(j);Infobulle.generer(p,"pro-")}else{var b=h.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();var d={nproId:e,nproNom:h.find(":input[name=produit] option:selected").text(),nproStock:l,nproQteMax:k,nproUnite:b,modelesLot:[]};h.find(".ligne-lot :checkbox").each(function(){var q=false;if($(this).hasClass("modele-lot")){q=true}var s=false;if($(this).attr("checked")){s=true}if(q||s){var r=$(this).closest(".ligne-lot").find(".lot-id").text();var t={id:r,taille:$(this).closest(".ligne-lot").find(".lot-quantite").text(),prix:$(this).closest(".ligne-lot").find(".lot-prix").text(),unite:$(this).closest(".ligne-lot").find(".lot-unite").text(),selected:s,modele:q};d.modelesLot[r]=t}});if(!this.mAffichageMarche[o]){this.mAffichageMarche[o]={ferId:o,ferNom:h.find(":input[name=ferme] option:selected").text(),categories:[]}}if(!this.mAffichageMarche[o].categories[m]){this.mAffichageMarche[o].categories[m]={cproId:m,cproNom:h.find(":input[name=categorie] option:selected").text(),produits:[]}}var c=new ProduitMarcheVO();c.idNom=e;c.unite=b;c.qteMaxCommande=k;c.qteRestante=l;h.find(".ligne-lot :checkbox:checked").each(function(){var q=new DetailCommandeVO();q.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();q.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(q)});c.idFerme=o;c.idCategorie=m;var n=new ProduitMarcheValid();var g=n.validAjout(c);if(g.valid){Infobulle.init();this.mAffichageMarche[o].categories[m].produits[e]=d;this.mMarche.produits[e]=c;this.mNbProduit++;f.majListeFerme();h.dialog("close")}else{Infobulle.generer(g,"pro-")}}}}}else{var p=new Object();var j=new VRerreur();j.code=ERR_112_CODE;j.message=ERR_112_MSG;p.valid=false;p.log=new VRelement();p.log.valid=false;p.log.erreurs.push(j);Infobulle.generer(p,"")}};this.majListeFerme=function(){var d=this;var e=[];$(d.mAffichageMarche).each(function(){if(this.ferId){var g=[];$(this.categories).each(function(){if(this.cproId){var h=[];$(this.produits).each(function(){if(this.nproId){h.push([this.nproNom,this.nproId])}});h.sort(sortABC);g.push([this.cproNom,this.cproId,h])}});g.sort(sortABC);e.push([this.ferNom,this.ferId,g])}});e.sort(sortABC);var c={fermes:[]};$(e).each(function(h,l){var m=l[1];var k=l[2];if(d.mAffichageMarche[m]){var j=false;var g={ferId:d.mAffichageMarche[m].ferId,ferNom:d.mAffichageMarche[m].ferNom,categories:[]};$(k).each(function(n,r){var o=r[1];var s=r[2];if(d.mAffichageMarche[m].categories[o]){var q=false;var p={cproId:d.mAffichageMarche[m].categories[o].cproId,cproNom:d.mAffichageMarche[m].categories[o].cproNom,produits:[]};$(s).each(function(t,v){var u=v[1];if(d.mAffichageMarche[m].categories[o].produits[u]){p.produits.push({nproId:d.mAffichageMarche[m].categories[o].produits[u].nproId,nproNom:d.mAffichageMarche[m].categories[o].produits[u].nproNom});j=true;q=true}});if(q){g.categories.push(p)}}});if(j){c.fermes.push(g)}}});var b=new GestionCommandeTemplate();var f=b.ajoutMarcheListeProduit;$("#liste-ferme").replaceWith(this.affectListeProduit($(f.template(c))));if(this.mNbProduit>0){if($("#btn-gestion-marche").length<1){$("#liste-ferme").after(this.affectCeerMarche($(b.btnValiderAjoutMarche)))}}else{$("#btn-gestion-marche").remove()}};this.affectListeProduit=function(b){b=this.affectModifierProduit(b);b=this.affectSupprimerProduit(b);b=gCommunVue.comHoverBtn(b);return b};this.affectModifierProduit=function(b){var c=this;b.find(".btn-modifier-produit").click(function(){c.dialogModifierProduit($(this).attr("id-produit"))});return b};this.dialogModifierProduit=function(g){var f=this;var k=this.mMarche.produits[g].idFerme;var j=this.mMarche.produits[g].idCategorie;var d={ferId:k,ferNom:this.mAffichageMarche[k].ferNom,cproId:j,cproNom:this.mAffichageMarche[k].categories[j].cproNom,nproId:g,nproNom:this.mAffichageMarche[k].categories[j].produits[g].nproNom,nproStock:this.mAffichageMarche[k].categories[j].produits[g].nproStock,nproQteMax:this.mAffichageMarche[k].categories[j].produits[g].nproQteMax,modelesLot:[]};for(i in this.mAffichageMarche[k].categories[j].produits[g].modelesLot){var h=this.mAffichageMarche[k].categories[j].produits[g].modelesLot[i];if(h.id){var e={id:h.id,quantite:h.taille,prix:h.prix,unite:h.unite,sigleMonetaire:gSigleMonetaire};if(h.selected){e.checked='checked="checked"';d.unite=h.unite}else{e.checked=""}if(h.modele){e.modele="modele-lot"}else{e.modele=""}d.modelesLot.push(e)}}if(this.mMarche.produits[g].qteRestante==""){d.nproStockCheckedNoLimit='checked="checked"';d.nproStockDisabled='disabled="disabled"'}else{d.nproStockCheckedLimit='checked="checked"'}if(this.mMarche.produits[g].qteMaxCommande==""){d.nproQteMaxCheckedNoLimit='checked="checked"';d.nproQteMaxDisabled='disabled="disabled"'}else{d.nproQteMaxCheckedLimit='checked="checked"'}var b=new GestionCommandeTemplate();var c=b.dialogModifProduitAjoutMarche;$(f.affectPrixEtStock($(c.template(d)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Modifier:function(){f.modifierProduit($(this))},Annuler:function(){f.mEditionLot=false;$(this).dialog("close")}},close:function(l,m){$(this).remove();Infobulle.init()}})};this.modifierProduit=function(j){var g=this;if(!this.mEditionLot){var q=j.find("#pro-idFerme").attr("id-ferme");var o=j.find("#pro-idCategorie").attr("id-categorie");var e=j.find("#pro-idProduit").attr("id-produit");var n=j.find(":input[name=pro-stock]").val().numberFrToDb();if(j.find(":input[name=pro-stock-choix]:checked").val()==1&&n==""){var r=new Object();var l=new VRerreur();l.code=ERR_201_CODE;l.message=ERR_201_MSG;r.valid=false;r.qteRestante=new VRelement();r.qteRestante.valid=false;r.qteRestante.erreurs.push(l);Infobulle.generer(r,"pro-")}else{var m=j.find(":input[name=pro-qte-max]").val().numberFrToDb();if(j.find(":input[name=pro-qte-max-choix]:checked").val()==1&&m==""){var r=new Object();var l=new VRerreur();l.code=ERR_201_CODE;l.message=ERR_201_MSG;r.valid=false;r.qteMaxCommande=new VRelement();r.qteMaxCommande.valid=false;r.qteMaxCommande.erreurs.push(l);Infobulle.generer(r,"pro-")}else{var b=j.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();var k="";if(n!=""){k=n.nombreFormate(2,","," ")}var f="";if(m!=""){f=m.nombreFormate(2,","," ")}var d={nproId:e,nproNom:this.mAffichageMarche[q].categories[o].produits[e].nproNom,nproStock:k,nproQteMax:f,nproUnite:b,modelesLot:[]};j.find(".ligne-lot :checkbox").each(function(){var s=false;if($(this).hasClass("modele-lot")){s=true}var u=false;if($(this).attr("checked")){u=true}if(s||u){var t=$(this).closest(".ligne-lot").find(".lot-id").text();var v={id:t,taille:$(this).closest(".ligne-lot").find(".lot-quantite").text(),prix:$(this).closest(".ligne-lot").find(".lot-prix").text(),unite:b,selected:u,modele:s};d.modelesLot[t]=v}});var c=new ProduitMarcheVO();c.idNom=e;c.unite=b;c.qteMaxCommande=m;c.qteRestante=n;j.find(".ligne-lot :checkbox:checked").each(function(){var s=new DetailCommandeVO();s.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();s.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(s)});c.idFerme=q;c.idCategorie=o;var p=new ProduitMarcheValid();var h=p.validAjout(c);if(h.valid){Infobulle.init();this.mAffichageMarche[q].categories[o].produits[e]=d;this.mMarche.produits[e]=c;g.majListeFerme();j.dialog("close")}else{Infobulle.generer(h,"pro-")}}}}else{var r=new Object();var l=new VRerreur();l.code=ERR_112_CODE;l.message=ERR_112_MSG;r.valid=false;r.log=new VRelement();r.log.valid=false;r.log.erreurs.push(l);Infobulle.generer(r,"")}};this.affectSupprimerProduit=function(b){var c=this;b.find(".btn-supprimer-produit").click(function(){c.supprimerProduit($(this).attr("id-produit"))});return b};this.supprimerProduit=function(b){var d=this.mMarche.produits[b].idFerme;var c=this.mMarche.produits[b].idCategorie;this.mMarche.produits.splice(b,1,null);this.mAffichageMarche[d].categories[c].produits.splice(b,1,null);this.mNbProduit--;this.majListeFerme()};this.affectCeerMarche=function(b){var c=this;b.find("#btn-creer-marche").click(function(){c.creerMarche()});b.find("#btn-modifier-creation-commande").click(function(){c.editerMarche()});return b};this.creerMarche=function(){var e=this;if(!this.mEditionLot){this.mMarche;this.mMarche.nom=$(":input[name=nom]").val();this.mMarche.description=$(":input[name=description]").val();this.mMarche.dateMarcheDebut=$(":input[name=date-debut]").val().dateFrToDb();this.mMarche.timeMarcheDebut=$(":input[name=heure-debut]").val()+":"+$(":input[name=minute-debut]").val()+":00";this.mMarche.dateMarcheFin=$(":input[name=date-debut]").val().dateFrToDb();this.mMarche.timeMarcheFin=$(":input[name=heure-fin]").val()+":"+$(":input[name=minute-fin]").val()+":00";this.mMarche.dateDebutReservation=$(":input[name=date-debut-reservation]").val().dateFrToDb();this.mMarche.timeDebutReservation=$(":input[name=heure-debut-reservation]").val()+":"+$(":input[name=minute-debut-reservation]").val()+":00";this.mMarche.dateFinReservation=$(":input[name=date-fin-reservation]").val().dateFrToDb();this.mMarche.timeFinReservation=$(":input[name=heure-fin-reservation]").val()+":"+$(":input[name=minute-fin-reservation]").val()+":00";this.mMarche.archive="0";if(this.mEtapeCreationMarche==0){var d=new MarcheValid();var f=d.validAjout(this.mMarche);if(f.valid){this.mEtapeCreationMarche=1;Infobulle.init();$("#nom-marche-span").text(this.mMarche.nom);$("#date-debut-reservation-marche-span").text($(":input[name=date-debut-reservation]").val());$("#time-debut-reservation-marche-span").text($(":input[name=heure-debut-reservation]").val()+"H"+$(":input[name=minute-debut-reservation]").val());$("#date-fin-reservation-marche-span").text($(":input[name=date-fin-reservation]").val());$("#time-fin-reservation-marche-span").text($(":input[name=heure-fin-reservation]").val()+"H"+$(":input[name=minute-fin-reservation]").val());$("#date-debut-marche-span").text($(":input[name=date-debut]").val());$("#time-debut-marche-span").text($(":input[name=heure-debut]").val()+"H"+$(":input[name=minute-debut]").val());$("#time-fin-marche-span").text($(":input[name=heure-fin]").val()+"H"+$(":input[name=minute-fin]").val());$("#description-marche-span").text(this.mMarche.description);$("#btn-ajout-produit-div, .informations-marche, #btn-modifier-creation-commande, .btn-modifier-produit, .btn-supprimer-produit").toggle()}else{Infobulle.generer(f,"marche-")}}else{if(this.mEtapeCreationMarche==1){var g=[];$(this.mMarche.produits).each(function(){if(this.idNom){var h=[];$(this.lots).each(function(){if(this.taille){h.push(this)}});this.lots=h;g.push(this)}});this.mMarche.produits=g;var c=this.mMarche;c.fonction="ajouter";$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(c),function(j){if(j){if(j.valid){var k=new Object();var h=new VRerreur();h.code=ERR_334_CODE;h.message=ERR_334_MSG;k.valid=false;k.log=new VRelement();k.log.valid=false;k.log.erreurs.push(h);EditerCommandeVue({id_commande:j.id,vr:k})}else{e.editerMarche();Infobulle.generer(j,"marche-")}}},"json")}}}else{var f=new Object();var b=new VRerreur();b.code=ERR_112_CODE;b.message=ERR_112_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(b);Infobulle.generer(f,"")}};this.editerMarche=function(){this.mEtapeCreationMarche=0;$("#btn-ajout-produit-div, .informations-marche, #btn-modifier-creation-commande, .btn-modifier-produit, .btn-supprimer-produit").toggle()};this.affectControleDatepicker=function(b){b=gCommunVue.lienDatepickerMarche("marche-dateDebutReservation","marche-dateFinReservation","marche-dateMarcheDebut",b);b.find("#marche-dateDebutReservation").datepicker("setDate",getDateAujourdhuiDb().dateDbToFr());b.find("#marche-dateFinReservation").datepicker("option","minDate",new Date());b.find("#marche-dateMarcheDebut").datepicker("option","minDate",new Date());return b};this.construct(a)}function AchatCommandeVue(a){this.idCommande=null;this.idAdherent=null;this.idCompte=null;this.mListeLot=[];this.mTypePaiement=[];this.solde=null;this.mCommunVue=new CommunVue();this.etapeValider=0;this.total=0;this.totalSolidaire=0;this.pdtCommande=[];this.construct=function(b){$.history({vue:function(){AchatCommandeVue(b)}});var c=this;this.idCommande=b.id_commande;this.idAdherent=b.id_adherent;if(this.idAdherent==0){c.idCompte=-3;b.fonction="infoMarche";$.post("./index.php?m=GestionCommande&v=MarcheCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.pdtCommande=d.marche.produits;$(d.typePaiement).each(function(){c.mTypePaiement[this.tppId]=this});c.solde=0;c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")}else{b.fonction="infoAchat";$.post("./index.php?m=GestionCommande&v=MarcheCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.idCompte=d.adherent.adhIdCompte;c.pdtCommande=d.marche.produits;$(d.typePaiement).each(function(){c.mTypePaiement[this.tppId]=this});c.solde=parseFloat(d.adherent.cptSolde);c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")}};this.afficher=function(d){Infobulle.init();if(d.valid){var e=this;var b=new GestionCommandeTemplate();var f=b.achatCommandePage;var c=new Object();c.comNumero=d.marche.numero;if(this.idAdherent!=0){c.adhNumero=d.adherent.adhNumero;c.adhCompte=d.adherent.cptLabel;c.adhNom=d.adherent.adhNom;c.adhPrenom=d.adherent.adhPrenom}else{c.adhNumero="ZZ";c.adhCompte="CC";c.adhNom="Invité"}c.sigleMonetaire=gSigleMonetaire;c.total=0;c.categories=[];c.categoriesSolidaire=[];$.each(e.pdtCommande,function(){if(this.id){var g=this;var j={};j.proId=this.id;j.nproNom=this.nom;j.proUniteMesure=this.unite;j.stoQuantite=0;j.proPrix=0;j.lot=[];var h=0;$.each(this.lots,function(){if(this.id){var k={};k.dcomId=this.id;k.dcomTaille=parseFloat(this.taille).nombreFormate(2,","," ");k.dcomPrix=parseFloat(this.prix).nombreFormate(2,","," ");h=parseFloat(this.prix);lStoQuantite=parseFloat(this.taille);$(d.reservation).each(function(){if(this.idDetailCommande==k.dcomId){j.stoQuantite=this.quantite*-1;h=this.montant*-1;j.proPrix=h.nombreFormate(2,","," ");k.prixReservation=h;e.mListeLot.push({idPdt:j.proId,idLot:k.dcomId})}});j.prixUnitaire=(h/lStoQuantite).nombreFormate(2,","," ");j.lot.push(k)}});c.total+=h;if(!c.categories[this.idCategorie]){c.categories[this.idCategorie]={nom:this.cproNom,produits:[]}}c.categories[this.idCategorie].produits.push(j);$(d.stockSolidaire).each(function(){if(j.proId==this.proId){if(!c.categoriesSolidaire[g.idCategorie]){c.categoriesSolidaire[g.idCategorie]={nom:g.cproNom,produits:[]}}c.categoriesSolidaire[g.idCategorie].produits.push(j)}})}});c.typePaiement=e.mTypePaiement;c.adhSolde=this.solde;c.adhSolde=c.adhSolde.nombreFormate(2,","," ");if(this.idAdherent!=0){c.total=c.total.nombreFormate(2,","," ");e.total=c.total}else{c.total="0".nombreFormate(2,","," ")}$("#contenu").replaceWith(e.affect($(f.template(c))));e.changerTypePaiement($(":input[name=typepaiement]"));e.majNouveauSolde()}else{Infobulle.generer(d,"")}};this.affect=function(b){b=this.affectSelectTypePaiement(b);b=this.affectNouveauSolde(b);b=this.mCommunVue.comNumeric(b);b=this.affectNouveauPrixProduit(b);b=this.affectChampComplementaire(b);b=this.affectValider(b);b=this.affectAnnuler(b);b=this.affectModifier(b);b=this.affectSupprimerPdt(b);b=this.supprimerSelect(b);b=this.affectChangementLot(b);b=this.selectLot(b);b=this.affectInitLot(b);b=this.mCommunVue.comHoverBtn(b);return b};this.selectLot=function(b){$(this.mListeLot).each(function(){b.find("#lot-"+this.idPdt).selectOptions(this.idLot)});return b};this.supprimerSelect=function(b){b.find(".ligne-produit select").each(function(){if($(this).find("option").size()==1){var c=new GestionCommandeTemplate();var e=c.lotUnique;var d={};d.IdPdt=$(this).parent().parent().find(".produit-id").text();d.valeur=$(this).val();d.text=$(this).text();$(this).replaceWith(e.template(d))}});b.find(".ligne-produit-solidaire select").each(function(){if($(this).find("option").size()==1){var c=new GestionCommandeTemplate();var e=c.lotUniqueSolidaire;var d={};d.IdPdt=$(this).parent().parent().find(".produit-id").text();d.valeur=$(this).val();d.text=$(this).text();$(this).replaceWith(e.template(d))}});return b};this.affectInitLot=function(b){var c=this;b.find(".ligne-produit select").each(function(){var d=$(this).parent().parent().find(".produit-id").text();var g=$(this).val();if(c.pdtCommande[d].lots[g]){var e=c.pdtCommande[d].lots[g].prix;var h=c.pdtCommande[d].lots[g].taille;var f=(e/h).nombreFormate(2,","," ");$(b).find("#prix-unitaire-"+d).text(f)}});b.find(".ligne-produit-solidaire select").each(function(){var d=$(this).parent().parent().find(".produit-id").text();var g=$(this).val();if(c.pdtCommande[d].lots[g]){var e=c.pdtCommande[d].lots[g].prix;var h=c.pdtCommande[d].lots[g].taille;var f=(e/h).nombreFormate(2,","," ");$(b).find("#prix-unitaire-solidaire-"+d).text(f)}});return b};this.affectChangementLot=function(b){var c=this;b.find(".ligne-produit select").change(function(){c.changerLot($(this).parent().parent().find(".produit-id").text(),$(this).val())});b.find(".ligne-produit-solidaire select").change(function(){c.changerLotSolidaire($(this).parent().parent().find(".produit-id").text(),$(this).val())});return b};this.changerLot=function(b,c){var d=this.pdtCommande[b].lots[c].prix;var f=this.pdtCommande[b].lots[c].taille;var e=(d/f).nombreFormate(2,","," ");$("#prix-unitaire-"+b).text(e);$("#produits"+b+"quantite,#produits"+b+"prix").val(0);this.majNouveauSolde()};this.changerLotSolidaire=function(b,c){var d=this.pdtCommande[b].lots[c].prix;var f=this.pdtCommande[b].lots[c].taille;var e=(d/f).nombreFormate(2,","," ");$("#prix-unitaire-solidaire-"+b).text(e);$("#produitsSolidaire"+b+"quantite,#produitsSolidaire"+b+"prix").val(0);this.majNouveauSoldeSolidaire()};this.affectSelectTypePaiement=function(b){var c=this;b.find(":input[name=typepaiement]").change(function(){c.changerTypePaiement($(this));c.controlerAchat()});return b};this.affectNouveauSolde=function(b){var c=this;b.find(":input[name=montant-rechargement], .produit-prix").keyup(function(){c.majNouveauSolde();c.controlerAchat()});b.find(".produit-solidaire-prix").keyup(function(){c.majNouveauSoldeSolidaire();c.controlerAchat()});return b};this.affectNouveauSoldeInvite=function(b){var c=this;b.find(".produit-prix").keyup(function(){c.majTotal();c.controlerAchat()});b.find(".produit-solidaire-prix").keyup(function(){c.majTotalSolidaire();c.controlerAchat()});return b};this.affectNouveauPrixProduit=function(b){var c=this;b.find(".produit-quantite").keyup(function(){c.majPrixProduit($(this));c.controlerAchat()});b.find(".produit-solidaire-quantite").keyup(function(){c.majPrixProduitSolidaire($(this));c.controlerAchat()});return b};this.affectChampComplementaire=function(b){var c=this;b.find(":input[name=champ-complementaire]").keyup(function(){c.controlerAchat()});return b};this.affectValider=function(b){var c=this;b.find("#btn-valider").click(function(){c.creerRecapitulatif()});return b};this.affectAnnuler=function(b){var c=this;b.find("#btn-annuler").click(function(){c.retourListe()});return b};this.affectModifier=function(b){var c=this;b.find("#btn-modifier").click(function(){c.boutonModifier()});return b};this.affectSupprimerPdt=function(b){if(b.find(".ligne-produit").size()==0){b.find("#achat-pdt-widget").remove()}if(b.find(".ligne-produit-solidaire").size()==0){b.find("#achat-pdt-solidaire-widget").remove()}return b};this.majPrixProduit=function(b){var j=parseFloat(b.val().numberFrToDb());if(isNaN(j)){j=0}var c=b.parent().parent();var d=c.find(".produit-id").text();var f=c.find("#lot-"+d).val();var e=this.pdtCommande[d].lots[f].prix;var h=this.pdtCommande[d].lots[f].taille;var g=(e/h*j).toFixed(2);if(isNaN(g)){g=0}if(g!=0){c.find(".produit-prix").val(g.nombreFormate(2,","," "))}else{c.find(".produit-prix").val(0)}this.majNouveauSolde()};this.majPrixProduitSolidaire=function(b){var j=parseFloat(b.val().numberFrToDb());if(isNaN(j)){j=0}var c=b.parent().parent();var d=c.find(".produit-id").text();var f=c.find("#lot-solidaire-"+d).val();var e=this.pdtCommande[d].lots[f].prix;var h=this.pdtCommande[d].lots[f].taille;var g=(e/h*j).toFixed(2);if(isNaN(g)){g=0}if(g!=0){c.find(".produit-solidaire-prix").val(g.nombreFormate(2,","," "))}else{c.find(".produit-solidaire-prix").val(0)}this.majNouveauSoldeSolidaire()};this.controlerAchat=function(){Infobulle.init();var b=new AchatCommandeValid();if(this.idCompte==-3){var c=b.validAjoutInvite(this.getAchatCommandeVO())}else{var c=b.validAjout(this.getAchatCommandeVO())}Infobulle.generer(c,"");return c};this.majTotal=function(){var b=this.calculerTotal();$("#total-achat").text(b.nombreFormate(2,","," "));this.total=b;this.majTotalGlobal()};this.majTotalSolidaire=function(){var b=this.calculerTotalSolidaire();$("#total-achat-solidaire").text(b.nombreFormate(2,","," "));this.totalSolidaire=b;this.majTotalGlobal()};this.majTotalGlobal=function(){var b=this.totalSolidaire+this.total;$("#total-global").text(b.nombreFormate(2,","," "))};this.calculerTotal=function(){var b=0;$(".produit-prix").each(function(){var c=parseFloat($(this).val().numberFrToDb());if(isNaN(c)){c=0}b+=c});return b};this.calculerTotalSolidaire=function(){var b=0;$(".produit-solidaire-prix").each(function(){var c=parseFloat($(this).val().numberFrToDb());if(isNaN(c)){c=0}b+=c});return b};this.majNouveauSolde=function(){this.majTotal();var b=this.calculNouveauSolde();if(b<=0){$("#nouveau-solde").addClass("com-nombre-negatif");$("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde").removeClass("com-nombre-negatif");$("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}$("#nouveau-solde").text(b.nombreFormate(2,","," "))};this.majNouveauSoldeSolidaire=function(){this.majTotalSolidaire();var b=this.calculNouveauSolde();if(b<=0){$("#nouveau-solde").addClass("com-nombre-negatif");$("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde").removeClass("com-nombre-negatif");$("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}$("#nouveau-solde").text(b.nombreFormate(2,","," "))};this.calculNouveauSolde=function(){var d=this.total;if(isNaN(d)){d=0}var c=this.totalSolidaire;if(isNaN(c)){c=0}var b=parseFloat($(":input[name=montant-rechargement]").val().numberFrToDb());if(isNaN(b)){b=0}return this.solde-d-c+b};this.changerTypePaiement=function(d){var c=d.val();var b=this.getLabelChamComplementaire(c);if(b!=null){$("#label-champ-complementaire").text(b).show();$("#td-champ-complementaire").show()}else{$("#label-champ-complementaire").text("").hide();$(":input[name=champ-complementaire]").val("");$("#td-champ-complementaire").hide()}};this.getLabelChamComplementaire=function(c){var b=this.mTypePaiement;if(b[c]){if(b[c].tppChampComplementaire==1){return b[c].tppLabelChampComplementaire}}return null};this.getAchatCommandeVO=function(){var b=new AchatCommandeVO();b.id=this.idCommande;b.idCompte=this.idCompte;b.produits=this.getProduitsVO();b.produitsSolidaire=this.getProduitsSolidaireVO();b.rechargement=this.getRechargementVO();if(this.idCompte==-3){b.solde=this.calculNouveauSolde()}return b};this.getProduitsVO=function(){var b=new Array();$(".ligne-produit").each(function(){var d=new ProduitAchatVO();d.id=$(this).find(".produit-id").text();var e=$(this).find(".produit-quantite").val().numberFrToDb();if(!isNaN(e)&&!e.isEmpty()&&e!=0){e=parseFloat(e);d.quantite=e*-1;var c=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(c)&&!c.isEmpty()&&c!=0){c=parseFloat(c);d.prix=c*-1}b.push(d)}else{var c=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(c)&&!c.isEmpty()&&c!=0){c=parseFloat(c);d.prix=c*-1;b.push(d)}}});return b};this.getProduitsSolidaireVO=function(){var b=new Array();$(".ligne-produit-solidaire").each(function(){var d=new ProduitAchatVO();d.id=$(this).find(".produit-id").text();var e=$(this).find(".produit-solidaire-quantite").val().numberFrToDb();if(!isNaN(e)&&!e.isEmpty()&&e!=0){e=parseFloat(e);d.quantite=e*-1;var c=$(this).find(".produit-solidaire-prix").val().numberFrToDb();if(!isNaN(c)&&!c.isEmpty()&&c!=0){c=parseFloat(c);d.prix=c*-1}b.push(d)}else{var c=$(this).find(".produit-solidaire-prix").val().numberFrToDb();if(!isNaN(c)&&!c.isEmpty()&&c!=0){c=parseFloat(c);d.prix=c*-1;b.push(d)}}});return b};this.getRechargementVO=function(){var b=new RechargementCompteVO();var c=$(":input[name=montant-rechargement]").val().numberFrToDb();b.id=this.idCompte;if(!isNaN(c)&&!c.isEmpty()&&c!=0){c=parseFloat(c);b.montant=c}b.typePaiement=$(":input[name=typepaiement]").val();if(this.getLabelChamComplementaire(b.typePaiement)!=null){b.champComplementaireObligatoire=1;b.champComplementaire=$(":input[name=champ-complementaire]").val()}else{b.champComplementaireObligatoire=0}return b};this.creerRecapitulatif=function(){var b=this.controlerAchat();if(b.valid){if(this.etapeValider==0){$(".produit-quantite,.produit-solidaire-quantite,#rechargementchampComplementaire,#rechargementtypePaiement").each(function(){$(this).inputToText()});$(".produit-prix,.produit-solidaire-prix,#rechargementmontant").each(function(){$(this).inputToText("montant")});$(".lot-vente-produit-select").each(function(){var c=$(this).find("option:selected").text();$(this).next().text(c)});$(".lot-vente-produit, #btn-annuler, #btn-modifier").toggle();this.etapeValider=1}else{if(this.etapeValider==1){this.enregistrerAchat()}}}};this.enregistrerAchat=function(){var c=this;var b=this.getAchatCommandeVO();b.fonction="acheter";$.post("./index.php?m=GestionCommande&v=MarcheCommande","pParam="+$.toJSON(b),function(e){if(e){if(e.valid){var d=new GestionCommandeTemplate();var f=d.achatCommandeSucces;$("#contenu").replaceWith(c.affectAnnuler($(f)))}else{c.boutonModifier();Infobulle.generer(e,"")}c.etapeValider=0}},"json")};this.boutonModifier=function(){if(this.etapeValider==1){$(".produit-prix,.produit-solidaire-prix,#rechargementmontant,.produit-quantite,.produit-solidaire-quantite,#rechargementchampComplementaire,#rechargementtypePaiement").each(function(){$(this).textToInput()});$(".lot-vente-produit, #btn-annuler, #btn-modifier").toggle();this.etapeValider=0}};this.retourListe=function(){MarcheCommandeVue({id_commande:this.idCommande})};this.construct(a)}function ListeCommandeArchiveVue(a){this.mCommunVue=new CommunVue();this.construct=function(b){$.history({vue:function(){ListeCommandeArchiveVue(b)}});var c=this;var d={archive:1};$.post("./index.php?m=GestionCommande&v=ListeCommande","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(e)}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(e){var d=this;var c=new GestionCommandeTemplate();if(e.listeCommande.length>0&&e.listeCommande[0].comId!=null){var f=new Object;f.commande=new Array();$(e.listeCommande).each(function(){var h=new Object();h.id=this.comId;h.numero=this.comNumero;h.dateFinReservation=this.comDateFinReservation.extractDbDate().dateDbToFr();h.heureFinReservation=this.comDateFinReservation.extractDbHeure();h.minuteFinReservation=this.comDateFinReservation.extractDbMinute();h.dateMarcheDebut=this.comDateMarcheDebut.extractDbDate().dateDbToFr();h.heureMarcheDebut=this.comDateMarcheDebut.extractDbHeure();h.minuteMarcheDebut=this.comDateMarcheDebut.extractDbMinute();h.heureMarcheFin=this.comDateMarcheFin.extractDbHeure();h.minuteMarcheFin=this.comDateMarcheFin.extractDbMinute();h.dateTimeFinResa=this.comDateFinReservation.replace("-","").replace(" ","").replace(":","");h.dateTimeMarche=this.comDateMarcheDebut.replace("-","").replace(" ","").replace(":","");f.commande.push(h)});var g=c.listeCommandeArchivePage;var b=$(g.template(f));if(e.listeCommande.length<31){b=this.masquerPagination(b)}else{b=this.paginnation(b)}$("#contenu").replaceWith(d.affect(b))}else{$("#contenu").replaceWith(d.affect($(c.listeCommandeArchiveVide)))}};this.affect=function(b){b=this.affectLienListeCommandeArchive(b);b=this.affectLienDetail(b);b=this.mCommunVue.comHoverBtn(b);return b};this.affectLienListeCommandeArchive=function(b){b.find("#lien-marche-encours").click(function(){GestionListeCommandeVue()});return b};this.paginnation=function(b){b.find("#table-marche-archive").tablesorter({sortList:[[2,1]]}).tablesorterPager({container:b.find("#content-nav-liste-operation"),positionFixed:false,size:30});return b};this.masquerPagination=function(b){b.find("#content-nav-liste-operation").hide();b.find("#table-marche-archive").tablesorter({sortList:[[2,1]]});return b};this.affectLienDetail=function(b){b.find(".detail-commande-ligne").click(function(){var c={id_commande:$(this).find(".id-commande").text()};InfoCommandeArchiveVue(c)});return b};this.construct(a)}function MarcheCommandeVue(a){this.idCommande=null;this.construct=function(b){$.history({vue:function(){MarcheCommandeVue(b)}});var c=this;b.fonction="listeReservation";$.post("./index.php?m=GestionCommande&v=MarcheCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(d)}else{Infobulle.generer(d,"")}}},"json");this.idCommande=b.id_commande};this.afficher=function(d){Infobulle.init();if(d.valid){if(d.listeAdherentCommande){var e=this;var b=new GestionCommandeTemplate();if(d.listeAdherentCommande.length>0&&d.listeAdherentCommande[0].adhId!=null){var f=b.listeAdherentCommandePage;d.comNumero=d.listeAdherentCommande[0].comNumero;$("#contenu").replaceWith(e.affect($(f.template(d))))}else{$("#contenu").replaceWith(b.listeMarcheVide)}}else{var g=new TemplateVR();g.valid=false;g.log.valid=false;var c=new VRerreur();c.code=ERR_211_CODE;c.message=ERR_211_MSG;g.log.push(c);Infobulle.generer(g,"")}}else{Infobulle.generer(d,"")}};this.affect=function(b){b=this.affectTri(b);b=this.affectRecherche(b);b=this.affectLienAchat(b);return b};this.affectTri=function(b){b.find("#liste-adherent").tablesorter({sortList:[[2,0]]});return b};this.affectRecherche=function(b){b.find("#filter").keyup(function(){$.uiTableFilter($("#liste-adherent"),this.value)});b.find("#filter-form").submit(function(){return false});return b};this.affectLienAchat=function(b){var c=this;b.find(".achat-commande-ligne").click(function(){var d={id_commande:c.idCommande,id_adherent:$(this).find(".id-adherent").text()};AchatCommandeVue(d)});return b};this.construct(a)}function BonDeLivraisonVue(a){this.mCommunVue=new CommunVue();this.mIdCommande=null;this.mComNumero=null;this.mEtatEdition=false;this.mListeProduit=[];this.mSuiteEdition=0;this.mIdCompteProducteur=0;this.mTypePaiement=[];this.construct=function(b){$.history({vue:function(){BonDeLivraisonVue(b)}});var c=this;b.fonction="afficher";$.post("./index.php?m=GestionCommande&v=BonDeLivraison","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.mEtatEdition=false;c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(c){var d=this;var b=new GestionCommandeTemplate();var e=b.bonDeLivraison;this.mIdCommande=c.producteurs[0].proIdCommande;this.mComNumero=c.comNumero;$(c.typePaiement).each(function(){d.mTypePaiement[this.tppId]=this});$("#contenu").replaceWith(d.affect($(e.template(c))))};this.affect=function(b){b=this.mCommunVue.comHoverBtn(b);b=this.affectBtnRetourMarche(b);b=this.affectChangementProducteur(b);b=this.affectExportBonDeLivraison(b);return b};this.affectBtnRetourMarche=function(b){var c=this;b.find("#btn-editer-com").click(function(){EditerCommandeVue({id_commande:c.mIdCommande})});return b};this.affectChangementProducteur=function(b){var c=this;b.find("#select-prdt").change(function(){if(c.mEtatEdition){c.mSuiteEdition=1;c.dialogEnregistrer()}else{c.changementProducteur()}});return b};this.changementProducteur=function(){var c=this;var d=$("#select-prdt").val();if(d>0){var e={id_commande:c.mIdCommande,id_compte_ferme:d,fonction:"afficherProducteur"};$.post("./index.php?m=GestionCommande&v=BonDeLivraison","pParam="+$.toJSON(e),function(l){Infobulle.init();if(l){if(l.valid){c.mIdCompteProducteur=d;c.mEtatEdition=false;var k=0;$(l.produits).each(function(){c.mListeProduit[this.proId]=parseFloat(this.stoQuantite);this.stoQuantiteCommande="";this.opeMontant="";var q=0;var o=this.proId;var p=this;p.stoQuantiteCommande="0".nombreFormate(2,","," ");p.opeMontantCommande="0".nombreFormate(2,","," ");p.stoQuantiteLivraison="";p.opeMontantLivraison="";p.stoQuantiteSolidaire="";$(l.produitsCommande).each(function(){if(this.proId==o){var r=0;if(this.stoQuantite!=null){p.stoQuantiteCommande=this.stoQuantite.nombreFormate(2,","," ")}if(this.dopeMontant!=null){p.opeMontantCommande=this.dopeMontant.nombreFormate(2,","," ");r=parseFloat(this.dopeMontant)}k+=r}});$(l.produitsLivraison).each(function(){if(this.proId==o){if(this.stoQuantite!=null){p.stoQuantiteLivraison=this.stoQuantite.nombreFormate(2,","," ");q+=parseFloat(this.stoQuantite)}if(this.dopeMontant!=null){p.opeMontantLivraison=this.dopeMontant.nombreFormate(2,","," ")}}});$(l.produitsSolidaire).each(function(){if(this.proId==o){if(this.stoQuantite!=null){p.stoQuantiteSolidaire=this.stoQuantite.nombreFormate(2,","," ");q+=parseFloat(this.stoQuantite)}}});if(q-parseFloat(this.stoQuantite)<0){this.classEtat="qte-reservation-ko"}else{this.classEtat="qte-reservation-ok"}this.stoQuantite=this.stoQuantite.nombreFormate(2,","," ")});l.total="";if(l.operationProducteur){if(l.operationProducteur.montant!=null){l.total=(l.operationProducteur.montant).nombreFormate(2,","," ")}if(l.operationProducteur.typePaiementChampComplementaire!=null){l.champComplementaire=l.operationProducteur.typePaiementChampComplementaire}}l.sigleMonetaire=gSigleMonetaire;l.totalCommande=k.nombreFormate(2,","," ");l.typePaiement=c.mTypePaiement;var h=new GestionCommandeTemplate();var n=h.listeProduitLivraison;var g=c.affectListeProduit($(n.template(l)));if(l.operationProducteur&&l.operationProducteur.typePaiement!=null){var m=l.operationProducteur.typePaiement;g.find(":input[name=typepaiement]").selectOptions(m);var j=c.getLabelChamComplementaire(m);if(j!=null){g.find("#label-champ-complementaire").text(j);g.find("#tr-champ-complementaire").show()}else{g.find("#label-champ-complementaire").text("");g.find("#tr-champ-complementaire").hide()}}else{g.find("#label-champ-complementaire").text("");g.find("#tr-champ-complementaire").hide()}$("#liste-pdt").replaceWith(g)}else{Infobulle.generer(l,"")}}},"json")}else{var b=new GestionCommandeTemplate();var f=b.listeProduitVide;$("#liste-pdt").replaceWith(f)}};this.affectListeProduit=function(b){b=this.mCommunVue.comNumeric(b);b=this.affectEtatCommande(b);b=this.mCommunVue.comHoverBtn(b);b=this.affectEnregistrer(b);b=this.affectTypePaiement(b);b=this.affectChangementEtatEdition(b);return b};this.affectTypePaiement=function(b){var c=this;b.find(":input[name=typepaiement]").change(function(){c.changerTypePaiement($(this))});return b};this.changerTypePaiement=function(d){var c=d.val();var b=this.getLabelChamComplementaire(c);if(b!=null){$("#label-champ-complementaire").text(b);$("#tr-champ-complementaire").show()}else{$("#label-champ-complementaire").text("");$(":input[name=champ-complementaire]").val("");$("#tr-champ-complementaire").hide()}};this.getLabelChamComplementaire=function(c){var b=this.mTypePaiement;if(b[c]){if(b[c].tppChampComplementaire==1){return b[c].tppLabelChampComplementaire}}return null};this.affectEtatCommande=function(b){var c=this;b.find(".qte-commande ,.qte-solidaire-commande ").keyup(function(){c.mEtatEdition=true;var e=$(this).prev(".pro-id-etat").text();if(c.mListeProduit[e]){var g=0;var f=$(":input[name=qte-commande-"+e+"]").val().numberFrToDb();var d=$(":input[name=qte-solidaire-commande-"+e+"]").val().numberFrToDb();if(!isNaN(f)&&!f.isEmpty()){g+=parseFloat(f)}if(!isNaN(d)&&!d.isEmpty()){g+=parseFloat(d)}if(g-c.mListeProduit[e]<0){$("#etat-commande-"+e).removeClass("qte-reservation-ok").addClass("qte-reservation-ko")}else{$("#etat-commande-"+e).removeClass("qte-reservation-ko").addClass("qte-reservation-ok")}}});return b};this.affectEnregistrer=function(b){var c=this;b.find("#btn-enregistrer").click(function(){c.mSuiteEdition=0;c.enregistrer()});b.find(".qte-commande ,.prix-commande ").keyup(function(d){if(d.keyCode=="13"){c.mSuiteEdition=0;c.enregistrer()}});return b};this.enregistrer=function(){var c=this;var d=new ProduitsBonDeLivraisonVO();d.id_commande=this.mIdCommande;d.id_compte_ferme=this.mIdCompteProducteur;$(".pro-id").each(function(){var f=$(this).text();var g=new ProduitBonDeLivraisonVO();g.id=f;g.quantite=$(":input[name=qte-commande-"+f+"]").val().numberFrToDb();g.quantiteSolidaire=$(":input[name=qte-solidaire-commande-"+f+"]").val().numberFrToDb();g.prix=$(":input[name=prix-commande-"+f+"]").val().numberFrToDb();d.produits.push(g)});d.typePaiement=$(":input[name=typepaiement]").val();d.total=$(":input[name=total]").val().numberFrToDb();if(this.getLabelChamComplementaire(d.typePaiement)!=null){d.typePaiementChampComplementaireObligatoire=1;d.typePaiementChampComplementaire=$(":input[name=champ-complementaire]").val()}else{d.typePaiementChampComplementaireObligatoire=0}var b=new ProduitsBonDeLivraisonValid();var e=b.validAjout(d);if(e.valid){d.fonction="enregistrer";$.post("./index.php?m=GestionCommande&v=BonDeLivraison","pParam="+$.toJSON(d),function(g){Infobulle.init();if(g){if(g.valid){c.mEtatEdition=false;if(c.mSuiteEdition==1){c.changementProducteur()}else{if(c.mSuiteEdition==2){c.dialogExportBonDeLivraison()}else{var h=new TemplateVR();h.valid=false;h.log.valid=false;var f=new VRerreur();f.code=ERR_301_CODE;f.message=ERR_301_MSG;h.log.erreurs.push(f);Infobulle.generer(h,"")}}}else{Infobulle.generer(g,"");$("#select-prdt").selectOptions(c.mIdCompteProducteur)}}},"json")}else{Infobulle.generer(e,"");$("#select-prdt").selectOptions(c.mIdCompteProducteur)}};this.affectExportBonDeLivraison=function(b){var c=this;b.find("#btn-export-bcom").click(function(){if(c.mEtatEdition){c.mSuiteEdition=2;c.dialogEnregistrer()}else{c.dialogExportBonDeLivraison()}});return b};this.affectChangementEtatEdition=function(b){var c=this;b.find(".com-input-text").keyup(function(){c.mEtatEdition=true});b.find(":input[name=typepaiement]").change(function(){c.mEtatEdition=true});return b};this.dialogExportBonDeLivraison=function(){var c=this;var b=new GestionCommandeTemplate();var d=b.dialogExportBonDeLivraison;$(d.template({comNumero:c.mComNumero})).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Exporter:function(){var e=$(this).find(":input[name=format]:checked").val();var g=new ExportBonLivraisonVO();g.id_commande=c.mIdCommande;g.format=e;g.fonction="export";var f=new ExportBonLivraisonValid();var h=f.validAjout(g);Infobulle.init();if(h.valid){$.download("./index.php?m=GestionCommande&v=BonDeLivraison",g)}else{Infobulle.generer(h,"")}},Annuler:function(){$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.dialogEnregistrer=function(){var c=this;var b=new GestionCommandeTemplate();var d=b.dialogEnregistrement;$(d).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Enregistrer:function(){c.enregistrer();$(this).dialog("close")},Annuler:function(){if(c.mSuiteEdition==1){$("#select-prdt").selectOptions(c.mIdCompteProducteur)}$(this).dialog("close")},"Ne pas Enregistrer":function(){c.mEtatEdition=false;if(c.mSuiteEdition==1){c.changementProducteur()}else{if(c.mSuiteEdition==2){c.changementProducteur();c.dialogExportBonDeLivraison()}}$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.construct(a)}function InfoCommandeArchiveVue(a){this.mIdMarche=0;this.construct=function(b){$.history({vue:function(){InfoCommandeArchiveVue(b)}});var c=this;b.fonction="afficherCommande";$.post("./index.php?m=GestionCommande&v=InfoCommandeArchive","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(e){var d=this;var b=new GestionCommandeTemplate();var g=b.infoCommandeArchive;e.sigleMonetaire=gSigleMonetaire;var c=0;var f=0;$(e.infoCommande).each(function(){d.mIdMarche=this.comId;if(this.stoQuantite==null){this.stoQuantite=0}if(this.opeMontant==null){this.opeMontant=0}if(this.stoQuantiteLivraison==null){this.stoQuantiteLivraison=0}if(this.opeMontantLivraison==null){this.opeMontantLivraison=0}if(this.stoQuantiteSolidaire==null){this.stoQuantiteSolidaire=0}if(this.stoQuantiteVente==null){this.stoQuantiteVente=0}if(this.opeMontantVente==null){this.opeMontantVente=0}if(this.stoQuantiteVenteSolidaire==null){this.stoQuantiteVenteSolidaire=0}if(this.opeMontantVenteSolidaire==null){this.opeMontantVenteSolidaire=0}c-=parseFloat(this.opeMontantLivraison);c+=parseFloat(this.opeMontantVente);f+=parseFloat(this.opeMontantVenteSolidaire);this.stoQuantite=this.stoQuantite.nombreFormate(2,","," ");this.opeMontant=this.opeMontant.nombreFormate(2,","," ");this.stoQuantiteLivraison=this.stoQuantiteLivraison.nombreFormate(2,","," ");this.opeMontantLivraison=this.opeMontantLivraison.nombreFormate(2,","," ");this.stoQuantiteSolidaire=this.stoQuantiteSolidaire.nombreFormate(2,","," ");this.stoQuantiteVente=this.stoQuantiteVente.nombreFormate(2,","," ");this.opeMontantVente=this.opeMontantVente.nombreFormate(2,","," ");this.stoQuantiteVenteSolidaire=this.stoQuantiteVenteSolidaire.nombreFormate(2,","," ");this.opeMontantVenteSolidaire=this.opeMontantVenteSolidaire.nombreFormate(2,","," ")});e.total=c.nombreFormate(2,","," ");e.totalSolidaire=f.nombreFormate(2,","," ");e.numero=e.detailMarche.numero;$("#contenu").replaceWith(d.affect($(g.template(e))))};this.affect=function(b){b=this.affectDupliquerMarche(b);b=gCommunVue.comHoverBtn(b);return b};this.affectDupliquerMarche=function(b){var c=this;b.find("#btn-dupliquer-com").click(function(){DupliquerMarcheVue({id_commande:c.mIdMarche})});return b};this.construct(a)}function ModifierCommandeVue(a){this.etapeCreationCommande=0;this.mEditionEnCours=0;this.mListeProducteurs=[];this.mCommunVue=new CommunVue();this.commande=null;this.construct=function(b){$.history({vue:function(){ModifierCommandeVue(b)}});var c=this;$.post("./index.php?m=GestionCommande&v=ModifierCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}if(d.producteurs[0].prdtId==null){d.producteurs=[]}c.mListeProducteurs=d.producteurs;c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(e){var f=this;var d=e.marche;e.sigleMonetaire=gSigleMonetaire;e.comId=d.id;e.comNom=d.nom;e.comNumero=d.numero;e.comDescription=d.description;e.dateTimeFinReservation=d.dateFinReservation.extractDbDate().dateDbToFr();e.heureFinReservation=d.dateFinReservation.extractDbHeure();e.minuteFinReservation=d.dateFinReservation.extractDbMinute();e.dateMarcheDebut=d.dateMarcheDebut.extractDbDate().dateDbToFr();e.heureMarcheDebut=d.dateMarcheDebut.extractDbHeure();e.minuteMarcheDebut=d.dateMarcheDebut.extractDbMinute();e.heureMarcheFin=d.dateMarcheFin.extractDbHeure();e.minuteMarcheFin=d.dateMarcheFin.extractDbMinute();if(e.produits[0].id==null){e.produits=[]}this.commande=e;var b=new GestionCommandeTemplate();var g=b.formulaireModifierCommande;var c=f.affect($(g.template(e)));e.pdtCommande=e.marche.produits;var b=new GestionCommandeTemplate();var g=b.ajoutProduitModifierCommande;$.each(e.pdtCommande,function(){if(this.id!=undefined){this.sigleMonetaire=gSigleMonetaire;this.producteurs=f.mListeProducteurs;var k=this.idCompteProducteur;var j="";$(f.mListeProducteurs).each(function(){if(this.prdtIdCompte==k){j=this.prdtPrenom+" "+this.prdtNom}});this.nomProducteur=j;this.stockInitial=this.stockInitial.nombreFormate(2,","," ");this.qteMaxCommande=this.qteMaxCommande.nombreFormate(2,","," ");var h=f.affectNouveauProduit($(g.template(this)));h.find(":input[name=producteur]").selectOptions(k);var l=this;$.each(this.lots,function(){if(this.id!=undefined){var m={lots:[{id:this.id,taille:this.taille.nombreFormate(2,","," "),prix:this.prix.nombreFormate(2,","," "),unite:l.unite,idPdt:l.id}],siglemonetaire:gSigleMonetaire};h.find(".produit-lots").append(f.affectAjoutLot($(b.ajoutLotModifPdt.template(m))))}});c.find("#liste_produit").append(f.afficherDeleteLot($(h)))}});$("#contenu").replaceWith(c)};this.affectSelectHeure=function(b){var c=this;b.find(":input[name=heure_fin_commande]").selectOptions(c.commande.heureFinReservation);b.find(":input[name=minute_fin_commande]").selectOptions(c.commande.minuteFinReservation);b.find(":input[name=heure_debut_marche]").selectOptions(c.commande.heureMarcheDebut);b.find(":input[name=minute_debut_marche]").selectOptions(c.commande.minuteMarcheDebut);b.find(":input[name=heure_fin_marche]").selectOptions(c.commande.heureMarcheFin);b.find(":input[name=minute_fin_marche]").selectOptions(c.commande.minuteMarcheFin);return b};this.affect=function(b){b=this.affectAjoutProduit(b);b=this.affectCreerCommande(b);b=this.affectModifierCommande(b);b=this.affectDialogCreerProduit(b);b=this.affectControleDatepicker(b);b=this.mCommunVue.comNumeric(b);b=this.affectSelectHeure(b);b=this.affectBtnRetourMarche(b);b=this.mCommunVue.comHoverBtn(b);return b};this.affectNouveauProduit=function(b){b=this.mCommunVue.comDelete(b);b=this.mCommunVue.comNumeric(b);b=this.editProduit(b);b=this.ajoutLotProduit(b);b=this.mCommunVue.comHoverBtn(b);return b};this.affectAjoutLot=function(b){b=this.editLot(b);b=this.deleteLot(b);b=this.mCommunVue.comNumeric(b);return b};this.affectAjoutProduit=function(b){var d="#formulaire-ajout-produit-creation-commande";var c=this;b.find(d).submit(function(){var j=true;$(".produit-nom-id").each(function(){if(parseInt($(this).text())==$(d+" :input[name=produit]").val()){j=false}});if(j){var h=new ProduitCommandeVO();h.idNom=$(d+" :input[name=produit]").val();h.nom=$(d+" :input[name=produit] option:selected").text();h.idProducteur=$(d+" :input[name=producteur]").val();h.unite=$(d+" :input[name=unite]").val();h.qteMaxCommande=$(d+" :input[name=qmax]").val().numberFrToDb();h.qteRestante=$(d+" :input[name=stock]").val().numberFrToDb();if(isNaN(parseFloat(h.qteMaxCommande))||(parseFloat(h.qteMaxCommande)>parseFloat(h.qteRestante))){h.qteMaxCommande=h.qteRestante}var m=new DetailCommandeVO();m.taille=$(d+" :input[name=taille]").val().numberFrToDb();m.prix=$(d+" :input[name=prix]").val().numberFrToDb();h.lots.push(m);var j=new ProduitCommandeValid();var l=j.validAjout(h);if(l.valid){Infobulle.init();var f=new GestionCommandeTemplate();var k=f.ajoutProduitModifierCommande;h.proMaxProduitCommande=h.qteMaxCommande.nombreFormate(2,","," ");h.stockInitial=h.qteRestante.nombreFormate(2,","," ");h.id=h.idNom*-1;h.lots=new Array();h.lots.push({id:0,idPdt:h.id,unite:h.unite,taille:m.taille.nombreFormate(2,","," "),prix:m.prix.nombreFormate(2,","," ")});h.siglemonetaire=gSigleMonetaire;h.producteurs=c.mListeProducteurs;h.nomProducteur=$(d+" :input[name=producteur]").selectedOptions().text();var e=c.affectNouveauProduit($(k.template(h)));e.find(":input[name=producteur]").selectOptions(h.idProducteur);k=f.ajoutLotModifPdt;e.find(".produit-lots").append(c.affectAjoutLot($(k.template(h))));$("#liste_produit").append(e);$(d+" :input[name=unite]").val("");$(d+" :input[name=qmax]").val("");$(d+" :input[name=stock]").val("");$(d+" :input[name=taille]").val("");$(d+" :input[name=prix]").val("");$(d+" :input[name=produit]").selectedOptions().attr("selected","");$(d+" :input[name=produit]").selectOptions(0);$(d+" :input[name=producteur]").selectedOptions().attr("selected","");$(d+" :input[name=producteur]").selectOptions(0)}else{Infobulle.generer(l,"ajout-produit-")}}else{var l=new TemplateVR();l.valid=false;l.log.valid=false;var g=new VRerreur();g.code=ERR_211_CODE;g.message=ERR_211_MSG;l.log.erreurs.push(g);Infobulle.generer(l,"")}return false});return b};this.affectCreerCommande=function(b){var d="#btn-creer-commande";var c=this;b.find(d).click(function(){if(c.mEditionEnCours==0){var f=new CommandeCompleteVO();f.id=c.commande.comId;f.numero=c.commande.comNumero;f.nom=$("#formulaire-information-creation-commande").find(":input[name=nom_commande]").val();f.description=$("#formulaire-information-creation-commande").find(":input[name=description_commande]").val();f.dateMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();f.timeMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=heure_debut_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_debut_marche]").val()+":00";f.dateMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();f.timeMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_marche]").val()+":00";f.dateFinReservation=$("#formulaire-information-creation-commande").find(":input[name=date_fin_commande]").val().dateFrToDb();f.timeFinReservation=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_commande]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_commande]").val()+":00";f.archive="0";$(".produit-div").each(function(){var k=new ProduitCommandeVO();k.idProducteur=$(this).find(":input[name=producteur]").val();k.id=$(this).find(".produit-id").text();k.idNom=$(this).find(".produit-nom-id").text();k.unite=$(this).find(":input[name=unite]").val();k.qteMaxCommande=$(this).find(":input[name=qmax]").val().numberFrToDb();k.qteRestante=$(this).find(":input[name=stock]").val().numberFrToDb();$(this).find(".produit-lot").each(function(){var l=new DetailCommandeVO();l.id=$(this).find(".lot-id").text();l.taille=$(this).find(":input[name=taille]").val().numberFrToDb();l.prix=$(this).find(":input[name=prix]").val().numberFrToDb();k.lots.push(l)});f.produits.push(k)});if(c.etapeCreationCommande==0){var g=new CommandeCompleteValid();var j=g.validUpdate(f);if(j.valid){c.etapeCreationCommande=1;Infobulle.init();$("#window-ajout-produit-creation-commande").hide();$("#btn-modifier-creation-commande").show();$("#liste_produit .produit-div :button , .form-ajout-lot-creation-commande, .com-btn-header, .conteneur-btn-edt-lot").each(function(){$(this).hide()});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").each(function(){$(this).inputToText()})}else{Infobulle.generer(j,"commande-")}}else{if(c.etapeCreationCommande==1){var h={form:2,commande:f};$.post("./index.php?m=GestionCommande&v=ModifierCommande","pParam="+$.toJSON(h),function(l){if(l){if(l.valid){var m=new TemplateVR();m.valid=false;m.log.valid=false;var k=new VRerreur();k.code=ERR_310_CODE;k.message=ERR_310_MSG;m.log.erreurs.push(k);EditerCommandeVue({id_commande:c.mIdCommande,vr:m})}else{c.modifierCommandeFunction();Infobulle.generer(l,"commande-")}c.etapeCreationCommande=0}},"json")}}}else{var j=new Object();var e=new VRerreur();e.code=ERR_112_CODE;e.message=ERR_112_MSG;j.valid=false;j.log=new VRelement();j.log.valid=false;j.log.erreurs.push(e);Infobulle.generer(j,"")}});return b};this.affectModifierCommande=function(b){var c=this;b.find("#btn-modifier-creation-commande").click(function(){c.modifierCommandeFunction()});return b};this.modifierCommandeFunction=function(){this.etapeCreationCommande=0;var b=this;$("#window-ajout-produit-creation-commande, #liste_produit .produit-div :button, .form-ajout-lot-creation-commande, .com-btn-header, .conteneur-btn-edt-lot").show();$("#btn-modifier-creation-commande, .edit-nom-pdt-creation-commande-valid").hide();$(".produit-lots").each(function(){b.afficherDeleteLot($(this))});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").textToInput()};this.ajoutLotProduit=function(b){var c=this;b.find(".btn-ajout-lot-creation-commande").click(function(){var k=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=taille]");var d=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=prix]");var j=new DetailCommandeVO();j.idProduit=$(this).parents(".produit-div").find(".produit-id").text();j.taille=k.val().numberFrToDb();j.prix=d.val().numberFrToDb();var l=new DetailCommandeValid();var h=l.validAjout(j);if(h.valid){Infobulle.init();j.prix=parseFloat(j.prix).nombreFormate(2,","," ");j.taille=parseFloat(j.taille).nombreFormate(2,","," ");j.siglemonetaire=gSigleMonetaire;j.unite=$(this).parentsUntil(".produit-div").find(":input[name=unite]").val();j.idNom=j.idProduit;var m=new Array();$(this).parentsUntil(".produit-div").find(".produit-lot").each(function(){m.push(parseInt($(this).find(".lot-id").text()))});var e=Array.min(m);if(e<0){j.id=e-1}else{j.id=-1}var f=new GestionCommandeTemplate();var g=f.ajoutLot;c.afficherDeleteLot($(this).parents(".produit-div").find(".produit-lots").append(c.affectAjoutLot($(g.template(j)))));k.val("");d.val("")}else{Infobulle.generer(h,"ajout-lot-produit-"+j.idProduit+"-")}});return b};this.editProduit=function(b){var c=this;b.find(".edit-nom-pdt-creation-commande-valid").click(function(){var d=new ProduitCommandeVO();var k=$(this).closest(".produit-div");d.idProducteur=$(k).find(":input[name=producteur]").val();d.idNom=$(k).find(".produit-nom-id").text();d.nom=$(k).find(".produit-nom").text();d.unite=$(k).find(":input[name=unite]").val();d.qteMaxCommande=$(k).find(":input[name=qmax]").val().numberFrToDb();d.qteRestante=$(k).find(":input[name=stock]").val().numberFrToDb();var f=new ProduitCommandeValid();var l=f.validAjout(d,"simple");if(l.valid){Infobulle.init();var e=$(k).find(":input[name=producteur]").selectedOptions().text();$(k).find("#nom-producteur").text(e);var j=parseFloat(d.qteRestante).nombreFormate(2,","," ");$(k).find(".produit-stock").text(j);$(k).find(":input[name=stock]").val(j);var h=parseFloat(d.qteMaxCommande).nombreFormate(2,","," ");$(k).find(".produit-qmax").text(h);$(k).find(":input[name=qmax]").val(h);$(k).find(".produit-unite").text(d.unite);var g=$(this).parentsUntil("#liste_produit");g.find(".produit-unite").text(d.unite);b.find(".edit-nom-pdt-creation-commande, .info-produit").toggle();c.mEditionEnCours--}else{Infobulle.generer(l,"produit-"+d.idNom+"-")}});b.find(".edit-nom-pdt-creation-commande-edit").click(function(){c.mEditionEnCours++;b.find(".edit-nom-pdt-creation-commande, .info-produit").toggle()});return b};this.editLot=function(b){var c=this;b.find(".edit-lot-creation-commande-valid").click(function(){var d=new DetailCommandeVO();var h=$(this).closest(".produit-lot");d.id=$(h).find(".lot-id").text();d.idProduit=$(this).parentsUntil(".produit-div").find(".produit-id").text();d.taille=$(h).find(":input[name=taille]").val().numberFrToDb();d.prix=$(h).find(":input[name=prix]").val().numberFrToDb();var e=new DetailCommandeValid();var j=e.validAjout(d);if(j.valid){Infobulle.init();var f=d.taille.nombreFormate(2,","," ");$(h).find(".produit-taille").text(f);$(h).find(":input[name=taille]").val(f);var g=d.prix.nombreFormate(2,","," ");$(h).find(".produit-prix").text(g);$(h).find(":input[name=prix]").val(g);b.find(".edit-lot-creation-commande, .pdt-"+d.idProduit+"-lot-"+d.id).toggle();c.mEditionEnCours--}else{Infobulle.generer(j,"produit-"+d.idProduit+"-lot-"+d.id+"-")}});b.find(".edit-lot-creation-commande-edit").click(function(){var d=$(this).closest(".produit-div").find(".produit-id").text();var e=$(this).closest(".produit-lot").find(".lot-id").text();b.find(".edit-lot-creation-commande, .pdt-"+d+"-lot-"+e).toggle();c.mEditionEnCours++});return b};this.deleteLot=function(b){var c=this;b.find(".delete-lot").click(function(){var d=$(this).parents(".produit-lots");$(this).parent().parent().remove();c.afficherDeleteLot(d)});return b};this.afficherDeleteLot=function(b){if(b.find(".produit-lot").size()<2){b.find(".delete-lot").hide()}else{b.find(".delete-lot").show()}return b};this.affectDialogCreerProduit=function(b){var c=this;b.find("#btn-creer-nv-pdt").click(function(){var d=new GestionCommandeTemplate();var e=d.dialogAjoutProduit;$(e).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:400,buttons:{"Créer le produit":function(){var f=$(this).children("form").first();c.CreerProduit(f)},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}}).submit(function(){c.CreerProduit($(this));return false})});return b};this.CreerProduit=function(c){var b=new NomProduitVO();b.nom=c.find(":input[name=nom]").val();b.description=c.find(":input[name=description]").val();b.idCategorie=1;var d=new NomProduitValid();var f=d.validAjout(b);if(f.valid){Infobulle.init();var e={form:1,nomProduit:b};$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(e),function(h){if(h){if(h.valid){Infobulle.init();var g=[];g[h.id]=h.nom;$("#formulaire-ajout-produit-creation-commande select[name=produit]").addOption(g).sortOptions();$("#dialog-form-creer-nv-pdt").dialog("close")}else{Infobulle.generer(h,"nom-pdt-")}}},"json")}else{Infobulle.generer(f,"nom-pdt-")}};this.affectControleDatepicker=function(b){b=this.mCommunVue.comLienDatepicker("commande-dateFinReservation","commande-dateMarcheDebut",b);return b};this.affectBtnRetourMarche=function(b){var c=this;b.find("#btn-editer-com").click(function(){EditerCommandeVue({id_commande:c.mIdCommande})});return b};this.construct(a)}function AchatAdherentVue(a){this.mAdherent=null;this.infoCommande=new Object();this.pdtCommande=new Array();this.reservation=[];this.achats=[];this.achatsSolidaire=[];this.infoReservation={};this.stockSolidaire=[];this.pParam={};this.construct=function(b){$.history({vue:function(){AchatAdherentVue(b)}});var c=this;this.pParam=b;b.fonction="afficher";$.post("./index.php?m=GestionCommande&v=AchatAdherent","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.mAdherent=d.adherent;c.infoCommande.comId=d.marche.id;c.infoCommande.comNumero=d.marche.numero;c.infoCommande.comNom=d.marche.nom;c.infoCommande.comDescription=d.marche.description;c.infoCommande.dateTimeFinReservation=d.marche.dateFinReservation;c.infoCommande.dateFinReservation=d.marche.dateFinReservation.extractDbDate().dateDbToFr();c.infoCommande.heureFinReservation=d.marche.dateFinReservation.extractDbHeure();c.infoCommande.minuteFinReservation=d.marche.dateFinReservation.extractDbMinute();c.infoCommande.dateMarcheDebut=d.marche.dateMarcheDebut.extractDbDate().dateDbToFr();c.infoCommande.heureMarcheDebut=d.marche.dateMarcheDebut.extractDbHeure();c.infoCommande.minuteMarcheDebut=d.marche.dateMarcheDebut.extractDbMinute();c.infoCommande.heureMarcheFin=d.marche.dateMarcheFin.extractDbHeure();c.infoCommande.minuteMarcheFin=d.marche.dateMarcheFin.extractDbMinute();c.infoCommande.comArchive=d.marche.archive;c.pdtCommande=d.marche.produits;c.infoReservation=d.reservation;c.stockSolidaire=d.stockSolidaire;$.each(c.pdtCommande,function(){if(this.id){var e=this.id;$.each(this.lots,function(){if(this.id){var f=this.id;$(d.reservation.detailReservation).each(function(){if(this.idDetailCommande==f){this.stoQuantite=this.quantite*-1;this.dcomId=this.idDetailCommande;this.proId=e;this.montant=this.montant*-1;c.reservation[e]=this}})}})}});c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(k){var j=this;var c=new GestionCommandeTemplate();var e=c.detailAchatEtReservation;var f={};f.adhId=this.mAdherent.adhId;f.adhNumero=this.mAdherent.adhNumero;f.adhCompte=this.mAdherent.cptLabel;f.adhNom=this.mAdherent.adhNom;f.adhPrenom=this.mAdherent.adhPrenom;f.adhSolde=this.mAdherent.cptSolde.nombreFormate(2,","," ");f.sigleMonetaire=gSigleMonetaire;f.comNumero=this.infoCommande.comNumero;f.dateFinReservation=this.infoCommande.dateFinReservation;f.heureFinReservation=this.infoCommande.heureFinReservation;f.minuteFinReservation=this.infoCommande.minuteFinReservation;f.dateMarcheDebut=this.infoCommande.dateMarcheDebut;f.heureMarcheDebut=this.infoCommande.heureMarcheDebut;f.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;f.heureMarcheFin=this.infoCommande.heureMarcheFin;f.minuteMarcheFin=this.infoCommande.minuteMarcheFin;f.totalReservation=(this.infoReservation.total*-1).nombreFormate(2,","," ");f.reservation=[];var h=false;$.each(this.pdtCommande,function(){h=true;var o=this.id;var n={};n.id=this.id;n.nproNom=this.nom;n.proUniteMesure=this.unite;n.prix=0;n.stoQuantite=0;if(j.reservation[o]){n.stoQuantite=parseFloat(j.reservation[o].stoQuantite);n.prix=parseFloat(j.reservation[o].montant)}n.stoQuantite=n.stoQuantite.nombreFormate(2,","," ");n.prix=n.prix.nombreFormate(2,","," ");f.reservation.push(n)});f.achats=[];f.achatsSolidaire=[];var g=0;$(k.achats).each(function(){var n=this;var q=[];var p=false;$.each(j.pdtCommande,function(){if(this.id){var s=this.id;var r={};r.id=this.id;r.nproNom=this.nom;r.proUniteMesure=this.unite;r.prix=0;r.stoQuantite=0;$.each(this.lots,function(){if(this.id){var t=this.id;$(n.detailAchat).each(function(){if(this.idDetailCommande==t){r.stoQuantite=this.quantite*-1;r.prix=this.montant*-1;g++;p=true}})}});r.stoQuantite=r.stoQuantite.nombreFormate(2,","," ");r.prix=r.prix.nombreFormate(2,","," ");q.push(r)}});if(p){var o={achat:q,idAchat:this.id.idAchat,total:(this.total*-1).nombreFormate(2,","," ")};f.achats.push(o)}});if(g==0&&h){var m=[];$.each(j.pdtCommande,function(){if(this.id){var o=this.id;var n={};n.id=this.id;n.nproNom=this.nom;n.proUniteMesure=this.unite;n.stoQuantite="0".nombreFormate(2,","," ");n.prix="0".nombreFormate(2,","," ");m.push(n)}});var d={achat:m,idAchat:"-1",total:"0".nombreFormate(2,","," ")};f.achats.push(d)}var b=0;$(k.achats).each(function(){var n=this;var q=[];var o=false;$.each(j.pdtCommande,function(){if(this.id){var s=false;var u=this;var t=this.id;var r={};r.id=this.id;r.nproNom=this.nom;r.proUniteMesure=this.unite;r.prix=0;r.stoQuantite=0;$(k.stockSolidaire).each(function(){if(r.id==this.proId){$.each(u.lots,function(){if(this.id){var v=this.id;$(n.detailAchatSolidaire).each(function(){if(this.idDetailCommande==v){r.stoQuantite=this.quantite*-1;r.prix=this.montant*-1;b++;o=true;s=true}})}})}});if(s){r.stoQuantite=r.stoQuantite.nombreFormate(2,","," ");r.prix=r.prix.nombreFormate(2,","," ");q.push(r)}}});if(o){var p={achat:q,idAchat:this.id.idAchat,totalSolidaire:(this.totalSolidaire*-1).nombreFormate(2,","," ")};f.achatsSolidaire.push(p)}});if(b==0&&k.stockSolidaire.length>0&&k.stockSolidaire[0].proId!=null){var m=[];$.each(j.pdtCommande,function(){if(this.id){var o=this.id;var n={};n.id=this.id;n.nproNom=this.nom;n.proUniteMesure=this.unite;n.stoQuantite="0".nombreFormate(2,","," ");n.prix="0".nombreFormate(2,","," ");$(k.stockSolidaire).each(function(){if(n.id==this.proId){m.push(n)}})}});var d={achat:m,idAchat:"-2",totalSolidaire:"0".nombreFormate(2,","," ")};f.achatsSolidaire.push(d)}f.typeEtatReservation=[];var l={};l.value="-1";l.label="Aucune Réservation";l.selected="";f.typeEtatReservation[-1]=l;var l={};l.value="0";l.label="En réservation";l.selected="";f.typeEtatReservation[0]=l;var l={};l.value="7";l.label="Achetée";l.selected="";f.typeEtatReservation[7]=l;var l={};l.value="15";l.label="Non Récupérée";l.selected="";f.typeEtatReservation[15]=l;var l={};l.value="16";l.label="Supprimée";l.selected="";f.typeEtatReservation[16]=l;switch(this.infoReservation.etat){case"0":f.etatReservation="En réservation";f.typeEtatReservation[0].selected='selected="selected"';break;case"7":f.etatReservation="Achetée";f.typeEtatReservation[7].selected='selected="selected"';break;case"15":f.etatReservation="Non Récupérée";f.typeEtatReservation[15].selected='selected="selected"';break;case"16":f.etatReservation="Supprimée";f.typeEtatReservation[16].selected='selected="selected"';break;default:f.etatReservation="Aucune Réservation";f.typeEtatReservation[-1].selected='selected="selected"';break}$("#contenu").replaceWith(j.affect($(e.template(f))))};this.affect=function(b){b=this.affectAnnulerDetailReservation(b);b=this.affectModifierReservation(b);b=this.affectValiderModifierReservation(b);b=this.affectModifierAchat(b);b=this.affectSupprimerAchat(b);b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);return b};this.affectAnnulerDetailReservation=function(b){var c=this;b.find("#btn-annuler").click(function(){EditerCommandeVue({id_commande:c.infoCommande.comId})});return b};this.affectModifierReservation=function(b){var c=this;b.find("#btn-modif-resa").click(function(){c.modifierReservation()});return b};this.affectValiderModifierReservation=function(b){var c=this;b.find("#btn-check-resa").click(function(){c.validerModifierReservation()});return b};this.affectSupprimerAchat=function(b){var c=this;b.find(".achat, .achatSolidaire").each(function(){var d=$(this).find(".achat-id").text();b.find("#btn-supp-achat-"+d).click(function(){c.supprimerAchat(d)})});return b};this.affectModifierAchat=function(b){var c=this;b.find(".achat, .achatSolidaire").each(function(){var d=$(this).find(".achat-id").text();b.find("#btn-annuler-achat-"+d+", #btn-modif-achat-"+d).click(function(){c.modifierAchat(d)});b.find("#btn-check-achat-"+d).click(function(){c.validerModifierAchat(d)})});return b};this.modifierReservation=function(){$(".modif-resa, .resa-etat, .detail-resa-prix, .detail-resa-qte, .resa-total").toggle()};this.validerModifierReservation=function(){var b={};b.total=$("#reservation-total").val().numberFrToDb();b.etat=$("#reservation-etat").val();b.produits=[];var e=[];$(".ligne-produit-reservation").each(function(){var g=new ProduitAchatVO();g.id=$(this).find(".produit-id").text();var h=$(this).find(".produit-quantite").val().numberFrToDb();if(!isNaN(h)&&!h.isEmpty()&&h!=0){h=parseFloat(h);g.quantite=h*-1;var f=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(f)&&!f.isEmpty()&&f!=0){f=parseFloat(f);g.prix=f*-1}b.produits.push(g)}else{var f=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(f)&&!f.isEmpty()&&f!=0){f=parseFloat(f);g.prix=f*-1;b.produits.push(g)}}e.push(g)});b.id=this.infoReservation.id;var c=new ReservationAdherentValid();var d=c.validUpdate(b);Infobulle.init();if(d.valid){$(e).each(function(){if(isNaN(this.quantite)||this.quantite.isEmpty()){this.quantite=0}$("#reservation-"+this.id+"-quantite").text((this.quantite*-1).nombreFormate(2,","," "));if(isNaN(this.prix)||this.quantite.isEmpty()){this.prix=0}$("#reservation-"+this.id+"-prix").text((this.prix*-1).nombreFormate(2,","," "))});switch(b.etat){case"0":$("#reservation-etat-label").text("En réservation");break;case"7":$("#reservation-etat-label").text("Achetée");break;case"15":$("#reservation-etat-label").text("Non Récupérée");break;case"16":$("#reservation-etat-label").text("Supprimée");break;default:$("#reservation-etat-label").text("Aucune Réservation");break}if(isNaN(b.total)||b.total.isEmpty()){b.total=0}$("#reservation-total-label").text(b.total.nombreFormate(2,","," "));$(".modif-resa, .resa-etat, .detail-resa-prix, .detail-resa-qte, .resa-total").toggle()}else{Infobulle.generer(d,"reservation-")}};this.modifierAchat=function(b){$(".modif-achat-"+b+", .detail-achat-"+b+"-prix, .detail-achat-"+b+"-qte, .achat-"+b+"-total").toggle()};this.validerModifierAchat=function(e){var d=this;var b={};b.idAchat=e;b.total=$("#achat-"+e+"-total").val().numberFrToDb()*-1;b.produits=[];var h=[];$(".ligne-produit-achat-"+e).each(function(){var k=new ProduitAchatVO();k.id=$(this).find(".produit-id").text();var l=$(this).find(".produit-quantite").val().numberFrToDb();if(!isNaN(l)&&!l.isEmpty()&&l!=0){l=parseFloat(l);k.quantite=l*-1;var j=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(j)&&!j.isEmpty()&&j!=0){j=parseFloat(j);k.prix=j*-1}b.produits.push(k)}else{var j=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(j)&&!j.isEmpty()&&j!=0){j=parseFloat(j);k.prix=j*-1;b.produits.push(k)}}h.push(k)});if(parseInt(e)<0){b.idCompte=d.mAdherent.adhIdCompte;b.idMarche=d.pParam.id_commande}var c=new AchatAdherentValid();var g=c.validUpdate(b);Infobulle.init();if(g.valid){var f={fonction:"modifierAchat",achat:b};$.post("./index.php?m=GestionCommande&v=AchatAdherent","pParam="+$.toJSON(f),function(l){Infobulle.init();if(l){if(l&&l.valid){var j=new TemplateVR();j.valid=false;j.log.valid=false;var k=new VRerreur();k.code=ERR_314_CODE;k.message=ERR_314_MSG;j.log.erreurs.push(k);if(b.idAchat<0){d.pParam.vr=j;d.construct(d.pParam)}else{$(h).each(function(){if(isNaN(this.quantite)||this.quantite.isEmpty()){this.quantite=0}$("#achat-"+e+"-"+this.id+"-quantite").text((this.quantite*-1).nombreFormate(2,","," "));if(isNaN(this.prix)||this.prix.isEmpty()){this.prix=0}$("#achat-"+e+"-"+this.id+"-prix").text((this.prix*-1).nombreFormate(2,","," "))});if(isNaN(b.total)||b.total.isEmpty()){b.total=0}$("#achat-"+e+"-total-label").text((b.total*-1).nombreFormate(2,","," "));$(".modif-achat-"+e+", .detail-achat-"+e+"-prix, .detail-achat-"+e+"-qte, .achat-"+e+"-total").toggle();Infobulle.generer(j,"")}}else{Infobulle.generer(l,"")}}},"json")}else{Infobulle.generer(g,"achat-"+e+"-")}};this.supprimerAchat=function(d){var c=this;var b=new GestionCommandeTemplate();var e=b.dialogSupprimerAchat;$(e).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Supprimer:function(){var g=this;var f={fonction:"supprimerAchat",idAchat:d};$.post("./index.php?m=GestionCommande&v=AchatAdherent","pParam="+$.toJSON(f),function(k){Infobulle.init();if(k){if(k&&k.valid){var h=new TemplateVR();h.valid=false;h.log.valid=false;var j=new VRerreur();j.code=ERR_315_CODE;j.message=ERR_315_MSG;h.log.erreurs.push(j);c.pParam.vr=h;c.construct(c.pParam);$(g).dialog("close")}else{Infobulle.generer(k,"")}}},"json")},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}})};this.construct(a)}function BonDeCommandeVue(a){this.mCommunVue=new CommunVue();this.mIdCommande=null;this.mComNumero=null;this.mEtatEdition=false;this.mListeProduit=[];this.mSuiteEdition=0;this.mIdCompteProducteur=0;this.construct=function(b){$.history({vue:function(){BonDeCommandeVue(b)}});var c=this;b.fonction="afficher";$.post("./index.php?m=GestionCommande&v=BonDeCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.mEtatEdition=false;c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(c){var d=this;var b=new GestionCommandeTemplate();var e=b.bonDeCommande;this.mIdCommande=c.producteurs[0].proIdCommande;this.mComNumero=c.comNumero;$("#contenu").replaceWith(d.affect($(e.template(c))))};this.affect=function(b){b=this.mCommunVue.comHoverBtn(b);b=this.affectBtnRetourMarche(b);b=this.affectChangementProducteur(b);b=this.affectExportBonCommande(b);return b};this.affectBtnRetourMarche=function(b){var c=this;b.find("#btn-editer-com").click(function(){EditerCommandeVue({id_commande:c.mIdCommande})});return b};this.affectChangementProducteur=function(b){var c=this;b.find("#select-prdt").change(function(){if(c.mEtatEdition){c.mSuiteEdition=1;c.dialogEnregistrer()}else{c.changementProducteur()}});return b};this.changementProducteur=function(){var c=this;var d=$("#select-prdt").val();if(d>0){var e={id_commande:c.mIdCommande,id_compte_ferme:d,fonction:"afficherProducteur"};$.post("./index.php?m=GestionCommande&v=BonDeCommande","pParam="+$.toJSON(e),function(h){Infobulle.init();if(h){if(h.valid){c.mIdCompteProducteur=d;c.mEtatEdition=false;$(h.produits).each(function(){c.mListeProduit[this.proId]=this.stoQuantite;this.stoQuantiteCommande="";this.dopeMontant="";var k=this.proId;var l=this;$(h.produitsCommande).each(function(){if(this.proId==k){l.stoQuantiteCommande=this.stoQuantite;l.dopeMontant=this.dopeMontant.nombreFormate(2,","," ")}});if(this.stoQuantiteCommande-this.stoQuantite<0){this.classEtat="qte-reservation-ko"}else{this.classEtat="qte-reservation-ok"}if(this.stoQuantiteCommande!=""){this.stoQuantiteCommande=this.stoQuantiteCommande.nombreFormate(2,","," ")}this.stoQuantite=this.stoQuantite.nombreFormate(2,","," ")});h.sigleMonetaire=gSigleMonetaire;var g=new GestionCommandeTemplate();var j=g.listeProduitBonDeCommande;$("#liste-pdt").replaceWith(c.affectListeProduit($(j.template(h))))}else{Infobulle.generer(h,"")}}},"json")}else{var b=new GestionCommandeTemplate();var f=b.listeProduitVide;$("#liste-pdt").replaceWith(f)}};this.affectListeProduit=function(b){b=this.mCommunVue.comNumeric(b);b=this.affectEtatCommande(b);b=this.mCommunVue.comHoverBtn(b);b=this.affectEnregistrer(b);return b};this.affectEtatCommande=function(b){var c=this;b.find(":input").keyup(function(){c.mEtatEdition=true;var d=$(this).prev(".pro-id").text();if(c.mListeProduit[d]){if($(this).val().numberFrToDb()-c.mListeProduit[d]<0){$("#etat-commande-"+d).removeClass("qte-reservation-ok").addClass("qte-reservation-ko")}else{$("#etat-commande-"+d).removeClass("qte-reservation-ko").addClass("qte-reservation-ok")}}});return b};this.affectEnregistrer=function(b){var c=this;b.find("#btn-enregistrer").click(function(){c.mSuiteEdition=0;c.enregistrer()});b.find(".qte-commande ,.prix-commande ").keyup(function(d){if(d.keyCode=="13"){c.mSuiteEdition=0;c.enregistrer()}});return b};this.enregistrer=function(){var c=this;var d=new ProduitsBonDeCommandeVO();d.id_commande=this.mIdCommande;d.id_compte_ferme=this.mIdCompteProducteur;d.export_type=0;$(".pro-id").each(function(){var f=$(this).text();var g=new ProduitBonDeCommandeVO();g={id:f,quantite:$(":input[name=qte-commande-"+f+"]").val().numberFrToDb(),prix:$(":input[name=prix-commande-"+f+"]").val().numberFrToDb()};d.produits.push(g)});var b=new ProduitsBonDeCommandeValid();var e=b.validAjout(d);if(e.valid){d.fonction="enregistrer";return $.post("./index.php?m=GestionCommande&v=BonDeCommande","pParam="+$.toJSON(d),function(g){Infobulle.init();if(g){if(g.valid){c.mEtatEdition=false;if(c.mSuiteEdition==1){c.changementProducteur()}else{if(c.mSuiteEdition==2){c.dialogExportBonDeCommande()}else{var h=new TemplateVR();h.valid=false;h.log.valid=false;var f=new VRerreur();f.code=ERR_301_CODE;f.message=ERR_301_MSG;h.log.erreurs.push(f);Infobulle.generer(h,"")}}}else{Infobulle.generer(g,"");$("#select-prdt").selectOptions(c.mIdCompteProducteur)}}},"json")}else{Infobulle.generer(e,"");$("#select-prdt").selectOptions(c.mIdCompteProducteur)}};this.affectExportBonCommande=function(b){var c=this;b.find("#btn-export-bcom").click(function(){if(c.mEtatEdition){c.mSuiteEdition=2;c.dialogEnregistrer()}else{c.dialogExportBonDeCommande()}});return b};this.dialogExportBonDeCommande=function(){var c=this;var b=new GestionCommandeTemplate();var d=b.dialogExportBonDeCommande;$(d.template({comNumero:c.mComNumero})).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Exporter:function(){var e=$(this).find(":input[name=format]:checked").val();var g=new ExportBonReservationVO();g.id_commande=c.mIdCommande;g.format=e;g.fonction="export";var f=new ExportBonReservationValid();var h=f.validAjout(g);Infobulle.init();if(h.valid){$.download("./index.php?m=GestionCommande&v=BonDeCommande",g)}else{Infobulle.generer(h,"")}},Annuler:function(){$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.dialogEnregistrer=function(){var c=this;var b=new GestionCommandeTemplate();var d=b.dialogEnregistrement;$(d).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Enregistrer:function(){c.enregistrer();$(this).dialog("close")},Annuler:function(){if(c.mSuiteEdition==1){$("#select-prdt").selectOptions(c.mIdCompteProducteur)}$(this).dialog("close")},"Ne pas Enregistrer":function(){c.mEtatEdition=false;if(c.mSuiteEdition==1){c.changementProducteur()}else{if(c.mSuiteEdition==2){c.changementProducteur();c.dialogExportBonDeCommande()}}$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.construct(a)}function ReservationAdherentVue(a){this.mCommunVue=new CommunVue();this.mAdherent=null;this.infoCommande=new Object();this.pdtCommande=new Array();this.reservation=new Array();this.reservationModif=new Array();this.construct=function(b){$.history({vue:function(){ReservationAdherentVue(b)}});var c=this;b.fonction="afficherReservation";$.post("./index.php?m=GestionCommande&v=ReservationAdherent","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.mAdherent=d.adherent;c.infoCommande.comId=d.marche.id;c.infoCommande.comNumero=d.marche.numero;c.infoCommande.comNom=d.marche.nom;c.infoCommande.comDescription=d.marche.description;c.infoCommande.dateTimeFinReservation=d.marche.dateFinReservation;c.infoCommande.dateFinReservation=d.marche.dateFinReservation.extractDbDate().dateDbToFr();c.infoCommande.heureFinReservation=d.marche.dateFinReservation.extractDbHeure();c.infoCommande.minuteFinReservation=d.marche.dateFinReservation.extractDbMinute();c.infoCommande.dateMarcheDebut=d.marche.dateMarcheDebut.extractDbDate().dateDbToFr();c.infoCommande.heureMarcheDebut=d.marche.dateMarcheDebut.extractDbHeure();c.infoCommande.minuteMarcheDebut=d.marche.dateMarcheDebut.extractDbMinute();c.infoCommande.heureMarcheFin=d.marche.dateMarcheFin.extractDbHeure();c.infoCommande.minuteMarcheFin=d.marche.dateMarcheFin.extractDbMinute();c.infoCommande.comArchive=d.marche.archive;c.pdtCommande=d.marche.produits;$.each(c.pdtCommande,function(){if(this.id){var e=this.id;$.each(this.lots,function(){if(this.id){var f=this.id;$(d.reservation).each(function(){if(this.idDetailCommande==f){this.stoQuantite=this.quantite*-1;this.dcomId=this.idDetailCommande;this.proId=e;c.reservation[e]=this}})}})}});c.afficher()}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(){this.afficherDetailReservation()};this.afficherDetailReservation=function(){var e=this;var b=new GestionCommandeTemplate();var f=b.detailReservation;var c={};c.adhId=this.mAdherent.adhId;c.adhNumero=this.mAdherent.adhNumero;c.adhCompte=this.mAdherent.cptLabel;c.adhNom=this.mAdherent.adhNom;c.adhPrenom=this.mAdherent.adhPrenom;c.adhSolde=this.mAdherent.cptSolde.nombreFormate(2,","," ");c.sigleMonetaire=gSigleMonetaire;c.comNumero=this.infoCommande.comNumero;c.dateFinReservation=this.infoCommande.dateFinReservation;c.heureFinReservation=this.infoCommande.heureFinReservation;c.minuteFinReservation=this.infoCommande.minuteFinReservation;c.dateMarcheDebut=this.infoCommande.dateMarcheDebut;c.heureMarcheDebut=this.infoCommande.heureMarcheDebut;c.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;c.heureMarcheFin=this.infoCommande.heureMarcheFin;c.minuteMarcheFin=this.infoCommande.minuteMarcheFin;c.categories=[];var d=0;$.each(this.pdtCommande,function(){if(e.reservation[this.id]){var g=new Object;g.nproNom=this.nom;g.stoQuantite=parseFloat(e.reservation[this.id].stoQuantite);g.proUniteMesure=this.unite;g.prix=0;var h=e.reservation[this.id].dcomId;$.each(this.lots,function(){if(this.id==h){g.prix=(g.stoQuantite/this.taille)*this.prix}});d+=g.prix;g.stoQuantite=g.stoQuantite.nombreFormate(2,","," ");g.prix=g.prix.nombreFormate(2,","," ");if(!c.categories[this.idCategorie]){c.categories[this.idCategorie]={nom:this.cproNom,produits:[]}}c.categories[this.idCategorie].produits.push(g)}});c.total=parseFloat(d).nombreFormate(2,","," ");$("#contenu").replaceWith(e.affect($(f.template(c))))};this.afficherModifier=function(){var e=this;var b=new GestionCommandeTemplate();var f=b.modifierReservation;var c={};c.adhId=this.mAdherent.adhId;c.adhNumero=this.mAdherent.adhNumero;c.adhCompte=this.mAdherent.cptLabel;c.adhNom=this.mAdherent.adhNom;c.adhPrenom=this.mAdherent.adhPrenom;c.adhSolde=this.mAdherent.cptSolde.nombreFormate(2,","," ");c.adhNouveauSolde=0;c.sigleMonetaire=gSigleMonetaire;c.comNumero=this.infoCommande.comNumero;c.dateFinReservation=this.infoCommande.dateFinReservation;c.heureFinReservation=this.infoCommande.heureFinReservation;c.minuteFinReservation=this.infoCommande.minuteFinReservation;c.dateMarcheDebut=this.infoCommande.dateMarcheDebut;c.heureMarcheDebut=this.infoCommande.heureMarcheDebut;c.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;c.heureMarcheFin=this.infoCommande.heureMarcheFin;c.minuteMarcheFin=this.infoCommande.minuteMarcheFin;c.categories=[];var d=0;$.each(this.pdtCommande,function(){if(this.id){var g={};g.proId=this.id;g.nproNom=this.nom;g.proUniteMesure=this.unite;g.proMaxProduitCommande=parseFloat(this.qteMaxCommande);if(e.reservation[this.id]){g.stock=parseFloat(this.stockReservation)+parseFloat(e.reservation[this.id].stoQuantite)}else{g.stock=parseFloat(this.stockReservation)}g.lot=new Array();var l=false;if(parseFloat(this.qteMaxCommande)==-1&&parseFloat(this.stockInitial)==-1){l=true}else{if(parseFloat(this.stockInitial)==-1){g.max=g.proMaxProduitCommande}else{if(parseFloat(this.qteMaxCommande)==-1){g.max=g.stock}else{if(parseFloat(g.proMaxProduitCommande)<parseFloat(g.stock)){g.max=g.proMaxProduitCommande}else{g.max=g.stock}}}}var j=0;var h=-1;var k=-1;$.each(this.lots,function(){if(this.id){if(l||(!l&&parseFloat(this.taille)<=g.max)){var m={};m.dcomId=this.id;m.dcomTaille=parseFloat(this.taille).nombreFormate(2,","," ");m.dcomPrix=parseFloat(this.prix).nombreFormate(2,","," ");m.prixReservation=parseFloat(this.prix);m.stoQuantiteReservation=parseFloat(this.taille);if(e.reservation[g.proId]&&(e.reservation[g.proId].dcomId==this.id)){m.stoQuantiteReservation=parseFloat(e.reservation[g.proId].stoQuantite);m.prixReservation=(m.stoQuantiteReservation/this.taille)*this.prix;d+=m.prixReservation;h=this.id;m.checked='checked="checked"'}g.prixUnitaire=(m.prixReservation/m.stoQuantiteReservation).nombreFormate(2,","," ");g.stoQuantiteReservation=m.stoQuantiteReservation.nombreFormate(2,","," ");g.prixReservation=m.prixReservation.nombreFormate(2,","," ");g.lot.push(m)}}});c.total=parseFloat(d).nombreFormate(2,","," ");if(h!=-1){g.checked='checked="checked"'}else{g.checked=""}if(g.lot.length==0){g.checked='rel="indisponible"'}if(!c.categories[this.idCategorie]){c.categories[this.idCategorie]={nom:this.cproNom,produits:[]}}c.categories[this.idCategorie].produits.push(g)}});this.reservationModif=[];$(this.reservation).each(function(){if(this.proId){e.reservationModif[this.proId]={proId:this.proId,dcomId:this.dcomId,stoQuantite:this.stoQuantite}}});$("#contenu").replaceWith(e.affectModifier($(f.template(c))))};this.affect=function(b){b=this.affectModifierReservation(b);b=this.affectAnnulerDetailReservation(b);b=this.mCommunVue.comHoverBtn(b);b=this.affectSupprimerReservation(b);return b};this.affectModifier=function(b){b=this.affectBtnQte(b);b=this.affectChangementLot(b);b=this.affectChangementProduit(b);b=this.preparerAffichageModifier(b);b=this.affectValiderReservation(b);b=this.affectAnnulerReservation(b);b=this.supprimerSelect(b);b=this.mCommunVue.comHoverBtn(b);b=this.affectNouveauSolde(b);b=this.affectInitLot(b);b=this.masquerIndisponible(b);return b};this.affectBtnQte=function(b){var c=this;b.find(".btn-plus").click(function(){var d=$(this).parent().parent().find(".pdt-id").text();c.nouvelleQuantite(d,$(this).parent().parent().find("#lot-"+d).val(),1)});b.find(".btn-moins").click(function(){var d=$(this).parent().parent().find(".pdt-id").text();c.nouvelleQuantite(d,$(this).parent().parent().find("#lot-"+d).val(),-1)});return b};this.affectChangementLot=function(b){var c=this;b.find(".pdt select").change(function(){c.changerLot($(this).parent().parent().find(".pdt-id").text(),$(this).val())});return b};this.affectChangementProduit=function(b){var c=this;b.find(".pdt :checkbox").click(function(){c.changerProduit($(this).parent().parent().find(".pdt-id").text())});return b};this.affectValiderReservation=function(b){var c=this;b.find("#btn-valider").click(function(){c.validerReservation()});return b};this.affectAnnulerReservation=function(b){var c=this;b.find("#btn-annuler").click(function(){c.afficherDetailReservation()});return b};this.affectModifierReservation=function(b){var c=this;b.find("#btn-modifier").click(function(){c.afficherModifier()});return b};this.masquerIndisponible=function(b){b.find("[rel='indisponible']").each(function(){var c=new GestionCommandeTemplate();var e=c.produitIndisponible;var d={nom:$(this).parents(".pdt").find(".nom-pro").text()};$(this).parents(".pdt").before(e.template(d));$(this).parents(".pdt").remove()});return b};this.affectAnnulerDetailReservation=function(b){var c=this;b.find("#btn-annuler").click(function(){EditerCommandeVue({id_commande:c.infoCommande.comId})});return b};this.affectInitLot=function(b){var c=this;b.find(".pdt select").each(function(){var d=$(this).parent().parent().find(".pdt-id").text();var g=$(this).val();if(c.pdtCommande[d].lots[g]){var e=c.pdtCommande[d].lots[g].prix;var h=c.pdtCommande[d].lots[g].taille;var f=(e/h).nombreFormate(2,","," ");$(b).find("#prix-unitaire-"+d).text(f)}});return b};this.nouvelleQuantite=function(f,n,b){var j=parseFloat(this.pdtCommande[f].qteMaxCommande);if(this.reservationModif[f]){var l=parseFloat(this.pdtCommande[f].stockReservation)+parseFloat(this.reservationModif[f].stoQuantite)}else{var l=parseFloat(this.pdtCommande[f].stockReservation)}var g=false;if(parseFloat(this.pdtCommande[f].qteMaxCommande)==-1&&parseFloat(this.pdtCommande[f].stockInitial)==-1){g=true}else{if(parseFloat(this.pdtCommande[f].stockInitial)==-1){j=this.pdtCommande[f].qteMaxCommande}else{if(parseFloat(this.pdtCommande[f].qteMaxCommande)==-1){j=l}else{if(parseFloat(l)<parseFloat(j)){j=l}}}}var o=this.pdtCommande[f].lots[n].taille;var m=this.pdtCommande[f].lots[n].prix;var d=0;if(this.reservationModif[f]&&(this.reservationModif[f].dcomId==n)){d=parseFloat(this.reservationModif[f].stoQuantite)/parseFloat(o)}d+=b;var c=0;c=d*o;if(g||(!g&&c>0&&c<=j)){var e=0;e=(d*m).toFixed(2);this.reservationModif[f].stoQuantite=c;$("#qte-pdt-"+f).text(parseFloat(c).nombreFormate(2,","," "));$("#prix-pdt-"+f).text(parseFloat(e).nombreFormate(2,","," "));this.majTotal()}else{if(c>j){var h=new TemplateVR();h.valid=false;h.log.valid=false;var k=new VRerreur();k.code=ERR_304_CODE;k.message=ERR_304_MSG;h.log.erreurs.push(k);Infobulle.generer(h,"")}}};this.changerLot=function(b,c){var d=this.pdtCommande[b].lots[c].prix;var f=this.pdtCommande[b].lots[c].taille;var e=(d/f).nombreFormate(2,","," ");$("#prix-unitaire-"+b).text(e);if(this.reservationModif[b]){this.reservationModif[b].dcomId=c;this.reservationModif[b].stoQuantite=f;$("#qte-pdt-"+b).text(f.nombreFormate(2,","," "));$("#prix-pdt-"+b).text(d.nombreFormate(2,","," "))}this.majTotal()};this.changerProduit=function(b){if(this.reservationModif[b]!=null){$(".resa-pdt-"+b).hide();$("#qte-pdt-"+b).text("");$("#prix-pdt-"+b).text("");this.reservationModif[b]=null}else{var e=$("#lot-"+b).val();var f=this.pdtCommande[b].lots[e].taille;var d={};d.comId=this.infoCommande.comId;d.proId=b;d.dcomId=e;d.stoQuantite=f;this.reservationModif[b]=d;$("#qte-pdt-"+b).text(f.nombreFormate(2,","," "));var c=this.pdtCommande[b].lots[e].prix.nombreFormate(2,","," ");$("#prix-pdt-"+b).text(c);$(".resa-pdt-"+b).show()}this.majTotal()};this.majTotal=function(){$("#total").text(this.calculTotal().nombreFormate(2,","," "));this.majNouveauSolde()};this.majNouveauSolde=function(){var b=this.mAdherent.cptSolde-this.calculTotal();if(b<=0){$("#nouveau-solde").addClass("com-nombre-negatif");$("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde").removeClass("com-nombre-negatif");$("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}$("#nouveau-solde").text(b.nombreFormate(2,","," "))};this.affectNouveauSolde=function(c){var b=this.mAdherent.cptSolde-this.calculTotal();if(b<=0){c.find("#nouveau-solde").addClass("com-nombre-negatif");c.find("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{c.find("#nouveau-solde").removeClass("com-nombre-negatif");c.find("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}c.find("#nouveau-solde").text(b.nombreFormate(2,","," "));return c};this.calculTotal=function(){var c=this;var b=0;$(this.reservationModif).each(function(){var d=this;if(d.stoQuantite){if(c.pdtCommande[d.proId]){$.each(c.pdtCommande[d.proId].lots,function(){if(d.dcomId==this.id){b+=(d.stoQuantite/this.taille)*this.prix}})}}});return b};this.preparerAffichageModifier=function(b){var c=this;$(b).find(".pdt").each(function(){var d=$(this).find(".pdt-id").text();if(c.reservation[d]!=null){var g=c.reservation[d];var f=g.dcomId;var h=g.stoQuantite;$(b).find("#qte-pdt-"+d).text(h.nombreFormate(2,","," "));var e=((c.pdtCommande[d].lots[f].prix*g.stoQuantite)/c.pdtCommande[d].lots[f].taille).nombreFormate(2,","," ");$(b).find("#prix-pdt-"+d).text(e);$(b).find("#lot-"+d).selectOptions(f);$(b).find(".resa-pdt-"+d).css("display","table-cell")}});return b};this.validerReservation=function(){var e=this;Infobulle.init();var c=new ListeReservationCommandeVO();var f=0;$(this.reservationModif).each(function(){if(this.stoQuantite){var h=new ReservationCommandeVO();h.stoQuantite=this.stoQuantite*-1;h.stoIdDetailCommande=this.dcomId;c.detailReservation.push(h);f++}});if(f>0){var d=new ListeReservationCommandeValid();var g=d.validAjout(c);if(!g.valid){Infobulle.generer(g,"")}else{c.fonction="modifierReservation";c.id_compte=this.mAdherent.adhIdCompte;$.post("./index.php?m=GestionCommande&v=ReservationAdherent","pParam="+$.toJSON(c),function(h){Infobulle.init();if(h){if(h.valid){e.reservation=[];$(e.reservationModif).each(function(){if(this.proId){e.reservation[this.proId]={proId:this.proId,dcomId:this.dcomId,stoQuantite:this.stoQuantite}}});e.afficher()}else{Infobulle.generer(h,"")}}},"json")}}else{var g=new TemplateVR();g.valid=false;g.log.valid=false;var b=new VRerreur();b.code=ERR_207_CODE;b.message=ERR_207_MSG;g.log.erreurs.push(b);Infobulle.generer(g,"")}};this.affectSupprimerReservation=function(b){var c=this;b.find("#btn-supprimer").click(function(){var d=new GestionCommandeTemplate();var e=d.supprimerReservationDialog;$(e).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Supprimer:function(){var f={id_commande:c.infoCommande.comId,id_compte:c.mAdherent.adhIdCompte,fonction:"supprimerReservation"};var g=this;$.post("./index.php?m=GestionCommande&v=ReservationAdherent","pParam="+$.toJSON(f),function(j){Infobulle.init();if(j){if(j.valid){var k=new TemplateVR();k.valid=false;k.log.valid=false;var h=new VRerreur();h.code=ERR_303_CODE;h.message=ERR_303_MSG;k.log.erreurs.push(h);EditerCommandeVue({id_commande:c.infoCommande.comId,vr:k});$(g).dialog("close")}else{Infobulle.generer(j,"")}}},"json")},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove()}})});return b};this.supprimerSelect=function(b){b.find(".pdt select").each(function(){if($(this).find("option").size()==1){var c=new GestionCommandeTemplate();var e=c.lotUnique;var d={};d.IdPdt=$(this).parent().parent().find(".pdt-id").text();d.valeur=$(this).val();d.text=$(this).text();$(this).replaceWith(e.template(d))}});return b};this.construct(a)}function DupliquerMarcheVue(a){this.mListeFerme={};this.mProduits=[];this.mMarche=new MarcheVO();this.mAffichageMarche=[];this.mNbProduit=0;this.mEditionLot=false;this.mIdLot=0;this.mEtapeCreationMarche=0;this.construct=function(b){$.history({vue:function(){DupliquerMarcheVue(b)}});var d=$.extend(d,b);d.fonction="dupliquer";var c=this;$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(e)}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(c){var d=this;$.each(c.marche.produits,function(){if(this.id){var p=this.ferId;var o=this.idCategorie;var j=this.idNom;var m="";var l="";if(parseFloat(this.stockInitial)!=-1){m=this.stockInitial;l=this.stockInitial.nombreFormate(2,","," ")}var n="";var k="";if(parseFloat(this.qteMaxCommande)!=-1){n=this.qteMaxCommande;k=this.qteMaxCommande.nombreFormate(2,","," ")}var f=this.unite;var h={nproId:j,nproNom:this.nom,nproStock:l,nproQteMax:k,nproUnite:f,modelesLot:[]};var g=new ProduitMarcheVO();g.idNom=j;g.unite=f;g.qteMaxCommande=n;g.qteRestante=m;$.each(this.lots,function(){var q=this.id;var r={id:q,taille:this.taille.nombreFormate(2,","," "),prix:this.prix.nombreFormate(2,","," "),unite:f,selected:true,modele:true};h.modelesLot[q]=r;var r=new DetailCommandeVO();r.taille=this.taille;r.prix=this.prix;g.lots.push(r)});if(!d.mAffichageMarche[p]){d.mAffichageMarche[p]={ferId:p,ferNom:this.ferNom,categories:[]}}if(!d.mAffichageMarche[p].categories[o]){d.mAffichageMarche[p].categories[o]={cproId:o,cproNom:this.cproNom,produits:[]}}g.idFerme=p;g.idCategorie=o;d.mAffichageMarche[p].categories[o].produits[j]=h;d.mMarche.produits[j]=g;d.mNbProduit++}});this.mListeFerme=c.listeFerme;var b=new GestionCommandeTemplate();var e=b.formulaireAjoutMarche;$("#contenu").replaceWith(d.affect($(e.template(c))))};this.affect=function(b){b=this.affectDialogAjoutProduit(b);b=this.affectControleDatepicker(b);b=this.affectInitListeFerme(b);b=gCommunVue.comNumeric(b);b=gCommunVue.comHoverBtn(b);return b};this.affectDialogAjoutProduit=function(b){var c=this;b.find("#btn-ajout-produit").click(function(){var d=new GestionCommandeTemplate();var e=d.dialogAjoutProduitAjoutMarche;$(c.affectAjoutProduitSelectFerme($(e.template({listeFerme:c.mListeFerme})))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Ajouter:function(){c.ajouterProduit($(this))},Annuler:function(){c.mEditionLot=false;$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}})});return b};this.affectAjoutProduitSelectFerme=function(b){var c=this;b.find("#pro-idFerme select").change(function(){var e=$(this).val();$("#pro-idCategorie select, #pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#prix-stock-produit").replaceWith('<div id="prix-stock-produit"></div>');if(e>0){var d={fonction:"listeProduit",id:e};$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(d),function(j){if(j){if(j.valid){Infobulle.init();if(j.listeProduit.length>0&&j.listeProduit[0].nproId!=null){c.mProduits=[];var h=0;var l=[];$.each(j.listeProduit,function(){if(c.mProduits[this.cproId]){c.mProduits[this.cproId].listeProduit.push(this)}else{c.mProduits[this.cproId]={nom:this.cproNom,listeProduit:[this]}}if(h!=this.cproId){l.push({cproId:this.cproId,cproNom:this.cproNom});h=this.cproId}});var f=new GestionCommandeTemplate();var k=f.ajoutProduitSelectCategorie;$("#pro-idCategorie").replaceWith(c.affectAjoutProduitSelectCategorie($(k.template({listeCategorie:l}))))}else{var m=new TemplateVR();m.valid=false;m.log.valid=false;var g=new VRerreur();g.code=ERR_332_CODE;g.message=ERR_332_MSG;m.log.erreurs.push(g);Infobulle.generer(m,"")}}else{Infobulle.generer(j,"")}}},"json")}});return b};this.affectAjoutProduitSelectCategorie=function(b){var c=this;b.find("select").change(function(){var f=$(this).val();$("#pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#prix-stock-produit").replaceWith('<div id="prix-stock-produit"></div>');if(f>0){var d=new GestionCommandeTemplate();var e=d.ajoutProduitSelectProduit;$("#pro-idProduit").replaceWith(c.affectAjoutProduitSelectProduit($(e.template(c.mProduits[f]))))}});return b};this.affectAjoutProduitSelectProduit=function(b){var c=this;b.find("select").change(function(){var g=$(this).val();if(g>0){if(!c.mMarche.produits[g]){var e={fonction:"listeModeleLot",idNomProduit:g};$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(e),function(k){if(k){if(k.valid){Infobulle.init();var j={sigleMonetaire:gSigleMonetaire};if(k.modelesLot.length>0&&k.modelesLot[0].mLotId!=null){j.modelesLot=[];$(k.modelesLot).each(function(){if(this.mLotId!=null){this.id=this.mLotId;this.quantite=this.mLotQuantite.nombreFormate(2,","," ");this.unite=this.mLotUnite;this.prix=this.mLotPrix.nombreFormate(2,","," ");this.sigleMonetaire=gSigleMonetaire;j.modelesLot.push(this);j.unite=this.mLotUnite}})}var h=new GestionCommandeTemplate();var l=h.prixEtStockAjoutProduit;$("#prix-stock-produit").replaceWith(c.affectPrixEtStock($(l.template(j))))}else{Infobulle.generer(k,"")}}},"json")}else{var f=new Object();var d=new VRerreur();d.code=ERR_211_CODE;d.message=ERR_211_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(d);Infobulle.generer(f,"")}}else{$("#prix-stock-produit").replaceWith($('<div id="prix-stock-produit">'))}});return b};this.affectPrixEtStock=function(b){b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);b=this.affectAjoutLotGestion(b);b=this.affectAjoutLot(b);return b};this.affectAjoutLot=function(b){var c=this;b.find("#btn-ajout-lot").click(function(){c.ajoutLot()});b.find("#table-pro-prix input").keyup(function(d){if(d.keyCode=="13"){c.ajoutLot()}});return b};this.ajoutLot=function(){var c=new ModeleLotVO();c.quantite=$(":input[name=lot-quantite]").val().numberFrToDb();c.unite=$(":input[name=lot-unite]").val();c.prix=$(":input[name=lot-prix]").val().numberFrToDb();var d=new ModeleLotValid();var f=d.validAjout(c);if(f.valid){Infobulle.init();var b=new GestionCommandeTemplate();var e=b.modeleLot;this.mIdLot--;c.id=this.mIdLot;c.sigleMonetaire=gSigleMonetaire;c.quantite=c.quantite.nombreFormate(2,","," ");c.prix=c.prix.nombreFormate(2,","," ");$("#lot-liste").append(this.affectLot($(e.template(c))));$(":input[name=lot-quantite], :input[name=lot-unite], :input[name=lot-prix]").val("")}else{Infobulle.generer(f,"pro-lot-")}};this.affectLot=function(b){b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);b=this.affectAjoutLotGestion(b);return b};this.affectAjoutLotGestion=function(b){var c=this;b.find(".btn-modifier-lot").click(function(){c.ajoutLotModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-valider-lot").click(function(){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())});b.find(".catalogue-input-lot").keyup(function(d){if(d.keyCode=="13"){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())}});b.find(".btn-annuler-lot").click(function(){c.ajoutLotAnnulerModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-supprimer-lot").click(function(){c.ajoutLotSupprimer($(this).closest("tr").find("#id-lot").text())});b.find(":checkbox").change(function(){if(!c.majUnite()){if($(this).attr("checked")){$(this).removeAttr("checked")}else{$(this).attr("checked","checked")}}});return b};this.majUnite=function(){var d=true;var c=0;var e="";$(".ligne-lot :checkbox:checked").each(function(){var g=$(this).closest(".ligne-lot").find(".lot-unite").text();if(e!=""&&e!=g){d=false}else{e=g}c++});if(d){if(c>0){$(".unite-stock").text(e)}}else{var f=new Object();var b=new VRerreur();b.code=ERR_333_CODE;b.message=ERR_333_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(b);Infobulle.generer(f,"")}return d};this.ajoutLotModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();$("#pro-lot-"+b+"-quantite").val($("#lot-"+b+"-quantite").text());$("#pro-lot-"+b+"-unite").val($("#lot-"+b+"-unite").text());$("#pro-lot-"+b+"-prix").val($("#lot-"+b+"-prix").text());this.mEditionLot=true};this.ajoutLotValiderModification=function(c){var b=new ModeleLotVO();b.quantite=$("#pro-lot-"+c+"-quantite").val().numberFrToDb();b.unite=$("#pro-lot-"+c+"-unite").val();b.prix=$("#pro-lot-"+c+"-prix").val().numberFrToDb();var d=new ModeleLotValid();var e=d.validAjout(b);if(e.valid){Infobulle.init();$("#lot-"+c+"-quantite").text(b.quantite.nombreFormate(2,","," "));$("#lot-"+c+"-unite").text(b.unite);$("#lot-"+c+"-prix").text(b.prix.nombreFormate(2,","," "));$(".btn-lot, #btn-annuler-lot-"+c+", #btn-valider-lot-"+c+", .champ-lot-"+c).toggle();this.mEditionLot=false;this.majUnite()}else{Infobulle.generer(e,"pro-lot-"+c+"-")}};this.ajoutLotAnnulerModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();this.mEditionLot=false};this.ajoutLotSupprimer=function(b){$("#ligne-lot-"+b).remove()};this.ajouterProduit=function(h){var f=this;if(!this.mEditionLot){var p=h.find(":input[name=ferme]").val();var m=h.find(":input[name=categorie]").val();var e=h.find(":input[name=produit]").val();if(e!=0){var k=h.find(":input[name=pro-stock]").val().numberFrToDb();var l=h.find(":input[name=pro-qte-max]").val().numberFrToDb();var b=h.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();var d={nproId:e,nproNom:h.find(":input[name=produit] option:selected").text(),nproStock:k,nproQteMax:l,nproUnite:b,modelesLot:[]};h.find(".ligne-lot :checkbox").each(function(){var q=false;if($(this).hasClass("modele-lot")){q=true}var s=false;if($(this).attr("checked")){s=true}if(q||s){var r=$(this).closest(".ligne-lot").find(".lot-id").text();var t={id:r,taille:$(this).closest(".ligne-lot").find(".lot-quantite").text(),prix:$(this).closest(".ligne-lot").find(".lot-prix").text(),unite:$(this).closest(".ligne-lot").find(".lot-unite").text(),selected:s,modele:q};d.modelesLot[r]=t}});if(!this.mAffichageMarche[p]){this.mAffichageMarche[p]={ferId:p,ferNom:h.find(":input[name=ferme] option:selected").text(),categories:[]}}if(!this.mAffichageMarche[p].categories[m]){this.mAffichageMarche[p].categories[m]={cproId:m,cproNom:h.find(":input[name=categorie] option:selected").text(),produits:[]}}var c=new ProduitMarcheVO();c.idNom=e;c.unite=b;c.qteMaxCommande=l;c.qteRestante=k;h.find(".ligne-lot :checkbox:checked").each(function(){var q=new DetailCommandeVO();q.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();q.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(q)});c.idFerme=p;c.idCategorie=m;var n=new ProduitMarcheValid();var g=n.validAjout(c);if(g.valid){Infobulle.init();this.mAffichageMarche[p].categories[m].produits[e]=d;this.mMarche.produits[e]=c;this.mNbProduit++;f.majListeFerme();h.dialog("close")}else{Infobulle.generer(g,"pro-")}}}else{var o=new Object();var j=new VRerreur();j.code=ERR_112_CODE;j.message=ERR_112_MSG;o.valid=false;o.log=new VRelement();o.log.valid=false;o.log.erreurs.push(j);Infobulle.generer(o,"")}};this.affectInitListeFerme=function(d){var e=this;var f=[];$(e.mAffichageMarche).each(function(){if(this.ferId){var h=[];$(this.categories).each(function(){if(this.cproId){var j=[];$(this.produits).each(function(){if(this.nproId){j.push([this.nproNom,this.nproId])}});j.sort(sortABC);h.push([this.cproNom,this.cproId,j])}});h.sort(sortABC);f.push([this.ferNom,this.ferId,h])}});f.sort(sortABC);var c={fermes:[]};$(f).each(function(j,m){var n=m[1];var l=m[2];if(e.mAffichageMarche[n]){var k=false;var h={ferId:e.mAffichageMarche[n].ferId,ferNom:e.mAffichageMarche[n].ferNom,categories:[]};$(l).each(function(o,s){var p=s[1];var t=s[2];if(e.mAffichageMarche[n].categories[p]){var r=false;var q={cproId:e.mAffichageMarche[n].categories[p].cproId,cproNom:e.mAffichageMarche[n].categories[p].cproNom,produits:[]};$(t).each(function(u,w){var v=w[1];if(e.mAffichageMarche[n].categories[p].produits[v]){q.produits.push({nproId:e.mAffichageMarche[n].categories[p].produits[v].nproId,nproNom:e.mAffichageMarche[n].categories[p].produits[v].nproNom});k=true;r=true}});if(r){h.categories.push(q)}}});if(k){c.fermes.push(h)}}});var b=new GestionCommandeTemplate();var g=b.ajoutMarcheListeProduit;d.find("#liste-ferme").replaceWith(this.affectListeProduit($(g.template(c))));if(this.mNbProduit>0){d.find("#liste-ferme").after(this.affectCeerMarche($(b.btnValiderAjoutMarche)))}return d};this.majListeFerme=function(){var d=this;var e=[];$(d.mAffichageMarche).each(function(){if(this.ferId){var g=[];$(this.categories).each(function(){if(this.cproId){var h=[];$(this.produits).each(function(){if(this.nproId){h.push([this.nproNom,this.nproId])}});h.sort(sortABC);g.push([this.cproNom,this.cproId,h])}});g.sort(sortABC);e.push([this.ferNom,this.ferId,g])}});e.sort(sortABC);var c={fermes:[]};$(e).each(function(h,l){var m=l[1];var k=l[2];if(d.mAffichageMarche[m]){var j=false;var g={ferId:d.mAffichageMarche[m].ferId,ferNom:d.mAffichageMarche[m].ferNom,categories:[]};$(k).each(function(n,r){var o=r[1];var s=r[2];if(d.mAffichageMarche[m].categories[o]){var q=false;var p={cproId:d.mAffichageMarche[m].categories[o].cproId,cproNom:d.mAffichageMarche[m].categories[o].cproNom,produits:[]};$(s).each(function(t,v){var u=v[1];if(d.mAffichageMarche[m].categories[o].produits[u]){p.produits.push({nproId:d.mAffichageMarche[m].categories[o].produits[u].nproId,nproNom:d.mAffichageMarche[m].categories[o].produits[u].nproNom});j=true;q=true}});if(q){g.categories.push(p)}}});if(j){c.fermes.push(g)}}});var b=new GestionCommandeTemplate();var f=b.ajoutMarcheListeProduit;$("#liste-ferme").replaceWith(this.affectListeProduit($(f.template(c))));if(this.mNbProduit>0){if($("#btn-gestion-marche").length<1){$("#liste-ferme").after(this.affectCeerMarche($(b.btnValiderAjoutMarche)))}}else{$("#btn-gestion-marche").remove()}};this.affectListeProduit=function(b){b=this.affectModifierProduit(b);b=this.affectSupprimerProduit(b);b=gCommunVue.comHoverBtn(b);return b};this.affectModifierProduit=function(b){var c=this;b.find(".btn-modifier-produit").click(function(){c.dialogModifierProduit($(this).attr("id-produit"))});return b};this.dialogModifierProduit=function(g){var f=this;var k=this.mMarche.produits[g].idFerme;var j=this.mMarche.produits[g].idCategorie;var d={ferId:k,ferNom:this.mAffichageMarche[k].ferNom,cproId:j,cproNom:this.mAffichageMarche[k].categories[j].cproNom,nproId:g,nproNom:this.mAffichageMarche[k].categories[j].produits[g].nproNom,nproStock:this.mAffichageMarche[k].categories[j].produits[g].nproStock,nproQteMax:this.mAffichageMarche[k].categories[j].produits[g].nproQteMax,modelesLot:[]};for(i in this.mAffichageMarche[k].categories[j].produits[g].modelesLot){var h=this.mAffichageMarche[k].categories[j].produits[g].modelesLot[i];if(h.id){var e={id:h.id,quantite:h.taille,prix:h.prix,unite:h.unite,sigleMonetaire:gSigleMonetaire};if(h.selected){e.checked='checked="checked"';d.unite=h.unite}else{e.checked=""}if(h.modele){e.modele="modele-lot"}else{e.modele=""}d.modelesLot.push(e)}}var b=new GestionCommandeTemplate();var c=b.dialogModifProduitAjoutMarche;$(f.affectPrixEtStock($(c.template(d)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Modifier:function(){f.modifierProduit($(this))},Annuler:function(){f.mEditionLot=false;$(this).dialog("close")}},close:function(l,m){$(this).remove();Infobulle.init()}})};this.modifierProduit=function(j){var g=this;if(!this.mEditionLot){var r=j.find("#pro-idFerme").attr("id-ferme");var o=j.find("#pro-idCategorie").attr("id-categorie");var e=j.find("#pro-idProduit").attr("id-produit");var m=j.find(":input[name=pro-stock]").val().numberFrToDb();var n=j.find(":input[name=pro-qte-max]").val().numberFrToDb();var b=j.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();var l="";if(m!=""){l=m.nombreFormate(2,","," ")}var f="";if(n!=""){f=n.nombreFormate(2,","," ")}var d={nproId:e,nproNom:this.mAffichageMarche[r].categories[o].produits[e].nproNom,nproStock:l,nproQteMax:f,nproUnite:b,modelesLot:[]};j.find(".ligne-lot :checkbox").each(function(){var s=false;if($(this).hasClass("modele-lot")){s=true}var u=false;if($(this).attr("checked")){u=true}if(s||u){var t=$(this).closest(".ligne-lot").find(".lot-id").text();var v={id:t,taille:$(this).closest(".ligne-lot").find(".lot-quantite").text(),prix:$(this).closest(".ligne-lot").find(".lot-prix").text(),unite:b,selected:u,modele:s};d.modelesLot[t]=v}});var c=new ProduitMarcheVO();c.idNom=e;c.unite=b;c.qteMaxCommande=n;c.qteRestante=m;j.find(".ligne-lot :checkbox:checked").each(function(){var s=new DetailCommandeVO();s.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();s.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(s)});c.idFerme=r;c.idCategorie=o;var p=new ProduitMarcheValid();var h=p.validAjout(c);if(h.valid){Infobulle.init();this.mAffichageMarche[r].categories[o].produits[e]=d;this.mMarche.produits[e]=c;g.majListeFerme();j.dialog("close")}else{Infobulle.generer(h,"pro-")}}else{var q=new Object();var k=new VRerreur();k.code=ERR_112_CODE;k.message=ERR_112_MSG;q.valid=false;q.log=new VRelement();q.log.valid=false;q.log.erreurs.push(k);Infobulle.generer(q,"")}};this.affectSupprimerProduit=function(b){var c=this;b.find(".btn-supprimer-produit").click(function(){c.supprimerProduit($(this).attr("id-produit"))});return b};this.supprimerProduit=function(b){var d=this.mMarche.produits[b].idFerme;var c=this.mMarche.produits[b].idCategorie;this.mMarche.produits.splice(b,1,null);this.mAffichageMarche[d].categories[c].produits.splice(b,1,null);this.mNbProduit--;this.majListeFerme()};this.affectCeerMarche=function(b){var c=this;b.find("#btn-creer-marche").click(function(){c.creerMarche()});b.find("#btn-modifier-creation-commande").click(function(){c.editerMarche()});return b};this.creerMarche=function(){var e=this;if(!this.mEditionLot){this.mMarche;this.mMarche.nom=$(":input[name=nom]").val();this.mMarche.description=$(":input[name=description]").val();this.mMarche.dateMarcheDebut=$(":input[name=date-debut]").val().dateFrToDb();this.mMarche.timeMarcheDebut=$(":input[name=heure-debut]").val()+":"+$(":input[name=minute-debut]").val()+":00";this.mMarche.dateMarcheFin=$(":input[name=date-debut]").val().dateFrToDb();this.mMarche.timeMarcheFin=$(":input[name=heure-fin]").val()+":"+$(":input[name=minute-fin]").val()+":00";this.mMarche.dateDebutReservation=$(":input[name=date-debut-reservation]").val().dateFrToDb();this.mMarche.timeDebutReservation=$(":input[name=heure-debut-reservation]").val()+":"+$(":input[name=minute-debut-reservation]").val()+":00";this.mMarche.dateFinReservation=$(":input[name=date-fin-reservation]").val().dateFrToDb();this.mMarche.timeFinReservation=$(":input[name=heure-fin-reservation]").val()+":"+$(":input[name=minute-fin-reservation]").val()+":00";this.mMarche.archive="0";if(this.mEtapeCreationMarche==0){var d=new MarcheValid();var f=d.validAjout(this.mMarche);if(f.valid){this.mEtapeCreationMarche=1;Infobulle.init();$("#nom-marche-span").text(this.mMarche.nom);$("#date-debut-reservation-marche-span").text($(":input[name=date-debut-reservation]").val());$("#time-debut-reservation-marche-span").text($(":input[name=heure-debut-reservation]").val()+"H"+$(":input[name=minute-debut-reservation]").val());$("#date-fin-reservation-marche-span").text($(":input[name=date-fin-reservation]").val());$("#time-fin-reservation-marche-span").text($(":input[name=heure-fin-reservation]").val()+"H"+$(":input[name=minute-fin-reservation]").val());$("#date-debut-marche-span").text($(":input[name=date-debut]").val());$("#time-debut-marche-span").text($(":input[name=heure-debut]").val()+"H"+$(":input[name=minute-debut]").val());$("#time-fin-marche-span").text($(":input[name=heure-fin]").val()+"H"+$(":input[name=minute-fin]").val());$("#description-marche-span").text(this.mMarche.description);$("#btn-ajout-produit-div, .informations-marche, #btn-modifier-creation-commande, .btn-modifier-produit, .btn-supprimer-produit").toggle()}else{Infobulle.generer(f,"marche-")}}else{if(this.mEtapeCreationMarche==1){var g=[];$(this.mMarche.produits).each(function(){if(this.idNom){var h=[];$(this.lots).each(function(){if(this.taille){h.push(this)}});this.lots=h;g.push(this)}});this.mMarche.produits=g;var c=this.mMarche;c.fonction="ajouter";$.post("./index.php?m=GestionCommande&v=AjoutCommande","pParam="+$.toJSON(c),function(j){if(j){if(j.valid){var k=new Object();var h=new VRerreur();h.code=ERR_334_CODE;h.message=ERR_334_MSG;k.valid=false;k.log=new VRelement();k.log.valid=false;k.log.erreurs.push(h);EditerCommandeVue({id_commande:j.id,vr:k})}else{e.editerMarche();Infobulle.generer(j,"marche-")}}},"json")}}}else{var f=new Object();var b=new VRerreur();b.code=ERR_112_CODE;b.message=ERR_112_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(b);Infobulle.generer(f,"")}};this.editerMarche=function(){this.mEtapeCreationMarche=0;$("#btn-ajout-produit-div, .informations-marche, #btn-modifier-creation-commande, .btn-modifier-produit, .btn-supprimer-produit").toggle()};this.affectControleDatepicker=function(b){b=gCommunVue.lienDatepickerMarche("marche-dateDebutReservation","marche-dateFinReservation","marche-dateMarcheDebut",b);b.find("#marche-dateDebutReservation").datepicker("setDate",getDateAujourdhuiDb().dateDbToFr());b.find("#marche-dateFinReservation").datepicker("option","minDate",new Date());b.find("#marche-dateMarcheDebut").datepicker("option","minDate",new Date());return b};this.construct(a)}function EditerCommandeVue(a){this.mIdMarche=null;this.mMarche=null;this.mListeFerme=null;this.mEditionLot=false;this.mIdLot=0;this.mNbProduit=0;this.mProduits=[];this.mParam=null;this.construct=function(b){$.history({vue:function(){EditerCommandeVue(b)}});this.mParam=b;var c=this;b.fonction="afficher";$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){c.afficher(d);if(b.vr){Infobulle.generer(b.vr,"")}}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(f){var g=this;var e={};e.comId=f.marche.id;this.mIdMarche=e.comId;e.comNumero=f.marche.numero;e.nom=f.marche.nom;e.comDescription=f.marche.description;e.dateTimeDebutReservation=f.marche.dateDebutReservation;e.dateDebutReservation=f.marche.dateDebutReservation.extractDbDate().dateDbToFr();e.heureDebutReservation=f.marche.dateDebutReservation.extractDbHeure();e.minuteDebutReservation=f.marche.dateDebutReservation.extractDbMinute();e.dateTimeFinReservation=f.marche.dateFinReservation;e.dateFinReservation=f.marche.dateFinReservation.extractDbDate().dateDbToFr();e.heureFinReservation=f.marche.dateFinReservation.extractDbHeure();e.minuteFinReservation=f.marche.dateFinReservation.extractDbMinute();e.dateMarcheDebut=f.marche.dateMarcheDebut.extractDbDate().dateDbToFr();e.heureMarcheDebut=f.marche.dateMarcheDebut.extractDbHeure();e.minuteMarcheDebut=f.marche.dateMarcheDebut.extractDbMinute();e.heureMarcheFin=f.marche.dateMarcheFin.extractDbHeure();e.minuteMarcheFin=f.marche.dateMarcheFin.extractDbMinute();e.archive=f.marche.archive;var d=[];$.each(f.marche.produits,function(){var o=this.ferId;var l=this.idCategorie;var k=this.idNom;var m=parseFloat(this.stockInitial)-parseFloat(this.stockReservation);if(this.stockInitial==-1){m++}var n={id:this.id,nproId:k,nproNom:this.nom,nproStock:this.stockInitial,nproQteMax:this.qteMaxCommande,nproUnite:this.unite,qteReservation:m};if(!d[o]){d[o]={ferId:o,ferNom:this.ferNom,categories:[]}}if(!d[o].categories[l]){d[o].categories[l]={cproId:l,cproNom:this.cproNom,produits:[]}}d[o].categories[l].produits[k]=n;g.mNbProduit++});var h=[];$(d).each(function(){if(this.ferId){var k=[];$(this.categories).each(function(){if(this.cproId){var l=[];$(this.produits).each(function(){if(this.nproId){l.push([this.nproNom,this.nproId])}});l.sort(sortABC);k.push([this.cproNom,this.cproId,l])}});k.sort(sortABC);h.push([this.ferNom,this.ferId,k])}});h.sort(sortABC);this.mListeFerme={fermes:[]};$(h).each(function(l,o){var p=o[1];var n=o[2];if(d[p]){var m=false;var k={ferId:d[p].ferId,ferNom:d[p].ferNom,categories:[]};$(n).each(function(q,u){var r=u[1];var v=u[2];if(d[p].categories[r]){var t=false;var s={cproId:d[p].categories[r].cproId,cproNom:d[p].categories[r].cproNom,produits:[]};$(v).each(function(w,y){var x=y[1];if(d[p].categories[r].produits[x]){s.produits.push({id:d[p].categories[r].produits[x].id,nproId:d[p].categories[r].produits[x].nproId,nproNom:d[p].categories[r].produits[x].nproNom,nproUnite:d[p].categories[r].produits[x].nproUnite,qteReservation:d[p].categories[r].produits[x].qteReservation});m=true;t=true}});if(t){k.categories.push(s)}}});if(m){g.mListeFerme.fermes.push(k)}}});e.listeAdherentCommande=f.listeAdherentCommande;e.sigleMonetaire=gSigleMonetaire;this.mMarche=e;this.mMarche.produits=[];$.each(f.marche.produits,function(){g.mMarche.produits[this.idNom]=1});var c=new GestionCommandeTemplate();var j=c.editerCommandePage;var b=g.affect($(j.template(e)));$("#contenu").replaceWith(b)};this.affect=function(b){b=this.affectTri(b);b=this.affectRecherche(b);b=this.affectModifier(b);b=this.affectDupliquerMarche(b);b=this.affectExportReservation(b);b=this.affectBonDeCommande(b);b=this.affectBonDeLivraison(b);b=this.affectArchive(b);b=this.affectListeAchatEtReservation(b);b=this.affectListeReservation(b);b=this.affectMajListeFerme(b);b=this.affectDialogAjoutProduit(b);b=gCommunVue.comHoverBtn(b);b=this.affectInformation(b);return b};this.affectInformation=function(b){var c=this;b.find("#btn-information-marche").click(function(){c.construct(c.mParam)});return b};this.affectTri=function(b){b.find(".com-table").tablesorter({sortList:[[2,0]]});return b};this.affectRecherche=function(b){b.find("#filter").keyup(function(){$.uiTableFilter($(".com-table"),this.value)});b.find("#filter-form").submit(function(){return false});return b};this.affectReservation=function(b){var c=this;b.find(".edt-com-reservation-ligne").click(function(){ReservationAdherentVue({id_commande:c.mIdMarche,id_adherent:$(this).find(".id-adherent").text()})});return b};this.affectModifier=function(b){var c=this;b.find("#btn-modif-com").click(function(){c.dialogModifierInformationMarche()});return b};this.affectBonDeCommande=function(b){var c=this;b.find("#btn-bon-com").click(function(){BonDeCommandeVue({id_commande:c.mIdMarche})});return b};this.affectBonDeLivraison=function(b){var c=this;b.find("#btn-livraison-com").click(function(){BonDeLivraisonVue({id_commande:c.mIdMarche})});return b};this.affectDupliquerMarche=function(b){var c=this;b.find("#btn-dupliquer-com").click(function(){DupliquerMarcheVue({id_commande:c.mIdMarche})});return b};this.affectArchive=function(b){if(this.mMarche.archive==0){b.find(".marche-archive-0").show()}else{if(this.mMarche.archive==1){b.find(".marche-archive-1").show()}}b=this.affectPause(b);b=this.affectPlay(b);b=this.affectCloturer(b);return b};this.modifierArchive=function(){if(this.mMarche.archive==0){$(".marche-archive-0").show();$(".marche-archive-1").hide()}else{if(this.mMarche.archive==1){$(".marche-archive-0").hide();$(".marche-archive-1").show()}}};this.affectCloturer=function(b){var c=this;b.find("#btn-cloture-com").click(function(){var d=new GestionCommandeTemplate();var e=d.dialogClotureCommande;$(e.template(c.mMarche)).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Cloturer:function(){var f={id_commande:c.mIdMarche,fonction:"cloturer"};var g=this;$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(f),function(k){Infobulle.init();if(k){if(k.valid){var l=new TemplateVR();l.valid=false;l.log.valid=false;var j=new VRerreur();j.code=ERR_313_CODE;j.message=ERR_313_MSG;l.log.erreurs.push(j);var h={id_commande:c.mIdMarche,vr:l};InfoCommandeArchiveVue(h);$(g).dialog("close")}else{Infobulle.generer(k,"")}}},"json")},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}})});return b};this.affectPause=function(b){var c=this;b.find("#btn-pause-com").click(function(){var d={id_commande:c.mIdMarche,fonction:"pause"};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(d),function(f){Infobulle.init();if(f){if(f.valid){c.mMarche.archive=1;c.modifierArchive();var g=new TemplateVR();g.valid=false;g.log.valid=false;var e=new VRerreur();e.code=ERR_311_CODE;e.message=ERR_311_MSG;g.log.erreurs.push(e);Infobulle.generer(g,"")}else{Infobulle.generer(f,"")}}},"json")});return b};this.affectPlay=function(b){var c=this;b.find("#btn-play-com").click(function(){var d={id_commande:c.mIdMarche,fonction:"play"};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(d),function(f){Infobulle.init();if(f){if(f.valid){c.mMarche.archive=0;c.modifierArchive();var g=new TemplateVR();g.valid=false;g.log.valid=false;var e=new VRerreur();e.code=ERR_312_CODE;e.message=ERR_312_MSG;g.log.erreurs.push(e);Infobulle.generer(g,"")}else{Infobulle.generer(f,"")}}},"json")});return b};this.affectExportReservation=function(b){var c=this;b.find("#btn-export-resa").click(function(){var d=new GestionCommandeTemplate();var e=d.dialogExportListeReservation;$(e.template(c.mListeFerme)).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Exporter:function(){var h="";$(this).find(":input[name=id_produits]:checked").each(function(){h+=$(this).val()+","});h=h.substr(0,h.length-1);var f=$(this).find(":input[name=format]:checked").val();var j=new ExportListeReservationVO();j={fonction:"exportReservation",id_commande:c.mIdMarche,id_produits:h,format:f};var g=new ExportListeReservationValid();var k=g.validAjout(j);Infobulle.init();if(k.valid){$.download("./index.php?m=GestionCommande&v=EditerCommande",j)}else{Infobulle.generer(k,"")}},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}})});return b};this.affectListeAchatEtReservation=function(b){var c=this;b.find("#btn-liste-achat-resa").click(function(){c.afficherAchatEtReservation()});return b};this.affectAchatEtReservation=function(b){b=this.affectTri(b);b=this.affectRecherche(b);b=this.affectAchat(b);b=this.affectExportDataEtReservation(b);return b};this.affectAchat=function(b){var c=this;b.find(".edt-com-achat-ligne").click(function(){AchatAdherentVue({id_commande:c.mIdMarche,id_adherent:$(this).find(".id-adherent").text()})});return b};this.afficherAchatEtReservation=function(){var b=this;var c={id_commande:this.mIdMarche,fonction:"listeAchatReservation"};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(c),function(e){Infobulle.init();if(e){if(e.valid){$("#edt-com-nav-resa-achat span").removeClass("ui-state-active");$("#btn-liste-achat-resa").addClass("ui-state-active");$(e.listeAchatEtReservation).each(function(){if(this.reservation==null){this.reservation=""}if(this.achat==null){this.achat=""}});var d=new GestionCommandeTemplate();if(e.listeAchatEtReservation.length>0&&e.listeAchatEtReservation[0].adhId!=null){var f=d.listeAchatEtReservation;$("#edt-com-liste").replaceWith(b.affectAchatEtReservation($(f.template(e))))}else{$("#edt-com-liste").replaceWith(d.listeAchatEtReservationVide)}}else{Infobulle.generer(e,"")}}},"json")};this.affectExportDataEtReservation=function(b){var c=this;b.find("#btn-export-achat").click(function(){var d=new GestionCommandeTemplate();var e=d.dialogExportListeAchatEtReservation;$(e.template(c.mMarche)).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Exporter:function(){lParam={fonction:"exportAchatEtReservation",id_commande:c.mIdMarche};$.download("./index.php?m=GestionCommande&v=EditerCommande",lParam)},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}})});return b};this.affectListeReservation=function(b){var c=this;b.find("#btn-liste-resa").click(function(){c.afficherListeReservation()});return b};this.affectReservationAction=function(b){b=this.affectTri(b);b=this.affectRecherche(b);b=this.affectExportReservation(b);b=this.affectReservation(b);return b};this.afficherListeReservation=function(){var b=this;var c={id_commande:this.mIdMarche,fonction:"listeReservation"};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(c),function(f){Infobulle.init();if(f){if(f.valid){$("#edt-com-nav-resa-achat span").removeClass("ui-state-active");$("#btn-liste-resa").addClass("ui-state-active");var e=new GestionCommandeTemplate();var g=e.listeReservation;var d=b.affectReservationAction($(g.template(f)));if(!(f.listeAdherentCommande.length>0&&f.listeAdherentCommande[0].adhId!=null)){d.find("#edt-com-recherche").hide();d.find("#edt-com-liste-resa").replaceWith(e.listeReservationVide)}$("#edt-com-liste").replaceWith(d)}else{Infobulle.generer(f,"")}}},"json")};this.affectMajListeFerme=function(c){var d=this;var b=new GestionCommandeTemplate();var e=b.editerMarcheListeProduit;c.find("#liste-ferme").replaceWith(d.affectGestionProduit($(e.template(d.mListeFerme))));return c};this.affectGestionProduit=function(b){b=this.affectModifierProduit(b);b=this.affectSupprimerProduit(b);return b};this.affectModifierProduit=function(b){var c=this;b.find(".btn-modifier-produit").click(function(){c.dialogModifierProduit($(this).attr("id-produit"))});return b};this.dialogModifierProduit=function(b){var c=this;var d={fonction:"detailProduitMarche",id:b};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(d),function(j){if(j){if(j.valid){var m=j.produit.ferId;var h=j.produit.idCategorie;var k="";if(parseFloat(j.produit.stockInitial)!=-1){k=j.produit.stockInitial.nombreFormate(2,","," ")}var f="";if(parseFloat(j.produit.qteMaxCommande)!=-1){f=j.produit.qteMaxCommande.nombreFormate(2,","," ")}var g={ferId:m,ferNom:j.produit.ferNom,cproId:h,cproNom:j.produit.cproNom,nproId:b,nproNom:j.produit.nom,unite:j.produit.unite,nproStock:k,nproQteMax:f,modelesLot:[]};$(j.modelesLot).each(function(){if(this.mLotId!=null){var n={id:this.mLotId,quantite:this.mLotQuantite.nombreFormate(2,","," "),prix:this.mLotPrix.nombreFormate(2,","," "),unite:this.mLotUnite,sigleMonetaire:gSigleMonetaire,modele:"modele-lot",checked:""};g.modelesLot.push(n)}});$(j.produit.lots).each(function(){var n={id:this.id,quantite:this.taille.nombreFormate(2,","," "),prix:this.prix.nombreFormate(2,","," "),unite:j.produit.unite,sigleMonetaire:gSigleMonetaire,modele:"",checked:'checked="checked"'};g.modelesLot.push(n)});if(j.produit.qteRestante==""||j.produit.stockInitial==-1){g.nproStockCheckedNoLimit='checked="checked"';g.nproStockDisabled='disabled="disabled"'}else{g.nproStockCheckedLimit='checked="checked"'}if(j.produit.qteMaxCommande==""||j.produit.qteMaxCommande==-1){g.nproQteMaxCheckedNoLimit='checked="checked"';g.nproQteMaxDisabled='disabled="disabled"'}else{g.nproQteMaxCheckedLimit='checked="checked"'}var e=new GestionCommandeTemplate();var l=e.dialogModifProduitAjoutMarche;$(c.affectPrixEtStock($(l.template(g)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Modifier:function(){c.modifierProduit($(this))},Annuler:function(){c.mEditionLot=false;$(this).dialog("close")}},close:function(n,o){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(j,"marche-")}}},"json")};this.affectPrixEtStock=function(b){b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);b=this.affectAjoutLotGestion(b);b=this.affectAjoutLot(b);b=this.affectLimiteStock(b);return b};this.affectLimiteStock=function(b){b.find(":input[name=pro-stock-choix]").change(function(){if($(":input[name=pro-stock-choix]:checked").val()==1){$(":input[name=pro-stock]").attr("disabled","").val("")}else{$(":input[name=pro-stock]").attr("disabled","disabled").val("")}});b.find(":input[name=pro-qte-max-choix]").change(function(){if($(":input[name=pro-qte-max-choix]:checked").val()==1){$(":input[name=pro-qte-max]").attr("disabled","").val("")}else{$(":input[name=pro-qte-max]").attr("disabled","disabled").val("")}});return b};this.affectAjoutLot=function(b){var c=this;b.find("#btn-ajout-lot").click(function(){c.ajoutLot()});b.find("#table-pro-prix input").keyup(function(d){if(d.keyCode=="13"){c.ajoutLot()}});return b};this.ajoutLot=function(){var c=new ModeleLotVO();c.quantite=$(":input[name=lot-quantite]").val().numberFrToDb();c.unite=$(":input[name=lot-unite]").val();c.prix=$(":input[name=lot-prix]").val().numberFrToDb();var d=new ModeleLotValid();var f=d.validAjout(c);if(f.valid){Infobulle.init();var b=new GestionCommandeTemplate();var e=b.modeleLot;this.mIdLot--;c.id=this.mIdLot;c.sigleMonetaire=gSigleMonetaire;c.quantite=c.quantite.nombreFormate(2,","," ");c.prix=c.prix.nombreFormate(2,","," ");$("#lot-liste").append(this.affectLot($(e.template(c))));$(":input[name=lot-quantite], :input[name=lot-unite], :input[name=lot-prix]").val("")}else{Infobulle.generer(f,"pro-lot-")}};this.affectLot=function(b){b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);b=this.affectAjoutLotGestion(b);return b};this.affectAjoutLotGestion=function(b){var c=this;b.find(".btn-modifier-lot").click(function(){c.ajoutLotModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-valider-lot").click(function(){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())});b.find(".catalogue-input-lot").keyup(function(d){if(d.keyCode=="13"){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())}});b.find(".btn-annuler-lot").click(function(){c.ajoutLotAnnulerModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-supprimer-lot").click(function(){c.ajoutLotSupprimer($(this).closest("tr").find("#id-lot").text())});b.find(":checkbox").change(function(){if(!c.majUnite()){if($(this).attr("checked")){$(this).removeAttr("checked")}else{$(this).attr("checked","checked")}}});return b};this.majUnite=function(){var d=true;var c=0;var e="";$(".ligne-lot :checkbox:checked").each(function(){var g=$(this).closest(".ligne-lot").find(".lot-unite").text();if(e!=""&&e!=g){d=false}else{e=g}c++});if(d){if(c>0){$(".unite-stock").text(e)}}else{var f=new Object();var b=new VRerreur();b.code=ERR_333_CODE;b.message=ERR_333_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(b);Infobulle.generer(f,"")}return d};this.ajoutLotModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();$("#pro-lot-"+b+"-quantite").val($("#lot-"+b+"-quantite").text());$("#pro-lot-"+b+"-unite").val($("#lot-"+b+"-unite").text());$("#pro-lot-"+b+"-prix").val($("#lot-"+b+"-prix").text());this.mEditionLot=true};this.ajoutLotValiderModification=function(c){var b=new ModeleLotVO();b.quantite=$("#pro-lot-"+c+"-quantite").val().numberFrToDb();b.unite=$("#pro-lot-"+c+"-unite").val();b.prix=$("#pro-lot-"+c+"-prix").val().numberFrToDb();var d=new ModeleLotValid();var e=d.validAjout(b);if(e.valid){Infobulle.init();$("#lot-"+c+"-quantite").text(b.quantite.nombreFormate(2,","," "));$("#lot-"+c+"-unite").text(b.unite);$("#lot-"+c+"-prix").text(b.prix.nombreFormate(2,","," "));$(".btn-lot, #btn-annuler-lot-"+c+", #btn-valider-lot-"+c+", .champ-lot-"+c).toggle();this.mEditionLot=false;this.majUnite()}else{Infobulle.generer(e,"pro-lot-"+c+"-")}};this.ajoutLotAnnulerModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();this.mEditionLot=false};this.ajoutLotSupprimer=function(b){$("#ligne-lot-"+b).remove()};this.modifierProduit=function(f){var d=this;if(!this.mEditionLot){var h=f.find(":input[name=pro-stock]").val().numberFrToDb();if(f.find(":input[name=pro-stock-choix]:checked").val()==1&&h==""){var l=new Object();var g=new VRerreur();g.code=ERR_201_CODE;g.message=ERR_201_MSG;l.valid=false;l.qteRestante=new VRelement();l.qteRestante.valid=false;l.qteRestante.erreurs.push(g);Infobulle.generer(l,"pro-")}else{var j=f.find(":input[name=pro-qte-max]").val().numberFrToDb();if(f.find(":input[name=pro-qte-max-choix]:checked").val()==1&&j==""){var l=new Object();var g=new VRerreur();g.code=ERR_201_CODE;g.message=ERR_201_MSG;l.valid=false;l.qteMaxCommande=new VRelement();l.qteMaxCommande.valid=false;l.qteMaxCommande.erreurs.push(g);Infobulle.generer(l,"pro-")}else{var b=f.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();var c=new ProduitMarcheVO();c.id=f.find("#pro-idProduit").attr("id-produit");c.unite=b;c.qteMaxCommande=j;c.qteRestante=h;f.find(".ligne-lot :checkbox:checked").each(function(){var m=new DetailCommandeVO();m.id=$(this).closest(".ligne-lot").find(".lot-id").text();m.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();m.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(m)});var k=new ProduitMarcheValid();var e=k.validUpdate(c);if(e.valid){Infobulle.init();c.fonction="modifierProduitMarche";$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(c),function(n){if(n){if(n.valid){var o=new Object();var m=new VRerreur();m.code=ERR_330_CODE;m.message=ERR_330_MSG;o.valid=false;o.log=new VRelement();o.log.valid=false;o.log.erreurs.push(m);Infobulle.generer(o,"");f.dialog("close");d.construct({id_commande:d.mIdMarche,vr:o})}else{Infobulle.generer(n,"pro-")}}},"json")}else{Infobulle.generer(e,"pro-")}}}}else{var l=new Object();var g=new VRerreur();g.code=ERR_112_CODE;g.message=ERR_112_MSG;l.valid=false;l.log=new VRelement();l.log.valid=false;l.log.erreurs.push(g);Infobulle.generer(l,"")}};this.affectSupprimerProduit=function(b){var c=this;b.find(".btn-supprimer-produit").click(function(){var d=$(this).attr("id-produit");if($(this).attr("qte-reservation")>0){c.dialogConfirmationSupprimerProduit(d)}else{c.supprimerProduit(d)}});return b};this.dialogConfirmationSupprimerProduit=function(c){var d=this;var b=new GestionCommandeTemplate();$(b.dialogSupprimerProduit).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Supprimer:function(){d.supprimerProduit(c)},Annuler:function(){$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.supprimerProduit=function(b){var c=this;var d={fonction:"supprimerProduitMarche",id:b};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(d),function(f){if(f){if(f.valid){c.mNbProduit--;var g=new Object();var e=new VRerreur();e.code=ERR_331_CODE;e.message=ERR_331_MSG;g.valid=false;g.log=new VRelement();g.log.valid=false;g.log.erreurs.push(e);Infobulle.generer(g,"");$("#dialog-supprimer-produit").dialog("close");c.construct({id_commande:c.mIdMarche,vr:g})}else{Infobulle.generer(f,"marche-")}}},"json")};this.dialogModifierInformationMarche=function(){var d=this;var c=new GestionCommandeTemplate();var b=$(c.dialogModifierInfoMarche.template(d.mMarche));b.find(":input[name=heure-debut]").selectOptions(d.mMarche.heureMarcheDebut);b.find(":input[name=minute-debut]").selectOptions(d.mMarche.minuteMarcheDebut);b.find(":input[name=heure-fin]").selectOptions(d.mMarche.heureMarcheFin);b.find(":input[name=minute-fin]").selectOptions(d.mMarche.minuteMarcheFin);b.find(":input[name=heure-debut-reservation]").selectOptions(d.mMarche.heureDebutReservation);b.find(":input[name=minute-debut-reservation]").selectOptions(d.mMarche.minuteDebutReservation);b.find(":input[name=heure-fin-reservation]").selectOptions(d.mMarche.heureFinReservation);b.find(":input[name=minute-fin-reservation]").selectOptions(d.mMarche.minuteFinReservation);b=gCommunVue.lienDatepickerMarche("marche-dateDebutReservation","marche-dateFinReservation","marche-dateMarcheDebut",b);b.find("#marche-dateDebutReservation").datepicker("option","maxDate",d.mMarche.dateFinReservation);b.find("#marche-dateFinReservation").datepicker("option","minDate",d.mMarche.dateDebutReservation).datepicker("option","maxDate",d.mMarche.dateMarcheDebut);b.find("#marche-dateMarcheDebut").datepicker("option","minDate",d.mMarche.dateFinReservation);$(b).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:800,buttons:{Modifier:function(){d.modifierInformationMarche($(this))},Annuler:function(){$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.modifierInformationMarche=function(b){var e=this;var c=new MarcheVO();c.id=this.mMarche.comId;c.nom=b.find(":input[name=nom]").val();c.description=b.find(":input[name=description]").val();c.dateMarcheDebut=b.find(":input[name=date-debut]").val().dateFrToDb();c.timeMarcheDebut=b.find(":input[name=heure-debut]").val()+":"+b.find(":input[name=minute-debut]").val()+":00";c.dateMarcheFin=b.find(":input[name=date-debut]").val().dateFrToDb();c.timeMarcheFin=b.find(":input[name=heure-fin]").val()+":"+b.find(":input[name=minute-fin]").val()+":00";c.dateDebutReservation=b.find(":input[name=date-debut-reservation]").val().dateFrToDb();c.timeDebutReservation=b.find(":input[name=heure-debut-reservation]").val()+":"+b.find(":input[name=minute-debut-reservation]").val()+":00";c.dateFinReservation=b.find(":input[name=date-fin-reservation]").val().dateFrToDb();c.timeFinReservation=b.find(":input[name=heure-fin-reservation]").val()+":"+b.find(":input[name=minute-fin-reservation]").val()+":00";var d=new MarcheValid();var f=d.validUpdateInformation(c);if(f.valid){c.fonction="modifierInformationMarche";$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(c),function(j){if(j){if(j.valid){e.mMarche.nom=c.nom;e.mMarche.comDescription=c.description;var g=c.dateDebutReservation+" "+c.timeDebutReservation;e.mMarche.dateDebutReservation=g.extractDbDate().dateDbToFr();e.mMarche.heureDebutReservation=g.extractDbHeure();e.mMarche.minuteDebutReservation=g.extractDbMinute();g=c.dateFinReservation+" "+c.timeFinReservation;e.mMarche.dateFinReservation=g.extractDbDate().dateDbToFr();e.mMarche.heureFinReservation=g.extractDbHeure();e.mMarche.minuteFinReservation=g.extractDbMinute();g=c.dateMarcheDebut+" "+c.timeMarcheDebut;e.mMarche.dateMarcheDebut=g.extractDbDate().dateDbToFr();e.mMarche.heureMarcheDebut=g.extractDbHeure();e.mMarche.minuteMarcheDebut=g.extractDbMinute();g=c.dateMarcheDebut+" "+c.timeMarcheFin;e.mMarche.heureMarcheFin=g.extractDbHeure();e.mMarche.minuteMarcheFin=g.extractDbMinute();$("#edt-marche-dateDebutReservation").text(e.mMarche.dateDebutReservation);$("#edt-marche-heureDebutReservation").text(e.mMarche.heureDebutReservation);$("#edt-marche-minuteDebutReservation").text(e.mMarche.minuteDebutReservation);$("#edt-marche-dateFinReservation").text(e.mMarche.dateFinReservation);$("#edt-marche-heureFinReservation").text(e.mMarche.heureFinReservation);$("#edt-marche-minuteFinReservation").text(e.mMarche.minuteFinReservation);$("#edt-marche-dateMarcheDebut").text(e.mMarche.dateMarcheDebut);$("#edt-marche-heureMarcheDebut").text(e.mMarche.heureMarcheDebut);$("#edt-marche-minuteMarcheDebut").text(e.mMarche.minuteMarcheDebut);$("#edt-marche-heureMarcheFin").text(e.mMarche.heureMarcheFin);$("#edt-marche-minuteMarcheFin").text(e.mMarche.minuteMarcheFin);b.dialog("close");var k=new Object();var h=new VRerreur();h.code=ERR_335_CODE;h.message=ERR_335_MSG;k.valid=false;k.log=new VRelement();k.log.valid=false;k.log.erreurs.push(h);Infobulle.generer(k,"")}else{Infobulle.generer(j,"marche-")}}},"json")}else{Infobulle.generer(f,"marche-")}};this.affectDialogAjoutProduit=function(b){var c=this;b.find("#btn-ajout-produit").click(function(){var d={fonction:"listeFerme"};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(d),function(f){if(f){if(f.valid){Infobulle.init();var e=new GestionCommandeTemplate();var g=e.dialogAjoutProduitAjoutMarche;$(c.affectAjoutProduitSelectFerme($(g.template(f)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Ajouter:function(){c.ajouterProduit($(this))},Annuler:function(){c.mEditionLot=false;$(this).dialog("close")}},close:function(h,j){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(f,"")}}},"json")});return b};this.affectAjoutProduitSelectFerme=function(b){var c=this;b.find("#pro-idFerme select").change(function(){var e=$(this).val();$("#pro-idCategorie select, #pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#prix-stock-produit").replaceWith('<div id="prix-stock-produit"></div>');if(e>0){var d={fonction:"listeProduit",id:e};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(d),function(j){if(j){if(j.valid){Infobulle.init();if(j.listeProduit.length>0&&j.listeProduit[0].nproId!=null){c.mProduits=[];var h=0;var l=[];$.each(j.listeProduit,function(){if(c.mProduits[this.cproId]){c.mProduits[this.cproId].listeProduit.push(this)}else{c.mProduits[this.cproId]={nom:this.cproNom,listeProduit:[this]}}if(h!=this.cproId){l.push({cproId:this.cproId,cproNom:this.cproNom});h=this.cproId}});var f=new GestionCommandeTemplate();var k=f.ajoutProduitSelectCategorie;$("#pro-idCategorie").replaceWith(c.affectAjoutProduitSelectCategorie($(k.template({listeCategorie:l}))))}else{var m=new TemplateVR();m.valid=false;m.log.valid=false;var g=new VRerreur();g.code=ERR_332_CODE;g.message=ERR_332_MSG;m.log.erreurs.push(g);Infobulle.generer(m,"")}}else{Infobulle.generer(j,"")}}},"json")}});return b};this.affectAjoutProduitSelectCategorie=function(b){var c=this;b.find("select").change(function(){$("#pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#prix-stock-produit").replaceWith('<div id="prix-stock-produit"></div>');var f=$(this).val();if(f>0){var d=new GestionCommandeTemplate();var e=d.ajoutProduitSelectProduit;$("#pro-idProduit").replaceWith(c.affectAjoutProduitSelectProduit($(e.template(c.mProduits[f]))))}});return b};this.affectAjoutProduitSelectProduit=function(b){var c=this;b.find("select").change(function(){var g=$(this).val();if(g>0){if(!c.mMarche.produits[g]){var e={fonction:"listeModeleLot",idNomProduit:g};$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(e),function(k){if(k){if(k.valid){Infobulle.init();var j={sigleMonetaire:gSigleMonetaire};if(k.modelesLot.length>0&&k.modelesLot[0].mLotId!=null){j.modelesLot=[];$(k.modelesLot).each(function(){if(this.mLotId!=null){this.id=this.mLotId;this.quantite=this.mLotQuantite.nombreFormate(2,","," ");this.unite=this.mLotUnite;this.prix=this.mLotPrix.nombreFormate(2,","," ");this.sigleMonetaire=gSigleMonetaire;j.modelesLot.push(this);j.unite=this.mLotUnite}})}var h=new GestionCommandeTemplate();var l=h.prixEtStockAjoutProduit;$("#prix-stock-produit").replaceWith(c.affectPrixEtStock($(l.template(j))))}else{Infobulle.generer(k,"")}}},"json")}else{var f=new Object();var d=new VRerreur();d.code=ERR_211_CODE;d.message=ERR_211_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(d);Infobulle.generer(f,"")}}else{$("#prix-stock-produit").replaceWith($('<div id="prix-stock-produit">'))}});return b};this.ajouterProduit=function(g){var e=this;if(!this.mEditionLot){var n=g.find(":input[name=ferme]").val();var l=g.find(":input[name=categorie]").val();var d=g.find(":input[name=produit]").val();if(d!=0){var k=g.find(":input[name=pro-stock]").val().numberFrToDb();if(g.find(":input[name=pro-stock-choix]:checked").val()==1&&k==""){var o=new Object();var h=new VRerreur();h.code=ERR_201_CODE;h.message=ERR_201_MSG;o.valid=false;o.qteRestante=new VRelement();o.qteRestante.valid=false;o.qteRestante.erreurs.push(h);Infobulle.generer(o,"pro-")}else{var j=g.find(":input[name=pro-qte-max]").val().numberFrToDb();if(g.find(":input[name=pro-qte-max-choix]:checked").val()==1&&j==""){var o=new Object();var h=new VRerreur();h.code=ERR_201_CODE;h.message=ERR_201_MSG;o.valid=false;o.qteMaxCommande=new VRelement();o.qteMaxCommande.valid=false;o.qteMaxCommande.erreurs.push(h);Infobulle.generer(o,"pro-")}else{var b=g.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();var c=new ProduitMarcheVO();c.id=e.mIdMarche;c.idNom=d;c.unite=b;c.qteMaxCommande=j;c.qteRestante=k;g.find(".ligne-lot :checkbox:checked").each(function(){var p=new DetailCommandeVO();p.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();p.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(p)});var m=new CommandeCompleteValid();var f=m.validAjoutProduit(c);if(f.valid){Infobulle.init();c.fonction="ajouterProduitMarche";$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(c),function(q){if(q){if(q.valid){var r=new Object();var p=new VRerreur();p.code=ERR_329_CODE;p.message=ERR_329_MSG;r.valid=false;r.log=new VRelement();r.log.valid=false;r.log.erreurs.push(p);Infobulle.generer(r,"");g.dialog("close");e.construct({id_commande:e.mIdMarche,vr:r})}else{Infobulle.generer(q,"pro-")}}},"json")}else{Infobulle.generer(f,"pro-")}}}}}else{var o=new Object();var h=new VRerreur();h.code=ERR_112_CODE;h.message=ERR_112_MSG;o.valid=false;o.log=new VRelement();o.log.valid=false;o.log.erreurs.push(h);Infobulle.generer(o,"")}};this.construct(a)};