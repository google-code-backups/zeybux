function GestionListeCommandeVue(){this.construct=function(){var a=this;$.post("./index.php?m=GestionCommande&v=ListeCommande",function(b){Infobulle.init();if(b.valid){a.afficher(b)}else{Infobulle.generer(b,"")}},"json")};this.afficher=function(c){var b=this;var a=new GestionCommandeTemplate();if(c.listeCommande.length>0&&c.listeCommande[0].comId!=null){var d=new Object;d.commande=new Array();$(c.listeCommande).each(function(){var f=new Object();f.id=this.comId;f.numero=this.comNumero;f.dateFinReservation=this.comDateFinReservation.extractDbDate().dateDbToFr();f.heureFinReservation=this.comDateFinReservation.extractDbHeure();f.minuteFinReservation=this.comDateFinReservation.extractDbMinute();f.dateMarcheDebut=this.comDateMarcheDebut.extractDbDate().dateDbToFr();f.heureMarcheDebut=this.comDateMarcheDebut.extractDbHeure();f.minuteMarcheDebut=this.comDateMarcheDebut.extractDbMinute();f.heureMarcheFin=this.comDateMarcheFin.extractDbHeure();f.minuteMarcheFin=this.comDateMarcheFin.extractDbMinute();d.commande.push(f)});var e=a.listeCommandePage;$("#contenu").replaceWith(b.affect($(e.template(d))))}else{$("#contenu").replaceWith(a.listeCommandeVide)}};this.affect=function(a){a=this.affectLienEditer(a);a=this.affectLienMarche(a);return a};this.affectLienEditer=function(a){a.find(".btn-editer").click(function(){var b={id_commande:$(this).attr("id")};EditerCommandeVue(b)});return a};this.affectLienMarche=function(a){a.find(".btn-marche").click(function(){var b=new MarcheCommandeVue();b.construct($(this).attr("id"))});return a};this.construct()}function ModifierCommandeVue(a){this.etapeCreationCommande=0;this.mCommunVue=new CommunVue();this.commande=null;this.construct=function(b){var c=this;$.post("./index.php?m=GestionCommande&v=ModifierCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d.valid){c.afficher(d)}else{Infobulle.generer(d,"")}},"json")};this.afficher=function(d){var e=this;var f=d.commande[0];d.sigleMonetaire=gSigleMonetaire;d.comId=f.comId;d.comNom=f.comNom;d.comNumero=f.comNumero;d.comDescription=f.comDescription;d.dateTimeFinReservation=f.comDateFinReservation.extractDbDate().dateDbToFr();d.heureFinReservation=f.comDateFinReservation.extractDbHeure();d.minuteFinReservation=f.comDateFinReservation.extractDbMinute();d.dateMarcheDebut=f.comDateMarcheDebut.extractDbDate().dateDbToFr();d.heureMarcheDebut=f.comDateMarcheDebut.extractDbHeure();d.minuteMarcheDebut=f.comDateMarcheDebut.extractDbMinute();d.heureMarcheFin=f.comDateMarcheFin.extractDbHeure();d.minuteMarcheFin=f.comDateMarcheFin.extractDbMinute();this.commande=d;var b=new GestionCommandeTemplate();var g=b.formulaireModifierCommande;var c=e.affect($(g.template(d)));d.pdtCommande=[];$(d.commande).each(function(){var h={dcomId:this.dcomId,dcomTaille:this.dcomTaille.nombreFormate(2,","," "),dcomPrix:this.dcomPrix.nombreFormate(2,","," ")};if(d.pdtCommande[this.proId]){d.pdtCommande[this.proId].lots[this.dcomId]=h}else{var i={proId:this.proId,proUniteMesure:this.proUniteMesure,proMaxProduitCommande:this.proMaxProduitCommande.nombreFormate(2,","," "),proIdNomProduit:this.proIdNomProduit,nproNom:this.nproNom,lots:[]};i.lots[this.dcomId]=h;$(d.stockInitiaux).each(function(){if(this.idProduit==i.proId){i.quantiteInit=this.quantite.nombreFormate(2,","," ")}});d.pdtCommande[this.proId]=i}});var b=new GestionCommandeTemplate();var g=b.ajoutProduitModifierCommande;$(d.pdtCommande).each(function(){if(this.proId!=undefined){this.sigleMonetaire=gSigleMonetaire;var h=e.affectNouveauProduit($(g.template(this)));var i=this;$(this.lots).each(function(){if(this.dcomId!=undefined){var j={lots:[{id:this.dcomId,taille:this.dcomTaille,prix:this.dcomPrix,unite:i.proUniteMesure}],siglemonetaire:gSigleMonetaire};h.find(".produit-lots").append(e.affectAjoutLot($(b.ajoutLotModifPdt.template(j))))}});c.find("#liste_produit").append(e.afficherDeleteLot($(h)))}});$("#contenu").replaceWith(c)};this.affectSelectHeure=function(b){var c=this;b.find(":input[name=heure_fin_commande]").selectOptions(c.commande.heureFinReservation);b.find(":input[name=minute_fin_commande]").selectOptions(c.commande.minuteFinReservation);b.find(":input[name=heure_debut_marche]").selectOptions(c.commande.heureMarcheDebut);b.find(":input[name=minute_debut_marche]").selectOptions(c.commande.minuteMarcheDebut);b.find(":input[name=heure_fin_marche]").selectOptions(c.commande.heureMarcheFin);b.find(":input[name=minute_fin_marche]").selectOptions(c.commande.minuteMarcheFin);return b};this.affect=function(b){b=this.affectAjoutProduit(b);b=this.affectCreerCommande(b);b=this.affectModifierCommande(b);b=this.affectDialogCreerProduit(b);b=this.affectControleDatepicker(b);b=this.mCommunVue.comNumeric(b);b=this.affectSelectHeure(b);return b};this.affectNouveauProduit=function(b){b=this.mCommunVue.comDelete(b);b=this.mCommunVue.comNumeric(b);b=this.editProduit(b);b=this.ajoutLotProduit(b);return b};this.affectAjoutLot=function(b){b=this.editLot(b);b=this.deleteLot(b);b=this.mCommunVue.comNumeric(b);return b};this.affectAjoutProduit=function(b){var d="#formulaire-ajout-produit-creation-commande";var c=this;b.find(d).submit(function(){var i=true;$(".produit-id").each(function(){if(parseInt($(this).text())==$(d+" :input[name=produit]").val()){i=false}});if(i){var h=new ProduitCommandeVO();h.idNom=$(d+" :input[name=produit]").val();h.nom=$(d+" :input[name=produit] option:selected").text();h.unite=$(d+" :input[name=unite]").val();h.qteMaxCommande=$(d+" :input[name=qmax]").val().numberFrToDb();h.qteRestante=$(d+" :input[name=stock]").val().numberFrToDb();var l=new DetailCommandeVO();l.taille=$(d+" :input[name=taille]").val().numberFrToDb();l.prix=$(d+" :input[name=prix]").val().numberFrToDb();h.lots.push(l);var i=new ProduitCommandeValid();var k=i.validAjout(h);if(k.valid){Infobulle.init();var f=new GestionCommandeTemplate();var j=f.ajoutProduitModifierCommande;h.proIdNomProduit=h.idNom;h.nproNom=h.nom;h.proUniteMesure=h.unite;h.proMaxProduitCommande=h.qteMaxCommande;h.quantiteInit=h.qteRestante;h.proId=h.idNom*-1;h.lots=new Array();h.lots.push({id:0,taille:l.taille.nombreFormate(2,","," "),prix:l.prix.nombreFormate(2,","," ")});h.siglemonetaire=gSigleMonetaire;var e=c.affectNouveauProduit($(j.template(h)));j=f.ajoutLotAjoutPdt;e.find(".produit-lots").append(c.affectAjoutLot($(j.template(h))));$("#liste_produit").append(e);$(d+" :input[name=unite]").val("");$(d+" :input[name=qmax]").val("");$(d+" :input[name=stock]").val("");$(d+" :input[name=taille]").val("");$(d+" :input[name=prix]").val("")}else{Infobulle.generer(k,"ajout-produit-")}}else{var k=new TemplateVR();k.valid=false;k.log.valid=false;var g=new VRerreur();g.code=ERR_211_CODE;g.message=ERR_211_MSG;k.log.erreurs.push(g);Infobulle.generer(k,"")}return false});return b};this.affectCreerCommande=function(b){var d="#btn-creer-commande";var c=this;b.find(d).click(function(){var e=true;$("#liste_produit").find(":button").each(function(){if($(this).text()==gTextValider){e=false}});if(e){var g=new CommandeCompleteVO();g.id=c.commande.comId;g.numero=c.commande.comNumero;g.nom=$("#formulaire-information-creation-commande").find(":input[name=nom_commande]").val();g.description=$("#formulaire-information-creation-commande").find(":input[name=description_commande]").val();g.dateMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();g.timeMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=heure_debut_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_debut_marche]").val()+":00";g.dateMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();g.timeMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_marche]").val()+":00";g.dateFinReservation=$("#formulaire-information-creation-commande").find(":input[name=date_fin_commande]").val().dateFrToDb();g.timeFinReservation=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_commande]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_commande]").val()+":00";g.archive="0";$(".produit-div").each(function(){var k=new ProduitCommandeVO();k.id=$(this).find(".produit-id").text();k.idNom=$(this).find(".produit-nom-id").text();k.unite=$(this).find(":input[name=unite]").val();k.qteMaxCommande=$(this).find(":input[name=qmax]").val().numberFrToDb();k.qteRestante=$(this).find(":input[name=stock]").val().numberFrToDb();$(this).find(".produit-lot").each(function(){var l=new DetailCommandeVO();l.id=$(this).find(".lot-id").text();l.taille=$(this).find(":input[name=taille]").val().numberFrToDb();l.prix=$(this).find(":input[name=prix]").val().numberFrToDb();k.lots.push(l)});g.produits.push(k)});if(c.etapeCreationCommande==0){var h=new CommandeCompleteValid();var j=h.validUpdate(g);if(j.valid){c.etapeCreationCommande=1;Infobulle.init();$("#window-ajout-produit-creation-commande").hide();$("#btn-modifier-creation-commande").show();$("#liste_produit .produit-div :button , .form-ajout-lot-creation-commande, .com-btn-header, .conteneur-btn-edt-lot").each(function(){$(this).hide()});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").each(function(){$(this).inputToText()})}else{Infobulle.generer(j,"commande-")}}else{if(c.etapeCreationCommande==1){var i={form:2,commande:g};$.post("./index.php?m=GestionCommande&v=ModifierCommande","pParam="+$.toJSON(i),function(l){if(l.valid){l.numero=c.commande.comNumero;var k=new GestionCommandeTemplate();var m=k.modifCommandeSucces;$("#contenu").replaceWith(m.template(l))}else{c.modifierCommandeFunction();Infobulle.generer(l,"commande-")}c.etapeCreationCommande=0},"json")}}}else{var j=new Object();var f=new VRerreur();f.code=ERR_112_CODE;f.message=ERR_112_MSG;j.valid=false;j.log=new VRelement();j.log.valid=false;j.log.erreurs.push(f);Infobulle.generer(j,"")}});return b};this.affectModifierCommande=function(b){var c=this;b.find("#btn-modifier-creation-commande").click(function(){c.modifierCommandeFunction()});return b};this.modifierCommandeFunction=function(){this.etapeCreationCommande=0;var b=this;$("#window-ajout-produit-creation-commande, #liste_produit .produit-div :button, .form-ajout-lot-creation-commande, .com-btn-header, .conteneur-btn-edt-lot").show();$("#btn-modifier-creation-commande, .edit-nom-pdt-creation-commande-valid").hide();$(".produit-lots").each(function(){b.afficherDeleteLot($(this))});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").textToInput()};this.ajoutLotProduit=function(b){var c=this;b.find(".btn-ajout-lot-creation-commande").click(function(){var j=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=taille]");var d=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=prix]");var i=new DetailCommandeVO();i.idProduit=$(this).parents(".produit-div").find(".produit-id").text();i.taille=j.val().numberFrToDb();i.prix=d.val().numberFrToDb();var k=new DetailCommandeValid();var h=k.validAjout(i);if(h.valid){Infobulle.init();i.prix=parseFloat(i.prix).nombreFormate(2,","," ");i.taille=parseFloat(i.taille).nombreFormate(2,","," ");i.siglemonetaire=gSigleMonetaire;i.unite=$(this).parentsUntil(".produit-div").find(":input[name=unite]").val();i.idNom=i.idProduit;var l=new Array();$(this).parentsUntil(".produit-div").find(".produit-lot").each(function(){l.push(parseInt($(this).find(".lot-id").text()))});var e=Array.min(l);if(e<0){i.id=e-1}else{i.id=-1}var f=new GestionCommandeTemplate();var g=f.ajoutLot;c.afficherDeleteLot($(this).parents(".produit-div").find(".produit-lots").append(c.affectAjoutLot($(g.template(i)))));j.val("");d.val("")}else{Infobulle.generer(h,"ajout-lot-produit-"+i.idProduit+"-")}});return b};this.editProduit=function(b){var c=this;b.find(".edit-nom-pdt-creation-commande-valid").click(function(){var d=new ProduitCommandeVO();var g=$(this).closest(".produit-div");d.idNom=$(g).find(".produit-nom-id").text();d.nom=$(g).find(".produit-nom").text();d.unite=$(g).find(":input[name=unite]").val();d.qteMaxCommande=$(g).find(":input[name=qmax]").val().numberFrToDb();d.qteRestante=$(g).find(":input[name=stock]").val().numberFrToDb();var e=new ProduitCommandeValid();var h=e.validAjout(d,"simple");if(h.valid){Infobulle.init();$(this).parent().find(":input[name=qmax]").inputToText("montant");$(this).parent().find(":input[name=stock]").inputToText("montant");$(this).parent().find(":input[name=unite]").inputToText();var f=$(this).parentsUntil("#liste_produit");f.find(".produit-unite").text(f.children(":input[name=unite]").val());b.find(".edit-nom-pdt-creation-commande").toggle()}else{Infobulle.generer(h,"produit-"+d.idNom+"-")}});b.find(".edit-nom-pdt-creation-commande-edit").click(function(){$(this).parent().children(":input:not(:button,:submit)").each(function(){$(this).textToInput()});b.find(".edit-nom-pdt-creation-commande").toggle()});return b};this.editLot=function(b){var c=this;b.find(".edit-lot-creation-commande-edit").click(function(){$(this).parent().parent().children(":input:not(:button,:submit)").each(function(){$(this).textToInput()});b.find(".edit-lot-creation-commande").toggle()});b.find(".edit-lot-creation-commande-valid").click(function(){var d=new DetailCommandeVO();var f=$(this).closest(".produit-lot");d.id=$(f).find(".lot-id").text();d.idProduit=$(this).parentsUntil(".produit-div").find(".produit-id").text();d.taille=$(f).find(":input[name=taille]").val().numberFrToDb();d.prix=$(f).find(":input[name=prix]").val().numberFrToDb();var e=new DetailCommandeValid();var g=e.validAjout(d);if(g.valid){Infobulle.init();$(this).parent().parent().find(":input[name='taille']").inputToText();$(this).parent().parent().find(":input[name='prix']").inputToText("montant");b.find(".edit-lot-creation-commande").toggle()}else{Infobulle.generer(g,"produit-"+d.idProduit+"-lot-"+d.id+"-")}});return b};this.deleteLot=function(b){var c=this;b.find(".delete-lot").click(function(){var d=$(this).parents(".produit-lots");$(this).parent().parent().remove();c.afficherDeleteLot(d)});return b};this.afficherDeleteLot=function(b){if(b.find(".produit-lot").size()<2){b.find(".delete-lot").hide()}else{b.find(".delete-lot").show()}return b};this.affectDialogCreerProduit=function(b){b.find("#dialog-form-creer-nv-pdt").dialog({autoOpen:false,modal:true,draggable:false,resizable:false,width:400,buttons:{"Créer le produit":function(){var f=this;var d=new NomProduitVO();var c=$(this).children("form").first();d.nom=c.find(":input[name=nom]").val();d.description=c.find(":input[name=description]").val();d.idCategorie=1;var e=new NomProduitValid();var h=e.validAjout(d);if(h.valid){Infobulle.init();var g={form:1,nomProduit:d};$.post("./index.php?m=GestionCommande&v=ModifierCommande","pParam="+$.toJSON(g),function(j){if(j.valid){Infobulle.init();var i=[];i[j.id]=j.nom;$("#formulaire-ajout-produit-creation-commande select[name=produit]").addOption(i).sortOptions();$(f).dialog("close")}else{Infobulle.generer(j,"nom-pdt-")}},"json")}else{Infobulle.generer(h,"nom-pdt-")}},Annuler:function(){$(this).dialog("close")}},close:function(){$(this).children("form").first().find(":input").val("");Infobulle.init()}});b.find("#btn-creer-nv-pdt").click(function(){$("#dialog-form-creer-nv-pdt").dialog("open")});return b};this.affectControleDatepicker=function(b){b=this.mCommunVue.comLienDatepicker("commande-dateFinReservation","commande-dateMarcheDebut",b);return b};this.construct(a)}function AjoutCommandeVue(){this.etapeCreationCommande=0;this.mCommunVue=new CommunVue();this.construct=function(){var a=this;$.post("./index.php?m=GestionCommande&v=AjoutCommande",function(b){Infobulle.init();if(b.valid){a.afficher(b)}else{Infobulle.generer(b,"")}},"json")};this.afficher=function(b){var c=this;var a=new GestionCommandeTemplate();var d=a.formulaireAjoutCommande;$("#contenu").replaceWith(c.affect($(d.template(b))))};this.affect=function(a){a=this.affectAjoutProduit(a);a=this.affectCreerCommande(a);a=this.affectModifierCommande(a);a=this.affectDialogCreerProduit(a);a=this.affectControleDatepicker(a);a=this.mCommunVue.comNumeric(a);return a};this.affectNouveauProduit=function(a){a=this.mCommunVue.comDelete(a);a=this.mCommunVue.comNumeric(a);a=this.editProduit(a);a=this.ajoutLotProduit(a);return a};this.affectAjoutLot=function(a){a=this.editLot(a);a=this.deleteLot(a);a=this.mCommunVue.comNumeric(a);return a};this.affectAjoutProduit=function(a){var c="#formulaire-ajout-produit-creation-commande";var b=this;a.find(c).submit(function(){var h=true;$(".produit-id").each(function(){if(parseInt($(this).text())==$(c+" :input[name=produit]").val()){h=false}});if(h){var g=new ProduitCommandeVO();g.idNom=$(c+" :input[name=produit]").val();g.nom=$(c+" :input[name=produit] option:selected").text();g.unite=$(c+" :input[name=unite]").val();g.qteMaxCommande=$(c+" :input[name=qmax]").val().numberFrToDb();g.qteRestante=$(c+" :input[name=stock]").val().numberFrToDb();var k=new DetailCommandeVO();k.taille=$(c+" :input[name=taille]").val().numberFrToDb();k.prix=$(c+" :input[name=prix]").val().numberFrToDb();g.lots.push(k);var h=new ProduitCommandeValid();var j=h.validAjout(g);if(j.valid){Infobulle.init();var e=new GestionCommandeTemplate();var i=e.ajoutProduitAjoutCommande;g.lots[0].prix=parseFloat(g.lots[0].prix).nombreFormate(2,","," ");g.lots[0].taille=parseFloat(g.lots[0].taille).nombreFormate(2,","," ");g.lots[0].id=0;g.siglemonetaire=gSigleMonetaire;var d=b.affectNouveauProduit($(i.template(g)));i=e.ajoutLotAjoutPdt;d.find(".produit-lots").append(b.affectAjoutLot($(i.template(g))));$("#liste_produit").append(d);$(c+" :input[name=unite]").val("");$(c+" :input[name=qmax]").val("");$(c+" :input[name=stock]").val("");$(c+" :input[name=taille]").val("");$(c+" :input[name=prix]").val("")}else{Infobulle.generer(j,"ajout-produit-")}}else{var j=new TemplateVR();j.valid=false;j.log.valid=false;var f=new VRerreur();f.code=ERR_211_CODE;f.message=ERR_211_MSG;j.log.erreurs.push(f);Infobulle.generer(j,"")}return false});return a};this.affectCreerCommande=function(a){var c="#btn-creer-commande";var b=this;a.find(c).click(function(){var d=true;$("#liste_produit").find(":button").each(function(){if($(this).text()==gTextValider){d=false}});if(d){var f=new CommandeCompleteVO();f.nom=$("#formulaire-information-creation-commande").find(":input[name=nom_commande]").val();f.description=$("#formulaire-information-creation-commande").find(":input[name=description_commande]").val();f.dateMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();f.timeMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=heure_debut_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_debut_marche]").val()+":00";f.dateMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();f.timeMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_marche]").val()+":00";f.dateFinReservation=$("#formulaire-information-creation-commande").find(":input[name=date_fin_commande]").val().dateFrToDb();f.timeFinReservation=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_commande]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_commande]").val()+":00";f.archive="0";$(".produit-div").each(function(){var i=new ProduitCommandeVO();i.idNom=$(this).find(".produit-id").text();i.unite=$(this).find(":input[name=unite]").val();i.qteMaxCommande=$(this).find(":input[name=qmax]").val().numberFrToDb();i.qteRestante=$(this).find(":input[name=stock]").val().numberFrToDb();$(this).find(".produit-lot").each(function(){var j=new DetailCommandeVO();j.taille=$(this).find(":input[name=taille]").val().numberFrToDb();j.prix=$(this).find(":input[name=prix]").val().numberFrToDb();i.lots.push(j)});f.produits.push(i)});if(b.etapeCreationCommande==0){var g=new CommandeCompleteValid();var h=g.validAjout(f);if(h.valid){b.etapeCreationCommande=1;Infobulle.init();$("#window-ajout-produit-creation-commande").hide();$("#btn-modifier-creation-commande").show();$("#liste_produit .produit-div :button , .form-ajout-lot-creation-commande, .com-btn-header, .conteneur-btn-edt-lot").each(function(){$(this).hide()});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").each(function(){$(this).inputToText()})}else{Infobulle.generer(h,"commande-")}}else{if(b.etapeCreationCommande==1){$.post("./index.php?m=GestionCommande&v=AjoutCommande","commande="+$.toJSON(f)+"&form=2",function(j){if(j.valid){var i=new GestionCommandeTemplate();var k=i.ajoutCommandeSucces;$("#contenu").replaceWith(k.template(j))}else{b.modifierCommandeFunction();Infobulle.generer(j,"commande-")}b.etapeCreationCommande=0},"json")}}}else{var h=new Object();var e=new VRerreur();e.code=ERR_112_CODE;e.message=ERR_112_MSG;h.valid=false;h.log=new VRelement();h.log.valid=false;h.log.erreurs.push(e);Infobulle.generer(h,"")}});return a};this.affectModifierCommande=function(a){var b=this;a.find("#btn-modifier-creation-commande").click(function(){b.modifierCommandeFunction()});return a};this.modifierCommandeFunction=function(){this.etapeCreationCommande=0;var a=this;$("#window-ajout-produit-creation-commande, #liste_produit .produit-div :button, .form-ajout-lot-creation-commande, .com-btn-header, .conteneur-btn-edt-lot").show();$("#btn-modifier-creation-commande, .edit-nom-pdt-creation-commande-valid").hide();$(".produit-lots").each(function(){a.afficherDeleteLot($(this))});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").textToInput()};this.ajoutLotProduit=function(a){var b=this;a.find(".btn-ajout-lot-creation-commande").click(function(){var f=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=taille]");var c=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=prix]");var e=new DetailCommandeVO();e.idProduit=$(this).parents(".produit-div").find(".produit-id").text();e.taille=f.val().numberFrToDb();e.prix=c.val().numberFrToDb();var g=new DetailCommandeValid();var j=g.validAjout(e);if(j.valid){Infobulle.init();e.prix=parseFloat(e.prix).nombreFormate(2,","," ");e.taille=parseFloat(e.taille).nombreFormate(2,","," ");e.siglemonetaire=gSigleMonetaire;e.unite=$(this).parentsUntil(".produit-div").find(":input[name=unite]").val();e.idNom=e.idProduit;var i=new Array();$(this).parentsUntil(".produit-div").find(".produit-lot").each(function(){i.push(parseInt($(this).find(".lot-id").text()))});e.id=Array.max(i)+1;var d=new GestionCommandeTemplate();var h=d.ajoutLot;b.afficherDeleteLot($(this).parents(".produit-div").find(".produit-lots").append(b.affectAjoutLot($(h.template(e)))));f.val("");c.val("")}else{Infobulle.generer(j,"ajout-lot-produit-"+e.idProduit+"-")}});return a};this.editProduit=function(a){var b=this;a.find(".edit-nom-pdt-creation-commande-valid").click(function(){var c=new ProduitCommandeVO();var f=$(this).closest(".produit-div");c.idNom=$(f).find(".produit-id").text();c.nom=$(f).find(".produit-nom").text();c.unite=$(f).find(":input[name=unite]").val();c.qteMaxCommande=$(f).find(":input[name=qmax]").val().numberFrToDb();c.qteRestante=$(f).find(":input[name=stock]").val().numberFrToDb();var d=new ProduitCommandeValid();var g=d.validAjout(c,"simple");if(g.valid){Infobulle.init();$(this).parent().find(":input[name=qmax]").inputToText("montant");$(this).parent().find(":input[name=stock]").inputToText("montant");$(this).parent().find(":input[name=unite]").inputToText();var e=$(this).parentsUntil("#liste_produit");e.find(".produit-unite").text(e.children(":input[name=unite]").val());a.find(".edit-nom-pdt-creation-commande").toggle()}else{Infobulle.generer(g,"produit-"+c.idNom+"-")}});a.find(".edit-nom-pdt-creation-commande-edit").click(function(){$(this).parent().children(":input:not(:button,:submit)").each(function(){$(this).textToInput()});a.find(".edit-nom-pdt-creation-commande").toggle()});return a};this.editLot=function(a){var b=this;a.find(".edit-lot-creation-commande-edit").click(function(){$(this).parent().parent().children(":input:not(:button,:submit)").each(function(){$(this).textToInput()});a.find(".edit-lot-creation-commande").toggle()});a.find(".edit-lot-creation-commande-valid").click(function(){var c=new DetailCommandeVO();var e=$(this).closest(".produit-lot");c.id=$(e).find(".lot-id").text();c.idProduit=$(this).parentsUntil(".produit-div").find(".produit-id").text();c.taille=$(e).find(":input[name=taille]").val().numberFrToDb();c.prix=$(e).find(":input[name=prix]").val().numberFrToDb();var d=new DetailCommandeValid();var f=d.validAjout(c);if(f.valid){Infobulle.init();$(this).parent().parent().find(":input[name='taille']").inputToText();$(this).parent().parent().find(":input[name='prix']").inputToText("montant");a.find(".edit-lot-creation-commande").toggle()}else{Infobulle.generer(f,"produit-"+c.idProduit+"-lot-"+c.id+"-")}});return a};this.deleteLot=function(a){var b=this;a.find(".delete-lot").click(function(){var c=$(this).parents(".produit-lots");$(this).parent().parent().remove();b.afficherDeleteLot(c)});return a};this.afficherDeleteLot=function(a){if(a.children(".produit-lot").size()<2){a.find(".delete-lot").hide()}else{a.find(".delete-lot").show()}return a};this.affectDialogCreerProduit=function(a){a.find("#dialog-form-creer-nv-pdt").dialog({autoOpen:false,modal:true,draggable:false,resizable:false,width:400,buttons:{"Créer le produit":function(){var b=$(this).children("form").first();var c=b.find(":input[name=nom]");var d=true;$("#dialog-form-creer-nv-pdt").children().first().html("").hide();b.find(":input").removeClass("ui-state-error");d=c.checkLength(1,50);if(d){$.post("./index.php?m=GestionCommande&v=AjoutCommande",b.serialize()+"&form=1",function(e){if(e.succes==true){$("#formulaire-ajout-produit-creation-commande select[name=produit]").addOption(e.produit,true).sortOptions();$("#dialog-form-creer-nv-pdt").dialog("close")}else{var f='<div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"><p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span><strong>Erreur : </strong> L\'ajout n\'a pas été effectué.<br/><!-- BEGIN erreurs --><strong>Code Erreur : </strong>{erreurs.CODE_ERREUR}<br/><strong>Message Erreur : </strong>{erreurs.MESSAGE_ERREUR}<br/><!-- END erreurs --></p></div>';$("#dialog-form-creer-nv-pdt").children().first().html(f.template(e)).fadeIn(gTempsTransitionUnique)}},"json")}},Annuler:function(){$(this).dialog("close")}},close:function(){$(this).children("form").first().find(":input").val("").removeClass("ui-state-error");$("#dialog-form-creer-nv-pdt").children().first().html("").hide()}});a.find("#btn-creer-nv-pdt").click(function(){$("#dialog-form-creer-nv-pdt").dialog("open")});return a};this.affectControleDatepicker=function(a){a=this.mCommunVue.comLienDatepicker("commande-dateFinReservation","commande-dateMarcheDebut",a);return a};this.construct()}function AchatCommandeVue(){this.idCommande=null;this.idAdherent=null;this.idCompte=null;this.listeLot=new Array();this.typePaiement=null;this.solde=null;this.mCommunVue=new CommunVue();this.etapeValider=0;this.construct=function(b,c){var a=this;this.idCommande=b;this.idAdherent=c;$.post("./index.php?m=GestionCommande&v=MarcheCommande","id_commande="+b+"&id_adherent="+c,function(f){Infobulle.init();if(f.valid){a.idCompte=f.adherent.adhIdCompte;for(lLigne in f.commande){var e=new Object();e.quantite=f.commande[lLigne].dcomTaille;e.prix=f.commande[lLigne].dcomPrix;if(!a.listeLot[f.commande[lLigne].proId]){if(!isArray(a.listeLot[f.commande[lLigne].proId])){a.listeLot[f.commande[lLigne].proId]=new Array()}}a.listeLot[f.commande[lLigne].proId].push(e)}var d=new Array();for(lIndice in f.typePaiement){d[f.typePaiement[lIndice].id]=f.typePaiement[lIndice]}a.typePaiement=d;a.solde=parseFloat(f.adherent.opeMontant);a.afficher(f)}else{Infobulle.generer(f,"")}},"json")};this.afficher=function(c){Infobulle.init();if(c.valid){var d=this;var a=new GestionCommandeTemplate();var f=a.achatCommandePage;var b=new Object();b.comNumero=c.commande[0].comNumero;b.adhNumero=c.adherent.adhNumero;b.adhCompte=c.adherent.cptLabel;b.adhNom=c.adherent.adhNom;b.adhPrenom=c.adherent.adhPrenom;b.sigleMonetaire=gSigleMonetaire;b.total=0;b.produits=new Array();lListeIdProduit=new Array();for(lLigne in c.commande){lPush=true;for(lId in lListeIdProduit){if(lListeIdProduit[lId]==c.commande[lLigne].proId){lPush=false}}if(lPush){lListeIdProduit.push(c.commande[lLigne].proId);var g=new Object();g.proId=c.commande[lLigne].proId;g.nproNom=c.commande[lLigne].nproNom;g.proUniteMesure=c.commande[lLigne].proUniteMesure;g.stoQuantite=0;g.proPrix=0;var e=0;for(lReservation in c.reservation){if(c.reservation[lReservation].proId==g.proId){g.stoQuantite=c.reservation[lReservation].stoQuantite*-1;e=this.calculPrixProduit(g.proId,g.stoQuantite);g.proPrix=e.nombreFormate(2,","," ")}}b.total+=e;b.produits.push(g)}}b.adhSolde=parseFloat(c.adherent.opeMontant);b.adhNouveauSolde=b.adhSolde-b.total;b.adhSolde=b.adhSolde.nombreFormate(2,","," ");b.adhNouveauSolde=b.adhNouveauSolde.nombreFormate(2,","," ");b.total=b.total.nombreFormate(2,","," ");b.typePaiement=c.typePaiement;$("#contenu").replaceWith(d.affect($(f.template(b))));d.changerTypePaiement($(":input[name=typepaiement]"));d.majNouveauSolde()}else{Infobulle.generer(c,"")}};this.affect=function(a){a=this.affectSelectTypePaiement(a);a=this.affectNouveauSolde(a);a=this.mCommunVue.comNumeric(a);a=this.affectNouveauPrixProduit(a);a=this.affectChampComplementaire(a);a=this.affectValider(a);a=this.affectAnnuler(a);a=this.affectModifier(a);return a};this.affectSelectTypePaiement=function(a){var b=this;a.find(":input[name=typepaiement]").change(function(){b.changerTypePaiement($(this))});return a};this.affectNouveauSolde=function(a){var b=this;a.find(":input[name=montant-rechargement], .produit-prix").keyup(function(){b.majNouveauSolde();b.controlerAchat()});return a};this.affectNouveauPrixProduit=function(a){var b=this;a.find(".produit-quantite").keyup(function(){b.majPrixProduit($(this));b.controlerAchat()});return a};this.affectChampComplementaire=function(a){var b=this;a.find(":input[name=champ-complementaire]").keyup(function(){b.controlerAchat()});return a};this.affectValider=function(a){var b=this;a.find("#btn-valider").click(function(){b.creerRecapitulatif()});return a};this.affectAnnuler=function(a){var b=this;a.find("#btn-annuler").click(function(){b.retourListe()});return a};this.affectModifier=function(a){var b=this;a.find("#btn-modifier").click(function(){b.boutonModifier()});return a};this.majPrixProduit=function(a){var e=parseFloat(a.val().numberFrToDb());if(isNaN(e)){e=0}var b=a.parent().parent();var c=b.find(".produit-id").text();var d=this.calculPrixProduit(c,e);if(isNaN(d)){d=0}b.find(".produit-prix").val(d.nombreFormate(2,","," "));this.majNouveauSolde()};this.controlerAchat=function(){Infobulle.init();var a=new AchatCommandeValid();var b=a.validAjout(this.getAchatCommandeVO());Infobulle.generer(b,"");return b};this.calculPrixProduit=function(a,d){if(this.listeLot[a]){var b=this.listeLot[a];var c=0;for(lLot in b){if(d%b[lLot].quantite==0){c=(d/b[lLot].quantite)*b[lLot].prix}}return c}return 0};this.majTotal=function(){var a=this;$("#total-achat").text(a.calculerTotal().nombreFormate(2,","," "))};this.calculerTotal=function(){var a=0;$(".produit-prix").each(function(){var b=parseFloat($(this).val().numberFrToDb());if(isNaN(b)){b=0}a+=b});return a};this.majNouveauSolde=function(){this.majTotal();var a=this.calculNouveauSolde();if(a<=0){$("#nouveau-solde").addClass("com-nombre-negatif");$("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde").removeClass("com-nombre-negatif");$("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}$("#nouveau-solde").text(a.nombreFormate(2,","," "))};this.calculNouveauSolde=function(){var b=parseFloat($("#total-achat").text().numberFrToDb());if(isNaN(b)){b=0}var a=parseFloat($(":input[name=montant-rechargement]").val().numberFrToDb());if(isNaN(a)){a=0}return this.solde-b+a};this.changerTypePaiement=function(c){var b=c.val();var a=this.getLabelChamComplementaire(b);if(a!=null){$("#label-champ-complementaire").text(a).show();$("#td-champ-complementaire").show()}else{$("#label-champ-complementaire").text("").hide();$(":input[name=champ-complementaire]").val();$("#td-champ-complementaire").hide()}};this.getLabelChamComplementaire=function(b){var a=this.typePaiement;if(a[b]){if(a[b].champComplementaire==1){return a[b].labelChampComplementaire}}return null};this.getAchatCommandeVO=function(){var a=new AchatCommandeVO();a.id=this.idCommande;a.idCompte=this.idCompte;a.produits=this.getProduitsVO();a.rechargement=this.getRechargementVO();return a};this.getProduitsVO=function(){var a=new Array();$(".ligne-produit").each(function(){var c=new ProduitAchatVO();c.id=$(this).find(".produit-id").text();var d=$(this).find(".produit-quantite").val().numberFrToDb();if(!isNaN(d)&&!d.isEmpty()){d=parseFloat(d)}c.quantite=d;var b=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(b)&&!b.isEmpty()){b=parseFloat(b)}c.prix=b;a.push(c)});return a};this.getRechargementVO=function(){var a=new RechargementCompteVO();a.id=this.idCompte;var b=$(":input[name=montant-rechargement]").val().numberFrToDb();if(!isNaN(b)&&!b.isEmpty()){b=parseFloat(b)}a.montant=b;a.typePaiement=$(":input[name=typepaiement]").val();if(this.getLabelChamComplementaire(a.typePaiement)!=null){a.champComplementaireObligatoire=1;a.champComplementaire=$(":input[name=champ-complementaire]").val()}else{a.champComplementaireObligatoire=0}return a};this.creerRecapitulatif=function(){var a=this.controlerAchat();if(a.valid){if(this.etapeValider==0){$(".produit-quantite,#rechargementchampComplementaire,#typepaiement").each(function(){$(this).inputToText()});$(".produit-prix,#rechargementmontant").each(function(){$(this).inputToText("montant")});$("#btn-modifier").show();$("#btn-annuler").hide();this.etapeValider=1}else{if(this.etapeValider==1){this.enregistrerAchat()}}}};this.enregistrerAchat=function(){var b=this;var a=this.getAchatCommandeVO();$.post("./index.php?m=GestionCommande&v=MarcheCommande","achat="+$.toJSON(a),function(d){if(d.valid){var c=new GestionCommandeTemplate();var e=c.achatCommandeSucces;$("#contenu").replaceWith(b.affectAnnuler($(e)))}else{b.boutonModifier();Infobulle.generer(d,"")}b.etapeValider=0},"json")};this.boutonModifier=function(){if(this.etapeValider==1){$(".produit-prix,#rechargementmontant,.produit-quantite,#rechargementchampComplementaire,#typepaiement").each(function(){$(this).textToInput()});$("#btn-modifier").hide();$("#btn-annuler").show();this.etapeValider=0}};this.retourListe=function(){var a=new MarcheCommandeVue();a.construct(this.idCommande)}}function MarcheCommandeVue(){this.idCommande=null;this.construct=function(a){var b=this;$.post("./index.php?m=GestionCommande&v=MarcheCommande","id_commande="+a,function(c){Infobulle.init();if(c.valid){b.afficher(c)}else{Infobulle.generer(c,"")}},"json");this.idCommande=a};this.afficher=function(c){Infobulle.init();if(c.valid){if(c.listeAdherentCommande){var d=this;var a=new GestionCommandeTemplate();if(c.listeAdherentCommande.length>0&&c.listeAdherentCommande[0].adhId!=null){var e=a.listeAdherentCommandePage;c.comNumero=c.listeAdherentCommande[0].comNumero;$("#contenu").replaceWith(d.affect($(e.template(c))))}else{$("#contenu").replaceWith(a.listeMarcheVide)}}else{var f=new TemplateVR();f.valid=false;f.log.valid=false;var b=new VRerreur();b.code=ERR_211_CODE;b.message=ERR_211_MSG;f.log.push(b);Infobulle.generer(f,"")}}else{Infobulle.generer(c,"")}};this.affect=function(a){a=this.affectTri(a);a=this.affectRecherche(a);a=this.affectLienAchat(a);return a};this.affectTri=function(a){a.find(".com-table").tablesorter({sortList:[[2,0]]});return a};this.affectRecherche=function(a){a.find("#filter").keyup(function(){$.uiTableFilter($(".com-table"),this.value)});a.find("#filter-form").submit(function(){return false});return a};this.affectLienAchat=function(a){var b=this;a.find(".achat-commande-ligne").click(function(){var c=new AchatCommandeVue();c.construct(b.idCommande,$(this).find(".id-adherent").text())});return a}}function ReservationAdherentVue(a){this.mAdherent=null;this.infoCommande=new Object();this.pdtCommande=new Array();this.reservation=new Array();this.reservationModif=new Array();this.construct=function(b){var c=this;$.post("./index.php?m=GestionCommande&v=ReservationAdherent","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d.valid){c.mAdherent=d.adherent;c.infoCommande.comId=d.commande[0].comId;c.infoCommande.comNumero=d.commande[0].comNumero;c.infoCommande.comNom=d.commande[0].comNom;c.infoCommande.comDescription=d.commande[0].comDescription;c.infoCommande.dateTimeFinReservation=d.commande[0].comDateFinReservation;c.infoCommande.dateFinReservation=d.commande[0].comDateFinReservation.extractDbDate().dateDbToFr();c.infoCommande.heureFinReservation=d.commande[0].comDateFinReservation.extractDbHeure();c.infoCommande.minuteFinReservation=d.commande[0].comDateFinReservation.extractDbMinute();c.infoCommande.dateMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbDate().dateDbToFr();c.infoCommande.heureMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbHeure();c.infoCommande.minuteMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbMinute();c.infoCommande.heureMarcheFin=d.commande[0].comDateMarcheFin.extractDbHeure();c.infoCommande.minuteMarcheFin=d.commande[0].comDateMarcheFin.extractDbMinute();c.infoCommande.comArchive=d.commande[0].comArchive;$(d.commande).each(function(){var f=new Object();f.dcomId=this.dcomId;f.dcomIdProduit=this.dcomIdProduit;f.dcomTaille=this.dcomTaille;f.dcomPrix=this.dcomPrix;if(c.pdtCommande[this.proId]){c.pdtCommande[this.proId].lot[f.dcomId]=f}else{var e=new Object();e.proId=this.proId;e.proUniteMesure=this.proUniteMesure;e.proMaxProduitCommande=this.proMaxProduitCommande;$(d.stock).each(function(){if(this.proId==e.proId){if(parseFloat(this.stoQuantite)<parseFloat(e.proMaxProduitCommande)){e.proMaxProduitCommande=this.stoQuantite}}});e.nproNom=this.nproNom;e.nproDescription=this.nproDescription;e.nproIdCategorie=this.nproIdCategorie;e.lot=new Array();e.lot[f.dcomId]=f;c.pdtCommande[e.proId]=e}});$(d.reservation).each(function(){this.stoQuantite=this.stoQuantite*-1;c.reservation[this.proId]=this});c.afficher()}else{Infobulle.generer(d,"")}},"json")};this.afficher=function(){this.afficherDetailReservation()};this.afficherDetailReservation=function(){var e=this;var b=new GestionCommandeTemplate();var f=b.detailReservation;var c={};c.adhId=this.mAdherent.adhId;c.adhNumero=this.mAdherent.adhNumero;c.adhCompte=this.mAdherent.cptLabel;c.adhNom=this.mAdherent.adhNom;c.adhPrenom=this.mAdherent.adhPrenom;c.adhSolde=this.mAdherent.opeMontant.nombreFormate(2,","," ");c.sigleMonetaire=gSigleMonetaire;c.comNumero=this.infoCommande.comNumero;c.dateFinReservation=this.infoCommande.dateFinReservation;c.heureFinReservation=this.infoCommande.heureFinReservation;c.minuteFinReservation=this.infoCommande.minuteFinReservation;c.dateMarcheDebut=this.infoCommande.dateMarcheDebut;c.heureMarcheDebut=this.infoCommande.heureMarcheDebut;c.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;c.heureMarcheFin=this.infoCommande.heureMarcheFin;c.minuteMarcheFin=this.infoCommande.minuteMarcheFin;c.reservation=new Array();var d=0;$(this.pdtCommande).each(function(){if(e.reservation[this.proId]){var g=new Object;g.nproNom=this.nproNom;g.stoQuantite=parseFloat(e.reservation[this.proId].stoQuantite);g.proUniteMesure=this.proUniteMesure;g.prix=0;var h=e.reservation[this.proId].dcomId;$(this.lot).each(function(){if(this.dcomId==h){g.prix=(g.stoQuantite/this.dcomTaille)*this.dcomPrix}});d+=g.prix;g.stoQuantite=g.stoQuantite.nombreFormate(2,","," ");g.prix=g.prix.nombreFormate(2,","," ");c.reservation.push(g)}});c.total=parseFloat(d).nombreFormate(2,","," ");$("#contenu").replaceWith(e.affect($(f.template(c))))};this.afficherModifier=function(){var e=this;var b=new GestionCommandeTemplate();var f=b.modifierReservation;var c={};c.adhId=this.mAdherent.adhId;c.adhNumero=this.mAdherent.adhNumero;c.adhCompte=this.mAdherent.cptLabel;c.adhNom=this.mAdherent.adhNom;c.adhPrenom=this.mAdherent.adhPrenom;c.adhSolde=this.mAdherent.opeMontant.nombreFormate(2,","," ");c.adhNouveauSolde=0;c.sigleMonetaire=gSigleMonetaire;c.comNumero=this.infoCommande.comNumero;c.dateFinReservation=this.infoCommande.dateFinReservation;c.heureFinReservation=this.infoCommande.heureFinReservation;c.minuteFinReservation=this.infoCommande.minuteFinReservation;c.dateMarcheDebut=this.infoCommande.dateMarcheDebut;c.heureMarcheDebut=this.infoCommande.heureMarcheDebut;c.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;c.heureMarcheFin=this.infoCommande.heureMarcheFin;c.minuteMarcheFin=this.infoCommande.minuteMarcheFin;c.produit=new Array();var d=0;$(this.pdtCommande).each(function(){if(this.proId){var g={};g.proId=this.proId;g.nproNom=this.nproNom;g.proMaxProduitCommande=parseFloat(this.proMaxProduitCommande).nombreFormate(2,","," ");g.proUniteMesure=this.proUniteMesure;g.lot=new Array();var j=0;var h=-1;var k=-1;$(this.lot).each(function(){if(this.dcomId){var i={};i.dcomId=this.dcomId;i.dcomTaille=parseFloat(this.dcomTaille).nombreFormate(2,","," ");i.dcomPrix=parseFloat(this.dcomPrix).nombreFormate(2,","," ");i.prixReservation=parseFloat(this.dcomPrix);i.stoQuantiteReservation=parseFloat(this.dcomTaille);if(e.reservation[g.proId]&&(e.reservation[g.proId].stoQuantite%this.dcomTaille==0)){i.stoQuantiteReservation=parseFloat(e.reservation[g.proId].stoQuantite);i.prixReservation=(i.stoQuantiteReservation/this.dcomTaille)*this.dcomPrix;d+=i.prixReservation;h=this.dcomId;i.checked='checked="checked"'}i.stoQuantiteReservation=i.stoQuantiteReservation.nombreFormate(2,","," ");i.prixReservation=i.prixReservation.nombreFormate(2,","," ");g.lot.push(i)}});c.total=parseFloat(d).nombreFormate(2,","," ");if(h!=-1){g.checked='checked="checked"'}else{if(g.lot[0]){g.lot[0].checked='checked="checked"'}}c.produit.push(g)}});this.reservationModif=new Array();$(this.reservation).each(function(){if(this.proId){e.reservationModif[this.proId]={comId:this.comId,proId:this.proId,dcomId:this.dcomId,stoId:this.stoId,stoQuantite:this.stoQuantite,stoType:this.stoType,stoIdCompte:this.stoIdCompte}}});$("#contenu").replaceWith(e.affectModifier($(f.template(c))))};this.affect=function(b){b=this.affectModifierReservation(b);b=this.affectAnnulerDetailReservation(b);return b};this.affectModifier=function(b){b=this.affectBtnQte(b);b=this.affectChangementLot(b);b=this.affectChangementProduit(b);b=this.preparerAffichageModifier(b);b=this.affectValiderReservation(b);b=this.affectAnnulerReservation(b);b=this.affectNouveauSolde(b);return b};this.affectBtnQte=function(b){var c=this;b.find(".btn-plus").click(function(){c.nouvelleQuantite($(this).parent().parent().find(".pdt-id").text(),$(this).parent().parent().find(".lot-id").text(),1)});b.find(".btn-moins").click(function(){c.nouvelleQuantite($(this).parent().parent().find(".pdt-id").text(),$(this).parent().parent().find(".lot-id").text(),-1)});return b};this.affectChangementLot=function(b){var c=this;b.find(".lot").click(function(){$(this).find(":radio").attr("checked","checked");c.changerLot($(this).find(".pdt-id").text(),$(this).find(".lot-id").text())});return b};this.affectChangementProduit=function(b){var c=this;b.find(".pdt :checkbox").click(function(){c.changerProduit($(this).parent().parent().find(".pdt-id").text())});return b};this.affectValiderReservation=function(b){var c=this;b.find("#btn-valider").click(function(){c.validerReservation()});return b};this.affectAnnulerReservation=function(b){var c=this;b.find("#btn-annuler").click(function(){c.afficherDetailReservation()});return b};this.affectModifierReservation=function(b){var c=this;b.find("#btn-modifier").click(function(){c.afficherModifier()});return b};this.affectAnnulerDetailReservation=function(b){var c=this;b.find("#btn-annuler").click(function(){EditerCommandeVue({id_commande:c.infoCommande.comId})});return b};this.nouvelleQuantite=function(f,i,b){var g=this.pdtCommande[f].proMaxProduitCommande;var j=this.pdtCommande[f].lot[i].dcomTaille;var h=this.pdtCommande[f].lot[i].dcomPrix;var d=0;if(this.reservationModif[f]&&(this.reservationModif[f].dcomId==i)){d=this.reservationModif[f].stoQuantite/j}d+=b;var c=0;c=d*j;if(c>0&&c<=g){var e=0;e=d*h;this.reservationModif[f].stoQuantite=c;$("#qte-pdt-"+f+"-lot-"+i).text(parseFloat(c).nombreFormate(2,","," "));$("#prix-pdt-"+f+"-lot-"+i).text(parseFloat(e).nombreFormate(2,","," "));this.majTotal()}};this.changerLot=function(b,c){$(".btn-pdt-"+b).attr("disabled","disabled").addClass("ui-helper-hidden");$(".colonne-pdt-"+b).addClass("ui-helper-hidden");$("#btn-moins-lot-"+c+",#btn-plus-lot-"+c).removeAttr("disabled").removeClass("ui-helper-hidden");$("#colonne-qte-pdt-"+b+"-lot-"+c+",#colonne-prix-pdt-"+b+"-lot-"+c+",#colonne-sigle-pdt-"+b+"-lot-"+c).removeClass("ui-helper-hidden");this.reservationModif[b].stoQuantite=$("#qte-pdt-"+b+"-lot-"+c).text().numberFrToDb();this.reservationModif[b].dcomId=c;this.majTotal()};this.changerProduit=function(b){var c=this;if($("#pdt-"+b).find(":checkbox").attr("checked")){$(".lot-pdt-"+b).show();$("[name=lot-produit-"+b+"]").each(function(){if($(this).attr("checked")){var e=$("#qte-pdt-"+b+"-lot-"+$(this).parent().parent().find(".lot-id").text()).text().numberFrToDb();if(c.reservationModif[b]){c.reservationModif[b].stoQuantite=e}else{var d={};d.comId=c.infoCommande.comId;d.dcomId=lIdLot;d.stoQuantite=e;c.reservationModif[b]=d}}})}else{$(".lot-pdt-"+b).hide();if(this.reservationModif[b]){this.reservationModif[b]=null}}this.majTotal()};this.majTotal=function(){$("#total").text(this.calculTotal().nombreFormate(2,","," "));this.majNouveauSolde()};this.majNouveauSolde=function(){var b=this.mAdherent.opeMontant-this.calculTotal();if(b<=0){$("#nouveau-solde").addClass("com-nombre-negatif");$("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde").removeClass("com-nombre-negatif");$("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}$("#nouveau-solde").text(b.nombreFormate(2,","," "))};this.affectNouveauSolde=function(c){var b=this.mAdherent.opeMontant-this.calculTotal();if(b<=0){c.find("#nouveau-solde").addClass("com-nombre-negatif");c.find("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{c.find("#nouveau-solde").removeClass("com-nombre-negatif");c.find("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}c.find("#nouveau-solde").text(b.nombreFormate(2,","," "));return c};this.calculTotal=function(){var c=this;var b=0;$(this.reservationModif).each(function(){var d=this;if(d.stoQuantite){if(c.pdtCommande[d.proId]){$(c.pdtCommande[d.proId].lot).each(function(){if(d.dcomId==this.dcomId){b+=(d.stoQuantite/this.dcomTaille)*this.dcomPrix}})}}});return b};this.preparerAffichageModifier=function(b){var c=this;b.find(":checkbox:not(:checked)").each(function(){b.find(".lot-pdt-"+$(this).parent().parent().find(".pdt-id").text()).hide()});b.find(":radio:not(:checked)").each(function(){var e=$(this).parent().parent().find(".lot-id").text();var d=$(this).parent().parent().find(".pdt-id").text();b.find("#btn-moins-lot-"+e+",#btn-plus-lot-"+e).attr("disabled","disabled").addClass("ui-helper-hidden");b.find("#colonne-qte-pdt-"+d+"-lot-"+e+",#colonne-prix-pdt-"+d+"-lot-"+e+",#colonne-sigle-pdt-"+d+"-lot-"+e).addClass("ui-helper-hidden")});return b};this.validerReservation=function(){var e=this;Infobulle.init();var c=new ListeReservationCommandeVO();var f=0;$(this.reservationModif).each(function(){if(this.stoQuantite){var h=new ReservationCommandeVO();h.id="";h.stoQuantite=this.stoQuantite*-1;h.stoIdDetailCommande=this.dcomId;c.commandes.push(h);f++}});if(f>0){var d=new ListeReservationCommandeValid();var g=d.validAjout(c);if(!g.valid){Infobulle.generer(g,"")}else{lParam={reservation:c,id_compte:this.mAdherent.adhIdCompte};$.post("./index.php?m=GestionCommande&v=ReservationAdherent","pParam="+$.toJSON(lParam),function(h){Infobulle.init();if(h.valid){e.reservation=new Array();$(e.reservationModif).each(function(){if(this.proId){e.reservation[this.proId]={comId:this.comId,proId:this.proId,dcomId:this.dcomId,stoId:this.stoId,stoQuantite:this.stoQuantite,stoType:this.stoType,stoIdCompte:this.stoIdCompte}}});e.afficher()}else{Infobulle.generer(h,"")}},"json")}}else{var g=new TemplateVR();g.valid=false;g.log.valid=false;var b=new VRerreur();b.code=ERR_207_CODE;b.message=ERR_207_MSG;g.log.erreurs.push(b);Infobulle.generer(g,"")}};this.construct(a)}function EditerCommandeVue(a){this.mNiveau=[];this.mIdCommande=null;this.construct=function(b){var c=this;$.post("./index.php?m=GestionCommande&v=EditerCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d.valid){c.afficher(d)}else{Infobulle.generer(d,"")}},"json")};this.afficher=function(d){var e=this;var b=new GestionCommandeTemplate();var f=b.editerCommandePage;var c={};c.comId=d.commande[0].comId;this.mIdCommande=c.comId;c.comNumero=d.commande[0].comNumero;c.comDescription=d.commande[0].comDescription;c.dateTimeFinReservation=d.commande[0].comDateFinReservation;c.dateFinReservation=d.commande[0].comDateFinReservation.extractDbDate().dateDbToFr();c.heureFinReservation=d.commande[0].comDateFinReservation.extractDbHeure();c.minuteFinReservation=d.commande[0].comDateFinReservation.extractDbMinute();c.dateMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbDate().dateDbToFr();c.heureMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbHeure();c.minuteMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbMinute();c.heureMarcheFin=d.commande[0].comDateMarcheFin.extractDbHeure();c.minuteMarcheFin=d.commande[0].comDateMarcheFin.extractDbMinute();c.pdtCommande=[];$(d.commande).each(function(){var g={dcomTaille:this.dcomTaille.nombreFormate(2,","," "),dcomPrix:this.dcomPrix.nombreFormate(2,","," ")};if(c.pdtCommande[this.proId]){c.pdtCommande[this.proId].lot[this.dcomId]=g}else{var h={proId:this.proId,proUniteMesure:this.proUniteMesure,proMaxProduitCommande:this.proMaxProduitCommande.nombreFormate(2,","," "),nproNom:this.nproNom,lot:[]};h.lot[this.dcomId]=g;$(d.stockInitiaux).each(function(){if(this.idProduit==h.proId){h.quantiteInit=this.quantite}});$(d.stock).each(function(){if(this.proId==h.proId){h.quantite=this.stoQuantite}});h.quantiteCommande=h.quantiteInit-h.quantite;e.mNiveau.push({id:h.proId,quantite:parseInt(h.quantiteCommande*100/h.quantiteInit)});h.quantiteCommande=h.quantiteCommande.nombreFormate(2,","," ");h.quantiteInit=h.quantiteInit.nombreFormate(2,","," ");h.quantite=h.quantite.nombreFormate(2,","," ");c.pdtCommande[this.proId]=h}});c.listeAdherentCommande=d.listeAdherentCommande;c.sigleMonetaire=gSigleMonetaire;var c=e.affect($(f.template(c)));if(!(d.listeAdherentCommande.length>0&&d.listeAdherentCommande[0].adhId!=null)){c.find("#edt-com-recherche").hide();c.find("#edt-com-liste-resa").replaceWith(b.listeReservationVide)}$("#contenu").replaceWith(c)};this.affect=function(b){b=this.affectTri(b);b=this.affectRecherche(b);b=this.affectNiveau(b);b=this.affectReservation(b);b=this.affectModifier(b);b=this.affectCloturer(b);return b};this.affectTri=function(b){b.find(".com-table").tablesorter({sortList:[[2,0]]});return b};this.affectRecherche=function(b){b.find("#filter").keyup(function(){$.uiTableFilter($(".com-table"),this.value)});b.find("#filter-form").submit(function(){return false});return b};this.affectNiveau=function(b){$(this.mNiveau).each(function(){var c=this.id;var d=this.quantite;b.find("#pdt-"+c).progressbar({value:d});b.find(".pdt-"+c+"-afficher-detail").click(function(){b.find("#pdt-"+c+"-detail").slideToggle();b.find(".pdt-"+c+"-afficher-detail").toggle()})});return b};this.affectReservation=function(b){var c=this;b.find(".edt-com-reservation-ligne").click(function(){ReservationAdherentVue({id_commande:c.mIdCommande,id_adherent:$(this).find(".id-adherent").text()})});return b};this.affectModifier=function(b){var c=this;b.find("#btn-modif-com").click(function(){ModifierCommandeVue({id_commande:c.mIdCommande})});return b};this.affectCloturer=function(b){var c=this;b.find("#dialog-cloturer-com").dialog({autoOpen:false,modal:true,draggable:false,resizable:false,width:600,buttons:{Cloturer:function(){var d={id_commande:c.mIdCommande};var e=this;$.post("./index.php?m=GestionCommande&v=CloturerCommande","pParam="+$.toJSON(d),function(g){Infobulle.init();if(g.valid){var f=new GestionCommandeTemplate();var h=f.cloturerCommandeSucces;$("#contenu").replaceWith(h.template(g));$(e).dialog("close")}else{Infobulle.generer(g,"")}},"json")},Annuler:function(){$(this).dialog("close")}}});b.find("#btn-cloture-com").click(function(){$("#dialog-cloturer-com").dialog("open")});return b};this.construct(a)};