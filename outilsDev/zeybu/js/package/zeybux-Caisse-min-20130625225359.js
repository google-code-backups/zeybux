function CaisseTemplate(){this.listeCommandePage='<div id="contenu"><div id="liste_commande_int"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés en cours</div><table class="com-table"><tr class="ui-widget ui-widget-header"><th class="com-table-th-debut com-center" colspan="2">N°</th><th class="com-table-th-med">Date de cloture des Réservations</th><th class="com-table-th-med">Marché</th>	<th class="com-table-th-fin"></th></tr><!-- BEGIN commande --><tr class="com-cursor-pointer btn-marche" id="{commande.id}"><td class="com-table-td-debut lst-resa-th-num com-text-align-right">{commande.numero} : </td><td class="com-table-td-med lst-resa-td-nom">{commande.nom}</td><td class="com-table-td-med">Le {commande.jourFinReservation} {commande.dateFinReservation} à {commande.heureFinReservation}H{commande.minuteFinReservation}</td><td class="com-table-td-med">Le {commande.jourMarcheDebut} {commande.dateMarcheDebut} de {commande.heureMarcheDebut}H{commande.minuteMarcheDebut} à {commande.heureMarcheFin}H{commande.minuteMarcheFin}</td><td class="com-table-td-fin"><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all"><span class="ui-icon ui-icon-triangle-1-e"></span></span></td></tr><!-- END commande --></table></div></div></div></div>';this.listeCommandeVide='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés en cours</div><p id="texte-liste-vide">Aucun Marché en cours.</p></div></div>';this.listeMarcheVide='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Vente</div><p id="texte-liste-vide">Aucun adhérent.</p></div></div>';this.listeAdherentCommandePage='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">{venteTitre}</div><div class="recherche com-widget-header ui-widget ui-widget-header ui-corner-all"><form id="filter-form"> <span class="conteneur-icon com-float-left ui-widget-content ui-corner-left" title="Chercher"><span class="ui-icon ui-icon-search"></span></span><input class="com-input-text ui-widget-content ui-corner-right" name="filter" id="filter" value="" maxlength="30" size="15" type="text" /></form></div><table class="com-table"><thead><tr class="ui-widget ui-widget-header com-cursor-pointer achat-commande-ligne" id-adherent="0" ><th class="com-table-th com-underline-hover com-center">Compte invité</th></tr></thead></table><table class="com-table" id="liste-adherent"><thead><tr class="ui-widget ui-widget-header com-cursor-pointer"><th class="com-table-th-debut com-underline-hover marche-com-th-num-adh"><span class="ui-icon span-icon"></span>Numéro Adhérent</th><th class="com-table-th-med com-underline-hover marche-com-th-num-adh"><span class="ui-icon span-icon"></span>Numéro Compte</th><th class="com-table-th-med com-underline-hover marche-com-th-nom"><span class="ui-icon span-icon"></span>Nom</th>	<th class="com-table-th-med com-underline-hover"><span class="ui-icon span-icon"></span>Prénom</th><th class="com-table-th-fin com-underline-hover"></th></tr></thead><tbody><!-- BEGIN listeAdherentCommande --><tr class="com-cursor-pointer achat-commande-ligne" id-adherent="{listeAdherentCommande.adhId}"><td class="com-table-td-debut com-underline-hover"><span class="ui-helper-hidden">{listeAdherentCommande.adhIdTri}</span>{listeAdherentCommande.adhNumero}</td><td class="com-table-td-med com-underline-hover"><span class="ui-helper-hidden">{listeAdherentCommande.cptIdTri}</span>{listeAdherentCommande.cptLabel}</td><td class="com-table-td-med com-underline-hover">{listeAdherentCommande.adhNom}</td><td class="com-table-td-med com-underline-hover">{listeAdherentCommande.adhPrenom}</td><td class="com-table-td-fin"><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all"><span class="ui-icon ui-icon-triangle-1-e"></span></span></td></tr><!-- END listeAdherentCommande --></tbody></table></div></div></div>';this.listeAdherentVenteMarcheTitre="Vente du Marché n°{numeroMarche}";this.listeAdherentVenteTitre="Vente";this.achatMarchePage='<div id="contenu">{formulaire}{detail}<div class="com-clear-float-left com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button type="button" id="btn-annuler" class="com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center">Annuler</button><button type="button" id="btn-modifier" class="ui-helper-hidden com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center">Modifier</button><button type="button" id="btn-confirmer" class="btn-valider ui-state-default ui-corner-all com-button com-center">Confirmer</button><button type="button" id="btn-enregistrer" class="btn-valider ui-helper-hidden ui-state-default ui-corner-all com-button com-center">Enregistrer</button></div></div>';this.achatMarcheSelectLot='<span><select id="select-{nproId}{type}" class="select-lot" data-id-nom-produit="{nproId}" data-type="{type}" ><!-- BEGIN lots --><option {lots.selected} value="{lots.id}">par {lots.tailleAffiche} {unite}</option><!-- END lots --></select></span>';this.achatMarcheAfficheLot='<span data-id-lot="{id}">par {tailleAffiche} {unite}</span>';this.achatMarchePrixUnitaire='à <span id="prix-unitaire-{nproId}">{prixUnitaire}</span> {sigleMonetaire}/{unite}';this.achatMarcheIdentiteAdherent="{adhNumero} : {adhPrenom} {adhNom}";this.achatMarcheIdentiteInvite="Invité";this.achatMarcheEtatCompte='{cptLabel} : <span id="solde" class="{adhSoldeEtatClass}">{adhSolde}</span> <span id="solde-sigle" class="{adhSoldeEtatClass}">{sigleMonetaire}</span>';this.achatMarcheEtatCompteInvite="Compte Invité";this.achatMarcheLabelRechargement="Recharger";this.achatMarcheLabelPaiement="Paiement";this.achatInfoAdherent='<div id="info-adherent-widget" class="com-widget-window ui-widget ui-widget-content ui-widget-content-transparent ui-corner-all"><table><tbody><tr><td colspan="2" class="info-adherent-cellule-nom-adherent"><div class="info-adherent-cellule ui-widget-header ui-corner-all">{identite}</div></td><td class="info-adherent-cellule-achat"><div class="info-adherent-cellule ui-widget-header ui-corner-all" >{etatCompte}</div></td><td id="ligne-rechargement" class="info-adherent-cellule-achat"><div id="cellule-recharger" class="info-adherent-cellule ui-widget-header ui-corner-all">{labelRecharger} : <span class="form-produit ui-helper-hidden" id="rechargement-affiche"></span><input type="text" name="montant-rechargement" value="{rechargementMontant}" class="form-produit com-numeric com-input-text ui-widget-content ui-corner-all" id="rechargementmontant" maxlength="12" size="12"/> {sigleMonetaire}</div><div id="select-typePaiement" class="info-adherent-cellule-achat ui-widget ui-widget-content ui-helper-hidden ui-corner-bottom"><span id="label-type-paiement">Type de Paiement<br/><span><select name="typepaiement" id="rechargementtypePaiement" class="form-produit"><option value="0">== Choisir ==</option><!-- BEGIN typePaiement --><option {typePaiement.selected} value="{typePaiement.tppId}">{typePaiement.tppType}</option><!-- END typePaiement --></select><span class="form-produit ui-helper-hidden" id="rechargement-select-affiche"></span><div id="form-champ-complementaire" class="{rechargementAfficheChampComplementaire}"><div id="label-champ-complementaire"></div><span class="form-produit ui-helper-hidden" id="rechargement-champ-complementaire-affiche"></span><input type="text" name="champ-complementaire" value="{rechargementChampComplementaire}" class="form-produit com-input-text ui-widget-content ui-corner-all" id="rechargementchampComplementaire" maxlength="50" size="15"/><br/><div id="label-champ-complementaire-banque">Banque</div><span class="form-produit ui-helper-hidden" id="rechargement-banque-affiche"></span><input id-banque="{rechargementIdBanque}" type="text" name="champ-complementaire-banque" value="{rechargementNomBanque}" class="form-produit com-input-text ui-widget-content ui-corner-all" id="rechargementidBanque" maxlength="50" size="15"/></div></div></td></tr><tr><td colspan="2" class="info-adherent-cellule-achat"><div class="info-adherent-cellule ui-widget-header ui-corner-all">Total : <span id="total">{total}</span> {sigleMonetaire}</div></td><td><div class="info-adherent-cellule ui-widget-header ui-corner-all">Achat : <span id="total-achat">{totalAchat}</span> {sigleMonetaire}</div></td><td><div class="info-adherent-cellule ui-widget-header ui-corner-all">Solidaire : <span id="total-achat-solidaire">{totalAchatSolidaire}</span> {sigleMonetaire}</div></td></tr><tr><td><div id="recherche-produit" class="recherche-produit-achat-marche ui-widget ui-widget-header ui-corner-all" ><span id="icon-recherche" class="conteneur-icon com-float-left ui-widget-content ui-widget-content-transparent ui-corner-left" title="Chercher"><span class="ui-icon ui-icon-search"></span></span><input id="input-rechercher" class="com-input-text ui-widget-content ui-widget-content-transparent" name="filter" value="" maxlength="30" size="15" type="text" /><span id="icon-annuler-recherche" class="com-cursor-pointer conteneur-icon com-float-right ui-widget-content ui-widget-content-transparent ui-corner-right" title="Annuler"><span class="ui-icon ui-icon-close"></span></span></div></td><td><div class="info-adherent-cellule com-center"><button type="button" id="btn-valider" class="ui-state-default ui-corner-all com-button com-center">Valider</button><button type="button" id="btn-modifier" class="ui-helper-hidden ui-state-default ui-corner-all com-button com-center">Modifier</button></div></td><td><div class="ligne-lot-produit ui-helper-hidden info-adherent-cellule ui-widget-header ui-corner-all">Prix : <span id="cellule-lot-produit"></span></div><div class="info-adherent-cellule com-center"><button type="button" id="btn-enregistrer" class="ui-helper-hidden ui-state-default ui-corner-all com-button com-center">Enregistrer</button></div></td><td><div class="ligne-lot-produit ui-helper-hidden info-adherent-cellule ui-widget-header ui-corner-all"><span id="cellule-lot-produit-prix-unitaire"></span></div></td></tr></tbody></table></div>';this.achatHorsMarcheFormulaire='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-retour"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour</button></div>{infoAdherent}<div id="formulaire-produit" class="tableau-liste-produit com-widget-window ui-widget ui-widget-content ui-widget-content-transparent ui-corner-all"><table class="achat-commande-table-pdt"><thead><tr><th class="info-adherent-cellule-nom-adherent"></th><th colspan="4" class="info-adherent-cellule-achat">Achat</th><th colspan="4" class="info-adherent-cellule-achat">Achat Solidaire</th></tr><tr><th></th><th colspan="2" class="formulaire-achat-produit-quantite">Quantite</th><th colspan="2" class="formulaire-achat-produit-prix">Prix</th><th colspan="2" class="formulaire-achat-produit-quantite">Quantite</th><th colspan="2" class="formulaire-achat-produit-prix">Prix</th></tr></thead></table><!-- BEGIN categories --><div id="ligne-categorie-{categories.cproId}" class="ligne-categorie ui-widget-header ui-corner-all com-cursor-pointer" data-id-categorie="{categories.cproId}">{categories.cproNom}<span class="ligne-categorie-btn-toggle com-btn-header-multiples-gauche ui-widget-content ui-widget-content-transparent ui-corner-all" id="btn-toggle-categorie-{categories.cproId}"><span class="ui-icon ui-icon-triangle-1-s"></span></div><table id="tableau-produit-{categories.cproId}" class="com-table-100 tableau-produit {categories.visible}"><tbody><!-- BEGIN categories.produits --><tr class="ligne-produit" data-id-produit="{categories.produits.id}" data-id-nom-produit="{categories.produits.nproId}" data-id-categorie="{categories.cproId}" ><td class="info-adherent-cellule-nom-adherent">{categories.produits.nom}</td><td class="input-formulaire-achat-produit" ><input type="text" id="produits{categories.produits.nproId}quantite" class="produit-quantite com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="" /></td><td class="formulaire-achat-produit-unite">{categories.produits.unite}</td><td class="input-formulaire-achat-produit"><input type="text" id="produits{categories.produits.nproId}prix" class="produit-prix com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="" /></td><td class="formulaire-achat-produit-sigle-monetaire">{sigleMonetaire}</td><td class="input-formulaire-achat-produit"><input type="text" id="produitsSolidaire{categories.produits.nproId}quantite" class="produit-quantite-solidaire com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="Solidaire" /></td><td class="formulaire-achat-produit-unite">{categories.produits.unite}</td><td class="input-formulaire-achat-produit"><input type="text" id="produitsSolidaire{categories.produits.nproId}prix" class="produit-prix-solidaire com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="Solidaire" /></td><td class="formulaire-achat-produit-sigle-monetaire">{sigleMonetaire}</td></tr><!-- END categories.produits --></tbody></table><!-- END categories --></div></div>';this.achatHorsMarcheDetailAchat='<div id="formulaire-produit-detail" class="tableau-liste-produit com-widget-window ui-widget ui-widget-content ui-widget-content-transparent ui-corner-all"><table class="achat-commande-table-pdt"><thead><tr><th class="info-adherent-cellule-nom-adherent"></th><th colspan="4" class="info-adherent-cellule-achat">Achat</th><th colspan="4" class="info-adherent-cellule-achat">Achat Solidaire</th></tr><tr><th></th><th colspan="2" class="formulaire-achat-produit-quantite">Quantite</th><th colspan="2" class="formulaire-achat-produit-prix">Prix</th><th colspan="2" class="formulaire-achat-produit-quantite">Quantite</th><th colspan="2" class="formulaire-achat-produit-prix">Prix</th></tr></thead></table><!-- BEGIN categories --><div class="ui-widget-header ui-corner-all">{categories.cproNom}</div><table class="com-table-100"><tbody><!-- BEGIN categories.produits --><tr class="ligne-detail-produit" ><td class="info-adherent-cellule-nom-adherent">{categories.produits.nom}</td><td class="input-formulaire-achat-produit">{categories.produits.quantite}</td><td class="formulaire-achat-produit-unite">{categories.produits.unite}</td><td class="input-formulaire-achat-produit">{categories.produits.prix}</td><td class="formulaire-achat-produit-sigle-monetaire">{categories.produits.sigleMonetaire}</td><td class="input-formulaire-achat-produit">{categories.produits.quantiteSolidaire}</td><td class="formulaire-achat-produit-unite">{categories.produits.uniteSolidaire}</td><td class="input-formulaire-achat-produit">{categories.produits.prixSolidaire}</td><td class="formulaire-achat-produit-sigle-monetaire">{categories.produits.sigleMonetaireSolidaire}</td></tr><!-- END categories.produits --></tbody></table><!-- END categories --></div>';this.achatMarcheFormulaire='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-retour"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour</button></div>{infoAdherent}<div id="formulaire-produit" class="tableau-liste-produit com-widget-window ui-widget ui-widget-content ui-widget-content-transparent ui-corner-all"><table class="achat-commande-table-pdt"><thead><tr><th class="formulaire-achat-produit-nom-produit-reservation"></th><th class="formulaire-achat-produit-reservation">Réservation</th><th colspan="4" class="info-adherent-cellule-achat">Achat</th><th colspan="4" class="info-adherent-cellule-achat">Achat Solidaire</th></tr><tr><th colspan="2" ></th><th colspan="2" class="formulaire-achat-produit-quantite">Quantite</th><th colspan="2" class="formulaire-achat-produit-prix">Prix</th><th colspan="2" class="formulaire-achat-produit-quantite">Quantite</th><th colspan="2" class="formulaire-achat-produit-prix">Prix</th></tr></thead></table><!-- BEGIN categories --><div id="ligne-categorie-{categories.cproId}" class="ligne-categorie ui-widget-header ui-corner-all com-cursor-pointer" data-id-categorie="{categories.cproId}">{categories.cproNom}<span class="ligne-categorie-btn-toggle com-btn-header-multiples-gauche ui-widget-content ui-widget-content-transparent ui-corner-all" id="btn-toggle-categorie-{categories.cproId}"><span class="ui-icon ui-icon-triangle-1-s"></span></div><table id="tableau-produit-{categories.cproId}" class="com-table-100 tableau-produit {categories.visible}"><tbody><!-- BEGIN categories.produits --><tr class="ligne-produit" data-id-produit="{categories.produits.id}" data-id-nom-produit="{categories.produits.nproId}" data-id-categorie="{categories.cproId}" ><td class="formulaire-achat-produit-nom-produit-reservation">{categories.produits.nom}</td><td class="formulaire-achat-produit-reservation">{categories.produits.quantiteReservation}</td><td class="input-formulaire-achat-produit" ><input type="text" value="{categories.produits.quantiteAchat}" id="produits{categories.produits.nproId}quantite" class="produit-quantite com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="" /></td><td class="formulaire-achat-produit-unite">{categories.produits.unite}</td><td class="input-formulaire-achat-produit"><input type="text" value="{categories.produits.prixAchat}" id="produits{categories.produits.nproId}prix" class="produit-prix com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="" /></td><td class="formulaire-achat-produit-sigle-monetaire">{sigleMonetaire}</td><td class="input-formulaire-achat-produit"><input type="text" value="{categories.produits.quantiteAchatSolidaire}" id="produitsSolidaire{categories.produits.nproId}quantite" class="produit-quantite-solidaire com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="Solidaire" /></td><td class="formulaire-achat-produit-unite">{categories.produits.unite}</td><td class="input-formulaire-achat-produit"><input type="text" value="{categories.produits.prixAchatSolidaire}" id="produitsSolidaire{categories.produits.nproId}prix" class="produit-prix-solidaire com-numeric com-input-text ui-widget-content ui-corner-all" maxlength="12" size="3" data-id-nom-produit="{categories.produits.nproId}" data-type="Solidaire" /></td><td class="formulaire-achat-produit-sigle-monetaire">{sigleMonetaire}</td></tr><!-- END categories.produits --></tbody></table><!-- END categories --></div></div>';this.achatCommandeSucces='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat</div><div class="com-widget-content"><p class="com-msg-confirm-icon"><span class="com-float-left ui-icon ui-icon-check"></span>Achat effectué avec succès.<br/><br/><button id="lien-retour" class="ui-state-default ui-corner-all com-button com-center">Retourner à la liste des adhérents</button></p></div></div></div>';this.lotUnique='<input type="hidden" id="lot-{IdPdt}" value="{valeur}" /><span>{text}</span>';this.lotUniqueSolidaire='<input type="hidden" id="lot-solidaire-{IdPdt}" value="{valeur}" /><span>{text}</span>';this.flagAbonnement='<span class="com-widget-header ui-widget ui-widget-header ui-corner-all">Abo</span>'}function CaisseListeCommandeVue(a){this.construct=function(b){$.history({vue:function(){CaisseListeCommandeVue(b)}});var c=this;$.post("./index.php?m=Caisse&v=CaisseListeCommande",function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(d){var c=this;var b=new CaisseTemplate();if(d.listeCommande.length>0&&d.listeCommande[0].id!=null){var e=new Object;e.commande=new Array();$(d.listeCommande).each(function(){var g={};g.id=this.id;g.numero=this.numero;g.nom=this.nom;g.jourFinReservation=jourSem(this.dateFinReservation.extractDbDate());g.dateFinReservation=this.dateFinReservation.extractDbDate().dateDbToFr();g.heureFinReservation=this.dateFinReservation.extractDbHeure();g.minuteFinReservation=this.dateFinReservation.extractDbMinute();g.jourMarcheDebut=jourSem(this.dateMarcheDebut.extractDbDate());g.dateMarcheDebut=this.dateMarcheDebut.extractDbDate().dateDbToFr();g.heureMarcheDebut=this.dateMarcheDebut.extractDbHeure();g.minuteMarcheDebut=this.dateMarcheDebut.extractDbMinute();g.heureMarcheFin=this.dateMarcheFin.extractDbHeure();g.minuteMarcheFin=this.dateMarcheFin.extractDbMinute();e.commande.push(g)});var f=b.listeCommandePage;$("#contenu").replaceWith(c.affect($(f.template(e))))}else{$("#contenu").replaceWith(c.affect($(b.listeCommandeVide)))}};this.affect=function(b){b=this.affectLienMarche(b);b=this.gCommunVue.comHoverBtn(b);return b};this.affectLienMarche=function(b){b.find(".btn-marche").click(function(){CaisseMarcheCommandeVue({id_commande:$(this).attr("id")})});return b};this.construct(a)}function CaisseMarcheCommandeVue(a){this.idCommande=null;this.construct=function(b){var c=this;if(b&&b.id_commande){if(b.id_commande==-1){b.fonction="listeAdherent"}else{b.fonction="listeReservation"}$.history({vue:function(){CaisseMarcheCommandeVue(b)}});$.post("./index.php?m=Caisse&v=CaisseMarcheCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(d)}else{Infobulle.generer(d,"")}}},"json");this.idCommande=b.id_commande}};this.afficher=function(d){if(d.listeAdherentCommande){var e=this;var b=new CaisseTemplate();if(this.idCommande==-1){d.venteTitre=b.listeAdherentVenteTitre}else{d.venteTitre=b.listeAdherentVenteMarcheTitre.template(d)}if(d.listeAdherentCommande.length>0&&d.listeAdherentCommande[0].adhId!=null){d.comNumero=d.listeAdherentCommande[0].comNumero;$.each(d.listeAdherentCommande,function(){this.adhIdTri=this.adhNumero.replace("Z","");this.cptIdTri=this.cptLabel.replace("C","")});$("#contenu").replaceWith(e.affect($(b.listeAdherentCommandePage.template(d))))}else{$("#contenu").replaceWith(b.listeMarcheVide)}}else{var f=new TemplateVR();f.valid=false;f.log.valid=false;var c=new VRerreur();c.code=ERR_211_CODE;c.message=ERR_211_MSG;f.log.push(c);Infobulle.generer(f,"")}};this.affect=function(b){b=this.affectTri(b);b=this.affectRecherche(b);b=this.affectLienAchat(b);return b};this.affectTri=function(b){b.find("#liste-adherent").tablesorter({sortList:[[2,0]],headers:{4:{sorter:false}}});return b};this.affectRecherche=function(b){b.find("#filter").keyup(function(){$.uiTableFilter($("#liste-adherent"),this.value)});b.find("#filter-form").submit(function(){return false});return b};this.affectLienAchat=function(b){var c=this;b.find(".achat-commande-ligne").click(function(){var d={id_commande:c.idCommande,id_adherent:$(this).attr("id-adherent")};CaisseAchatCommandeVue(d)});return b};this.construct(a)}function CaisseAchatCommandeVue(a){this.mParam={};this.mSolde=0;this.mIdCompte=0;this.mTypePaiement=[];this.mBanques=[];this.mAdherent={};this.mLots=[];this.mPrixProduit=[];this.mLotAchat=[];this.mFocusRechargement=0;this.mCategorie=[];this.mNomCategorie=[];this.mAchat={};this.mIdAchat=[];this.construct=function(b){$.history({vue:function(){CaisseAchatCommandeVue(b)}});this.mParam=b;var c=this;b.fonction="infoAchat";if(b.id_adherent==0){this.mIdCompte=-3}$.post("./index.php?m=Caisse&v=CaisseMarcheCommande","pParam="+$.toJSON(b),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}$(e.typePaiement).each(function(){c.mTypePaiement[this.tppId]=this;this.selected=""});var f=0;if(b.id_adherent!=0){c.mIdCompte=e.adherent.adhIdCompte;c.mAdherent=e.adherent;c.mSolde=parseFloat(e.adherent.cptSolde);e.adherent.rechargementMontant="";e.adherent.rechargementChampComplementaire="";e.adherent.rechargementNomBanque="";e.adherent.rechargementIdBanque="";e.adherent.rechargementAfficheChampComplementaire="ui-helper-hidden";if(e.rechargement!=null&&e.rechargement.id&&e.rechargement.id!=null){c.mSolde=(parseFloat(c.mSolde)-parseFloat(e.rechargement.montant)).toFixed(2);e.adherent.rechargementMontant=e.rechargement.montant.nombreFormate(2,",","");f=e.rechargement.typePaiement;if(c.getLabelChamComplementaire(e.rechargement.typePaiement)!=null){e.adherent.rechargementAfficheChampComplementaire="";e.adherent.rechargementChampComplementaire=e.rechargement.typePaiementChampComplementaire;e.adherent.rechargementIdBanque=e.rechargement.idBanque;$(e.banques).each(function(){if(this.id==e.rechargement.idBanque){e.adherent.rechargementNomBanque=this.nom}})}}}else{e.adherent={rechargementMontant:"",rechargementChampComplementaire:"",rechargementNomBanque:"",rechargementIdBanque:"",rechargementAfficheChampComplementaire:"ui-helper-hidden"}}$(e.typePaiement).each(function(){if(this.tppId==f){this.selected='selected="selected"'}});c.mBanques=e.banques;e.adherent.total=0;e.adherent.totalAchat=0;e.adherent.totalAchatSolidaire=0;if(b.id_commande!=-1){$.each(e.marche.produits,function(){if(this.id){var i=this.id;var h=this.unite;var l={id:this.id,nproId:this.idNom,nom:this.nom,unite:this.unite,quantiteReservation:"",quantiteAchat:"",prixAchat:"",quantiteAchatAffiche:"",prixAchatAffiche:"",quantiteAchatSolidaire:"",prixAchatSolidaire:"",quantiteAchatAfficheSolidaire:"",prixAchatAfficheSolidaire:""};var g=[];$.each(this.lots,function(){this.mLotPrixUnitaire=(parseFloat(this.prix)/parseFloat(this.taille)).toFixed(2).nombreFormate(2,","," ");this.tailleAffiche=this.taille.nombreFormate(2,","," ");this.selected="";c.mLots[this.id]=this;g.sort(function(n,m){return n.taille.localeCompare(m.taille)});g.push(this)});var j=false;if(b.id_adherent!=0){$.each(e.reservation,function(){if(this.idProduit==i){l.quantiteReservation=(this.quantite*-1).nombreFormate(2,","," ")+" "+h;if(e.achats.length==0){l.quantiteAchat=(this.quantite*-1).nombreFormate(2,",","");l.prixAchat=(this.montant*-1).nombreFormate(2,",","");e.adherent.totalAchat=(parseFloat(e.adherent.totalAchat)-parseFloat(this.montant)).toFixed(2);c.mLotAchat[l.nproId]={normal:this.idDetailCommande,solidaire:0}}j=true}});$.each(e.achats,function(){if(this.id&&this.id.idAchat){c.mIdAchat.push(this.id.idAchat)}$(this.detailAchat).each(function(){if(this.idProduit==i){l.quantiteAchat=(this.quantite*-1).nombreFormate(2,",","");l.prixAchat=(this.montant*-1).nombreFormate(2,",","");l.quantiteAchatAffiche=(this.quantite*-1).nombreFormate(2,","," ");l.prixAchatAffiche=(this.montant*-1).nombreFormate(2,","," ");e.adherent.totalAchat=(parseFloat(e.adherent.totalAchat)-parseFloat(this.montant)).toFixed(2);j=true;c.mSolde=(parseFloat(c.mSolde)-parseFloat(this.montant)).toFixed(2);if(c.mLotAchat[l.nproId]){c.mLotAchat[l.nproId].normal=this.idDetailCommande}else{c.mLotAchat[l.nproId]={normal:this.idDetailCommande,solidaire:""}}}});$(this.detailAchatSolidaire).each(function(){if(this.idProduit==i){l.quantiteAchatSolidaire=(this.quantite*-1).nombreFormate(2,",","");l.prixAchatSolidaire=(this.montant*-1).nombreFormate(2,",","");l.quantiteAchatAfficheSolidaire=(this.quantite*-1).nombreFormate(2,","," ");l.prixAchatAfficheSolidaire=(this.montant*-1).nombreFormate(2,","," ");e.adherent.totalAchatSolidaire=(parseFloat(e.adherent.totalAchatSolidaire)-parseFloat(this.montant)).toFixed(2);j=true;c.mSolde=(parseFloat(c.mSolde)-parseFloat(this.montant)).toFixed(2);if(c.mLotAchat[l.nproId]){c.mLotAchat[l.nproId].solidaire=this.idDetailCommande}else{c.mLotAchat[l.nproId]={normal:"",solidaire:this.idDetailCommande}}}})});e.adherent.total=(parseFloat(e.adherent.totalAchat)+parseFloat(e.adherent.totalAchatSolidaire)).toFixed(2)}if(!c.mCategorie[this.idCategorie]){var k={cproId:this.idCategorie,cproNom:this.cproNom,visible:"ui-helper-hidden",produits:[]};c.mCategorie[this.idCategorie]=k;c.mNomCategorie[this.idCategorie]=k}if(j){c.mCategorie[this.idCategorie].visible=""}c.mCategorie[this.idCategorie].produits[this.idNom]=l;l.lots=g;c.mPrixProduit[this.idNom]=l}})}var d=-1;$.each(e.stock,function(){if(this.idNom){var h=this.idNom;var i=false;if(b.id_commande!=-1){$.each(e.marche.produits,function(){if(this.id&&this.idNom==h){i=true}})}if(!i){var g=[];$.each(this.lots,function(){this.mLotPrixUnitaire=(parseFloat(this.prix)/parseFloat(this.taille)).toFixed(2).nombreFormate(2,","," ");this.tailleAffiche=this.taille.nombreFormate(2,","," ");this.selected="";c.mLots[this.id]=this;g.push(this)});if(!c.mCategorie[this.idCategorie]){var k={cproId:this.idCategorie,cproNom:this.cproNom,visible:"ui-helper-hidden",produits:[]};c.mCategorie[this.idCategorie]=k;c.mNomCategorie[this.idCategorie]=k}var j={id:d,nproId:this.idNom,nom:this.nom,unite:this.unite,quantiteReservation:"",quantiteAchat:"",prixAchat:"",quantiteAchatAffiche:"",prixAchatAffiche:"",quantiteAchatSolidaire:"",prixAchatSolidaire:"",quantiteAchatAfficheSolidaire:"",prixAchatAfficheSolidaire:""};c.mCategorie[this.idCategorie].produits[this.idNom]=j;g.sort(function(m,l){return m.taille.localeCompare(l.taille)});j.lots=g;c.mPrixProduit[this.idNom]=j;d--}}});c.mCategorie.sort(function(h,g){return h.cproNom.localeCompare(g.cproNom)});$.each(c.mCategorie,function(){if(this.cproNom){this.produits.sort(function(h,g){return h.nom.localeCompare(g.nom)})}});if(b.id_commande!=-1){if(e.achats.length>0||(e.rechargement!=null&&e.rechargement.id!=null)){c.afficher(e,c.recapitulatifAchat)}else{c.afficher(e)}}else{c.afficher(e)}}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(e,f){var c=new CaisseTemplate();var d={categories:this.mCategorie,sigleMonetaire:gSigleMonetaire};e.adherent.sigleMonetaire=gSigleMonetaire;e.adherent.typePaiement=e.typePaiement;e.adherent.total=e.adherent.total.nombreFormate(2,","," ");e.adherent.totalAchat=e.adherent.totalAchat.nombreFormate(2,","," ");e.adherent.totalAchatSolidaire=e.adherent.totalAchatSolidaire.nombreFormate(2,","," ");if(this.mParam.id_adherent!=0){e.adherent.adhSoldeEtatClass="";if(parseFloat(e.adherent.cptSolde)<=0){e.adherent.adhSoldeEtatClass="com-nombre-negatif"}e.adherent.adhSolde=e.adherent.cptSolde.nombreFormate(2,","," ");e.adherent.identite=c.achatMarcheIdentiteAdherent.template(e.adherent);e.adherent.etatCompte=c.achatMarcheEtatCompte.template(e.adherent);e.adherent.labelRecharger=c.achatMarcheLabelRechargement}else{e.adherent.identite=c.achatMarcheIdentiteInvite;e.adherent.etatCompte=c.achatMarcheEtatCompteInvite;e.adherent.labelRecharger=c.achatMarcheLabelPaiement}d.infoAdherent=c.achatInfoAdherent.template(e.adherent);var b="";if(a.id_commande!=-1){b=c.achatMarcheFormulaire.template(d)}else{b=c.achatHorsMarcheFormulaire.template(d)}$("#contenu").replaceWith(this.affect($(b)));if(f){f()}};this.affect=function(b){b=this.affectAfficheLot(b);b=this.affectCalculPrix(b);b=this.affectPositionInfoAdherent(b);b=this.affectMajSolde(b);b=this.affectAfficheFormulaireRechargement(b);b=this.affectSelectTypePaiement(b);b=this.affectListeBanque(b);b=this.affectValider(b);b=this.affectModifier(b);b=this.affectToggleTableauCategorie(b);b=this.affectRecherche(b);b=this.affectRetour(b);b=this.affectEnregistrer(b);b=gCommunVue.comNumeric(b);b=gCommunVue.comHoverBtn(b);return b};this.affectRecherche=function(b){var c=this;b.find("#input-rechercher").keyup(function(){c.recherche(this.value)});b.find("#icon-annuler-recherche").click(function(){$("#input-rechercher").val("");c.recherche("")});return b};this.recherche=function(c){var b=this;if(c==""){b.afficheCategorieNonVide()}else{$(".tableau-produit").show()}$.uiTableFilter($(".tableau-produit"),c)};this.afficheCategorieNonVide=function(){var b=this;$(".ligne-categorie-btn-toggle span").addClass("ui-icon-triangle-1-s").removeClass("ui-icon-triangle-1-n");$(".tableau-produit").hide();$(".ligne-produit").each(function(){var f=$(this).data("id-nom-produit");var e=$(this).data("id-categorie");var d=new ProduitAchatVO();var c=new ProduitAchatVO();d=b.qteEtPrixAchat(f,"",d);c=b.qteEtPrixAchat(f,"Solidaire",c);if(d.quantite!=""||d.prix!=""||c.quantite!=""||c.prix!=""){$("#btn-toggle-categorie-"+e+" span").removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-n");$("#tableau-produit-"+e).show()}})};this.affectToggleTableauCategorie=function(b){b.find(".ligne-categorie").click(function(){var c=$(this).data("id-categorie");$("#btn-toggle-categorie-"+c+" span").toggleClass("ui-icon-triangle-1-s").toggleClass("ui-icon-triangle-1-n");$("#tableau-produit-"+c).toggle()});return b};this.affectAfficheLot=function(c){var d=this;var b=new CaisseTemplate();c.find(".produit-quantite, .produit-quantite-solidaire, .produit-prix, .produit-prix-solidaire").focus(function(){var f=$(this).data("id-nom-produit");var e=$(this).data("type");if($("#select-"+f+e).length==0){var h=d.mPrixProduit[f];h.prixUnitaire=h.lots[0].mLotPrixUnitaire;if(h.lots.length==1){h.lotAffiche=b.achatMarcheAfficheLot.template({id:h.lots[0].id,tailleAffiche:h.lots[0].tailleAffiche,unite:h.unite,})}else{if(d.mLotAchat[f]){var g=0;if(e==""){g=d.mLotAchat[f].normal}else{g=d.mLotAchat[f].solidaire}$(h.lots).each(function(){if(this.id==g){h.prixUnitaire=this.mLotPrixUnitaire;this.selected='selected="selected"'}else{this.selected=""}})}h.lotAffiche=b.achatMarcheSelectLot.template($.extend({type:e},h))}$("#cellule-lot-produit").html(d.affectChangeLot($(h.lotAffiche)));h.sigleMonetaire=gSigleMonetaire;$("#cellule-lot-produit-prix-unitaire").html(b.achatMarchePrixUnitaire.template(h));$(".ligne-lot-produit").show()}}).blur(function(){var e=$(this).data("id-nom-produit");if(d.mPrixProduit[e].lots.length==1){$(".ligne-lot-produit").hide()}}).keyup(function(){var f=$(this).data("id-nom-produit");var e=$(this).data("type");var g=0;if(d.mPrixProduit[f].lots.length==1){g=d.mPrixProduit[f].lots[0].id}else{g=d.mLots[$("#select-"+f+e).val()].id}if(d.mLotAchat[f]){if(e==""){d.mLotAchat[f].normal=g}else{d.mLotAchat[f].solidaire=g}}else{if(e==""){d.mLotAchat[f]={normal:g,solidaire:0}}else{d.mLotAchat[f]={normal:0,solidaire:g}}}});return c};this.affectCalculPrix=function(b){var c=this;b.find(".produit-quantite, .produit-quantite-solidaire").keyup(function(){c.calculPrix($(this).data("id-nom-produit"),$(this).data("type"),$(this).val())});return b};this.calculPrix=function(f,b,e){var c={};if(this.mPrixProduit[f].lots.length==1){c=this.mPrixProduit[f].lots[0]}else{c=this.mLots[$("#select-"+f+b).val()]}e=parseFloat(e.numberFrToDb());var d="";if(!isNaN(e)){d=(parseFloat(e)*parseFloat(c.prix)/parseFloat(c.taille)).toFixed(2).nombreFormate(2,",","")}$("#produits"+b+f+"prix").val(d)};this.affectChangeLot=function(b){var c=this;b.find(".select-lot").change(function(){var e=$(this).data("id-nom-produit");var d=$(this).data("type");var f=$(this).val();$("#produits"+d+e+"quantite, #produits"+d+e+"prix").val("");$("#prix-unitaire-"+e).text(c.mLots[f].mLotPrixUnitaire)});return b};this.affectPositionInfoAdherent=function(c){var d=null;var b=c.find("#info-adherent-widget").first();var e=c.find(".tableau-liste-produit").first();$(window).scroll(function(){var f=$(this).scrollTop();if(!d){d=setTimeout(function(){d=null;if(b.css("position")!=="fixed"&&b.offset().top<$(document).scrollTop()){e.css("margin-top",b.outerHeight()+10);b.css({"z-index":999,position:"fixed",top:0,width:e.width(),"box-shadow":"0 0 20px #555"}).removeClass("ui-corner-all").addClass("ui-corner-bottom")}else{if($(document).scrollTop()<=e.offset().top){e.css("margin-top","");b.css({position:"","z-index":"",width:"","box-shadow":""}).removeClass("ui-corner-bottom").addClass("ui-corner-all")}}},250)}});return c};this.affectMajSolde=function(b){var c=this;b.find(".produit-quantite, .produit-quantite-solidaire, .produit-prix, .produit-prix-solidaire, #rechargementmontant").keyup(function(){var f=(parseFloat(c.majTotal(""))+parseFloat(c.majTotal("-solidaire"))).toFixed(2);$("#total").text(f.nombreFormate(2,","," "));var e=parseFloat($("#rechargementmontant").val().numberFrToDb());if(isNaN(e)){e=0}var d=(parseFloat(c.mSolde)-f+e).toFixed(2);$("#solde").text(d.nombreFormate(2,","," "));if(d<=0){$("#solde, #solde-sigle").addClass("com-nombre-negatif")}else{$("#solde, #solde-sigle").removeClass("com-nombre-negatif")}});return b};this.majTotal=function(b){var c=0;$(".produit-prix"+b).each(function(){var d=parseFloat($(this).val().numberFrToDb());if(!isNaN(d)){c=(parseFloat(c)+d).toFixed(2)}});$("#total-achat"+b).text(c.nombreFormate(2,","," "));return parseFloat(c)};this.affectAfficheFormulaireRechargement=function(c){var d=this;var b=c.find("#cellule-recharger");c.find("#rechargementmontant, #rechargementtypePaiement, #rechargementchampComplementaire, #rechargementidBanque").focus(function(){d.mFocusRechargement++;$("#select-typePaiement").show();b.removeClass("ui-corner-all").addClass("ui-corner-top")}).blur(function(){d.mFocusRechargement--;if(d.mFocusRechargement==0){$("#select-typePaiement").hide();b.removeClass("ui-corner-top").addClass("ui-corner-all")}});c.find("#ligne-rechargement").hover(function(){d.mFocusRechargement++;$("#select-typePaiement").show();b.removeClass("ui-corner-all").addClass("ui-corner-top")},function(){d.mFocusRechargement--;if(d.mFocusRechargement==0){$("#select-typePaiement").hide();b.removeClass("ui-corner-top").addClass("ui-corner-all")}});return c};this.affectSelectTypePaiement=function(b){var c=this;b.find(":input[name=typepaiement]").change(function(){c.changerTypePaiement($(this))});return b};this.changerTypePaiement=function(d){var c=d.val();var b=this.getLabelChamComplementaire(c);if(b!=null){$("#label-champ-complementaire").text(b).show();$("#form-champ-complementaire").show()}else{$("#label-champ-complementaire").text("").hide();$(':input[name="champ-complementaire"], :input[name="champ-complementaire-banque"]').val("");$("#form-champ-complementaire").hide();$("#rechargementidBanque").attr("id-banque","")}};this.getLabelChamComplementaire=function(c){var b=this.mTypePaiement;if(b[c]){if(b[c].tppChampComplementaire==1){return b[c].tppLabelChampComplementaire}}return null};this.affectListeBanque=function(c){var d=this;function b(f){var h=$(f).val(),i=new RegExp("^"+$.ui.autocomplete.escapeRegex(h)+"$","i"),g=false;$(d.mBanques).each(function(){if($(this).text().match(i)){this.selected=g=true;return false}});if(!g){$(f).attr("id-banque","");var j=new RechargementCompteVR();j.valid=false;j.idBanque.valid=false;var e=new VRerreur();e.code=ERR_261_CODE;e.message=ERR_261_MSG;j.idBanque.erreurs.push(e);Infobulle.generer(j,"");return false}}c.find("#rechargementidBanque").autocomplete({minLength:0,source:function(f,e){var g=new RegExp("^"+$.ui.autocomplete.escapeRegex(f.term),"i");e($.grep(d.mBanques,function(h){return g.test(h.nom)||g.test(h.nomCourt)}))},focus:function(e,f){Infobulle.init();$("#rechargementidBanque").val(htmlDecode(f.item.nom));return false},select:function(e,f){Infobulle.init();$("#rechargementidBanque").val(htmlDecode(f.item.nom));$("#rechargementidBanque").attr("id-banque",f.item.id);return false},change:function(e,f){Infobulle.init();if(!f.item){return b(this)}}}).data("ui-autocomplete")._renderItem=function(e,f){return $("<li>").data("item.autocomplete",f).append("<a>"+f.nomCourt+" : "+f.nom+"<br>"+f.description+"</a>").appendTo(e)};return c};this.affectValider=function(b){var c=this;b.find("#btn-valider").click(function(){c.recapitulatifAchat()});return b};this.recapitulatifAchat=function(){var g=this;var k=new AchatCommandeVO();k.id=this.mParam.id_commande;k.idCompte=this.mIdCompte;var j=[];var f=false;$(".ligne-produit").each(function(){var v=$(this).data("id-produit");var t=$(this).data("id-nom-produit");var s=$(this).data("id-categorie");var r=new ProduitAchatVO();var q=new ProduitAchatVO();r.id=v;q.id=v;r.nproId=t;q.nproId=t;if(g.mLotAchat[t]){if(v>0){r.dcomId=g.mLotAchat[t].normal;q.dcomId=g.mLotAchat[t].solidaire}else{r.lotId=g.mLotAchat[t].normal;q.lotId=g.mLotAchat[t].solidaire}}r=g.qteEtPrixAchat(t,"",r);q=g.qteEtPrixAchat(t,"Solidaire",q);var p=g.mPrixProduit[t];var u=false;if(r.quantite!=""||r.prix!=""){k.produits.push(r);u=true;f=true}var o=false;if(q.quantite!=""||q.prix!=""){k.produitsSolidaire.push(q);o=true;f=true}if(u||o){if(!j[s]){j[s]={cproNom:g.mNomCategorie[s].cproNom,produits:[]}}j[s].produits[t]={nom:p.nom,quantite:"",prix:"",quantiteSolidaire:"",prixSolidaire:"",unite:"",uniteSolidaire:"",sigleMonetaire:"",sigleMonetaireSolidaire:""};if(u){j[s].produits[t].quantite=(r.quantite*-1).nombreFormate(2,","," ");j[s].produits[t].unite=p.unite;j[s].produits[t].prix=(r.prix*-1).nombreFormate(2,","," ");j[s].produits[t].sigleMonetaire=gSigleMonetaire}if(o){j[s].produits[t].quantiteSolidaire=(q.quantite*-1).nombreFormate(2,","," ");j[s].produits[t].uniteSolidaire=p.unite;j[s].produits[t].prixSolidaire=(q.prix*-1).nombreFormate(2,","," ");j[s].produits[t].sigleMonetaireSolidaire=gSigleMonetaire}}});j.sort(function(p,o){return p.cproNom.localeCompare(o.cproNom)});$.each(j,function(){if(this.cproNom){this.produits.sort(function(p,o){return p.nom.localeCompare(o.nom)})}});var i=new RechargementCompteVO();var e=$(":input[name=montant-rechargement]").val().numberFrToDb();var c=0;var m="";var l="";var d="";i.id=this.mIdCompte;if(!isNaN(e)&&!e.isEmpty()&&e!=0){e=parseFloat(e);i.montant=e;c=e}c=c.nombreFormate(2,","," ");i.typePaiement=$(":input[name=typepaiement]").val();if(i.typePaiement!=0){m=$(":input[name=typepaiement]").selectedTexts()}if(this.getLabelChamComplementaire(i.typePaiement)!=null){i.champComplementaireObligatoire=1;i.champComplementaire=$(":input[name=champ-complementaire]").val();l=i.champComplementaire}else{i.champComplementaireObligatoire=0}if($("#idBanque").val()!=""){i.idBanque=$("#rechargementidBanque").attr("id-banque");d=$("#rechargementidBanque").val()}k.rechargement=i;var n=new AchatCommandeValid();var h=new AchatCommandeVR();if(a.id_adherent!=0){h=n.validAjout(k)}else{h=n.validAjoutInvite(k)}$("#input-rechercher").val("");g.recherche("");Infobulle.init();if(h.valid){var b=new CaisseTemplate();if(f){$("#formulaire-produit").hide().before(b.achatHorsMarcheDetailAchat.template({categories:j}))}else{$("#formulaire-produit").hide()}$(".ligne-lot-produit").hide();$("#rechargement-affiche").text(c);$("#rechargement-select-affiche").text(m);$("#rechargement-champ-complementaire-affiche").text(l);$("#rechargement-banque-affiche").text(d);if(i.typePaiement==0){$("#label-type-paiement").hide()}$(".form-produit, #btn-valider, #btn-modifier, #btn-enregistrer, #recherche-produit").toggle();this.mAchat=k}else{Infobulle.generer(h,"")}};this.qteEtPrixAchat=function(d,b,e){var f=parseFloat($("#produits"+b+d+"quantite").val().numberFrToDb());if(!isNaN(f)){e.quantite=f*-1}var c=parseFloat($("#produits"+b+d+"prix").val().numberFrToDb());if(!isNaN(c)){e.prix=c*-1}return e};this.affectModifier=function(b){var c=this;b.find("#btn-modifier").click(function(){c.modifier()});return b};this.modifier=function(){$(".form-produit, #btn-valider, #btn-modifier, #btn-enregistrer, #recherche-produit").toggle();$("#formulaire-produit, #label-type-paiement").show();$("#formulaire-produit-detail").remove()};this.affectRetour=function(b){var c=this;b.find("#lien-retour").click(function(){CaisseMarcheCommandeVue({id_commande:c.mParam.id_commande})});return b};this.affectEnregistrer=function(b){var c=this;b.find("#btn-enregistrer").click(function(){c.enregistrerAchat()});return b};this.enregistrerAchat=function(){var c=this;var b=this.mAchat;b.fonction="acheter";b.idAchat=this.mIdAchat;$.post("./index.php?m=Caisse&v=CaisseMarcheCommande","pParam="+$.toJSON(b),function(f){if(f){if(f.valid){var d=new CaisseTemplate();$("#contenu").replaceWith(c.affectRetour($(d.achatCommandeSucces)))}else{var e=false;$(f.log.erreurs).each(function(){if(this.code==263){e=true}});if(e){CaisseAchatCommandeVue({id_commande:c.idCommande,id_adherent:c.idAdherent,vr:f})}else{c.modifier();Infobulle.generer(f,"")}}c.etapeValider=0}},"json")};this.construct(a)};