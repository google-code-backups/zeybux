function GestionAbonnementTemplate(){this.listeProduit='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Produits<span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-nv-produit" title="Ajouter un produit"><span class="ui-icon ui-icon-plusthick"></span></span></div><div id="liste-produit-recherche" class="recherche com-widget-header ui-widget ui-widget-header ui-corner-all"><form id="filter-form"><div><span class="conteneur-icon com-float-left ui-widget-content ui-corner-left" title="Chercher"><span class="ui-icon ui-icon-search"></span></span><input class="com-input-text ui-widget-content ui-corner-right" name="filter" id="filter" value="" maxlength="30" size="15" type="text" /></div></form></div><table class="com-table"><!-- BEGIN fermes --><tr class="ui-widget-header"><th class="com-table-th">{fermes.nom}</th></tr><!-- BEGIN fermes.categories --><tr class="ui-widget-header"><th class="com-table-th">{fermes.categories.nom}</th></tr><!-- BEGIN fermes.categories.produits --><tbody><tr class="com-cursor-pointer ligne-produit" idProduit="{fermes.categories.produits.id}" ><td class="com-table-td com-underline-hover">{fermes.categories.produits.nom}</td></tr></tbody><!-- END fermes.categories.produits --><!-- END fermes.categories --><!-- END fermes --></table></div></div>';this.listeProduitVide='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Produits<span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-nv-produit" title="Ajouter un produit"><span class="ui-icon ui-icon-plusthick"></span></span></div><p id="texte-liste-vide">Aucun produit dans la base.</p></div></div>';this.dialogAjoutProduit='<div id="dialog-ajout-pro" title="Produit"><div id="information-detail-producteur"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Le Produit</div><div id="pro-idFerme" class="com-float-left"><select name="ferme"><option value="0" >== Choisir une ferme ==</option><!-- BEGIN listeFerme --><option value="{listeFerme.ferId}" >{listeFerme.ferNom}</option><!-- END listeFerme --></select></div><div id="pro-idCategorie" class="com-float-left"><select name="categorie" disabled="disabled"><option value="0" >== Choisir une catégorie ==</option></select></div><div id="pro-idProduit" class="com-float-left"><select name="produit" disabled="disabled"><option value="0" >== Choisir un produit ==</option></select></div></div><div id="detail-produit"></div></div>';this.ajoutProduitSelectCategorie='<div id="pro-idCategorie" class="com-float-left"><select name="categorie"><option value="0" >== Choisir une catégorie ==</option><!-- BEGIN listeCategorie --><option value="{listeCategorie.cproId}" >{listeCategorie.cproNom}</option><!-- END listeCategorie --></select></div>';this.ajoutProduitSelectProduit='<div id="pro-idProduit" class="com-float-left"><select name="produit"><option value="0" >== Choisir un produit ==</option><!-- BEGIN listeProduit --><option value="{listeProduit.nproId}" >{listeProduit.nproNom}</option><!-- END listeProduit --></select></div>';this.detailProduitAjoutProduit='<div id="detail-produit"><div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Détail</div><table class="com-table-form"><tr><th class="com-table-form-th">Fréquence : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="text" name="pro-frequence" maxlength="200" id="pro-frequence"/></td></tr></table><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Prix de vente</div><table class="com-table-form" id="table-pro-prix"><tr><td class="catalogue-entete-lot">Quantité</td><td class="catalogue-entete-lot">Unité</td><td>Prix</td><td></td><td></td></tr><tr class="btn-lot"><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-quantite" maxlength="13" id="pro-lot-quantite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all" type="text" name="lot-unite" maxlength="20" id="pro-lot-unite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-prix" maxlength="13" id="pro-lot-prix"/> {sigleMonetaire}</td><td colspan="2"><button type="button" id="btn-ajout-lot" class="ui-state-default ui-corner-all com-button com-center">Ajouter</button></td></tr></table><table class="com-table" id="lot-liste"><!-- BEGIN modelesLot --><tr class="ligne-lot" id="ligne-lot-{modelesLot.id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{modelesLot.id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" value="{modelesLot.id}" name="pro-lot" id="pro-lot-{modelesLot.id}-id" class="modele-lot"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{modelesLot.id} lot-quantite" id="lot-{modelesLot.id}-quantite">{modelesLot.quantite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-quantite" maxlength="13" id="pro-lot-{modelesLot.id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{modelesLot.id} lot-unite" id="lot-{modelesLot.id}-unite">{modelesLot.unite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{modelesLot.id}-unite" maxlength="20" id="pro-lot-{modelesLot.id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{modelesLot.id} lot-prix" id="lot-{modelesLot.id}-prix">{modelesLot.prix}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-prix" maxlength="13" id="pro-lot-{modelesLot.id}-prix"/> {modelesLot.sigleMonetaire}</td><td class="com-table-td-med td-edt"><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-lot" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-valider-lot" id="btn-valider-lot-{modelesLot.id}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-annuler-lot" id="btn-annuler-lot-{modelesLot.id}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-lot" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span></td></tr><!-- END modelesLot --></table><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Stock</div><table class="com-table-form"><tr><th class="com-table-form-th">Limite de stock : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="pro-stockInitial" maxlength="13" id="pro-stockInitial"/> <span class="unite-stock">{unite}</span></td></tr><tr><th class="com-table-form-th">Quantité max par adhérent : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="0" checked="checked"/>Pas de limite</td></tr><tr><th class="com-table-form-th"></th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="1" /><input disabled="disabled" class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="pro-qte-max" maxlength="13" id="pro-max"/> <span class="unite-stock">{unite}</span></td></tr></table></div></div>';this.dialogModifierProduit='<div id="dialog-modif-pro" title="Modifier : {nproNom}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Détail</div><table class="com-table-form"><tr><th class="com-table-form-th">Fréquence : </th><td class="com-table-form-td"><input type="hidden" name="idProduit" value="{proAboId}"/><input class="com-input-text ui-widget-content ui-corner-all" type="text" name="pro-frequence" maxlength="200" id="pro-frequence" value="{proAboFrequence}"/></td></tr></table><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Prix de vente</div><table class="com-table-form" id="table-pro-prix"><tr><td class="catalogue-entete-lot">Quantité</td><td class="catalogue-entete-lot">Unité</td><td>Prix</td><td></td><td></td></tr><tr class="btn-lot"><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-quantite" maxlength="13" id="pro-lot-quantite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all" type="text" name="lot-unite" maxlength="20" id="pro-lot-unite"/></td><td><input class="pro-form-input-lot com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="lot-prix" maxlength="13" id="pro-lot-prix"/> {sigleMonetaire}</td><td colspan="2"><button type="button" id="btn-ajout-lot" class="ui-state-default ui-corner-all com-button com-center">Ajouter</button></td></tr></table><table class="com-table" id="lot-liste"><!-- BEGIN modelesLotReservation --><tr class="ligne-lot" id="ligne-lot-{modelesLotReservation.id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{modelesLotReservation.id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" checked="checked" disabled="disabled" value="{modelesLotReservation.id}" name="pro-lot" id="pro-lot-{modelesLotReservation.id}-id" {modelesLotReservation.checked} class="{modelesLotReservation.modele}"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{modelesLotReservation.id} lot-quantite" id="lot-{modelesLotReservation.id}-quantite">{modelesLotReservation.quantite}</span><input class="champ-lot-{modelesLotReservation.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLotReservation.id}-quantite" maxlength="13" id="pro-lot-{modelesLotReservation.id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{modelesLotReservation.id} lot-unite" id="lot-{modelesLotReservation.id}-unite">{modelesLotReservation.unite}</span><input class="champ-lot-{modelesLotReservation.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{modelesLotReservation.id}-unite" maxlength="20" id="pro-lot-{modelesLotReservation.id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{modelesLotReservation.id} lot-prix" id="lot-{modelesLotReservation.id}-prix">{modelesLotReservation.prix}</span><input class="champ-lot-{modelesLotReservation.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLotReservation.id}-prix" maxlength="13" id="pro-lot-{modelesLotReservation.id}-prix"/> {modelesLotReservation.sigleMonetaire}</td><td class="com-table-td-med td-edt"><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-lot" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-valider-lot" id="btn-valider-lot-{modelesLotReservation.id}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-annuler-lot" id="btn-annuler-lot-{modelesLotReservation.id}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-lot"  id="btn-supprimer-lot-{modelesLotReservation.id}" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span></td></tr><!-- END modelesLotReservation --><!-- BEGIN modelesLot --><tr class="ligne-lot" id="ligne-lot-{modelesLot.id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{modelesLot.id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" value="{modelesLot.id}" name="pro-lot" id="pro-lot-{modelesLot.id}-id" {modelesLot.checked} class="{modelesLot.modele}"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{modelesLot.id} lot-quantite" id="lot-{modelesLot.id}-quantite">{modelesLot.quantite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-quantite" maxlength="13" id="pro-lot-{modelesLot.id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{modelesLot.id} lot-unite" id="lot-{modelesLot.id}-unite">{modelesLot.unite}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{modelesLot.id}-unite" maxlength="20" id="pro-lot-{modelesLot.id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{modelesLot.id} lot-prix" id="lot-{modelesLot.id}-prix">{modelesLot.prix}</span><input class="champ-lot-{modelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{modelesLot.id}-prix" maxlength="13" id="pro-lot-{modelesLot.id}-prix"/> {modelesLot.sigleMonetaire}</td><td class="com-table-td-med td-edt"><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-lot" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-valider-lot" id="btn-valider-lot-{modelesLot.id}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-annuler-lot" id="btn-annuler-lot-{modelesLot.id}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-lot"  id="btn-supprimer-lot-{modelesLot.id}" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span></td></tr><!-- END modelesLot --><!-- BEGIN listeModelesLot --><tr class="ligne-lot" id="ligne-lot-modele-{listeModelesLot.id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{listeModelesLot.id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" value="{listeModelesLot.id}" name="pro-lot" id="pro-lot-{listeModelesLot.id}-id" {listeModelesLot.checked} class="{listeModelesLot.modele}"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{listeModelesLot.id} lot-quantite" id="lot-{listeModelesLot.id}-quantite">{listeModelesLot.quantite}</span><input class="champ-lot-{listeModelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{listeModelesLot.id}-quantite" maxlength="13" id="pro-lot-{listeModelesLot.id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{listeModelesLot.id} lot-unite" id="lot-{listeModelesLot.id}-unite">{listeModelesLot.unite}</span><input class="champ-lot-{listeModelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{listeModelesLot.id}-unite" maxlength="20" id="pro-lot-{listeModelesLot.id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{listeModelesLot.id} lot-prix" id="lot-{listeModelesLot.id}-prix">{listeModelesLot.prix}</span><input class="champ-lot-{listeModelesLot.id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{listeModelesLot.id}-prix" maxlength="13" id="pro-lot-{listeModelesLot.id}-prix"/> {listeModelesLot.sigleMonetaire}</td><td class="com-table-td-med td-edt"></td><td class="com-table-td-fin td-edt"></td></tr><!-- END listeModelesLot --></table><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Stock</div><table class="com-table-form"><tr><th class="com-table-form-th">Limite de stock : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="pro-stockInitial" maxlength="13" id="pro-stockInitial" value="{proAboStockInitial}"/> <span class="unite-stock">{proAboUnite}</span></td></tr><tr><th class="com-table-form-th">Quantité max par adhérent : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="0" {checkedNoLimit}/>Pas de limite</td></tr><tr><th class="com-table-form-th"></th><td class="com-table-form-td"><input {checkedLimit} class="com-input-text ui-widget-content ui-corner-all" type="radio" name="pro-qte-max-choix" value="1" /><input {disableLimit} class="com-input-text ui-widget-content ui-corner-all com-numeric" type="text" name="pro-qte-max" maxlength="13" id="pro-max" value="{max}"/> <span class="unite-stock">{proAboUnite}</span></td></tr></table></div>';this.modeleLot='<tr class="ligne-lot" id="ligne-lot-{id}"><td class="ui-helper-hidden"><span class="ui-helper-hidden lot-id" id="id-lot">{id}</span></td><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="checkbox" value="{id}" name="pro-lot" id="pro-lot-{id}-id"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{id} lot-quantite" id="lot-{id}-quantite">{quantite}</span><input class="champ-lot-{id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{id}-quantite" maxlength="13" id="pro-lot-{id}-quantite"/></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{id} lot-unite" id="lot-{id}-unite">{unite}</span><input class="champ-lot-{id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all ui-helper-hidden" type="text" name="lot-{id}-unite" maxlength="20" id="pro-lot-{id}-unite"/></td><td class="com-table-td-med">à <span class="champ-lot-{id} lot-prix" id="lot-{id}-prix">{prix}</span><input class="champ-lot-{id} catalogue-input-lot com-input-text ui-widget-content ui-corner-all com-numeric ui-helper-hidden" type="text" name="lot-{id}-prix" maxlength="13" id="pro-lot-{id}-prix"/> {sigleMonetaire}</td><td class="com-table-td-med td-edt"><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-modifier-lot" title="Modifier"><span class="ui-icon ui-icon-pencil"></span></span><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-valider-lot" id="btn-valider-lot-{id}" title="Valider"><span class="ui-icon ui-icon-check"></span></span></td><td class="com-table-td-fin td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all ui-helper-hidden btn-annuler-lot" id="btn-annuler-lot-{id}" title="Annuler"><span class="ui-icon ui-icon-closethick"></span></span><span class="btn-lot com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-supprimer-lot" id="btn-supprimer-lot-abonnement-{id}" title="Supprimer"><span class="ui-icon ui-icon-trash"></span></span></td></tr>';this.dialogSupprimerLotModifierMarche='<div id="dialog-supp-lot" title="Supprimer le prix de vente"><div id="information-detail-producteur">Des abonnements sont positionnés sur ce prix de vente.<br/>Veuillez préciser le nouveau prix de vente sur lequel se baseront ces abonnements.</div><div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Prix de vente</div><table class="com-table-100" id="lot-liste"><!-- BEGIN modelesLot --><tr class="ligne-lot" id="ligne-lot-{modelesLot.id}"><td class="com-table-td-debut catalogue-ligne-lot-quantite td-edt"><input type="radio" value="{modelesLot.id}" name="pro-lot" id="pro-lot-{modelesLot.id}-id"/></td><td class="com-table-td-med catalogue-ligne-lot-quantite"><span class="champ-lot-{modelesLot.id} lot-quantite" id="lot-{modelesLot.id}-quantite">{modelesLot.quantite}</span></td><td class="com-table-td-med catalogue-ligne-lot-unite"><span class="champ-lot-{modelesLot.id} lot-unite" id="lot-{modelesLot.id}-unite">{modelesLot.unite}</span></td><td class="com-table-td-fin">à <span class="champ-lot-{modelesLot.id} lot-prix" id="lot-{modelesLot.id}-prix">{modelesLot.prix}</span> {modelesLot.sigleMonetaire}</td></tr><!-- END modelesLot --></table></div></div>';this.detailProduit='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-retour"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Abonnement : {nproNom}<span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-supp" title="Supprimer" idProduit="{proAboId}"><span class="ui-icon ui-icon-trash"></span></span><span class="com-cursor-pointer com-btn-header-multiples  ui-widget-content ui-corner-all" id="btn-modifier" title="Modifier" idProduit="{proAboId}"><span class="ui-icon ui-icon-pencil"></span></span></div>Fréquence : {proAboFrequence}<br/>Stock : {proAboStockInitial} {proAboUnite}<br/>Quantité max par adhérent : {proAboMax}<br/>Total quantité d\'abonnement : {proAboReservation} {proAboUnite}<br/></div>{listeAbonnes}</div>';this.detailProduitListeAbonnes='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Adhérents Abonnés</div><table class="com-table"><thead><tr class="ui-widget-header" ><th class="com-table-th-debut liste-adh-th-num">N°</th><th class="com-table-th-med liste-adh-th-nom">Adhérent</th><th class="com-table-th-fin edt-marche-pro-unite">Quantité</th></tr></thead><tbody><!-- BEGIN abonnes --><tr><td class="com-table-td-debut com-underline-hover">{abonnes.adhNumero}</td><td class="com-table-td-med com-underline-hover">{abonnes.adhPrenom} {abonnes.adhNom}</td><td class="com-table-td-fin com-underline-hover edt-marche-pro-unite">{abonnes.cptAboQuantite} {abonnes.proAboUnite}</td></tr><!-- END abonnes --></tbody></table></div>';this.detailProduitListeAbonnesVide='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Adhérents Abonnés</div><p id="texte-liste-vide">Aucun abonné sur ce produit.</p></div>';this.dialogSuppressionProduit='<div id="dialog-supp-produit" title="Supprimer abonnement de produit"><p class="ui-state-error ui-corner-all"><span class="ui-icon ui-icon-alert com-float-left"></span>ATTENTION : Voulez-vous réellement supprimer l\'abonnement à ce produit?</p></div>';this.listeAdherentVide='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Adhérents</div><p id="texte-liste-vide">Aucun adhérent.</p></div></div>';this.listeAdherent='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Adhérents</div><div id="liste-adh-recherche" class="recherche com-widget-header ui-widget ui-widget-header ui-corner-all"><form id="filter-form"><div><span class="conteneur-icon com-float-left ui-widget-content ui-corner-left" title="Chercher"><span class="ui-icon ui-icon-search"></span></span><input class="com-input-text ui-widget-content ui-corner-right" name="filter" id="filter" value="" maxlength="30" size="15" type="text" /></div></form></div><table class="com-table"><thead><tr class="ui-widget ui-widget-header"><th class="com-table-th-debut com-underline-hover liste-adh-th-num com-cursor-pointer"><span class="ui-icon span-icon"></span>N°</th><th class="com-table-th-med com-underline-hover liste-adh-th-nom com-cursor-pointer"><span class="ui-icon span-icon"></span>Nom</th><th class="com-table-th-med com-underline-hover liste-adh-th-nom com-cursor-pointer"><span class="ui-icon span-icon"></span>Prénom</th><th class="com-table-th-fin liste-adh-th-solde"></th></tr></thead><tbody><!-- BEGIN listeAdherent --><tr class="com-cursor-pointer compte-ligne" id-adherent="{listeAdherent.adhId}"><td class="com-table-td-debut com-underline-hover"><span class="ui-helper-hidden">{listeAdherent.adhIdTri}</span>{listeAdherent.adhNumero}</td><td class="com-table-td-med com-underline-hover">{listeAdherent.adhNom}</td><td class="com-table-td-med com-underline-hover">{listeAdherent.adhPrenom}</td><td class="com-table-td-fin com-underline-hover liste-adh-td-solde"><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all"><span class="ui-icon ui-icon-triangle-1-e"></span></span></td></tr><!-- END listeAdherent --></tbody></table></div></div>';this.detailAbonne='<div id="contenu"><div class="com-barre-menu-2"><button class="ui-state-default ui-corner-top com-button" id="lien-retour"><span class="com-float-left ui-icon ui-icon-arrowthick-1-w"></span>Retour</button></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Adhérent</div><div class="com-float-left">{adhNumero} : {adhPrenom} {adhNom}</div><div class="com-center">{suspension}</div></div>{listeProduit}</div>';this.buttonSuspendre='<button type="button" id="btn-ajout-suspension" class="ui-state-default ui-corner-all com-button com-center">Suspendre</button>';this.buttonModifierSuspendre='Abonnements suspendus du {dateDebutsuspension} au {dateFinsuspension}<br/><br/><button type="button" id="btn-modif-suspension" class="com-btn-edt-multiples  ui-state-default ui-corner-all com-button com-center">Modifier la suspension</button><button type="button" id="btn-supp-suspension" class="ui-state-default ui-corner-all com-button com-center">Supprimer la suspension</button>';this.dialogAjoutSuspension='<div id="dialog-ajout-suspension" title="Suspendre les abonnements"><table class="com-table-form"><tr><th class="com-table-form-th">Du : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="text" name="dateDebutSuspension" maxlength="10" id="dateDebutSuspension" value="{dateDebutSuspension}"/> inclus</td></tr><tr><th class="com-table-form-th">Au : </th><td class="com-table-form-td"><input class="com-input-text ui-widget-content ui-corner-all" type="text" name="dateFinSuspension" maxlength="10" id="dateFinSuspension" value="{dateFinSuspension}"/> inclus</td></tr></table></div>';this.dialogSupprimerSuspension='<div id="dialog-supp-abonnement" title="Arrêter suspension"><p class="ui-state-error ui-corner-all"><span class="ui-icon ui-icon-alert com-float-left"></span>Voulez-vous arrêter la suspension d\'abonnement?</p></div>';this.detailAbonneListeProduit='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Abonnements<span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-nv-abonnement" title="Ajouter un abonnement"><span class="ui-icon ui-icon-plusthick"></span></span></div><table class="com-table"><!-- BEGIN fermes --><tr class="ui-widget-header"><th class="com-table-th" colspan="4" >{fermes.nom}</th></tr><!-- BEGIN fermes.categories --><tr class="ui-widget-header"><th class="com-table-th" colspan="4" >{fermes.categories.nom}</th></tr><!-- BEGIN fermes.categories.produits --><tbody><tr class="com-cursor-pointer ligne-produit" idProduit="{fermes.categories.produits.id}" ><td class="com-table-td-debut com-underline-hover">{fermes.categories.produits.nom}</td><td class="com-table-td-med com-underline-hover edt-marche-pro-unite">{fermes.categories.produits.quantite} {fermes.categories.produits.unite}</td><td class="com-table-td-med com-underline-hover td-edt"><span class="com-cursor-pointer com-btn-header-multiples  ui-widget-content ui-corner-all btn-modifier" title="Modifier" idProduit="{fermes.categories.produits.id}" idCompteAbonnement="{fermes.categories.produits.idAbonnement}"><span class="ui-icon ui-icon-pencil"></span></span></td><td class="com-table-td-fin com-underline-hover td-edt"><span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all btn-supp" title="Supprimer" idCompteAbonnement="{fermes.categories.produits.idAbonnement}"><span class="ui-icon ui-icon-trash"></span></span></td></tr></tbody><!-- END fermes.categories.produits --><!-- END fermes.categories --><!-- END fermes --></table></div>';this.detailAbonneListeProduitVide='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Abonnements<span class="com-cursor-pointer com-btn-header-multiples ui-widget-content ui-corner-all" id="btn-nv-abonnement" title="Ajouter un abonnement"><span class="ui-icon ui-icon-plusthick"></span></span></div><p id="texte-liste-vide">Cet adhérent n\'est abonné à aucun produit.</p></div>';this.dialogAjoutAbonnement='<div id="dialog-ajout-abonnement" title="Abonnement de Produit"><div id="information-detail-producteur"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Le Produit</div><div id="pro-idFerme" class="com-float-left"><select name="ferme"><option value="0" >== Choisir une ferme ==</option><!-- BEGIN listeFerme --><option value="{listeFerme.ferId}" >{listeFerme.ferNom}</option><!-- END listeFerme --></select></div><div id="pro-idCategorie" class="com-float-left"><select name="categorie" disabled="disabled"><option value="0" >== Choisir une catégorie ==</option></select></div><div id="pro-idProduit" class="com-float-left"><select name="produit" disabled="disabled"><option value="0" >== Choisir un produit ==</option></select></div></div><div id="detail-produit"></div></div>';this.ajoutAbonnementSelectCategorie='<div id="pro-idCategorie" class="com-float-left"><select name="categorie"><option value="0" >== Choisir une catégorie ==</option><!-- BEGIN listeCategorie --><option value="{listeCategorie.cproId}" >{listeCategorie.cproNom}</option><!-- END listeCategorie --></select></div>';this.ajoutAbonnementSelectProduit='<div id="pro-idProduit" class="com-float-left"><select name="produit"><option value="0" >== Choisir un produit ==</option><!-- BEGIN listeProduit --><option value="{listeProduit.proAboId}" >{listeProduit.nproNom}</option><!-- END listeProduit --></select></div>';this.detailProduitAjoutAbonnement='<div id="detail-produit"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Détail</div><table class="com-table-form"><tr><th class="com-table-form-th">Fréquence : </th><td class="com-table-form-td">{proAboFrequence}</td></tr><tr><th class="com-table-form-th">Quantité disponible : </th><td class="com-table-form-td">{qteRestant} {proAboUnite}</td></tr><th class="com-table-form-th">Limite par adhérent : </th><td class="com-table-form-td">{proAboMaxLabel}</td></tr><tr><th class="com-table-form-th">Quantité abonnement : </th><td class="com-table-form-td"><select id="lot"><!-- BEGIN lot --><option value="{lot.dcomId}">par {lot.dcomTaille} {proAboUnite}</option><!-- END lot --></select>à <span id="prix-unitaire">{prixUnitaire}</span> {sigleMonetaire}/{proAboUnite}<button class="btn-moins">-</button><span id="qte-pdt">{qteInit}</span> {proAboUnite}<button class="btn-plus">+</button><span id="prix-pdt">{prixInit}</span> {sigleMonetaire}</td></tr></table></div>';this.dialogModifierAbonnement='<div id="dialog-modif-abonnement" title="Abonnement de Produit : {nproNom}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Détail</div><table class="com-table-form"><tr><th class="com-table-form-th">Fréquence : </th><td class="com-table-form-td">{proAboFrequence}</td></tr><tr><th class="com-table-form-th">Quantité disponible : </th><td class="com-table-form-td">{qteRestant} {proAboUnite}</td></tr><th class="com-table-form-th">Limite par adhérent : </th><td class="com-table-form-td">{proAboMaxLabel}</td></tr><tr><th class="com-table-form-th">Quantité abonnement : </th><td class="com-table-form-td"><input type="hidden" name="idProduitAbonnement" id="idProduitAbonnement" value="{proAboId}"/><input type="hidden" name="id" id="id" value="{idCompteAbonnement}"/><select id="lot"><!-- BEGIN lot --><option {lot.selected} value="{lot.dcomId}">par {lot.dcomTaille} {proAboUnite}</option><!-- END lot --></select>à <span id="prix-unitaire">{prixUnitaire}</span> {sigleMonetaire}/{proAboUnite}<button class="btn-moins">-</button><span id="qte-pdt">{qteInit}</span> {proAboUnite}<button class="btn-plus">+</button><span id="prix-pdt">{prixInit}</span> {sigleMonetaire}</td></tr></table></div>';this.dialogSuppressionAbonnement='<div id="dialog-supp-abonnement" title="Supprimer l\'abonnement"><p class="ui-state-error ui-corner-all"><span class="ui-icon ui-icon-alert com-float-left"></span>ATTENTION : Voulez-vous réellement supprimer l\'abonnement à ce produit?</p></div>'}function ListeAbonneVue(a){this.construct=function(b){$.history({vue:function(){ListeAbonneVue(b)}});var c=this;var d={fonction:"afficher"};d=$.extend(d,b);$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(e)}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(c){var b=this;var d=new GestionAbonnementTemplate();if(c.listeAdherent.length>0&&c.listeAdherent[0].adhId!=null){var e=d.listeAdherent;$.each(c.listeAdherent,function(){this.adhIdTri=this.adhNumero.replace("Z","")});$("#contenu").replaceWith(b.affect($(e.template(c))))}else{$("#contenu").replaceWith(b.affect($(d.listeAdherentVide)))}};this.affect=function(b){b=this.affectTri(b);b=this.affectRecherche(b);b=this.affectLienCompte(b);return b};this.affectTri=function(b){b.find(".com-table").tablesorter({sortList:[[0,0]],headers:{4:{sorter:false}}});return b};this.affectRecherche=function(b){b.find("#filter").keyup(function(){$.uiTableFilter($(".com-table"),this.value)});b.find("#filter-form").submit(function(){return false});return b};this.affectLienCompte=function(b){b.find(".compte-ligne").click(function(){DetailAbonneAbonnementVue({id:$(this).attr("id-adherent")})});return b};this.construct(a)}function DetailAbonneAbonnementVue(a){this.idCompte=0;this.produit={};this.abonnement={};this.idAdherent=0;this.mDateDebutSuspension="";this.mDateFinSuspension="";this.reservationModif={};this.reservation={};this.construct=function(b){$.history({vue:function(){DetailAbonneAbonnementVue(b)}});var c=this;var d={fonction:"detailAbonne"};d=$.extend(d,b);$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.idAdherent=b.id;c.idCompte=e.adherent.cptId;c.afficher(e)}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(g){var f=this;var h=new GestionAbonnementTemplate();var c=g.adherent;var e=gDateTimeNulle;var b=gDateTimeNulle;var d=getDateTimeAujourdhuiDb();if(g.produits&&g.produits.fermes&&g.produits.fermes.length>0&&g.produits.fermes[0].nom!=null){e=g.produits.fermes[0].categories[0].produits[0].dateDebutSuspension;b=g.produits.fermes[0].categories[0].produits[0].dateFinSuspension;$.each(g.produits.fermes,function(){$.each(this.categories,function(){$.each(this.produits,function(){this.quantite=this.quantite.nombreFormate(2,","," ")})})});c.listeProduit=h.detailAbonneListeProduit.template(g.produits)}else{c.listeProduit=h.detailAbonneListeProduitVide}if(dateTimeEstPLusGrandeEgale(b,d,"db")){c.dateDebutsuspension=e.extractDbDate().dateDbToFr();c.dateFinsuspension=b.extractDbDate().dateDbToFr();c.suspension=h.buttonModifierSuspendre.template(c);this.mDateDebutSuspension=c.dateDebutsuspension;this.mDateFinSuspension=c.dateFinsuspension}else{c.suspension=h.buttonSuspendre}$("#contenu").replaceWith(f.affect($(h.detailAbonne.template(c))))};this.affect=function(b){b=this.affectAjoutAbonnement(b);b=this.affectModifierAbonnement(b);b=this.affecSupprimerAbonnement(b);b=this.affectRetour(b);b=this.affectAjoutSuspension(b);b=this.affectModifierSuspension(b);b=this.affectSupprimerSuspension(b);b=gCommunVue.comHoverBtn(b);return b};this.affectAjoutSuspension=function(b){var c=this;b.find("#btn-ajout-suspension").click(function(){c.dialogAjoutSuspension()});return b};this.dialogAjoutSuspension=function(){var b=this;var c=new GestionAbonnementTemplate();var d=c.dialogAjoutSuspension;$(b.affectDialogAjoutSuspension($(d))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Suspendre:function(){b.suspendreAbonnement($(this))},Annuler:function(){$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.affectDialogAjoutSuspension=function(b){b=gCommunVue.comLienDatepicker("dateDebutSuspension","dateFinSuspension",b);b.find("#dateDebutSuspension").datepicker("option","yearRange","c:c+10");b.find("#dateFinSuspension").datepicker("option","yearRange","c:c+10");return b};this.suspendreAbonnement=function(b){var d=this;var e=new CompteAbonnementVO();e.idCompte=this.idCompte;e.dateDebutSuspension=b.find("#dateDebutSuspension").val().dateFrToDb();e.dateFinSuspension=b.find("#dateFinSuspension").val().dateFrToDb();var c=new CompteAbonnementValid();var f=c.validAjoutSuspension(e);if(f.valid){Infobulle.init();e.fonction="suspendre";$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(e),function(h){if(h){if(h.valid){Infobulle.init();var i=new Object();var g=new VRerreur();g.code=ERR_348_CODE;g.message=ERR_348_MSG;i.valid=false;i.log=new VRelement();i.log.valid=false;i.log.erreurs.push(g);d.construct({id:d.idAdherent,vr:i});b.dialog("close")}else{Infobulle.generer(h,"")}}},"json")}else{Infobulle.generer(f,"")}};this.affectModifierSuspension=function(b){var c=this;b.find("#btn-modif-suspension").click(function(){c.dialogModifierSuspension()});return b};this.dialogModifierSuspension=function(){var c=this;var d=new GestionAbonnementTemplate();var e=d.dialogAjoutSuspension;var b={dateDebutSuspension:this.mDateDebutSuspension,dateFinSuspension:this.mDateFinSuspension};$(c.affectDialogAjoutSuspension($(e.template(b)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Suspendre:function(){c.suspendreAbonnement($(this))},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove();Infobulle.init()}})};this.affectSupprimerSuspension=function(b){var c=this;b.find("#btn-supp-suspension").click(function(){c.dialogSupprimerSuspension()});return b};this.dialogSupprimerSuspension=function(){var b=this;var c=new GestionAbonnementTemplate();var d=c.dialogSupprimerSuspension;$(b.affectDialogAjoutSuspension($(d))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Supprimer:function(){var f=new CompteAbonnementVO();f.idCompte=b.idCompte;var e=new CompteAbonnementValid();var h=e.validDeleteSuspension(f);if(h.valid){Infobulle.init();f.fonction="arretSuspension";var g=$(this);$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(f),function(j){if(j){if(j.valid){Infobulle.init();var k=new Object();var i=new VRerreur();i.code=ERR_349_CODE;i.message=ERR_349_MSG;k.valid=false;k.log=new VRelement();k.log.valid=false;k.log.erreurs.push(i);b.construct({id:b.idAdherent,vr:k});g.dialog("close")}else{Infobulle.generer(j,"")}}},"json")}else{Infobulle.generer(h,"")}},Annuler:function(){$(this).dialog("close")}},close:function(e,f){$(this).remove();Infobulle.init()}})};this.affectAjoutAbonnement=function(b){var c=this;b.find("#btn-nv-abonnement").click(function(){c.dialogAjoutAbonnement()});return b};this.dialogAjoutAbonnement=function(b){var c=this;var d={fonction:"listeFerme"};$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){var f=new GestionAbonnementTemplate();var g=f.dialogAjoutAbonnement;$(c.affectAjoutAbonnementSelectFerme($(g.template(e)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Abonner:function(){c.ajouterAbonnement($(this))},Annuler:function(){$(this).dialog("close")}},close:function(h,i){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(e,"")}}},"json");return b};this.affectAjoutAbonnementSelectFerme=function(b){var c=this;b.find("#pro-idFerme select").change(function(){var e=$(this).val();$("#pro-idCategorie select, #pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#detail-produit").replaceWith('<div id="detail-produit"></div>');if(e>0){var d={fonction:"listeProduit",id:c.idCompte,idFerme:e};$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(d),function(h){if(h){if(h.valid){Infobulle.init();if(h.listeProduit.length>0&&h.listeProduit[0].nproId!=null){c.mProduits=[];var g=0;var k=[];$.each(h.listeProduit,function(){if(this.ferId==e){if(c.mProduits[this.cproId]){c.mProduits[this.cproId].listeProduit.push(this)}else{c.mProduits[this.cproId]={nom:this.cproNom,listeProduit:[this]}}if(g!=this.cproId){k.push({cproId:this.cproId,cproNom:this.cproNom});g=this.cproId}}});var i=new GestionAbonnementTemplate();var j=i.ajoutAbonnementSelectCategorie;$("#pro-idCategorie").replaceWith(c.affectAjoutAbonnementSelectCategorie($(j.template({listeCategorie:k}))))}else{var l=new TemplateVR();l.valid=false;l.log.valid=false;var f=new VRerreur();f.code=ERR_332_CODE;f.message=ERR_332_MSG;l.log.erreurs.push(f);Infobulle.generer(l,"")}}else{Infobulle.generer(h,"")}}},"json")}});return b};this.affectAjoutAbonnementSelectCategorie=function(b){var c=this;b.find("select").change(function(){var f=$(this).val();$("#pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#detail-produit").replaceWith('<div id="detail-produit"></div>');if(f>0){var d=new GestionAbonnementTemplate();var e=d.ajoutAbonnementSelectProduit;$("#pro-idProduit").replaceWith(c.affectAjoutAbonnementSelectProduit($(e.template(c.mProduits[f]))))}});return b};this.affectAjoutAbonnementSelectProduit=function(b){var c=this;b.find("select").change(function(){var e=$(this).val();if(e>0){var d={fonction:"detailProduit",id:e};$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(d),function(h){if(h){if(h.valid){Infobulle.init();c.produit=h.produit[0];var i=new GestionAbonnementTemplate();var j=i.detailProduitAjoutAbonnement;var f=h.produit[0];if(f.proAboMax==-1){f.proAboMaxLabel="Pas de limite"}else{f.proAboMaxLabel=f.proAboMax.nombreFormate(2,","," ")+" "+f.proAboUnite}f.qteRestant=(parseFloat(f.proAboStockInitial)-parseFloat(f.proAboReservation)).nombreFormate(2,","," ");f.lot=[];var g=[];$.each(h.produit[0].lots,function(){if(this.id){var k={};k.dcomId=this.id;k.dcomTaille=parseFloat(this.taille).nombreFormate(2,","," ");k.dcomPrix=parseFloat(this.prix).nombreFormate(2,","," ");if(!f.prixUnitaire){f.prixUnitaire=(parseFloat(this.prix)/parseFloat(this.taille)).nombreFormate(2,","," ");f.qteInit=k.dcomTaille;f.prixInit=k.dcomPrix;c.reservationModif.dcomId=this.id;c.reservationModif.stoQuantite=this.taille}f.lot.push(k);g[this.id]=this}});c.produit.lots=g;f.sigleMonetaire=gSigleMonetaire;$("#detail-produit").replaceWith(c.affectDetailProduit($(j.template(f))))}else{Infobulle.generer(h,"")}}},"json")}else{$("#detail-produit").replaceWith($('<div id="detail-produit">'))}});return b};this.affectDetailProduit=function(b){b=this.affectChangementLot(b);b=this.affectBtnQte(b);b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);return b};this.affectChangementLot=function(b){var c=this;b.find("#lot").change(function(){Infobulle.init();c.changerLot($(this).val())});return b};this.changerLot=function(b){var c=this.produit.lots[b].prix;var e=this.produit.lots[b].taille;var d=(c/e).nombreFormate(2,","," ");$("#prix-unitaire").text(d);this.reservationModif.dcomId=b;this.reservationModif.stoQuantite=e;$("#qte-pdt").text(e.nombreFormate(2,","," "));$("#prix-pdt").text(c.nombreFormate(2,","," "))};this.affectBtnQte=function(b){var c=this;b.find(".btn-plus").click(function(){Infobulle.init();c.nouvelleQuantite($("#lot").val(),1)});b.find(".btn-moins").click(function(){Infobulle.init();c.nouvelleQuantite($("#lot").val(),-1)});return b};this.nouvelleQuantite=function(m,b){var i=parseFloat(this.produit.proAboMax);var k=0;if(this.reservation&&this.reservation.stoQuantite){k=parseFloat(this.produit.proAboStockInitial)-parseFloat(this.produit.proAboReservation)+parseFloat(this.reservation.stoQuantite)}else{k=parseFloat(this.produit.proAboStockInitial)-parseFloat(this.produit.proAboReservation)}var g=false;if(parseFloat(this.produit.proAboMax)==-1&&parseFloat(this.produit.proAboStockInitial)==-1){g=true}else{if(parseFloat(this.produit.proAboStockInitial)==-1){i=this.produit.proAboMax}else{if(parseFloat(this.produit.proAboMax)==-1){i=k}else{if(parseFloat(k)<parseFloat(i)){i=k}}}}var n=this.produit.lots[m].taille;var l=this.produit.lots[m].prix;var e=0;if(this.reservationModif&&(this.reservationModif.dcomId==m)){e=parseFloat(this.reservationModif.stoQuantite)/parseFloat(n)}e+=b;var c=e*n;if((g&&c>0)||(!g&&c>0&&c<=i)){var f=(e*l).toFixed(2);this.reservationModif.stoQuantite=c;$("#qte-pdt").text(parseFloat(c).nombreFormate(2,","," "));$("#prix-pdt").text(parseFloat(f).nombreFormate(2,","," "))}else{if(c>i&&i!=-1){var h=new TemplateVR();h.valid=false;var d=new ReservationCommandeVR();d.valid=false;d.stoQuantite.valid=false;var j=new VRerreur();j.code=ERR_304_CODE;j.message=ERR_304_MSG;d.stoQuantite.erreurs.push(j);h.produit=d;Infobulle.generer(h,"")}}};this.ajouterAbonnement=function(b){var e=this;var c=b.find(":input[name=produit]").val();if(c!=0){var f=new CompteAbonnementVO();f.idCompte=this.idCompte;f.idProduitAbonnement=c;f.quantite=this.reservationModif.stoQuantite;f.idLotAbonnement=b.find("#lot").val();var d=new CompteAbonnementValid();var g=d.validAjout(f,e.produit);if(g.valid){Infobulle.init();f.fonction="ajouter";$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(f),function(i){if(i){if(i.valid){Infobulle.init();var j=new Object();var h=new VRerreur();h.code=ERR_345_CODE;h.message=ERR_345_MSG;j.valid=false;j.log=new VRelement();j.log.valid=false;j.log.erreurs.push(h);e.construct({id:e.idAdherent,vr:j});b.dialog("close")}else{Infobulle.generer(i,"")}}},"json")}else{Infobulle.generer(g,"")}}return true};this.affectModifierAbonnement=function(b){var c=this;b.find(".btn-modifier").click(function(){c.dialogModifierAbonnement($(this).attr("idProduit"),$(this).attr("idCompteAbonnement"))});return b};this.dialogModifierAbonnement=function(b,c){var d=this;var e={fonction:"detailAbonnement",idProduit:b,idCompteAbonnement:c};$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(e),function(h){if(h){if(h.valid){Infobulle.init();d.produit=h.produit[0];d.abonnement=h.abonnement;var i=new GestionAbonnementTemplate();var j=i.dialogModifierAbonnement;var f=h.produit[0];if(f.proAboMax==-1){f.proAboMaxLabel="Pas de limite"}else{f.proAboMaxLabel=f.proAboMax.nombreFormate(2,","," ")+" "+f.proAboUnite}f.qteRestant=(parseFloat(f.proAboStockInitial)-parseFloat(f.proAboReservation)+parseFloat(h.abonnement.cptAboQuantite)).nombreFormate(2,","," ");f.cptAboQuantite=h.abonnement.cptAboQuantite.nombreFormate(2,","," ");f.proAboId=b;f.idCompteAbonnement=c;f.lot=[];var g=[];$.each(h.produit[0].lots,function(){if(this.id){var k={};k.dcomId=this.id;k.dcomTaille=parseFloat(this.taille).nombreFormate(2,","," ");k.dcomPrix=parseFloat(this.prix).nombreFormate(2,","," ");k.selected="";if(this.id==h.abonnement.cptAboIdLotAbonnement){f.prixUnitaire=(parseFloat(this.prix)/parseFloat(this.taille)).nombreFormate(2,","," ");f.qteInit=h.abonnement.cptAboQuantite.nombreFormate(2,","," ");f.prixInit=(h.abonnement.cptAboQuantite*this.prix/this.taille).nombreFormate(2,","," ");d.reservationModif.dcomId=this.id;d.reservationModif.stoQuantite=h.abonnement.cptAboQuantite;d.reservation.stoQuantite=h.abonnement.cptAboQuantite;k.selected='selected="selected"'}f.lot.push(k);g[this.id]=this}});d.produit.lots=g;f.sigleMonetaire=gSigleMonetaire;$(d.affectModifierProduit($(j.template(f)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Modifier:function(){d.modifierAbonnement($(this))},Annuler:function(){$(this).dialog("close")}},close:function(k,l){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(h,"")}}},"json")};this.affectModifierProduit=function(b){b=this.affectChangementLot(b);b=this.affectBtnQte(b);b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);return b};this.modifierAbonnement=function(b){var d=this;var e=new CompteAbonnementVO();e.id=b.find("#id").val();e.idCompte=this.idCompte;e.idProduitAbonnement=b.find("#idProduitAbonnement").val();e.quantite=this.reservationModif.stoQuantite;e.idLotAbonnement=b.find("#lot").val();var c=new CompteAbonnementValid();var f=c.validUpdate(e,d.produit,d.abonnement);if(f.valid){Infobulle.init();e.fonction="modifier";$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(e),function(h){if(h){if(h.valid){Infobulle.init();var i=new Object();var g=new VRerreur();g.code=ERR_346_CODE;g.message=ERR_346_MSG;i.valid=false;i.log=new VRelement();i.log.valid=false;i.log.erreurs.push(g);d.construct({id:d.idAdherent,vr:i});b.dialog("close")}else{Infobulle.generer(h,"")}}},"json")}else{Infobulle.generer(f,"")}};this.affecSupprimerAbonnement=function(b){var c=this;b.find(".btn-supp").click(function(){c.dialogSupprimerAbonnement($(this).attr("idCompteAbonnement"))});return b};this.dialogSupprimerAbonnement=function(b){var c=this;var d=new GestionAbonnementTemplate();var e=d.dialogSuppressionAbonnement;$(e).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Supprimer:function(){var f={fonction:"supprimer",id:b};var g=this;$.post("./index.php?m=GestionAbonnement&v=ListeAbonne","pParam="+$.toJSON(f),function(i){Infobulle.init();if(i){if(i.valid){$(g).dialog("close");var j=new Object();var h=new VRerreur();h.code=ERR_347_CODE;h.message=ERR_347_MSG;j.valid=false;j.log=new VRelement();j.log.valid=false;j.log.erreurs.push(h);c.construct({id:c.idAdherent,vr:j})}else{Infobulle.generer(i,"")}}},"json")},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove()}})};this.affectRetour=function(b){b.find("#lien-retour").click(function(){ListeAbonneVue()});return b};this.construct(a)}function DetailProduitAbonnementVue(a){this.mLotAbonnes=[];this.mIdLot=0;this.mEditionLot=false;this.mLotRemplacement=[];this.mQuantiteReservation=null;this.mTailleLotResaMax=-1;this.construct=function(b){$.history({vue:function(){DetailProduitAbonnementVue(b)}});var c=this;var d={fonction:"detailProduit"};d=$.extend(d,b);$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(e)}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(d){var c=this;$.each(d.abonnes,function(){if(!c.mLotAbonnes[this.cptAboIdLotAbonnement]){c.mLotAbonnes[this.cptAboIdLotAbonnement]={id:this.cptAboIdLotAbonnement,quantite:this.cptAboQuantite}}});var e=new GestionAbonnementTemplate();var b={};b.proAboId=d.produit[0].proAboId;b.unite=d.produit[0].proAboUnite;b.nproNom=d.produit[0].nproNom;b.proAboUnite=b.unite;b.proAboFrequence=d.produit[0].proAboFrequence;b.proAboStockInitial=d.produit[0].proAboStockInitial.nombreFormate(2,","," ");b.proAboReservation=d.produit[0].proAboReservation.nombreFormate(2,","," ");if(d.produit[0].proAboMax==-1){b.proAboMax="Pas de limite"}else{b.proAboMax=d.produit[0].proAboMax.nombreFormate(2,","," ")+" "+b.unite}if(d.abonnes&&d.abonnes.length>0&&d.abonnes[0].cptAboIdProduitAbonnement!=null){$.each(d.abonnes,function(){this.cptAboQuantite=this.cptAboQuantite.nombreFormate(2,","," ");this.proAboUnite=b.proAboUnite});b.listeAbonnes=e.detailProduitListeAbonnes.template(d)}else{b.listeAbonnes=e.detailProduitListeAbonnesVide}this.mQuantiteReservation=parseFloat(d.produit[0].proAboReservation);if(this.mQuantiteReservation<=0){this.mQuantiteReservation=-1}$("#contenu").replaceWith(c.affect($(e.detailProduit.template(b))))};this.affect=function(b){b=this.affectLienRetour(b);b=this.affectModifier(b);b=affectDialogSuppProduit(b);b=gCommunVue.comHoverBtn(b);return b};this.affectLienRetour=function(b){b.find("#lien-retour").click(function(){ListeProduitVue()});return b};this.affectModifier=function(b){var c=this;b.find("#btn-modifier").click(function(){var d={fonction:"detailProduitModifier",id:$(this).attr("idProduit")};$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(d),function(f){Infobulle.init();if(f){if(f.valid){var g=new GestionAbonnementTemplate();var h=g.dialogModifierProduit;var e=f.produit[0];e.modelesLot=[];c.mTailleLotResaMax=-1;e.modelesLotReservation=[];e.listeModelesLot=[];$(f.unite).each(function(){if(this.mLotId!=null){c.mIdLot--;var i={id:c.mIdLot,quantite:this.mLotQuantite.nombreFormate(2,","," "),prix:this.mLotPrix.nombreFormate(2,","," "),unite:this.mLotUnite,sigleMonetaire:gSigleMonetaire,modele:"modele-lot",checked:""};e.listeModelesLot.push(i)}});$(e.lots).each(function(){var i={id:this.id,quantite:this.taille.nombreFormate(2,","," "),prix:this.prix.nombreFormate(2,","," "),unite:e.proAboUnite,sigleMonetaire:gSigleMonetaire,modele:"",checked:'checked="checked"'};if(this.reservation){e.modelesLotReservation.push(i);if(this.taille>c.mTailleLotResaMax){c.mTailleLotResaMax=this.taille}}else{e.modelesLot.push(i)}});f.modelesLot=f.unite;e.proAboStockInitial=e.proAboStockInitial.nombreFormate(2,","," ");if(e.proAboMax==-1){e.checkedNoLimit='checked="checked"';e.disableLimit='disabled="disabled"'}else{e.checkedLimit='checked="checked"';e.max=e.proAboMax.nombreFormate(2,","," ")}e.sigleMonetaire=gSigleMonetaire;$(c.affectModifierDetailProduit($(h.template(e)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Modifier:function(){c.modifierProduit($(this))},Annuler:function(){$(this).dialog("close")}},close:function(i,j){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(f,"")}}},"json")});return b};this.affectModifierDetailProduit=function(b){b=this.affectLimiteStock(b);b=this.affectAjoutLot(b);b=this.affectAjoutLotGestionModifier(b);b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);return b};this.affectAjoutLot=function(b){var c=this;b.find("#btn-ajout-lot").click(function(){c.ajoutLot()});b.find("#table-pro-prix input").keyup(function(d){if(d.keyCode=="13"){c.ajoutLot()}});return b};this.ajoutLot=function(){var b=new ModeleLotVO();b.quantite=$(":input[name=lot-quantite]").val().numberFrToDb();b.unite=$(":input[name=lot-unite]").val();b.prix=$(":input[name=lot-prix]").val().numberFrToDb();var c=new ModeleLotValid();var f=c.validAjout(b);if(f.valid){Infobulle.init();var d=new GestionAbonnementTemplate();var e=d.modeleLot;this.mIdLot--;b.id=this.mIdLot;b.sigleMonetaire=gSigleMonetaire;b.quantite=b.quantite.nombreFormate(2,","," ");b.prix=b.prix.nombreFormate(2,","," ");$("#lot-liste").append(this.affectLot($(e.template(b))));$(":input[name=lot-quantite], :input[name=lot-unite], :input[name=lot-prix]").val("")}else{Infobulle.generer(f,"pro-lot-")}};this.affectLot=function(b){b=this.affectAjoutLotGestion(b);b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);return b};this.affectAjoutLotGestion=function(b){var c=this;b.find(".btn-modifier-lot").click(function(){c.ajoutLotModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-valider-lot").click(function(){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())});b.find(".catalogue-input-lot").keyup(function(d){if(d.keyCode=="13"){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())}});b.find(".btn-annuler-lot").click(function(){c.ajoutLotAnnulerModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-supprimer-lot").click(function(){c.ajoutLotSupprimer($(this).closest("tr").find("#id-lot").text())});b.find(":checkbox").change(function(){if(!c.majUnite()){if($(this).attr("checked")){$(this).removeAttr("checked")}else{$(this).attr("checked","checked")}}});return b};this.majUnite=function(){var d=true;var c=0;var e="";$(".ligne-lot :checkbox:checked").each(function(){var g=$(this).closest(".ligne-lot").find(".lot-unite").text();if(e!=""&&e!=g){d=false}else{e=g}c++});if(d){if(c>0){$(".unite-stock").text(e)}}else{var f=new Object();var b=new VRerreur();b.code=ERR_333_CODE;b.message=ERR_333_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(b);Infobulle.generer(f,"")}return d};this.affectLimiteStock=function(b){b.find(":input[name=pro-qte-max-choix]").change(function(){if($(":input[name=pro-qte-max-choix]:checked").val()==1){$(":input[name=pro-qte-max]").attr("disabled","").val("")}else{$(":input[name=pro-qte-max]").attr("disabled","disabled").val("")}});return b};this.ajoutLotModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();$("#pro-lot-"+b+"-quantite").val($("#lot-"+b+"-quantite").text());$("#pro-lot-"+b+"-unite").val($("#lot-"+b+"-unite").text());$("#pro-lot-"+b+"-prix").val($("#lot-"+b+"-prix").text());this.mEditionLot=true};this.ajoutLotAnnulerModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();this.mEditionLot=false};this.ajoutLotSupprimer=function(b){$("#ligne-lot-"+b).remove()};this.affectAjoutLotGestionModifier=function(b){var c=this;b.find(".btn-modifier-lot").click(function(){c.ajoutLotModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-valider-lot").click(function(){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())});b.find(".catalogue-input-lot").keyup(function(d){if(d.keyCode=="13"){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())}});b.find(".btn-annuler-lot").click(function(){c.ajoutLotAnnulerModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-supprimer-lot").click(function(){c.modifierLotSupprimer($(this).closest("tr").find("#id-lot").text())});b.find(":checkbox").change(function(){var d=c.majUnite();if($(this).attr("checked")){if(!d){$(this).removeAttr("checked")}}else{if(!c.autorisationSupprimerLot($(this).closest("tr").find("#id-lot").text())){$(this).attr("checked","checked")}}});return b};this.ajoutLotModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();$("#pro-lot-"+b+"-quantite").val($("#lot-"+b+"-quantite").text());$("#pro-lot-"+b+"-unite").val($("#lot-"+b+"-unite").text());$("#pro-lot-"+b+"-prix").val($("#lot-"+b+"-prix").text());this.mEditionLot=true};this.ajoutLotValiderModification=function(e){var d=new ModeleLotVO();d.id=e;d.quantite=$("#pro-lot-"+e+"-quantite").val().numberFrToDb();d.unite=$("#pro-lot-"+e+"-unite").val();d.prix=$("#pro-lot-"+e+"-prix").val().numberFrToDb();var f=new ModeleLotValid();var i=new TemplateVR();if(this.autorisationSupprimerLot(e)){i=f.validAjout(d)}else{i=f.validUpdateAvecReservation(d,this.mLotAbonnes[e].quantite)}if(i.valid){Infobulle.init();var h=new TemplateVR();var g=$("#pro-qteRestante").val();if(g!=undefined&&g!=""){g=g.numberFrToDb();if(g!=-1&&d.quantite>parseFloat(g)){h.valid=false;h.log.valid=false;var c=new VRerreur();c.code=ERR_241_CODE;c.message=ERR_241_MSG;h.log.erreurs.push(c)}}var b=$("#pro-qteMaxCommande").val();if(b!=undefined&&b!=""){b=b.numberFrToDb();if(b!=-1&&d.quantite>parseFloat(b)){h.valid=false;h.log.valid=false;var c=new VRerreur();c.code=ERR_241_CODE;c.message=ERR_241_MSG;h.log.erreurs.push(c)}}if(h.valid){$("#lot-"+e+"-quantite").text(d.quantite.nombreFormate(2,","," "));$("#lot-"+e+"-unite").text(d.unite);$("#lot-"+e+"-prix").text(d.prix.nombreFormate(2,","," "));$(".btn-lot, #btn-annuler-lot-"+e+", #btn-valider-lot-"+e+", .champ-lot-"+e).toggle();this.mEditionLot=false;this.majUnite()}else{Infobulle.generer(h,"pro-lot-"+e+"-")}}else{Infobulle.generer(i,"pro-lot-"+e+"-")}};this.ajoutLotAnnulerModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();this.mEditionLot=false};this.modifierLotSupprimer=function(b){if(this.autorisationSupprimerLot(b)){$("#ligne-lot-"+b).remove()}else{this.dialogSupprimerLot(b)}};this.autorisationSupprimerLot=function(b){if(this.mLotAbonnes[b]){return false}return true};this.dialogSupprimerLot=function(d){var e=this;var f=new GestionAbonnementTemplate();var b={modelesLot:[]};var c=$("#lot-"+d+"-unite").text();var g=parseFloat($("#lot-"+d+"-quantite").text().numberFrToDb());$("#dialog-modif-pro").find(".ligne-lot").each(function(){var k=$(this).find(".lot-id").text();var h=parseFloat($(this).find(".lot-quantite").text().numberFrToDb());var i=parseFloat($(this).find(".lot-prix").text().numberFrToDb());var j=$(this).find(".lot-unite").text();if(k!=null&&k!=d&&j==c&&h<=g&&(g%h)==0){var l={id:k,quantite:h.nombreFormate(2,","," "),prix:i.nombreFormate(2,","," "),unite:c,sigleMonetaire:gSigleMonetaire};b.modelesLot.push(l)}});$(f.dialogSupprimerLotModifierMarche.template(b)).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Valider:function(){e.supprimerLotModifierReservation($(this),d)},Annuler:function(){$(this).dialog("close")}},close:function(h,i){$(this).remove();Infobulle.init()}})};this.supprimerLotModifierReservation=function(b,d){var e=b.find(":input[name=pro-lot]:checked").val();Infobulle.init();if(e==undefined){var f=new Object();var c=new VRerreur();c.code=ERR_254_CODE;c.message=ERR_254_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(c);Infobulle.generer(f,"")}else{this.mLotRemplacement[d]=e;$("#ligne-lot-"+d+", #btn-supprimer-lot-"+e).remove();$("#pro-lot-"+e+"-id").attr("checked","checked").attr("disabled","disabled");b.dialog("close")}};this.modifierProduit=function(b){var e=this;var c=new ProduitAbonnementVO();c.id=b.find(":input[name=idProduit]").val();c.unite=b.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();c.stockInitial=b.find(":input[name=pro-stockInitial]").val().numberFrToDb();if(b.find(":input[name=pro-qte-max-choix]:checked").val()==1){c.max=b.find(":input[name=pro-qte-max]").val().numberFrToDb()}else{c.max=-1}c.frequence=b.find(":input[name=pro-frequence]").val();c.quantiteReservation=this.mQuantiteReservation;c.tailleLotResaMax=this.mTailleLotResaMax;c.lotRemplacement=this.mLotRemplacement;b.find(".ligne-lot :checkbox:checked").each(function(){var g=new DetailCommandeVO();g.id=$(this).closest(".ligne-lot").find(".lot-id").text();g.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();g.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(g)});var d=new ProduitAbonnementValid();var f=d.validUpdate(c);if(f.valid){Infobulle.init();c.fonction="modifier";$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(c),function(h){if(h){if(h.valid){Infobulle.init();var i=new Object();var g=new VRerreur();g.code=ERR_343_CODE;g.message=ERR_343_MSG;i.valid=false;i.log=new VRelement();i.log.valid=false;i.log.erreurs.push(g);e.construct({id:c.id,vr:i});b.dialog("close")}else{Infobulle.generer(h,"pro-")}}},"json")}else{Infobulle.generer(f,"pro-")}};this.affectDialogSuppProduit=function(b){b.find("#btn-supp").click(function(){var c=new GestionAbonnementTemplate();var d=c.dialogSuppressionProduit;var e=this;$(d).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Supprimer:function(){var f={fonction:"supprimer",id:$(e).attr("idProduit")};var g=this;$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(f),function(i){Infobulle.init();if(i){if(i.valid){$(g).dialog("close");var j=new Object();var h=new VRerreur();h.code=ERR_344_CODE;h.message=ERR_344_MSG;j.valid=false;j.log=new VRelement();j.log.valid=false;j.log.erreurs.push(h);ListeProduitVue({vr:j})}else{Infobulle.generer(i,"")}}},"json")},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove()}})});return b};this.construct(a)}function ListeProduitVue(a){this.mEditionLot=false;this.construct=function(b){$.history({vue:function(){ListeProduitVue(b)}});var c=this;var d={fonction:"afficher"};d=$.extend(d,b);$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(e)}else{Infobulle.generer(e,"")}}},"json")};this.afficher=function(c){var b=this;var d=new GestionAbonnementTemplate();if(c.produits&&c.produits.fermes&&c.produits.fermes.length>0&&c.produits.fermes[0].nom!=null){var e=d.listeProduit;$("#contenu").replaceWith(b.affect($(e.template(c.produits))))}else{$("#contenu").replaceWith(b.affect($(d.listeProduitVide)))}};this.affect=function(b){b=this.affectRecherche(b);b=this.affectLienProduit(b);b=this.affectAjoutProduit(b);b=gCommunVue.comHoverBtn(b);return b};this.affectAjoutProduit=function(b){var c=this;b.find("#btn-nv-produit").click(function(){c.dialogAjoutProduit()});return b};this.affectRecherche=function(b){b.find("#filter").keyup(function(){$.uiTableFilter($(".com-table"),this.value)});b.find("#filter-form").submit(function(){return false});return b};this.affectLienProduit=function(b){b.find(".ligne-produit").click(function(){DetailProduitAbonnementVue({id:$(this).attr("idProduit")})});return b};this.dialogAjoutProduit=function(b){var c=this;var d={fonction:"listeFerme"};$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(d),function(e){Infobulle.init();if(e){if(e.valid){var f=new GestionAbonnementTemplate();var g=f.dialogAjoutProduit;$(c.affectAjoutProduitSelectFerme($(g.template(e)))).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:900,buttons:{Ajouter:function(){c.ajouterProduit($(this))},Annuler:function(){c.mEditionLot=false;$(this).dialog("close")}},close:function(h,i){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(e,"")}}},"json");return b};this.affectAjoutProduitSelectFerme=function(b){var c=this;b.find("#pro-idFerme select").change(function(){var e=$(this).val();$("#pro-idCategorie select, #pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#detail-produit").replaceWith('<div id="detail-produit"></div>');if(e>0){var d={fonction:"listeProduit",id:e};$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(d),function(h){if(h){if(h.valid){Infobulle.init();if(h.listeProduit.length>0&&h.listeProduit[0].nproId!=null){c.mProduits=[];var g=0;var k=[];$.each(h.listeProduit,function(){if(c.mProduits[this.cproId]){c.mProduits[this.cproId].listeProduit.push(this)}else{c.mProduits[this.cproId]={nom:this.cproNom,listeProduit:[this]}}if(g!=this.cproId){k.push({cproId:this.cproId,cproNom:this.cproNom});g=this.cproId}});var i=new GestionAbonnementTemplate();var j=i.ajoutProduitSelectCategorie;$("#pro-idCategorie").replaceWith(c.affectAjoutProduitSelectCategorie($(j.template({listeCategorie:k}))))}else{var l=new TemplateVR();l.valid=false;l.log.valid=false;var f=new VRerreur();f.code=ERR_332_CODE;f.message=ERR_332_MSG;l.log.erreurs.push(f);Infobulle.generer(l,"")}}else{Infobulle.generer(h,"")}}},"json")}});return b};this.affectAjoutProduitSelectCategorie=function(b){var c=this;b.find("select").change(function(){var f=$(this).val();$("#pro-idProduit select").attr("disabled","disabled").selectOptions("0");$("#detail-produit").replaceWith('<div id="detail-produit"></div>');if(f>0){var d=new GestionAbonnementTemplate();var e=d.ajoutProduitSelectProduit;$("#pro-idProduit").replaceWith(c.affectAjoutProduitSelectProduit($(e.template(c.mProduits[f]))))}});return b};this.affectAjoutProduitSelectProduit=function(b){var c=this;b.find("select").change(function(){var e=$(this).val();if(e>0){var d={fonction:"listeUnite",id:e};$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(d),function(g){if(g){if(g.valid){Infobulle.init();var h=new GestionAbonnementTemplate();var i=h.detailProduitAjoutProduit;var f={};if(g.unite.length>0){f.modelesLot=[];$(g.unite).each(function(){if(this.mLotId!=null){this.id=this.mLotId;this.quantite=this.mLotQuantite.nombreFormate(2,","," ");this.unite=this.mLotUnite;this.prix=this.mLotPrix.nombreFormate(2,","," ");this.sigleMonetaire=gSigleMonetaire;f.modelesLot.push(this);f.unite=this.mLotUnite}});g.modelesLot=g.unite}$("#detail-produit").replaceWith(c.affectDetailProduit($(i.template(f))))}else{Infobulle.generer(g,"")}}},"json")}else{$("#detail-produit").replaceWith($('<div id="detail-produit">'))}});return b};this.affectDetailProduit=function(b){b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);b=this.affectLimiteStock(b);b=this.affectAjoutLot(b);b=this.affectAjoutLotGestion(b);return b};this.affectAjoutLot=function(b){var c=this;b.find("#btn-ajout-lot").click(function(){c.ajoutLot()});b.find("#table-pro-prix input").keyup(function(d){if(d.keyCode=="13"){c.ajoutLot()}});return b};this.ajoutLot=function(){var b=new ModeleLotVO();b.quantite=$(":input[name=lot-quantite]").val().numberFrToDb();b.unite=$(":input[name=lot-unite]").val();b.prix=$(":input[name=lot-prix]").val().numberFrToDb();var c=new ModeleLotValid();var f=c.validAjout(b);if(f.valid){Infobulle.init();var d=new GestionAbonnementTemplate();var e=d.modeleLot;this.mIdLot--;b.id=this.mIdLot;b.sigleMonetaire=gSigleMonetaire;b.quantite=b.quantite.nombreFormate(2,","," ");b.prix=b.prix.nombreFormate(2,","," ");$("#lot-liste").append(this.affectLot($(e.template(b))));$(":input[name=lot-quantite], :input[name=lot-unite], :input[name=lot-prix]").val("")}else{Infobulle.generer(f,"pro-lot-")}};this.affectLot=function(b){b=this.affectAjoutLotGestion(b);b=gCommunVue.comHoverBtn(b);b=gCommunVue.comNumeric(b);return b};this.affectAjoutLotGestion=function(b){var c=this;b.find(".btn-modifier-lot").click(function(){c.ajoutLotModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-valider-lot").click(function(){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())});b.find(".catalogue-input-lot").keyup(function(d){if(d.keyCode=="13"){c.ajoutLotValiderModification($(this).closest("tr").find("#id-lot").text())}});b.find(".btn-annuler-lot").click(function(){c.ajoutLotAnnulerModification($(this).closest("tr").find("#id-lot").text())});b.find(".btn-supprimer-lot").click(function(){c.ajoutLotSupprimer($(this).closest("tr").find("#id-lot").text())});b.find(":checkbox").change(function(){if(!c.majUnite()){if($(this).attr("checked")){$(this).removeAttr("checked")}else{$(this).attr("checked","checked")}}});return b};this.majUnite=function(){var d=true;var c=0;var e="";$(".ligne-lot :checkbox:checked").each(function(){var g=$(this).closest(".ligne-lot").find(".lot-unite").text();if(e!=""&&e!=g){d=false}else{e=g}c++});if(d){if(c>0){$(".unite-stock").text(e)}}else{var f=new Object();var b=new VRerreur();b.code=ERR_333_CODE;b.message=ERR_333_MSG;f.valid=false;f.log=new VRelement();f.log.valid=false;f.log.erreurs.push(b);Infobulle.generer(f,"")}return d};this.affectLimiteStock=function(b){b.find(":input[name=pro-qte-max-choix]").change(function(){if($(":input[name=pro-qte-max-choix]:checked").val()==1){$(":input[name=pro-qte-max]").attr("disabled","").val("")}else{$(":input[name=pro-qte-max]").attr("disabled","disabled").val("")}});return b};this.ajoutLotModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();$("#pro-lot-"+b+"-quantite").val($("#lot-"+b+"-quantite").text());$("#pro-lot-"+b+"-unite").val($("#lot-"+b+"-unite").text());$("#pro-lot-"+b+"-prix").val($("#lot-"+b+"-prix").text());this.mEditionLot=true};this.ajoutLotValiderModification=function(c){var b=new ModeleLotVO();b.quantite=$("#pro-lot-"+c+"-quantite").val().numberFrToDb();b.unite=$("#pro-lot-"+c+"-unite").val();b.prix=$("#pro-lot-"+c+"-prix").val().numberFrToDb();var d=new ModeleLotValid();var e=d.validAjout(b);if(e.valid){Infobulle.init();$("#lot-"+c+"-quantite").text(b.quantite.nombreFormate(2,","," "));$("#lot-"+c+"-unite").text(b.unite);$("#lot-"+c+"-prix").text(b.prix.nombreFormate(2,","," "));$(".btn-lot, #btn-annuler-lot-"+c+", #btn-valider-lot-"+c+", .champ-lot-"+c).toggle();this.mEditionLot=false;this.majUnite()}else{Infobulle.generer(e,"pro-lot-"+c+"-")}};this.ajoutLotAnnulerModification=function(b){$(".btn-lot, #btn-annuler-lot-"+b+", #btn-valider-lot-"+b+", .champ-lot-"+b).toggle();this.mEditionLot=false};this.ajoutLotSupprimer=function(b){$("#ligne-lot-"+b).remove()};this.ajouterProduit=function(b){var f=this;var d=b.find(":input[name=produit]").val();if(d!=0){var c=new ProduitAbonnementVO();c.idNomProduit=d;c.unite=b.find(".ligne-lot :checkbox:checked").first().closest(".ligne-lot").find(".lot-unite").text();c.stockInitial=b.find(":input[name=pro-stockInitial]").val().numberFrToDb();if(b.find(":input[name=pro-qte-max-choix]:checked").val()==1){c.max=b.find(":input[name=pro-qte-max]").val().numberFrToDb()}else{c.max=-1}c.frequence=b.find(":input[name=pro-frequence]").val();b.find(".ligne-lot :checkbox:checked").each(function(){var h=new DetailCommandeVO();h.taille=$(this).closest(".ligne-lot").find(".lot-quantite").text().numberFrToDb();h.prix=$(this).closest(".ligne-lot").find(".lot-prix").text().numberFrToDb();c.lots.push(h)});var e=new ProduitAbonnementValid();var g=e.validAjout(c);if(g.valid){Infobulle.init();c.fonction="ajouter";$.post("./index.php?m=GestionAbonnement&v=ListeProduit","pParam="+$.toJSON(c),function(i){if(i){if(i.valid){Infobulle.init();var j=new Object();var h=new VRerreur();h.code=ERR_342_CODE;h.message=ERR_342_MSG;j.valid=false;j.log=new VRelement();j.log.valid=false;j.log.erreurs.push(h);f.construct({vr:j});b.dialog("close")}else{Infobulle.generer(i,"pro-")}}},"json")}else{Infobulle.generer(g,"pro-")}}};this.construct(a)};