function CommandeTemplate(){this.detailReservation='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div><div id="resa-info-commande">Fin des réservations : Le {dateFinReservation} à {heureFinReservation}H{minuteFinReservation} <br/>Marché : Le {dateMarcheDebut} de {heureMarcheDebut}H{minuteMarcheDebut} à {heureMarcheFin}H{minuteMarcheFin} <br/></div><div><span>Solde Actuel : </span><span>{solde} {sigleMonetaire}</span><br/><span>Nouveau Solde : </span><span id="nouveau-solde">{soldeNv}</span> <span id="nouveau-solde-sigle">{sigleMonetaire}</span></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Ma Commande</div><table><!-- BEGIN categories --><td class="ui-widget-header ui-corner-all com-center">{categories.nom}</td><td colspan="5"></td><!-- BEGIN categories.produits --><tr ><td class="detail-resa-npro">{categories.produits.nproNom}</td><td class="td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-info-produit" title="Information sur le produit" id-produit="{categories.produits.proId}"><span class="ui-icon ui-icon-info"></span></span></td><td class="com-text-align-right detail-resa-qte">{categories.produits.stoQuantite}</td><td class="detail-resa-unite">{categories.produits.proUniteMesure}</td><td class="com-text-align-right detail-resa-prix">{categories.produits.prix}</td><td>{sigleMonetaire}</td></tr><!-- END categories.produits --><!-- END categories --><tr><td class="com-text-align-right" colspan="4">Total : </td><td class="com-text-align-right">{total}</td><td>{sigleMonetaire}</td></tr></table></div><div class="boutons-edition com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button class="com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center " id="btn-modifier">Modifier</button><button class="ui-state-default ui-corner-all com-button com-center" id="btn-valider">Valider</button></div></div>';this.mesCommandesDetailReservation='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div><div id="resa-info-commande">Fin des réservations : Le {dateFinReservation} à {heureFinReservation}H{minuteFinReservation} <br/>Marché : Le {dateMarcheDebut} de {heureMarcheDebut}H{minuteMarcheDebut} à {heureMarcheFin}H{minuteMarcheFin}</div><div><span>Solde Actuel : </span><span>{solde} {sigleMonetaire}</span><br/><span>Nouveau Solde : </span><span id="nouveau-solde">{soldeNv}</span> <span id="nouveau-solde-sigle">{sigleMonetaire}</span></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Ma réservation</div><table><!-- BEGIN categories --><td class="ui-widget-header ui-corner-all com-center">{categories.nom}</td><td colspan="5"></td><!-- BEGIN categories.produits --><tr ><td class="detail-resa-npro">{categories.produits.nproNom}</td><td class="td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-info-produit" title="Information sur le produit" id-produit="{categories.produits.proId}"><span class="ui-icon ui-icon-info"></span></span></td><td class="com-text-align-right detail-resa-qte">{categories.produits.stoQuantite}</td><td class="detail-resa-unite">{categories.produits.proUniteMesure}</td><td class="com-text-align-right detail-resa-prix">{categories.produits.prix}</td><td>{sigleMonetaire}</td></tr><!-- END categories.produits --><!-- END categories --><tr><td class="com-text-align-right" colspan="4">Total : </td><td class="com-text-align-right">{total}</td><td>{sigleMonetaire}</td></tr></table></div><div class="boutons-edition com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button class="com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center" id="btn-modifier">Modifier</button><button class="ui-state-default ui-corner-all com-button com-center" id="btn-supprimer">Supprimer</button></div></div>';this.supprimerReservationDialog='<div id="dialog-supprimer-reservation" title="Supprimer la réservation"><p>Voulez-vous supprimer la réservation ?</p></div>';this.reservation='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div><div id="resa-info-commande">Fin des réservations : Le {dateFinReservation} à {heureFinReservation}H{minuteFinReservation} <br/>Marché : Le {dateMarcheDebut} de {heureMarcheDebut}H{minuteMarcheDebut} à {heureMarcheFin}H{minuteMarcheFin} <br/></div><div><span>Solde Actuel : </span><span>{solde} {sigleMonetaire}</span><br/><span>Nouveau Solde : </span><span id="nouveau-solde">{soldeNv}</span> <span id="nouveau-solde-sigle">{sigleMonetaire}</span></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Ma Commande</div><div><table><!-- BEGIN categories --><tr><td colspan="4" class="ui-widget-header ui-corner-all com-center">{categories.nom}</td><td colspan="6"></td></tr><!-- BEGIN categories.produits --><tr class="pdt"><td><input type="checkbox" {categories.produits.checked}/></td><td><span class="ui-helper-hidden"><span class="pdt-id">{categories.produits.proId}</span></span></td><td><span class="nom-pro">{categories.produits.nproNom}<span></td><td class="td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-info-produit" title="Information sur le produit" id-produit="{categories.produits.proId}"><span class="ui-icon ui-icon-info"></span></span></td><td><select id="lot-{categories.produits.proId}"><!-- BEGIN categories.produits.lot --><option value="{categories.produits.lot.dcomId}">par {categories.produits.lot.dcomTaille} {categories.produits.proUniteMesure}</option><!-- END categories.produits.lot --></select></td><td>à <span id="prix-unitaire-{categories.produits.proId}">{categories.produits.prixUnitaire}</span> {sigleMonetaire}/{categories.produits.proUniteMesure}</td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><button class="btn-moins">-</button></td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><span id="qte-pdt-{categories.produits.proId}"></span> {categories.produits.proUniteMesure}</td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><button class="btn-plus">+</button></td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId} com-text-align-right"><span id="prix-pdt-{categories.produits.proId}"></span> {sigleMonetaire}</td></tr><!-- END categories.produits --><!-- END categories --><tr><td colspan="9" class="com-text-align-right">Total : </td><td class="com-text-align-right detail-resa-prix"><span id="total">{total}</span></td><td>{sigleMonetaire}</td></tr></table></div></div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button class="ui-state-default ui-corner-all com-button com-center" id="btn-valider">Valider</button></div></div>';this.produitIndisponible='<tr><td colspan="11">Le produit {nom} n\'est plus disponible.</td></tr>';this.lotUnique='<input type="hidden" id="lot-{IdPdt}" value="{valeur}" /><span>{text}</span>';this.modifierReservation='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div><div id="resa-info-commande">Fin des réservations : Le {dateFinReservation} à {heureFinReservation}H{minuteFinReservation} <br/>Marché : Le {dateMarcheDebut} de {heureMarcheDebut}H{minuteMarcheDebut} à {heureMarcheFin}H{minuteMarcheFin} <br/></div><div><span>Solde Actuel : </span><span>{solde} {sigleMonetaire}</span><br/><span>Nouveau Solde : </span><span id="nouveau-solde">{soldeNv}</span> <span id="nouveau-solde-sigle">{sigleMonetaire}</span></div></div><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Ma réservation</div><div><table><!-- BEGIN categories --><tr><td colspan="4" class="ui-widget-header ui-corner-all com-center">{categories.nom}</td><td colspan="6"></td></tr><!-- BEGIN categories.produits --><tr class="pdt"><td><input type="checkbox" {categories.produits.checked}/></td><td><span class="ui-helper-hidden"><span class="pdt-id">{categories.produits.proId}</span></span></td><td>{categories.produits.nproNom}</td><td class="td-edt"><span class="com-cursor-pointer com-btn-header ui-widget-content ui-corner-all btn-info-produit" title="Information sur le produit" id-produit="{categories.produits.proId}"><span class="ui-icon ui-icon-info"></span></span></td><td><select id="lot-{categories.produits.proId}"><!-- BEGIN categories.produits.lot --><option value="{categories.produits.lot.dcomId}">par {categories.produits.lot.dcomTaille} {categories.produits.proUniteMesure}</option><!-- END categories.produits.lot --></select></td><td>à <span id="prix-unitaire-{categories.produits.proId}">{categories.produits.prixUnitaire}</span> {sigleMonetaire}/{categories.produits.proUniteMesure}</td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><button class="btn-moins">-</button></td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><span id="qte-pdt-{categories.produits.proId}"></span> {categories.produits.proUniteMesure}</td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId}"><button class="btn-plus">+</button></td><td class="ui-helper-hidden resa-pdt-{categories.produits.proId} com-text-align-right"><span id="prix-pdt-{categories.produits.proId}"></span> {sigleMonetaire}</td></tr><!-- END categories.produits --><!-- END categories --><tr><td colspan="9" class="com-text-align-right">Total : </td><td class="com-text-align-right detail-resa-prix"><span id="total">{total}</span></td><td>{sigleMonetaire}</td></tr></table></div></div><div class="com-widget-header ui-widget ui-widget-header ui-corner-all com-center"><button class="com-btn-edt-multiples ui-state-default ui-corner-all com-button com-center" id="btn-annuler">Annuler</button><button class="ui-state-default ui-corner-all com-button com-center" id="btn-valider">Valider</button></div></div>';this.confirmationReservationCommande='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><table><!-- BEGIN produit --><tr><td>{produit.NOM}</td><td>{produit.QUANTITE}</td><td>{produit.PRIX}</td></tr><!-- END produit --><tr><td></td><td>Total : </td><td>{TOTAL_COMMANDE}</td></tr></table><div class="ui-helper-hidden"><form id="form-confirmation-reservation-commande"><table><tr><td><input type="text" name="id_commande" value="{ID_COMMANDE}" /></td></tr><!-- BEGIN info_produit --><tr><td><input type="text" name="id_pdt[]" value="{info_produit.IDPDT}" /></td><td><input type="text" name="id_lot[]" value="{info_produit.IDLOT}" /></td><td><input type="text" name="qte[]" value="{info_produit.QTE}" /></td></tr><!-- END info_produit --></table></form></div></div>';this.reservationOk='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Réservation</div><div class="com-widget-content"><p class="com-msg-confirm-icon"><span class="com-float-left ui-icon ui-icon-check"></span>Réservation effectuée avec succés.</p></div></div></div>';this.MonMarcheDebut='<div id="contenu">';this.listeReservation='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Mes Réservations</div><table class="com-table"><tr class="ui-widget ui-widget-header"><th class="com-table-th lst-resa-th-num">N°</th><th class="com-table-th">Date de cloture des Réservations</th><th class="com-table-th">Marché</th>	</tr><!-- BEGIN reservation --><tr class="com-cursor-pointer visualiser-reservation" id={reservation.idCommande} ><td class="com-table-td com-underline-hover com-text-align-right">{reservation.numero}</td><td class="com-table-td com-underline-hover">Le {reservation.dateFinReservation} à {reservation.heureFinReservation}H{reservation.minuteFinReservation}</td><td class="com-table-td com-underline-hover">Le {reservation.dateMarcheDebut} de {reservation.heureMarcheDebut}H{reservation.minuteMarcheDebut} à {reservation.heureMarcheFin}H{reservation.minuteMarcheFin}</td></tr><!-- END reservation --></table></div>';this.listeReservationVide='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Mes Réservations</div><p id="texte-liste-vide">Aucune réservation en cours.</p></div>';this.listeMarche='<div id="liste_commande_int"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés</div><table class="com-table"><tr class="ui-widget ui-widget-header"><th class="com-table-th lst-resa-th-num">N°</th><th class="com-table-th">Date de cloture des Réservations</th><th class="com-table-th">Marché</th>	<th class="com-table-th"></th></tr><!-- BEGIN marche --><tr ><td class="com-table-td com-text-align-right">{marche.numero}</td><td class="com-table-td">Le {marche.dateFinReservation} à {marche.heureFinReservation}H{marche.minuteFinReservation}</td><td class="com-table-td">Le {marche.dateMarcheDebut} de {marche.heureMarcheDebut}H{marche.minuteMarcheDebut} à {marche.heureMarcheFin}H{marche.minuteMarcheFin}</td><td class="com-table-td lst-resa-btn-commander"><button class="btn-commander ui-state-default ui-corner-all com-button com-center" id="{marche.id}">Commander</button></td></tr><!-- END marche --></table></div></div></div>';this.listeMarcheVide='<div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Les Marchés</div><p id="texte-liste-vide">Aucun Marché en cours.</p></div>';this.MonMarcheFin="</div>";this.listeAchats='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Mes Achats</div><table class="com-table"><tr class="ui-widget ui-widget-header"><th class="com-table-th lst-resa-th-num">N°</th><th class="com-table-th">Marché</th>	</tr><!-- BEGIN achat --><tr class="com-cursor-pointer ligne-achat" id={achat.idCommande} ><td class="com-table-td com-underline-hover com-text-align-right">{achat.numero}</td><td class="com-table-td com-underline-hover">Le {achat.dateMarcheDebut}</td></tr><!-- END achat --></table></div></div>';this.listeAchatVide='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Mes Achats</div><p id="texte-liste-vide">Aucun achat effectué.</p></div></div>';this.detailAchat='<div id="contenu"><div class="com-widget-window ui-widget ui-widget-content ui-corner-all"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Marché n°{comNumero}</div></div><!-- BEGIN achats --><div class="achat com-widget-window ui-widget ui-widget-content ui-corner-all" id="achat-{achats.idAchat}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat <span class="achat-id ui-helper-hidden">{achats.idAchat}</span></div><table><!-- BEGIN achats.categories --><tr><td class="ui-widget-header ui-corner-all com-center">{achats.categories.nom}</td></tr><!-- BEGIN achats.categories.achat --><tr><td class="detail-achat-npro">{achats.categories.achat.nproNom}</td><td class="com-text-align-right detail-achat-qte">{achats.categories.achat.stoQuantite}</td><td class="detail-achat-unite">{achats.categories.achat.proUniteMesure}</td><td class="com-text-align-right detail-achat-prix">{achats.categories.achat.prix} {sigleMonetaire}</td></tr><!-- END achats.categories.achat --><!-- END achats.categories --><tr><td class="com-text-align-right" colspan="3">Total : </td><td class="com-text-align-right detail-achat-prix">{achats.total} {sigleMonetaire}</td></tr></table></div><!-- END achats --><!-- BEGIN achatsSolidaire --><div class="achatSolidaire com-widget-window ui-widget ui-widget-content ui-corner-all" id="achat-{achatsSolidaire.idAchat}"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Achat Solidaire <span class="achat-id ui-helper-hidden">{achatsSolidaire.idAchat}</span></div><table><!-- BEGIN achatsSolidaire.categories --><tr><td class="ui-widget-header ui-corner-all com-center">{achatsSolidaire.categories.nom}</td></tr><!-- BEGIN achatsSolidaire.categories.achat --><tr><td class="detail-achat-npro">{achatsSolidaire.categories.achat.nproNom}</td><td class="com-text-align-right detail-achat-qte">{achatsSolidaire.categories.achat.stoQuantite}</td><td class="detail-achat-unite">{achatsSolidaire.categories.achat.proUniteMesure}</td><td class="com-text-align-right detail-achat-prix">{achatsSolidaire.categories.achat.prix} {sigleMonetaire}</td></tr><!-- END achatsSolidaire.categories.achat --><!-- END achatsSolidaire.categories --><tr><td class="com-text-align-right" colspan="3">Total : </td><td class="com-text-align-right detail-achat-prix">{achatsSolidaire.totalSolidaire} {sigleMonetaire}</td></tr></table></div><!-- END achatsSolidaire --></div>';this.dialogInfoProduit='<div id="dialog-info-pro" title="Produit"><div id="information-detail-producteur"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Informations</div><div class="com-widget-content"><table class="com-table-form"><tr><th class="com-table-form-th">Nom : </th><td class="com-table-form-td">{nom}</td></tr><tr><th class="com-table-form-th">Catégorie : </th><td class="com-table-form-td">{cproNom}</td></tr><tr><th class="com-table-form-th">Description : </th><td class="com-table-form-td">{description}</td></tr></table></div></div><div id="pro-prdt"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Producteurs</div><table class="com-table-form"><!-- BEGIN producteurs --><tr><td class="com-table-form-td">{producteurs.prdtPrenom} {producteurs.prdtNom}</td></tr><!-- END producteurs --></table></div><div id="pro-car"><div class="com-widget-header ui-widget ui-widget-header ui-corner-all">Caractéristiques</div><table class="com-table-form"><!-- BEGIN caracteristiques --><tr><td class="com-table-form-td">{caracteristiques.carNom}</td></tr><!-- END caracteristiques --></table></div></div>'}function AfficherReservationVue(a){this.infoCommande=new Object();this.pdtCommande=new Array();this.reservation=new Array();this.reservationModif=new Array();this.solde=0;this.soldeNv=0;this.construct=function(b){var c=this;b.fonction="afficher";$.history({vue:function(){AfficherReservationVue(b)}});$.post("./index.php?m=Commande&v=AfficherReservation","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.solde=d.adherent.cptSolde;c.soldeNv=d.adherent.cptSolde;c.infoCommande.comId=d.marche.id;c.infoCommande.comNumero=d.marche.numero;c.infoCommande.comNom=d.marche.nom;c.infoCommande.comDescription=d.marche.description;c.infoCommande.dateTimeFinReservation=d.marche.dateFinReservation;c.infoCommande.dateFinReservation=d.marche.dateFinReservation.extractDbDate().dateDbToFr();c.infoCommande.heureFinReservation=d.marche.dateFinReservation.extractDbHeure();c.infoCommande.minuteFinReservation=d.marche.dateFinReservation.extractDbMinute();c.infoCommande.dateMarcheDebut=d.marche.dateMarcheDebut.extractDbDate().dateDbToFr();c.infoCommande.heureMarcheDebut=d.marche.dateMarcheDebut.extractDbHeure();c.infoCommande.minuteMarcheDebut=d.marche.dateMarcheDebut.extractDbMinute();c.infoCommande.heureMarcheFin=d.marche.dateMarcheFin.extractDbHeure();c.infoCommande.minuteMarcheFin=d.marche.dateMarcheFin.extractDbMinute();c.infoCommande.comArchive=d.marche.archive;c.pdtCommande=d.marche.produits;$.each(c.pdtCommande,function(){if(this.id){var e=this.id;$.each(this.lots,function(){if(this.id){var f=this.id;$(d.reservation).each(function(){if(this.idDetailCommande==f){this.stoQuantite=this.quantite*-1;this.dcomId=this.idDetailCommande;this.proId=e;c.reservation[e]=this}})}})}});c.afficher()}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(){this.afficherDetailReservation()};this.afficherDetailReservation=function(){var d=this;var f=new CommandeTemplate();var e=f.mesCommandesDetailReservation;var b=new Object();b.sigleMonetaire=gSigleMonetaire;b.solde=this.solde.nombreFormate(2,","," ");b.comNumero=this.infoCommande.comNumero;b.dateFinReservation=this.infoCommande.dateFinReservation;b.heureFinReservation=this.infoCommande.heureFinReservation;b.minuteFinReservation=this.infoCommande.minuteFinReservation;b.dateMarcheDebut=this.infoCommande.dateMarcheDebut;b.heureMarcheDebut=this.infoCommande.heureMarcheDebut;b.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;b.heureMarcheFin=this.infoCommande.heureMarcheFin;b.minuteMarcheFin=this.infoCommande.minuteMarcheFin;b.categories=[];var c=0;$.each(this.pdtCommande,function(){var h=this.id;if(d.reservation[this.id]){var g=new Object;g.proId=h;g.nproNom=this.nom;g.stoQuantite=parseFloat(d.reservation[this.id].stoQuantite);g.proUniteMesure=this.unite;g.prix=0;var i=d.reservation[this.id].dcomId;$.each(this.lots,function(){if(this.id==i){g.prix=(g.stoQuantite/this.taille)*this.prix}});c+=g.prix;g.stoQuantite=g.stoQuantite.nombreFormate(2,","," ");g.prix=g.prix.nombreFormate(2,","," ");if(!b.categories[this.idCategorie]){b.categories[this.idCategorie]={nom:this.cproNom,produits:[]}}b.categories[this.idCategorie].produits.push(g)}});b.total=parseFloat(c).nombreFormate(2,","," ");this.soldeNv=this.solde-c;b.soldeNv=this.soldeNv.nombreFormate(2,","," ");$("#contenu").replaceWith(d.affect($(e.template(b))))};this.afficherModifier=function(){var d=this;var f=new CommandeTemplate();var e=f.modifierReservation;var b={};b.sigleMonetaire=gSigleMonetaire;b.solde=this.solde.nombreFormate(2,","," ");b.soldeNv=this.soldeNv.nombreFormate(2,","," ");b.comNumero=this.infoCommande.comNumero;b.dateFinReservation=this.infoCommande.dateFinReservation;b.heureFinReservation=this.infoCommande.heureFinReservation;b.minuteFinReservation=this.infoCommande.minuteFinReservation;b.dateMarcheDebut=this.infoCommande.dateMarcheDebut;b.heureMarcheDebut=this.infoCommande.heureMarcheDebut;b.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;b.heureMarcheFin=this.infoCommande.heureMarcheFin;b.minuteMarcheFin=this.infoCommande.minuteMarcheFin;b.categories=[];var c=0;$.each(this.pdtCommande,function(){if(this.id){var g={};g.proId=this.id;g.nproNom=this.nom;g.proUniteMesure=this.unite;g.proMaxProduitCommande=parseFloat(this.qteMaxCommande);if(d.reservation[this.id]){g.stock=parseFloat(this.stockReservation)+parseFloat(d.reservation[this.id].stoQuantite)}else{g.stock=parseFloat(this.stockReservation)}g.lot=new Array();var l=false;if(parseFloat(this.qteMaxCommande)==-1&&parseFloat(this.stockInitial)==-1){l=true}else{if(parseFloat(this.stockInitial)==-1){g.max=g.proMaxProduitCommande}else{if(parseFloat(this.qteMaxCommande)==-1){g.max=g.stock}else{if(parseFloat(g.proMaxProduitCommande)<parseFloat(g.stock)){g.max=g.proMaxProduitCommande}else{g.max=g.stock}}}}var j=0;var h=-1;var k=-1;$.each(this.lots,function(){if(this.id){if(l||(!l&&parseFloat(this.taille)<=g.max)){var i={};i.dcomId=this.id;i.dcomTaille=parseFloat(this.taille).nombreFormate(2,","," ");i.dcomPrix=parseFloat(this.prix).nombreFormate(2,","," ");i.prixReservation=parseFloat(this.prix);i.stoQuantiteReservation=parseFloat(this.taille);if(d.reservation[g.proId]&&(d.reservation[g.proId].dcomId==this.id)){i.stoQuantiteReservation=parseFloat(d.reservation[g.proId].stoQuantite);i.prixReservation=(i.stoQuantiteReservation/this.taille)*this.prix;c+=i.prixReservation;h=this.id;i.checked='checked="checked"'}g.prixUnitaire=(i.prixReservation/i.stoQuantiteReservation).nombreFormate(2,","," ");g.stoQuantiteReservation=i.stoQuantiteReservation.nombreFormate(2,","," ");g.prixReservation=i.prixReservation.nombreFormate(2,","," ");g.lot.push(i)}}});b.total=parseFloat(c).nombreFormate(2,","," ");if(h!=-1){g.checked='checked="checked"'}else{g.checked=""}if(g.lot.length==0){g.checked='rel="indisponible"'}if(!b.categories[this.idCategorie]){b.categories[this.idCategorie]={nom:this.cproNom,produits:[]}}b.categories[this.idCategorie].produits.push(g)}});this.reservationModif=[];$(this.reservation).each(function(){if(this.proId){d.reservationModif[this.proId]={proId:this.proId,dcomId:this.dcomId,stoQuantite:this.stoQuantite}}});$("#contenu").replaceWith(d.affectModifier($(e.template(b))));this.majNouveauSolde()};this.affect=function(b){b=this.affectDroitEdition(b);b=this.affectModifierReservation(b);b=this.affectSupprimerReservation(b);b=this.affectNvSolde(b);b=this.affectInfoProduit(b);b=gCommunVue.comHoverBtn(b);return b};this.affectInfoProduit=function(b){var c=this;b.find(".btn-info-produit").click(function(){var e=$(this).attr("id-produit");var d={id:e,fonction:"detailProduit"};$.post("./index.php?m=Commande&v=AfficherReservation","pParam="+$.toJSON(d),function(g){Infobulle.init();if(g){if(g.valid){var i=new CommandeTemplate();var h=i.dialogInfoProduit;g.produit.sigleMonetaire=gSigleMonetaire;var f=$(h.template(g.produit));if(g.produit.producteurs.length>0&&g.produit.producteurs[0].nPrdtIdNomProduit==null){f.find("#pro-prdt").remove()}if(g.produit.caracteristiques.length>0&&g.produit.caracteristiques[0].carProIdNomProduit==null){f.find("#pro-car").remove()}$(f).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:600,close:function(j,k){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(g,"")}}},"json")});return b};this.affectDroitEdition=function(b){if(!dateTimeEstPLusGrandeEgale(this.infoCommande.dateTimeFinReservation,getDateTimeAujourdhuiDb(),"db")){b.find(".boutons-edition").hide()}return b};this.affectModifier=function(b){b=this.affectBtnQte(b);b=this.affectChangementLot(b);b=this.affectChangementProduit(b);b=this.preparerAffichageModifier(b);b=this.affectValiderReservation(b);b=this.affectAnnulerReservation(b);b=this.supprimerSelect(b);b=gCommunVue.comHoverBtn(b);b=this.affectInitLot(b);b=this.affectInfoProduit(b);b=this.masquerIndisponible(b);return b};this.affectNvSolde=function(b){if(this.soldeNv<=0){b.find("#nouveau-solde, #nouveau-solde-sigle").addClass("com-nombre-negatif")}return b};this.affectBtnQte=function(b){var c=this;b.find(".btn-plus").click(function(){var d=$(this).parent().parent().find(".pdt-id").text();c.nouvelleQuantite(d,$(this).parent().parent().find("#lot-"+d).val(),1)});b.find(".btn-moins").click(function(){var d=$(this).parent().parent().find(".pdt-id").text();c.nouvelleQuantite(d,$(this).parent().parent().find("#lot-"+d).val(),-1)});return b};this.affectChangementLot=function(b){var c=this;b.find(".pdt select").change(function(){c.changerLot($(this).parent().parent().find(".pdt-id").text(),$(this).val())});return b};this.affectChangementProduit=function(b){var c=this;b.find(".pdt :checkbox").click(function(){c.changerProduit($(this).parent().parent().find(".pdt-id").text())});return b};this.affectValiderReservation=function(b){var c=this;b.find("#btn-valider").click(function(){c.validerReservation()});return b};this.affectAnnulerReservation=function(b){var c=this;b.find("#btn-annuler").click(function(){c.afficherDetailReservation()});return b};this.affectModifierReservation=function(b){var c=this;b.find("#btn-modifier").click(function(){c.afficherModifier()});return b};this.masquerIndisponible=function(b){b.find("[rel='indisponible']").each(function(){var e=new CommandeTemplate();var d=e.produitIndisponible;var c={nom:$(this).parents(".pdt").find(".nom-pro").text()};$(this).parents(".pdt").before(d.template(c));$(this).parents(".pdt").remove()});return b};this.affectInitLot=function(b){var c=this;b.find(".pdt select").each(function(){var d=$(this).parent().parent().find(".pdt-id").text();var g=$(this).val();if(c.pdtCommande[d].lots[g]){var e=c.pdtCommande[d].lots[g].prix;var h=c.pdtCommande[d].lots[g].taille;var f=(e/h).nombreFormate(2,","," ");$(b).find("#prix-unitaire-"+d).text(f)}});return b};this.nouvelleQuantite=function(f,m,b){var i=parseFloat(this.pdtCommande[f].qteMaxCommande);if(this.reservationModif[f]){var k=parseFloat(this.pdtCommande[f].stockReservation)+parseFloat(this.reservationModif[f].stoQuantite)}else{var k=parseFloat(this.pdtCommande[f].stockReservation)}var g=false;if(parseFloat(this.pdtCommande[f].qteMaxCommande)==-1&&parseFloat(this.pdtCommande[f].stockInitial)==-1){g=true}else{if(parseFloat(this.pdtCommande[f].stockInitial)==-1){i=this.pdtCommande[f].qteMaxCommande}else{if(parseFloat(this.pdtCommande[f].qteMaxCommande)==-1){i=k}else{if(parseFloat(k)<parseFloat(i)){i=k}}}}var n=this.pdtCommande[f].lots[m].taille;var l=this.pdtCommande[f].lots[m].prix;var d=0;if(this.reservationModif[f]&&(this.reservationModif[f].dcomId==m)){d=parseFloat(this.reservationModif[f].stoQuantite)/parseFloat(n)}d+=b;var c=0;c=d*n;if(g||(!g&&c>0&&c<=i)){var e=0;e=(d*l).toFixed(2);this.reservationModif[f].stoQuantite=c;$("#qte-pdt-"+f).text(parseFloat(c).nombreFormate(2,","," "));$("#prix-pdt-"+f).text(parseFloat(e).nombreFormate(2,","," "));this.majTotal()}else{if(c>i){var h=new TemplateVR();h.valid=false;h.log.valid=false;var j=new VRerreur();j.code=ERR_304_CODE;j.message=ERR_304_MSG;h.log.erreurs.push(j);Infobulle.generer(h,"")}}};this.changerLot=function(b,c){var d=this.pdtCommande[b].lots[c].prix;var f=this.pdtCommande[b].lots[c].taille;var e=(d/f).nombreFormate(2,","," ");$("#prix-unitaire-"+b).text(e);if(this.reservationModif[b]){this.reservationModif[b].dcomId=c;this.reservationModif[b].stoQuantite=f;$("#qte-pdt-"+b).text(f.nombreFormate(2,","," "));$("#prix-pdt-"+b).text(d.nombreFormate(2,","," "))}this.majTotal()};this.changerProduit=function(b){if(this.reservationModif[b]!=null){$(".resa-pdt-"+b).hide();$("#qte-pdt-"+b).text("");$("#prix-pdt-"+b).text("");this.reservationModif[b]=null}else{var e=$("#lot-"+b).val();var f=this.pdtCommande[b].lots[e].taille;var d={};d.comId=this.infoCommande.comId;d.proId=b;d.dcomId=e;d.stoQuantite=f;this.reservationModif[b]=d;$("#qte-pdt-"+b).text(f.nombreFormate(2,","," "));var c=this.pdtCommande[b].lots[e].prix.nombreFormate(2,","," ");$("#prix-pdt-"+b).text(c);$(".resa-pdt-"+b).show()}this.majTotal()};this.majTotal=function(){var b=this.calculTotal();$("#total").text(b.nombreFormate(2,","," "));this.soldeNv=this.solde-b;this.majNouveauSolde();$("#nouveau-solde").text(this.soldeNv.nombreFormate(2,","," "))};this.majNouveauSolde=function(){if(this.soldeNv<=0){$("#nouveau-solde, #nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde, #nouveau-solde-sigle").removeClass("com-nombre-negatif")}};this.calculTotal=function(){var c=this;var b=0;$(this.reservationModif).each(function(){var d=this;if(d.stoQuantite){if(c.pdtCommande[d.proId]){$.each(c.pdtCommande[d.proId].lots,function(){if(d.dcomId==this.id){b+=(d.stoQuantite/this.taille)*this.prix}})}}});return b};this.preparerAffichageModifier=function(b){var c=this;$(b).find(".pdt").each(function(){var d=$(this).find(".pdt-id").text();if(c.reservation[d]!=null){var g=c.reservation[d];var f=g.dcomId;var h=g.stoQuantite;$(b).find("#qte-pdt-"+d).text(h.nombreFormate(2,","," "));var e=((c.pdtCommande[d].lots[f].prix*g.stoQuantite)/c.pdtCommande[d].lots[f].taille).nombreFormate(2,","," ");$(b).find("#prix-pdt-"+d).text(e);$(b).find("#lot-"+d).selectOptions(f);$(b).find(".resa-pdt-"+d).css("display","table-cell")}});return b};this.validerReservation=function(){var e=this;Infobulle.init();var c=new ListeReservationCommandeVO();var f=0;$(this.reservationModif).each(function(){if(this.stoQuantite){var h=new ReservationCommandeVO();h.stoQuantite=this.stoQuantite*-1;h.stoIdDetailCommande=this.dcomId;c.detailReservation.push(h);f++}});if(f>0){var d=new ListeReservationCommandeValid();var g=d.validAjout(c);if(!g.valid){Infobulle.generer(g,"")}else{c.fonction="modifier";$.post("./index.php?m=Commande&v=AfficherReservation","pParam="+$.toJSON(c),function(h){Infobulle.init();if(h){if(h.valid){e.reservation=[];$(e.reservationModif).each(function(){if(this.proId){e.reservation[this.proId]={proId:this.proId,dcomId:this.dcomId,stoQuantite:this.stoQuantite}}});e.afficher()}else{Infobulle.generer(h,"")}}},"json")}}else{var g=new TemplateVR();g.valid=false;g.log.valid=false;var b=new VRerreur();b.code=ERR_207_CODE;b.message=ERR_207_MSG;g.log.erreurs.push(b);Infobulle.generer(g,"")}};this.affectSupprimerReservation=function(b){var c=this;b.find("#btn-supprimer").click(function(){var e=new CommandeTemplate();var d=e.supprimerReservationDialog;$(d).dialog({autoOpen:true,modal:true,draggable:false,resizable:false,width:600,buttons:{Supprimer:function(){var f={id_commande:c.infoCommande.comId,fonction:"supprimer"};var g=this;$.post("./index.php?m=Commande&v=AfficherReservation","pParam="+$.toJSON(f),function(i){Infobulle.init();if(i){if(i.valid){var j=new TemplateVR();j.valid=false;j.log.valid=false;var h=new VRerreur();h.code=ERR_303_CODE;h.message=ERR_303_MSG;j.log.erreurs.push(h);MonMarcheVue({vr:j});$(g).dialog("close")}else{Infobulle.generer(i,"")}}},"json")},Annuler:function(){$(this).dialog("close")}},close:function(f,g){$(this).remove()}})});return b};this.supprimerSelect=function(b){b.find(".pdt select").each(function(){if($(this).find("option").size()==1){var e=new CommandeTemplate();var d=e.lotUnique;var c={};c.IdPdt=$(this).parent().parent().find(".pdt-id").text();c.valeur=$(this).val();c.text=$(this).text();$(this).replaceWith(d.template(c))}});return b};this.construct(a)}function MesAchatsVue(a){this.mCommunVue=new CommunVue();this.construct=function(b){$.history({vue:function(){MesAchatsVue(b)}});var c=this;$.post("./index.php?m=Commande&v=MesAchats",function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(d);var e=new CommunVue();e.majMenu("Commande","MesAchats")}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(d){Infobulle.init();var c=this;var e=new CommandeTemplate();var b={achat:[]};$(d.achats).each(function(){if(this.comNumero!=null){var f={};f.numero=this.comNumero;f.dateMarcheDebut=this.comDateMarcheDebut.extractDbDate().dateDbToFr();f.idCommande='"'+this.comId+'"';b.achat.push(f)}});if(b.achat.length>0){$("#contenu").replaceWith(c.affect($(e.listeAchats.template(b))))}else{$("#contenu").replaceWith(c.affect($(e.listeAchatVide)))}};this.affect=function(b){b=this.affectVisualiser(b);b=this.mCommunVue.comHoverBtn(b);return b};this.affectVisualiser=function(b){b.find(".ligne-achat").click(function(){MesAchatsDetailVue({id_commande:$(this).attr("id")})});return b};this.construct(a)}function MesAchatsDetailVue(a){this.mCommunVue=new CommunVue();this.infoCommande=new Object();this.pdtCommande=new Array();this.achats=[];this.achatsSolidaire=[];this.stockSolidaire=[];this.pParam={};this.construct=function(b){$.history({vue:function(){MesAchatsDetailVue(b)}});var c=this;this.pParam=b;b.fonction="afficher";$.post("./index.php?m=Commande&v=MesAchatsDetail","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.pdtCommande=d.marche.produits;c.infoCommande.comNumero=d.marche.numero;c.stockSolidaire=d.stockSolidaire;c.afficher(d)}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(c){var d=this;var f=new CommandeTemplate();var e=f.detailAchat;var b={};b.comNumero=this.infoCommande.comNumero;b.sigleMonetaire=gSigleMonetaire;b.achats=[];b.achatsSolidaire=[];$(c.achats).each(function(){var g=this;var j=[];var i=false;$.each(d.pdtCommande,function(){if(this.id){var l=this.id;var k={};k.id=this.id;k.nproNom=this.nom;k.proUniteMesure=this.unite;k.prix=0;k.stoQuantite=0;$.each(this.lots,function(){if(this.id){var m=this.id;$(g.detailAchat).each(function(){if(this.idDetailCommande==m){k.stoQuantite=this.quantite*-1;k.prix=this.montant*-1;i=true}})}});k.stoQuantite=k.stoQuantite.nombreFormate(2,","," ");k.prix=k.prix.nombreFormate(2,","," ");if(!j[this.idCategorie]){j[this.idCategorie]={nom:this.cproNom,achat:[]}}j[this.idCategorie].achat.push(k)}});if(i){var h={categories:j,idAchat:this.id.idAchat,total:(this.total*-1).nombreFormate(2,","," ")};b.achats.push(h)}});$(c.achats).each(function(){var g=this;var j=[];var h=false;$.each(d.pdtCommande,function(){if(this.id){var l=false;var n=this;var m=this.id;var k={};k.id=this.id;k.nproNom=this.nom;k.proUniteMesure=this.unite;k.prix=0;k.stoQuantite=0;$(c.stockSolidaire).each(function(){if(k.id==this.proId){$.each(n.lots,function(){if(this.id){var o=this.id;$(g.detailAchatSolidaire).each(function(){if(this.idDetailCommande==o){k.stoQuantite=this.quantite*-1;k.prix=this.montant*-1;h=true;l=true}})}})}});if(l){k.stoQuantite=k.stoQuantite.nombreFormate(2,","," ");k.prix=k.prix.nombreFormate(2,","," ");if(!j[this.idCategorie]){j[this.idCategorie]={nom:this.cproNom,achat:[]}}j[this.idCategorie].achat.push(k)}}});if(h){var i={categories:j,idAchat:this.id.idAchat,totalSolidaire:(this.totalSolidaire*-1).nombreFormate(2,","," ")};b.achatsSolidaire.push(i)}});$("#contenu").replaceWith(d.affect($(e.template(b))))};this.affect=function(b){return b};this.construct(a)}function MonMarcheVue(a){this.mCommunVue=new CommunVue();this.construct=function(b){$.history({vue:function(){MonMarcheVue(b)}});var c=this;$.post("./index.php?m=Commande&v=MonMarche",function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.afficher(d);var e=new CommunVue();e.majMenu("Commande","MonMarche")}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(e){var d=this;var g=new CommandeTemplate();var b=g.MonMarcheDebut;var f=new Object;f.reservation=new Array();$(e.reservations).each(function(){if(this.comNumero!=null){var h=new Object();h.numero=this.comNumero;h.dateFinReservation=this.comDateFinReservation.extractDbDate().dateDbToFr();h.heureFinReservation=this.comDateFinReservation.extractDbHeure();h.minuteFinReservation=this.comDateFinReservation.extractDbMinute();h.dateMarcheDebut=this.comDateMarcheDebut.extractDbDate().dateDbToFr();h.heureMarcheDebut=this.comDateMarcheDebut.extractDbHeure();h.minuteMarcheDebut=this.comDateMarcheDebut.extractDbMinute();h.heureMarcheFin=this.comDateMarcheFin.extractDbHeure();h.minuteMarcheFin=this.comDateMarcheFin.extractDbMinute();h.idCommande='"'+this.comId+'"';f.reservation.push(h)}});if(f.reservation.length>0){b+=g.listeReservation.template(f)}else{b+=g.listeReservationVide}if(e.marches[0]&&e.marches[0].dateFinReservation!=null){var c=new Object;c.marche=new Array();$(e.marches).each(function(){var h=new Object();h.id=this.id;h.numero=this.numero;h.dateFinReservation=this.dateFinReservation.extractDbDate().dateDbToFr();h.heureFinReservation=this.dateFinReservation.extractDbHeure();h.minuteFinReservation=this.dateFinReservation.extractDbMinute();h.dateMarcheDebut=this.dateMarcheDebut.extractDbDate().dateDbToFr();h.heureMarcheDebut=this.dateMarcheDebut.extractDbHeure();h.minuteMarcheDebut=this.dateMarcheDebut.extractDbMinute();h.heureMarcheFin=this.dateMarcheFin.extractDbHeure();h.minuteMarcheFin=this.dateMarcheFin.extractDbMinute();c.marche.push(h)});b+=g.listeMarche.template(c)}else{b+=g.listeMarcheVide}b+=g.MonMarcheFin;$("#contenu").replaceWith(d.affect($(b)))};this.affect=function(b){b=this.affectBtnCommander(b);b=this.affectVisualiser(b);b=this.mCommunVue.comHoverBtn(b);return b};this.affectBtnCommander=function(b){b.find(".btn-commander").click(function(){var c={id_commande:$(this).attr("id")};ReservationMarcheVue(c)});return b};this.affectVisualiser=function(b){b.find(".visualiser-reservation").click(function(){AfficherReservationVue({id_commande:$(this).attr("id")})});return b};this.construct(a)}function ReservationMarcheVue(a){this.infoCommande=new Object();this.pdtCommande=[];this.reservation=new Array();this.solde=0;this.soldeNv=0;this.construct=function(b){$.history({vue:function(){ReservationMarcheVue(b)}});var c=this;b.fonction="detailMarche";$.post("./index.php?m=Commande&v=ReservationCommande","pParam="+$.toJSON(b),function(d){Infobulle.init();if(d){if(d.valid){if(b&&b.vr){Infobulle.generer(b.vr,"")}c.solde=d.adherent.cptSolde;c.soldeNv=d.adherent.cptSolde;c.infoCommande.comId=d.marche.id;c.infoCommande.comNumero=d.marche.numero;c.infoCommande.comNom=d.marche.nom;c.infoCommande.comDescription=d.marche.description;c.infoCommande.dateTimeFinReservation=d.marche.dateFinReservation;c.infoCommande.dateFinReservation=d.marche.dateFinReservation.extractDbDate().dateDbToFr();c.infoCommande.heureFinReservation=d.marche.dateFinReservation.extractDbHeure();c.infoCommande.minuteFinReservation=d.marche.dateFinReservation.extractDbMinute();c.infoCommande.dateMarcheDebut=d.marche.dateMarcheDebut.extractDbDate().dateDbToFr();c.infoCommande.heureMarcheDebut=d.marche.dateMarcheDebut.extractDbHeure();c.infoCommande.minuteMarcheDebut=d.marche.dateMarcheDebut.extractDbMinute();c.infoCommande.heureMarcheFin=d.marche.dateMarcheFin.extractDbHeure();c.infoCommande.minuteMarcheFin=d.marche.dateMarcheFin.extractDbMinute();c.infoCommande.comArchive=d.marche.archive;c.pdtCommande=d.marche.produits;c.afficher()}else{Infobulle.generer(d,"")}}},"json")};this.afficher=function(){this.afficherReservation()};this.afficherDetailCommande=function(){var d=this;var f=new CommandeTemplate();var e=f.detailReservation;var b=new Object();b.sigleMonetaire=gSigleMonetaire;b.solde=this.solde.nombreFormate(2,","," ");b.soldeNv=this.soldeNv.nombreFormate(2,","," ");b.comNumero=this.infoCommande.comNumero;b.dateFinReservation=this.infoCommande.dateFinReservation;b.heureFinReservation=this.infoCommande.heureFinReservation;b.minuteFinReservation=this.infoCommande.minuteFinReservation;b.dateMarcheDebut=this.infoCommande.dateMarcheDebut;b.heureMarcheDebut=this.infoCommande.heureMarcheDebut;b.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;b.heureMarcheFin=this.infoCommande.heureMarcheFin;b.minuteMarcheFin=this.infoCommande.minuteMarcheFin;b.categories=[];var c=0;$.each(this.pdtCommande,function(){var h=this.id;if(d.reservation[this.id]){var g=new Object;g.proId=h;g.nproNom=this.nom;g.stoQuantite=parseFloat(d.reservation[this.id].stoQuantite);g.proUniteMesure=this.unite;g.prix=0;var i=d.reservation[this.id].dcomId;$.each(this.lots,function(){if(this.id==i){g.prix=(g.stoQuantite/this.taille)*this.prix}});c+=g.prix;g.stoQuantite=g.stoQuantite.nombreFormate(2,","," ");g.prix=g.prix.nombreFormate(2,","," ");if(!b.categories[this.idCategorie]){b.categories[this.idCategorie]={nom:this.cproNom,produits:[]}}b.categories[this.idCategorie].produits.push(g)}});b.total=parseFloat(c).nombreFormate(2,","," ");$("#contenu").replaceWith(d.affect($(e.template(b))));this.majNouveauSolde()};this.afficherReservation=function(){var d=this;var f=new CommandeTemplate();var e=f.reservation;var b={};b.sigleMonetaire=gSigleMonetaire;b.solde=this.solde.nombreFormate(2,","," ");b.soldeNv=this.soldeNv.nombreFormate(2,","," ");b.comNumero=this.infoCommande.comNumero;b.dateFinReservation=this.infoCommande.dateFinReservation;b.heureFinReservation=this.infoCommande.heureFinReservation;b.minuteFinReservation=this.infoCommande.minuteFinReservation;b.dateMarcheDebut=this.infoCommande.dateMarcheDebut;b.heureMarcheDebut=this.infoCommande.heureMarcheDebut;b.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;b.heureMarcheFin=this.infoCommande.heureMarcheFin;b.minuteMarcheFin=this.infoCommande.minuteMarcheFin;b.categories=[];var c=0;$.each(this.pdtCommande,function(){if(this.id){var g={};g.proId=this.id;g.nproNom=this.nom;g.proUniteMesure=this.unite;g.proMaxProduitCommande=parseFloat(this.qteMaxCommande);g.stock=parseFloat(this.stockReservation);g.lot=new Array();var l=false;if(parseFloat(this.qteMaxCommande)==-1&&parseFloat(this.stockInitial)==-1){l=true}else{if(parseFloat(this.stockInitial)==-1){g.max=g.proMaxProduitCommande}else{if(parseFloat(this.qteMaxCommande)==-1){g.max=g.stock}else{if(parseFloat(g.proMaxProduitCommande)<parseFloat(g.stock)){g.max=g.proMaxProduitCommande}else{g.max=g.stock}}}}var j=0;var h=-1;var k=-1;$.each(this.lots,function(){if(this.id){if(l||(!l&&parseFloat(this.taille)<=g.max)){var i={};i.dcomId=this.id;i.dcomTaille=parseFloat(this.taille).nombreFormate(2,","," ");i.dcomPrix=parseFloat(this.prix).nombreFormate(2,","," ");i.prixReservation=parseFloat(this.prix);i.stoQuantiteReservation=parseFloat(this.taille);if(d.reservation[g.proId]&&(d.reservation[g.proId].dcomId==this.id)){i.stoQuantiteReservation=parseFloat(d.reservation[g.proId].stoQuantite);i.prixReservation=(i.stoQuantiteReservation/this.taille)*this.prix;c+=i.prixReservation;h=this.id;i.checked='checked="checked"'}g.prixUnitaire=(i.prixReservation/i.stoQuantiteReservation).nombreFormate(2,","," ");g.stoQuantiteReservation=i.stoQuantiteReservation.nombreFormate(2,","," ");g.prixReservation=i.prixReservation.nombreFormate(2,","," ");g.lot.push(i)}}});b.total=parseFloat(c).nombreFormate(2,","," ");if(h!=-1){g.checked='checked="checked"'}else{g.checked=""}if(g.lot.length==0){g.checked='rel="indisponible"'}if(!b.categories[this.idCategorie]){b.categories[this.idCategorie]={nom:this.cproNom,produits:[]}}b.categories[this.idCategorie].produits.push(g)}});$("#contenu").replaceWith(d.affectModifier($(e.template(b))));this.majNouveauSolde()};this.affect=function(b){b=this.affectModifierReservation(b);b=this.affectValiderReservation(b);b=this.affectInfoProduit(b);b=gCommunVue.comHoverBtn(b);return b};this.affectModifier=function(b){b=this.affectBtnQte(b);b=this.preparerAffichageModifier(b);b=this.affectChangementLot(b);b=this.affectChangementProduit(b);b=this.affectDetailReservation(b);b=this.supprimerSelect(b);b=gCommunVue.comHoverBtn(b);b=this.affectInitLot(b);b=this.affectInfoProduit(b);b=this.masquerIndisponible(b);return b};this.affectInfoProduit=function(b){var c=this;b.find(".btn-info-produit").click(function(){var e=$(this).attr("id-produit");var d={id:e,fonction:"detailProduit"};$.post("./index.php?m=Commande&v=ReservationCommande","pParam="+$.toJSON(d),function(g){Infobulle.init();if(g){if(g.valid){var i=new CommandeTemplate();var h=i.dialogInfoProduit;g.produit.sigleMonetaire=gSigleMonetaire;var f=$(h.template(g.produit));if(g.produit.producteurs.length>0&&g.produit.producteurs[0].nPrdtIdNomProduit==null){f.find("#pro-prdt").remove()}if(g.produit.caracteristiques.length>0&&g.produit.caracteristiques[0].carProIdNomProduit==null){f.find("#pro-car").remove()}$(f).dialog({autoOpen:true,modal:true,draggable:true,resizable:false,width:600,close:function(j,k){$(this).remove();Infobulle.init()}})}else{Infobulle.generer(g,"")}}},"json")});return b};this.affectBtnQte=function(b){var c=this;b.find(".btn-plus").click(function(){var d=$(this).parent().parent().find(".pdt-id").text();c.nouvelleQuantite(d,$(this).parent().parent().find("#lot-"+d).val(),1)});b.find(".btn-moins").click(function(){var d=$(this).parent().parent().find(".pdt-id").text();c.nouvelleQuantite(d,$(this).parent().parent().find("#lot-"+d).val(),-1)});return b};this.masquerIndisponible=function(b){b.find("[rel='indisponible']").each(function(){var e=new CommandeTemplate();var d=e.produitIndisponible;var c={nom:$(this).parents(".pdt").find(".nom-pro").text()};$(this).parents(".pdt").before(d.template(c));$(this).parents(".pdt").remove()});return b};this.affectInitLot=function(b){var c=this;b.find(".pdt select").each(function(){var d=$(this).parent().parent().find(".pdt-id").text();var g=$(this).val();if(c.pdtCommande[d].lots[g]){var e=c.pdtCommande[d].lots[g].prix;var h=c.pdtCommande[d].lots[g].taille;var f=(e/h).nombreFormate(2,","," ");$(b).find("#prix-unitaire-"+d).text(f)}});return b};this.affectChangementLot=function(b){var c=this;b.find(".pdt select").change(function(){c.changerLot($(this).parent().parent().find(".pdt-id").text(),$(this).val())});return b};this.affectChangementProduit=function(b){var c=this;b.find(".pdt :checkbox").click(function(){c.changerProduit($(this).parent().parent().find(".pdt-id").text())});return b};this.affectModifierReservation=function(b){var c=this;b.find("#btn-modifier").click(function(){c.afficherReservation()});return b};this.affectDetailReservation=function(b){var c=this;b.find("#btn-valider").click(function(){c.validerReservation()});return b};this.affectValiderReservation=function(b){var c=this;b.find("#btn-valider").click(function(){c.enregistrerReservation()});return b};this.nouvelleQuantite=function(f,m,b){var i=this.pdtCommande[f].qteMaxCommande;var k=this.pdtCommande[f].stockReservation;var g=false;if(parseFloat(this.pdtCommande[f].qteMaxCommande)==-1&&parseFloat(this.pdtCommande[f].stockInitial)==-1){g=true}else{if(parseFloat(this.pdtCommande[f].stockInitial)==-1){i=this.pdtCommande[f].qteMaxCommande}else{if(parseFloat(this.pdtCommande[f].qteMaxCommande)==-1){i=k}else{if(parseFloat(k)<parseFloat(i)){i=k}}}}var n=this.pdtCommande[f].lots[m].taille;var l=this.pdtCommande[f].lots[m].prix;var d=0;if(this.reservation[f]&&(this.reservation[f].dcomId==m)){d=this.reservation[f].stoQuantite/n}d+=b;var c=0;c=d*n;if(g||(!g&&c>0&&c<=i)){var e=0;e=(d*l).toFixed(2);this.reservation[f].stoQuantite=c;$("#qte-pdt-"+f).text(parseFloat(c).nombreFormate(2,","," "));$("#prix-pdt-"+f).text(parseFloat(e).nombreFormate(2,","," "));this.majTotal()}else{if(c>i){var h=new TemplateVR();h.valid=false;h.log.valid=false;var j=new VRerreur();j.code=ERR_304_CODE;j.message=ERR_304_MSG;h.log.erreurs.push(j);Infobulle.generer(h,"")}}};this.changerLot=function(b,c){var d=this.pdtCommande[b].lots[c].prix;var f=this.pdtCommande[b].lots[c].taille;var e=(d/f).nombreFormate(2,","," ");$("#prix-unitaire-"+b).text(e);if(this.reservation[b]){this.reservation[b].dcomId=c;this.reservation[b].stoQuantite=f;$("#qte-pdt-"+b).text(f.nombreFormate(2,","," "));$("#prix-pdt-"+b).text(d.nombreFormate(2,","," "))}this.majTotal()};this.changerProduit=function(b){if(this.reservation[b]!=null){$(".resa-pdt-"+b).hide();$("#qte-pdt-"+b).text("");$("#prix-pdt-"+b).text("");this.reservation[b]=null}else{var e=$("#lot-"+b).val();var f=this.pdtCommande[b].lots[e].taille;var d={};d.comId=this.infoCommande.comId;d.proId=b;d.dcomId=e;d.stoQuantite=f;this.reservation[b]=d;$("#qte-pdt-"+b).text(f.nombreFormate(2,","," "));var c=this.pdtCommande[b].lots[e].prix.nombreFormate(2,","," ");$("#prix-pdt-"+b).text(c);$(".resa-pdt-"+b).show()}this.majTotal()};this.majTotal=function(){var b=this.calculTotal();$("#total").text(b.nombreFormate(2,","," "));this.soldeNv=this.solde-b;this.majNouveauSolde();$("#nouveau-solde").text(this.soldeNv.nombreFormate(2,","," "))};this.majNouveauSolde=function(){if(this.soldeNv<=0){$("#nouveau-solde, #nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde, #nouveau-solde-sigle").removeClass("com-nombre-negatif")}};this.calculTotal=function(){var c=this;var b=0;$(this.reservation).each(function(){var d=this;if(d.stoQuantite){if(c.pdtCommande[d.proId]){$.each(c.pdtCommande[d.proId].lots,function(){if(d.dcomId==this.id){b+=(d.stoQuantite/this.taille)*this.prix}})}}});return b};this.preparerAffichageModifier=function(b){var c=this;$(b).find(".pdt").each(function(){var d=$(this).find(".pdt-id").text();if(c.reservation[d]!=null){var g=c.reservation[d];var f=g.dcomId;var h=g.stoQuantite;$(b).find("#qte-pdt-"+d).text(h.nombreFormate(2,","," "));var e=((c.pdtCommande[d].lots[f].prix*g.stoQuantite)/c.pdtCommande[d].lots[f].taille).nombreFormate(2,","," ");$(b).find("#prix-pdt-"+d).text(e);$(b).find("#lot-"+d).selectOptions(f);$(b).find(".resa-pdt-"+d).css("display","table-cell")}});return b};this.validerReservation=function(){Infobulle.init();var b=this.genererListeReservation();var c=this.verifierReservation(b);if(c.valid){this.afficherDetailCommande()}else{Infobulle.generer(c,"")}};this.enregistrerReservation=function(){Infobulle.init();var c=this;var b=this.genererListeReservation();var d=this.verifierReservation(b);if(d.valid){b.fonction="reservationMarche";$.post("./index.php?m=Commande&v=ReservationCommande","pParam="+$.toJSON(b),function(e){Infobulle.init();if(e){if(e.valid){c.afficherRetour()}else{Infobulle.generer(e,"")}}},"json")}else{Infobulle.generer(d,"")}};this.genererListeReservation=function(){var b=new ListeReservationCommandeVO();$(this.reservation).each(function(){if(this.stoQuantite){var c=new ReservationCommandeVO();c.stoQuantite=this.stoQuantite*-1;c.stoIdDetailCommande=this.dcomId;b.detailReservation.push(c)}});return b};this.verifierReservation=function(d){if(d.detailReservation.length>0){var c=new ListeReservationCommandeValid();var e=c.validAjout(d)}else{var e=new TemplateVR();e.valid=false;e.log.valid=false;var b=new VRerreur();b.code=ERR_207_CODE;b.message=ERR_207_MSG;e.log.erreurs.push(b)}return e};this.afficherRetour=function(){var b=new CommandeTemplate();$("#contenu").replaceWith(b.reservationOk)};this.supprimerSelect=function(b){b.find(".pdt select").each(function(){if($(this).find("option").size()==1){var e=new CommandeTemplate();var d=e.lotUnique;var c={};c.IdPdt=$(this).parent().parent().find(".pdt-id").text();c.valeur=$(this).val();c.text=$(this).text();$(this).replaceWith(d.template(c))}});return b};this.construct(a)};