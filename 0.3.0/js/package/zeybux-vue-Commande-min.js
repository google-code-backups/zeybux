function ListeCommandeVue(){this.construct=function(){var a=this;$.post("./index.php?m=Commande&v=ListeCommande",function(b){Infobulle.init();if(b.valid){a.afficher(b)}else{Infobulle.generer(b,"")}},"json")};this.afficher=function(c){Infobulle.init();if(c.listeCommande[0]&&c.listeCommande[0].comDateFinReservation!=null){var b=this;var d=new Object;d.commande=new Array();$(c.listeCommande).each(function(){var h=new Object();h.id=this.comId;h.numero=this.comNumero;h.dateFinReservation=this.comDateFinReservation.extractDbDate().dateDbToFr();h.heureFinReservation=this.comDateFinReservation.extractDbHeure();h.minuteFinReservation=this.comDateFinReservation.extractDbMinute();h.dateMarcheDebut=this.comDateMarcheDebut.extractDbDate().dateDbToFr();h.heureMarcheDebut=this.comDateMarcheDebut.extractDbHeure();h.minuteMarcheDebut=this.comDateMarcheDebut.extractDbMinute();h.heureMarcheFin=this.comDateMarcheFin.extractDbHeure();h.minuteMarcheFin=this.comDateMarcheFin.extractDbMinute();d.commande.push(h)});var g=new CommandeTemplate();var e=g.listeCommandePage;$("#contenu").replaceWith(b.affect($(e.template(d))))}else{var f=new TemplateVR();f.valid=false;f.log.valid=false;var a=new VRerreur();a.code=ERR_219_CODE;a.message=ERR_219_MSG;f.log.erreurs.push(a);Infobulle.generer(f,"")}};this.affect=function(a){a=this.affectBtnCommander(a);return a};this.affectBtnCommander=function(a){a.find(".btn-commander").click(function(){ReservationCommandeVue($(this).attr("id"))});return a}}function ReservationCommandeVue(a){this.infoCommande=new Object();this.pdtCommande=new Array();this.reservation=new Array();this.construct=function(b){var c=this;$.post("./index.php?m=Commande&v=ReservationCommande","id_commande="+b,function(d){Infobulle.init();if(d.valid){c.infoCommande.comId=d.commande[0].comId;c.infoCommande.comNumero=d.commande[0].comNumero;c.infoCommande.comNom=d.commande[0].comNom;c.infoCommande.comDescription=d.commande[0].comDescription;c.infoCommande.dateTimeFinReservation=d.commande[0].comDateFinReservation;c.infoCommande.dateFinReservation=d.commande[0].comDateFinReservation.extractDbDate().dateDbToFr();c.infoCommande.heureFinReservation=d.commande[0].comDateFinReservation.extractDbHeure();c.infoCommande.minuteFinReservation=d.commande[0].comDateFinReservation.extractDbMinute();c.infoCommande.dateMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbDate().dateDbToFr();c.infoCommande.heureMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbHeure();c.infoCommande.minuteMarcheDebut=d.commande[0].comDateMarcheDebut.extractDbMinute();c.infoCommande.heureMarcheFin=d.commande[0].comDateMarcheFin.extractDbHeure();c.infoCommande.minuteMarcheFin=d.commande[0].comDateMarcheFin.extractDbMinute();c.infoCommande.comArchive=d.commande[0].comArchive;$(d.commande).each(function(){var f=new Object();f.dcomId=this.dcomId;f.dcomIdProduit=this.dcomIdProduit;f.dcomTaille=this.dcomTaille;f.dcomPrix=this.dcomPrix;if(c.pdtCommande[this.proId]){c.pdtCommande[this.proId].lot[f.dcomId]=f}else{var e=new Object();e.proId=this.proId;e.proUniteMesure=this.proUniteMesure;e.proMaxProduitCommande=this.proMaxProduitCommande;$(d.stock).each(function(){if(this.proId==e.proId){if(this.stoQuantite<e.proMaxProduitCommande){e.proMaxProduitCommande=this.stoQuantite}}});e.nproNom=this.nproNom;e.nproDescription=this.nproDescription;e.nproIdCategorie=this.nproIdCategorie;e.lot=new Array();e.lot[f.dcomId]=f;c.pdtCommande[e.proId]=e}});c.afficher()}else{Infobulle.generer(d,"")}},"json")};this.afficher=function(){this.afficherReservation()};this.afficherDetailCommande=function(){var d=this;var f=new CommandeTemplate();var e=f.detailReservation;var b=new Object();b.sigleMonetaire=gSigleMonetaire;b.comNumero=this.infoCommande.comNumero;b.dateFinReservation=this.infoCommande.dateFinReservation;b.heureFinReservation=this.infoCommande.heureFinReservation;b.minuteFinReservation=this.infoCommande.minuteFinReservation;b.dateMarcheDebut=this.infoCommande.dateMarcheDebut;b.heureMarcheDebut=this.infoCommande.heureMarcheDebut;b.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;b.heureMarcheFin=this.infoCommande.heureMarcheFin;b.minuteMarcheFin=this.infoCommande.minuteMarcheFin;b.reservation=new Array();var c=0;$(this.pdtCommande).each(function(){if(d.reservation[this.proId]){var g=new Object;g.nproNom=this.nproNom;g.stoQuantite=parseFloat(d.reservation[this.proId].stoQuantite);g.proUniteMesure=this.proUniteMesure;g.prix=0;$(this.lot).each(function(){if(g.stoQuantite%this.dcomTaille==0){g.prix=(g.stoQuantite/this.dcomTaille)*this.dcomPrix}});c+=g.prix;g.stoQuantite=g.stoQuantite.nombreFormate(2,","," ");g.prix=g.prix.nombreFormate(2,","," ");b.reservation.push(g)}});b.total=parseFloat(c).nombreFormate(2,","," ");$("#contenu").replaceWith(d.affect($(e.template(b))))};this.afficherReservation=function(){var d=this;var f=new CommandeTemplate();var e=f.reservation;var b={};b.sigleMonetaire=gSigleMonetaire;b.comNumero=this.infoCommande.comNumero;b.dateFinReservation=this.infoCommande.dateFinReservation;b.heureFinReservation=this.infoCommande.heureFinReservation;b.minuteFinReservation=this.infoCommande.minuteFinReservation;b.dateMarcheDebut=this.infoCommande.dateMarcheDebut;b.heureMarcheDebut=this.infoCommande.heureMarcheDebut;b.minuteMarcheDebut=this.infoCommande.minuteMarcheDebut;b.heureMarcheFin=this.infoCommande.heureMarcheFin;b.minuteMarcheFin=this.infoCommande.minuteMarcheFin;b.produit=new Array();var c=0;$(this.pdtCommande).each(function(){if(this.proId){var g={};g.proId=this.proId;g.nproNom=this.nproNom;g.proMaxProduitCommande=parseFloat(this.proMaxProduitCommande).nombreFormate(2,","," ");g.proUniteMesure=this.proUniteMesure;g.lot=new Array();var j=0;var h=-1;var k=-1;$(this.lot).each(function(){if(this.dcomId){var i={};i.dcomId=this.dcomId;i.dcomTaille=parseFloat(this.dcomTaille).nombreFormate(2,","," ");i.dcomPrix=parseFloat(this.dcomPrix).nombreFormate(2,","," ");i.prixReservation=parseFloat(this.dcomPrix);i.stoQuantiteReservation=parseFloat(this.dcomTaille);if(d.reservation[g.proId]&&(d.reservation[g.proId].stoQuantite%this.dcomTaille==0)){i.stoQuantiteReservation=parseFloat(d.reservation[g.proId].stoQuantite);i.prixReservation=(i.stoQuantiteReservation/this.dcomTaille)*this.dcomPrix;c+=i.prixReservation;h=this.dcomId;i.checked='checked="checked"'}i.stoQuantiteReservation=i.stoQuantiteReservation.nombreFormate(2,","," ");i.prixReservation=i.prixReservation.nombreFormate(2,","," ");g.lot.push(i)}});b.total=parseFloat(c).nombreFormate(2,","," ");if(h!=-1){g.checked='checked="checked"'}else{if(g.lot[0]){g.lot[0].checked='checked="checked"'}}b.produit.push(g)}});$("#contenu").replaceWith(d.affectModifier($(e.template(b))))};this.affect=function(b){b=this.affectModifierReservation(b);b=this.affectValiderReservation(b);return b};this.affectModifier=function(b){b=this.affectBtnQte(b);b=this.affectChangementLot(b);b=this.affectChangementProduit(b);b=this.preparerAffichageModifier(b);b=this.affectDetailReservation(b);return b};this.affectBtnQte=function(b){var c=this;b.find(".btn-plus").click(function(){c.nouvelleQuantite($(this).parent().parent().find(".pdt-id").text(),$(this).parent().parent().find(".lot-id").text(),1)});b.find(".btn-moins").click(function(){c.nouvelleQuantite($(this).parent().parent().find(".pdt-id").text(),$(this).parent().parent().find(".lot-id").text(),-1)});return b};this.affectChangementLot=function(b){var c=this;b.find(".lot").click(function(){$(this).find(":radio").attr("checked","checked");c.changerLot($(this).find(".pdt-id").text(),$(this).find(".lot-id").text())});return b};this.affectChangementProduit=function(b){var c=this;b.find(".pdt :checkbox").click(function(){c.changerProduit($(this).parent().parent().find(".pdt-id").text())});return b};this.affectModifierReservation=function(b){var c=this;b.find("#btn-modifier").click(function(){c.afficherReservation()});return b};this.affectDetailReservation=function(b){var c=this;b.find("#btn-valider").click(function(){c.validerReservation()});return b};this.affectValiderReservation=function(b){var c=this;b.find("#btn-valider").click(function(){c.enregistrerReservation()});return b};this.nouvelleQuantite=function(f,i,b){var g=this.pdtCommande[f].proMaxProduitCommande;var j=this.pdtCommande[f].lot[i].dcomTaille;var h=this.pdtCommande[f].lot[i].dcomPrix;var d=0;if(this.reservation[f]&&(this.reservation[f].stoQuantite%j==0)){d=this.reservation[f].stoQuantite/j}d+=b;var c=0;c=d*j;if(c>0&&c<=g){var e=0;e=d*h;this.reservation[f].stoQuantite=c;$("#qte-pdt-"+f+"-lot-"+i).text(parseFloat(c).nombreFormate(2,","," "));$("#prix-pdt-"+f+"-lot-"+i).text(parseFloat(e).nombreFormate(2,","," "));this.majTotal()}};this.changerLot=function(b,c){$(".btn-pdt-"+b).attr("disabled","disabled").addClass("ui-helper-hidden");$(".colonne-pdt-"+b).addClass("ui-helper-hidden");$("#btn-moins-lot-"+c+",#btn-plus-lot-"+c).removeAttr("disabled").removeClass("ui-helper-hidden");$("#colonne-qte-pdt-"+b+"-lot-"+c+",#colonne-prix-pdt-"+b+"-lot-"+c+",#colonne-sigle-pdt-"+b+"-lot-"+c).removeClass("ui-helper-hidden");this.reservation[b].stoQuantite=$("#qte-pdt-"+b+"-lot-"+c).text().numberFrToDb();this.majTotal()};this.changerProduit=function(b){var c=this;if($("#pdt-"+b).find(":checkbox").attr("checked")){$(".lot-pdt-"+b).show();$("[name=lot-produit-"+b+"]").each(function(){if($(this).attr("checked")){var e=$("#qte-pdt-"+b+"-lot-"+$(this).parent().parent().find(".lot-id").text()).text().numberFrToDb();if(c.reservation[b]){c.reservation[b].stoQuantite=e}else{var d={};d.comId=c.infoCommande.comId;d.proId=b;d.stoQuantite=e;c.reservation[b]=d}}})}else{$(".lot-pdt-"+b).hide();if(this.reservation[b]){this.reservation[b]=null}}this.majTotal()};this.majTotal=function(){$("#total").text(this.calculTotal().nombreFormate(2,","," "))};this.calculTotal=function(){var c=this;var b=0;$(this.reservation).each(function(){var d=this;if(d.stoQuantite){if(c.pdtCommande[d.proId]){$(c.pdtCommande[d.proId].lot).each(function(){if(d.stoQuantite%this.dcomTaille==0){b+=(d.stoQuantite/this.dcomTaille)*this.dcomPrix}})}}});return b};this.preparerAffichageModifier=function(b){var c=this;b.find(":checkbox:not(:checked)").each(function(){b.find(".lot-pdt-"+$(this).parent().parent().find(".pdt-id").text()).hide()});b.find(":radio:not(:checked)").each(function(){var e=$(this).parent().parent().find(".lot-id").text();var d=$(this).parent().parent().find(".pdt-id").text();b.find("#btn-moins-lot-"+e+",#btn-plus-lot-"+e).attr("disabled","disabled").addClass("ui-helper-hidden");b.find("#colonne-qte-pdt-"+d+"-lot-"+e+",#colonne-prix-pdt-"+d+"-lot-"+e+",#colonne-sigle-pdt-"+d+"-lot-"+e).addClass("ui-helper-hidden")});return b};this.validerReservation=function(){Infobulle.init();var b=this.genererListeReservation();var c=this.verifierReservation(b);if(c.valid){this.afficherDetailCommande()}else{Infobulle.generer(c,"")}};this.enregistrerReservation=function(){Infobulle.init();var c=this;var b=this.genererListeReservation();var d=this.verifierReservation(b);if(d.valid){$.post("./index.php?m=Commande&v=ReservationCommande","reservation="+$.toJSON(b),function(e){Infobulle.init();if(e.valid){c.afficherRetour()}else{Infobulle.generer(e,"")}},"json")}else{Infobulle.generer(d,"")}};this.genererListeReservation=function(){var b=new ListeReservationCommandeVO();$(this.reservation).each(function(){if(this.stoQuantite){var c=new ReservationCommandeVO();c.id="";c.stoQuantite=this.stoQuantite*-1;c.stoIdProduit=this.proId;b.commandes.push(c)}});return b};this.verifierReservation=function(d){if($(d.commandes).length>0){var c=new ListeReservationCommandeValid();var e=c.validAjout(d)}else{var e=new TemplateVR();e.valid=false;e.log.valid=false;var b=new VRerreur();b.code=ERR_207_CODE;b.message=ERR_207_MSG;e.log.erreurs.push(b)}return e};this.afficherRetour=function(){var b=new CommandeTemplate();$("#contenu").replaceWith(b.reservationOk)};this.construct(a)};