function GestionListeCommandeVue(){this.construct=function(){var a=this;$.post("./index.php?m=GestionCommande&v=ListeCommande",function(b){Infobulle.init();if(b.valid){a.afficher(b)}else{Infobulle.generer(b,"")}},"json")};this.afficher=function(c){var b=this;var d=new Object;d.commande=new Array();$(c.listeCommande).each(function(){var f=new Object();f.numero=this.comNumero;f.dateFinReservation=this.comDateFinReservation.extractDbDate().dateDbToFr();f.heureFinReservation=this.comDateFinReservation.extractDbHeure();f.minuteFinReservation=this.comDateFinReservation.extractDbMinute();f.dateMarcheDebut=this.comDateMarcheDebut.extractDbDate().dateDbToFr();f.heureMarcheDebut=this.comDateMarcheDebut.extractDbHeure();f.minuteMarcheDebut=this.comDateMarcheDebut.extractDbMinute();f.heureMarcheFin=this.comDateMarcheFin.extractDbHeure();f.minuteMarcheFin=this.comDateMarcheFin.extractDbMinute();f.lienEdit='"'+this.comId+'"';f.lienMarche='"'+this.comId+'"';d.commande.push(f)});var a=new GestionCommandeTemplate();var e=a.listeCommandePage;$("#contenu").replaceWith(b.affectLienMarche($(e.template(d))))};this.affectLienMarche=function(a){a.find(".liste-commande-lien-marche").click(function(){var b=new MarcheCommandeVue();b.construct($(this).attr("id"))});return a}}function AjoutCommandeVue(){this.etapeCreationCommande=0;this.mCommunVue=new CommunVue();this.mControleur=new AjoutCommandeControleur();this.construct=function(){var a=this;$.post("./index.php?m=GestionCommande&v=AjoutCommande",function(b){Infobulle.init();if(b.valid){a.afficher(b)}else{Infobulle.generer(b,"")}},"json")};this.afficher=function(b){var c=this;var a=new GestionCommandeTemplate();var d=a.formulaireAjoutCommande;$("#contenu").replaceWith(c.affect($(d.template(b))))};this.affect=function(a){a=this.affectAjoutProduit(a);a=this.affectCreerCommande(a);a=this.affectModifierCommande(a);a=this.affectDialogCreerProduit(a);a=this.affectControleDatepicker(a);a=this.mCommunVue.comNumeric(a);return a};this.affectNouveauProduit=function(a){a=this.mCommunVue.comDelete(a);a=this.mCommunVue.comNumeric(a);a=this.editProduit(a);a=this.ajoutLotProduit(a);a=this.affectAjoutLot(a);return a};this.affectAjoutLot=function(a){a=this.editLot(a);a=this.deleteLot(a);return a};this.affectAjoutProduit=function(a){var c="#formulaire-ajout-produit-creation-commande";var b=this;a.find(c).submit(function(){var g=true;$(".produit-id").each(function(){if(parseInt($(this).text())==$(c+" :input[name=produit]").val()){g=false}});if(g){var f=new ProduitCommandeVO();f.idNom=$(c+" :input[name=produit]").val();f.nom=$(c+" :input[name=produit] option:selected").text();f.unite=$(c+" :input[name=unite]").val();f.qteMaxCommande=$(c+" :input[name=qmax]").val().numberFrToDb();f.qteRestante=$(c+" :input[name=stock]").val().numberFrToDb();var j=new DetailCommandeVO();j.taille=$(c+" :input[name=taille]").val().numberFrToDb();j.prix=$(c+" :input[name=prix]").val().numberFrToDb();f.lots.push(j);var i=b.mControleur.validAjoutProduit(f);if(i.valid){Infobulle.init();var d=new GestionCommandeTemplate();var h=d.ajoutProduitAjoutCommande;f.lots[0].prix=parseFloat(f.lots[0].prix).nombreFormate(2,","," ");f.siglemonetaire=gSigleMonetaire;$("#liste_produit").append(b.affectNouveauProduit($(h.template(f))));$(c+" :input[name=unite]").val("");$(c+" :input[name=qmax]").val("");$(c+" :input[name=stock]").val("");$(c+" :input[name=taille]").val("");$(c+" :input[name=prix]").val("")}else{Infobulle.generer(i,"ajout-produit-")}}else{var i=new TemplateVR();i.valid=false;i.log.valid=false;var e=new VRerreur();e.code=ERR_211_CODE;e.message=ERR_211_MSG;i.log.erreurs.push(e);Infobulle.generer(i,"")}return false});return a};this.affectCreerCommande=function(a){var c="#btn-creer-commande";var b=this;a.find(c).click(function(){var d=true;$("#liste_produit").find(":button").each(function(){if($(this).text()==gTextValider){d=false}});if(d){var f=new CommandeCompleteVO();f.nom=$("#formulaire-information-creation-commande").find(":input[name=nom_commande]").val();f.description=$("#formulaire-information-creation-commande").find(":input[name=description_commande]").val();f.dateMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();f.timeMarcheDebut=$("#formulaire-information-creation-commande").find(":input[name=heure_debut_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_debut_marche]").val()+":00";f.dateMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=date_debut_marche]").val().dateFrToDb();f.timeMarcheFin=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_marche]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_marche]").val()+":00";f.dateFinReservation=$("#formulaire-information-creation-commande").find(":input[name=date_fin_commande]").val().dateFrToDb();f.timeFinReservation=$("#formulaire-information-creation-commande").find(":input[name=heure_fin_commande]").val()+":"+$("#formulaire-information-creation-commande").find(":input[name=minute_fin_commande]").val()+":00";f.archive="0";$(".produit-div").each(function(){var h=new ProduitCommandeVO();h.idNom=$(this).find(".produit-id").text();h.unite=$(this).find(":input[name=unite]").val();h.qteMaxCommande=$(this).find(":input[name=qmax]").val().numberFrToDb();h.qteRestante=$(this).find(":input[name=stock]").val().numberFrToDb();$(this).find(".produit-lot").each(function(){var i=new DetailCommandeVO();i.taille=$(this).find(":input[name=taille]").val().numberFrToDb();i.prix=$(this).find(":input[name=prix]").val().numberFrToDb();h.lots.push(i)});f.produits.push(h)});if(b.etapeCreationCommande==0){var g=b.mControleur.valid(f);if(g.valid){b.etapeCreationCommande=1;Infobulle.init();$("#window-ajout-produit-creation-commande").hide();$("#btn-modifier-creation-commande").show();$("#liste_produit .produit-div :button , .form-ajout-lot-creation-commande").each(function(){$(this).hide()});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").each(function(){$(this).inputToText()})}else{Infobulle.generer(g,"commande-")}}else{if(b.etapeCreationCommande==1){$.post("./index.php?m=GestionCommande&v=AjoutCommande","commande="+$.toJSON(f)+"&form=2",function(i){if(i.valid){var h=new GestionCommandeTemplate();var j=h.ajoutCommandeSucces;$("#contenu").replaceWith(j.template(i))}else{b.modifierCommandeFunction();Infobulle.generer(i,"commande-")}b.etapeCreationCommande=0},"json")}}}else{var g=new Object();var e=new VRerreur();e.code=ERR_112_CODE;e.message=ERR_112_MSG;g.valid=false;g.log=new VRelement();g.log.valid=false;g.log.erreurs.push(e);Infobulle.generer(g,"")}});return a};this.affectModifierCommande=function(a){var b=this;a.find("#btn-modifier-creation-commande").click(function(){b.modifierCommandeFunction()});return a};this.modifierCommandeFunction=function(){this.etapeCreationCommande=0;var a=this;$("#window-ajout-produit-creation-commande, #liste_produit .produit-div :button, .form-ajout-lot-creation-commande").show();$("#btn-modifier-creation-commande").hide();$(".produit-lots").each(function(){a.afficherDeleteLot($(this))});$("#formulaire-information-creation-commande :input[type=text], #formulaire-information-creation-commande :input[type=textarea], #formulaire-information-creation-commande select").textToInput()};this.ajoutLotProduit=function(a){var b=this;a.find(".btn-ajout-lot-creation-commande").click(function(){var f=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=taille]");var c=$(this).parents(".form-ajout-lot-creation-commande").find(":input[name=prix]");var e=new DetailCommandeVO();e.idProduit=$(this).parents(".produit-div").find(".produit-id").text();e.taille=f.val().numberFrToDb();e.prix=c.val().numberFrToDb();var i=b.mControleur.validAjoutLot(e);if(i.valid){Infobulle.init();e.prix=parseFloat(e.prix).nombreFormate(2,","," ");e.siglemonetaire=gSigleMonetaire;e.unite=$(this).parentsUntil(".produit-div").find(":input[name=unite]").val();e.idNom=e.idProduit;var h=new Array();$(this).parentsUntil(".produit-div").find(".produit-lot").each(function(){h.push(parseInt($(this).find(".lot-id").text()))});e.id=Array.max(h)+1;var d=new GestionCommandeTemplate();var g=d.ajoutLot;b.afficherDeleteLot($(this).parents(".produit-div").find(".produit-lots").append(b.affectAjoutLot($(g.template(e)))));f.val("");c.val("")}else{Infobulle.generer(i,"ajout-lot-produit-"+e.idProduit+"-")}});return a};this.editProduit=function(a){var b=this;a.find(".edit-nom-pdt-creation-commande").click(function(){if($(this).text()==gTextEdition){$(this).text(gTextValider);$(this).parent().children(":input:not(:button,:submit)").each(function(){$(this).textToInput()})}else{var c=new ProduitCommandeVO();var e=$(this).parentsUntil(".produit-div");c.idNom=$(e).find(".produit-id").text();c.nom=$(e).find(".produit-nom").text();c.unite=$(e).find(":input[name=unite]").val();c.qteMaxCommande=$(e).find(":input[name=qmax]").val().numberFrToDb();c.qteRestante=$(e).find(":input[name=stock]").val().numberFrToDb();var f=b.mControleur.validAjoutProduitSimple(c);if(f.valid){Infobulle.init();$(this).text(gTextEdition);$(this).parent().children(":input:not(:button,:submit)").each(function(){$(this).inputToText()});var d=$(this).parentsUntil("#liste_produit");d.find(".produit-unite").text(d.children(":input[name=unite]").val())}else{Infobulle.generer(f,"produit-"+c.idNom+"-")}}});return a};this.editLot=function(a){var b=this;a.find(".edit-lot-creation-commande").click(function(){if($(this).text()==gTextEdition){$(this).text(gTextValider);$(this).parent().children(":input:not(:button,:submit)").each(function(){$(this).textToInput()})}else{var c=new DetailCommandeVO();var d=$(this).parent(".produit-lot");c.id=$(d).find(".lot-id").text();c.idProduit=$(this).parentsUntil(".produit-div").find(".produit-id").text();c.taille=$(d).find(":input[name=taille]").val().numberFrToDb();c.prix=$(d).find(":input[name=prix]").val().numberFrToDb();var e=b.mControleur.validAjoutLot(c);if(e.valid){Infobulle.init();$(this).text(gTextEdition);$(this).parent().find(":input[name='taille']").inputToText();$(this).parent().find(":input[name='prix']").inputToText("montant")}else{Infobulle.generer(e,"produit-"+c.idProduit+"-lot-"+c.id+"-")}}});return a};this.deleteLot=function(a){var b=this;a.find(".delete-lot").click(function(){var c=$(this).parents(".produit-lots");$(this).parent().remove();b.afficherDeleteLot(c)});return a};this.afficherDeleteLot=function(a){if(a.children(".produit-lot").size()<2){a.find(".delete-lot").hide()}else{a.find(".delete-lot").show()}return a};this.affectDialogCreerProduit=function(a){a.find("#dialog-form-creer-nv-pdt").dialog({autoOpen:false,modal:true,draggable:false,resizable:false,width:400,buttons:{"Créer le produit":function(){var b=$(this).children("form").first();var c=b.find(":input[name=nom]");var d=true;$("#dialog-form-creer-nv-pdt").children().first().html("").hide();b.find(":input").removeClass("ui-state-error");d=c.checkLength(1,50);if(d){$.post("./index.php?m=GestionCommande&v=AjoutCommande",b.serialize()+"&form=1",function(e){if(e.succes==true){$("#formulaire-ajout-produit-creation-commande select[name=produit]").addOption(e.produit,true).sortOptions();$("#dialog-form-creer-nv-pdt").dialog("close")}else{var f='<div class="ui-state-error ui-corner-all" style="padding: 0 .7em;"><p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span><strong>Erreur : </strong> L\'ajout n\'a pas été effectué.<br/><!-- BEGIN erreurs --><strong>Code Erreur : </strong>{erreurs.CODE_ERREUR}<br/><strong>Message Erreur : </strong>{erreurs.MESSAGE_ERREUR}<br/><!-- END erreurs --></p></div>';$("#dialog-form-creer-nv-pdt").children().first().html(f.template(e)).fadeIn(gTempsTransitionUnique)}},"json")}},Annuler:function(){$(this).dialog("close")}},close:function(){$(this).children("form").first().find(":input").val("").removeClass("ui-state-error");$("#dialog-form-creer-nv-pdt").children().first().html("").hide()}});a.find("#btn-creer-nv-pdt").click(function(){$("#dialog-form-creer-nv-pdt").dialog("open")});return a};this.affectControleDatepicker=function(a){a=this.mCommunVue.comLienDatepicker("commande-dateFinReservation","commande-dateMarcheDebut",a);return a}}function AchatCommandeVue(){this.idCommande=null;this.idAdherent=null;this.idCompte=null;this.listeLot=new Array();this.typePaiement=null;this.solde=null;this.mCommunVue=new CommunVue();this.etapeValider=0;this.construct=function(b,c){var a=this;this.idCommande=b;this.idAdherent=c;$.post("./index.php?m=GestionCommande&v=MarcheCommande","id_commande="+b+"&id_adherent="+c,function(f){Infobulle.init();if(f.valid){a.idCompte=f.adherent.adhIdCompte;for(lLigne in f.commande){var e=new Object();e.quantite=f.commande[lLigne].dcomTaille;e.prix=f.commande[lLigne].dcomPrix;if(!a.listeLot[f.commande[lLigne].proId]){if(!isArray(a.listeLot[f.commande[lLigne].proId])){a.listeLot[f.commande[lLigne].proId]=new Array()}}a.listeLot[f.commande[lLigne].proId].push(e)}var d=new Array();for(lIndice in f.typePaiement){d[f.typePaiement[lIndice].id]=f.typePaiement[lIndice]}a.typePaiement=d;a.solde=parseFloat(f.adherent.opeMontant);a.afficher(f)}else{Infobulle.generer(f,"")}},"json")};this.afficher=function(c){Infobulle.init();if(c.valid){var d=this;var a=new GestionCommandeTemplate();var f=a.achatCommandePage;var b=new Object();b.comNumero=c.commande[0].comNumero;b.adhNumero=c.adherent.adhNumero;b.adhCompte=c.adherent.cptLabel;b.adhNom=c.adherent.adhNom;b.adhPrenom=c.adherent.adhPrenom;b.sigleMonetaire=gSigleMonetaire;b.total=0;b.produits=new Array();lListeIdProduit=new Array();for(lLigne in c.commande){lPush=true;for(lId in lListeIdProduit){if(lListeIdProduit[lId]==c.commande[lLigne].proId){lPush=false}}if(lPush){lListeIdProduit.push(c.commande[lLigne].proId);var g=new Object();g.proId=c.commande[lLigne].proId;g.nproNom=c.commande[lLigne].nproNom;g.proUniteMesure=c.commande[lLigne].proUniteMesure;g.stoQuantite=0;g.proPrix=0;var e=0;for(lReservation in c.reservation){if(c.reservation[lReservation].proId==g.proId){g.stoQuantite=c.reservation[lReservation].stoQuantite*-1;e=this.calculPrixProduit(g.proId,g.stoQuantite);g.proPrix=e.nombreFormate(2,","," ")}}b.total+=e;b.produits.push(g)}}b.adhSolde=parseFloat(c.adherent.opeMontant);b.adhNouveauSolde=b.adhSolde-b.total;b.adhSolde=b.adhSolde.nombreFormate(2,","," ");b.adhNouveauSolde=b.adhNouveauSolde.nombreFormate(2,","," ");b.total=b.total.nombreFormate(2,","," ");b.typePaiement=c.typePaiement;$("#contenu").replaceWith(d.affect($(f.template(b))));d.changerTypePaiement($(":input[name=typepaiement]"));d.majNouveauSolde()}else{Infobulle.generer(c,"")}};this.affect=function(a){a=this.affectSelectTypePaiement(a);a=this.affectNouveauSolde(a);a=this.mCommunVue.comNumeric(a);a=this.affectNouveauPrixProduit(a);a=this.affectChampComplementaire(a);a=this.affectValider(a);a=this.affectAnnuler(a);a=this.affectModifier(a);return a};this.affectSelectTypePaiement=function(a){var b=this;a.find(":input[name=typepaiement]").change(function(){b.changerTypePaiement($(this))});return a};this.affectNouveauSolde=function(a){var b=this;a.find(":input[name=montant-rechargement], .produit-prix").keyup(function(){b.majNouveauSolde();b.controlerAchat()});return a};this.affectNouveauPrixProduit=function(a){var b=this;a.find(".produit-quantite").keyup(function(){b.majPrixProduit($(this));b.controlerAchat()});return a};this.affectChampComplementaire=function(a){var b=this;a.find(":input[name=champ-complementaire]").keyup(function(){b.controlerAchat()});return a};this.affectValider=function(a){var b=this;a.find("#btn-valider").click(function(){b.creerRecapitulatif()});return a};this.affectAnnuler=function(a){var b=this;a.find("#btn-annuler").click(function(){b.retourListe()});return a};this.affectModifier=function(a){var b=this;a.find("#btn-modifier").click(function(){b.boutonModifier()});return a};this.majPrixProduit=function(a){var e=parseFloat(a.val().numberFrToDb());if(isNaN(e)){e=0}var b=a.parent().parent();var c=b.find(".produit-id").text();var d=this.calculPrixProduit(c,e);if(isNaN(d)){d=0}b.find(".produit-prix").val(d.nombreFormate(2,","," "));this.majNouveauSolde()};this.controlerAchat=function(){Infobulle.init();var a=new AchatCommandeValid();var b=a.validAjout(this.getAchatCommandeVO());Infobulle.generer(b,"");return b};this.calculPrixProduit=function(a,d){if(this.listeLot[a]){var b=this.listeLot[a];var c=0;for(lLot in b){if(d%b[lLot].quantite==0){c=(d/b[lLot].quantite)*b[lLot].prix}}return c}return 0};this.majTotal=function(){var a=this;$("#total-achat").text(a.calculerTotal().nombreFormate(2,","," "))};this.calculerTotal=function(){var a=0;$(".produit-prix").each(function(){var b=parseFloat($(this).val().numberFrToDb());if(isNaN(b)){b=0}a+=b});return a};this.majNouveauSolde=function(){this.majTotal();var a=this.calculNouveauSolde();if(a<=0){$("#nouveau-solde").addClass("com-nombre-negatif");$("#nouveau-solde-sigle").addClass("com-nombre-negatif")}else{$("#nouveau-solde").removeClass("com-nombre-negatif");$("#nouveau-solde-sigle").removeClass("com-nombre-negatif")}$("#nouveau-solde").text(a.nombreFormate(2,","," "))};this.calculNouveauSolde=function(){var b=parseFloat($("#total-achat").text().numberFrToDb());if(isNaN(b)){b=0}var a=parseFloat($(":input[name=montant-rechargement]").val().numberFrToDb());if(isNaN(a)){a=0}return this.solde-b+a};this.changerTypePaiement=function(c){var b=c.val();var a=this.getLabelChamComplementaire(b);if(a!=null){$("#label-champ-complementaire").text(a).show();$("#td-champ-complementaire").show()}else{$("#label-champ-complementaire").text("").hide();$(":input[name=champ-complementaire]").val();$("#td-champ-complementaire").hide()}};this.getLabelChamComplementaire=function(b){var a=this.typePaiement;if(a[b]){if(a[b].champComplementaire==1){return a[b].labelChampComplementaire}}return null};this.getAchatCommandeVO=function(){var a=new AchatCommandeVO();a.id=this.idCommande;a.idCompte=this.idCompte;a.produits=this.getProduitsVO();a.rechargement=this.getRechargementVO();return a};this.getProduitsVO=function(){var a=new Array();$(".ligne-produit").each(function(){var c=new ProduitAchatVO();c.id=$(this).find(".produit-id").text();var d=$(this).find(".produit-quantite").val().numberFrToDb();if(!isNaN(d)&&!d.isEmpty()){d=parseFloat(d)}c.quantite=d;var b=$(this).find(".produit-prix").val().numberFrToDb();if(!isNaN(b)&&!b.isEmpty()){b=parseFloat(b)}c.prix=b;a.push(c)});return a};this.getRechargementVO=function(){var a=new RechargementCompteVO();a.id=this.idCompte;var b=$(":input[name=montant-rechargement]").val().numberFrToDb();if(!isNaN(b)&&!b.isEmpty()){b=parseFloat(b)}a.montant=b;a.typePaiement=$(":input[name=typepaiement]").val();if(this.getLabelChamComplementaire(a.typePaiement)!=null){a.champComplementaireObligatoire=1;a.champComplementaire=$(":input[name=champ-complementaire]").val()}else{a.champComplementaireObligatoire=0}return a};this.creerRecapitulatif=function(){var a=this.controlerAchat();if(a.valid){if(this.etapeValider==0){$(".produit-quantite,#rechargementchampComplementaire,#typepaiement").each(function(){$(this).inputToText()});$(".produit-prix,#rechargementmontant").each(function(){$(this).inputToText("montant")});$("#btn-modifier").show();$("#btn-annuler").hide();this.etapeValider=1}else{if(this.etapeValider==1){this.enregistrerAchat()}}}};this.enregistrerAchat=function(){var b=this;var a=this.getAchatCommandeVO();$.post("./index.php?m=GestionCommande&v=MarcheCommande","achat="+$.toJSON(a),function(d){if(d.valid){var c=new GestionCommandeTemplate();var e=c.achatCommandeSucces;$("#contenu").replaceWith(b.affectAnnuler($(e)))}else{b.boutonModifier();Infobulle.generer(d,"")}b.etapeValider=0},"json")};this.boutonModifier=function(){if(this.etapeValider==1){$(".produit-prix,#rechargementmontant,.produit-quantite,#rechargementchampComplementaire,#typepaiement").each(function(){$(this).textToInput()});$("#btn-modifier").hide();$("#btn-annuler").show();this.etapeValider=0}};this.retourListe=function(){var a=new MarcheCommandeVue();a.construct(this.idCommande)}}function MarcheCommandeVue(){this.idCommande=null;this.construct=function(a){var b=this;$.post("./index.php?m=GestionCommande&v=MarcheCommande","id_commande="+a,function(c){Infobulle.init();if(c.valid){b.afficher(c)}else{Infobulle.generer(c,"")}},"json");this.idCommande=a};this.afficher=function(c){Infobulle.init();if(c.valid){if(c.listeAdherentCommande){var d=this;var a=new GestionCommandeTemplate();var e=a.listeAdherentCommandePage;c.comNumero=c.listeAdherentCommande[0].comNumero;$("#contenu").replaceWith(d.affect($(e.template(c))))}else{var f=new TemplateVR();f.valid=false;f.log.valid=false;var b=new VRerreur();b.code=ERR_211_CODE;b.message=ERR_211_MSG;f.log.push(b);Infobulle.generer(f,"")}}else{Infobulle.generer(c,"")}};this.affect=function(a){a=this.affectTri(a);a=this.affectRecherche(a);a=this.affectLienAchat(a);return a};this.affectTri=function(a){a.find(".com-table").tablesorter({sortList:[[2,0]]});return a};this.affectRecherche=function(a){a.find("#filter").keyup(function(){$.uiTableFilter($(".com-table"),this.value)});return a};this.affectLienAchat=function(a){var b=this;a.find(".achat-commande-ligne").click(function(){var c=new AchatCommandeVue();c.construct(b.idCommande,$(this).find(".id-adherent").text())});return a}};